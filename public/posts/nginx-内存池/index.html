<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Wei Haoyu</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="ç‚¹å‡»è¿”å›ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•

ç›®å½•
{:toc}


1. ä»‹ç»
Nginx å†…å­˜æ± çš„å®ç°æ˜¯å…¶é«˜æ€§èƒ½ã€é«˜å¹¶å‘å¤„ç†èƒ½åŠ›çš„é‡è¦ç»„æˆéƒ¨åˆ†ä¹‹ä¸€ã€‚Nginx çš„å†…å­˜æ± ä¸»è¦ç”¨äºé«˜æ•ˆç®¡ç†å†…å­˜ï¼Œé¿å…é¢‘ç¹çš„å†…å­˜åˆ†é…ä¸é‡Šæ”¾æ“ä½œï¼Œå‡å°‘å†…å­˜ç¢ç‰‡ï¼Œæå‡æ€§èƒ½ã€‚Nginx å†…å­˜æ± çš„å®ç°éµå¾ªâ€œé¢„åˆ†é…ä¸€å—å†…å­˜ï¼Œç„¶åè¿›è¡Œå°å—åˆ†é…â€çš„ç­–ç•¥ï¼Œç±»ä¼¼äºå¸¸è§çš„å†…å­˜æ± æ¨¡å‹ã€‚
Nginxåœ¨ ngx_palloc.h å’Œ ngx_palloc.c ä¸­å®ç°äº†å†…å­˜æ± ã€‚
2. å†…å­˜æ± çš„å®ç°åŸç†
2.1 Nginx å†…å­˜æ± çš„ç»“æ„
ngx_pool_s ç»“æ„ä½“æ˜¯å†…å­˜æ± çš„æ ¸å¿ƒç»“æ„ï¼Œå®ƒç®¡ç†å†…å­˜å—çš„é“¾è¡¨ã€å†…å­˜æ± çš„å¤§å°ä¿¡æ¯ã€ä»¥åŠæ¸…ç†å‡½æ•°ç­‰ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š
struct ngx_pool_s {
    ngx_pool_data_t       d;         // å†…å­˜å—çš„æ•°æ®
    size_t                max;       // å¯ä»è¯¥å†…å­˜æ± åˆ†é…çš„æœ€å¤§å†…å­˜å—å¤§å°
    ngx_pool_t           *current;   // å½“å‰æ´»è·ƒçš„å†…å­˜å—
    ngx_chain_t          *chain;     // ç¼“å­˜é“¾
    ngx_pool_large_t     *large;     // å¤§å—å†…å­˜é“¾è¡¨
    ngx_pool_cleanup_t   *cleanup;   // æ¸…ç†å‡½æ•°é“¾è¡¨
    ngx_log_t            *log;       // æ—¥å¿—å¯¹è±¡
};
å…¶ä¸­ï¼Œngx_pool_data_t å®šä¹‰äº†æ¯ä¸ªå†…å­˜å—çš„å…ƒæ•°æ®ï¼š
typedef struct {
    u_char      *last;    // å½“å‰å†…å­˜å—ä¸­å·²ä½¿ç”¨çš„æœ€åä½ç½®
    u_char      *end;     // å½“å‰å†…å­˜å—çš„æœ«å°¾ä½ç½®
    ngx_pool_t  *next;    // ä¸‹ä¸€ä¸ªå†…å­˜å—çš„æŒ‡é’ˆ
    ngx_uint_t   failed;  // åˆ†é…å¤±è´¥æ¬¡æ•°
} ngx_pool_data_t;
2.2 å†…å­˜æ± çš„åˆ›å»ºå’Œé”€æ¯
ngx_create_poolå‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªå†…å­˜æ± ï¼Œåˆ†é…ä¸€ä¸ªåˆå§‹å¤§å°ä¸º size çš„å†…å­˜å—ï¼Œå¹¶åˆå§‹åŒ–å†…å­˜æ± çš„å„ç§å‚æ•°ï¼š">
    <meta name="generator" content="Hugo 0.145.0">
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >




    


    
      

    

    

    
      <link rel="canonical" href="http://localhost:1313/posts/nginx-%E5%86%85%E5%AD%98%E6%B1%A0/">
    

    <meta property="og:url" content="http://localhost:1313/posts/nginx-%E5%86%85%E5%AD%98%E6%B1%A0/">
  <meta property="og:site_name" content="Wei Haoyu">
  <meta property="og:title" content="Wei Haoyu">
  <meta property="og:description" content="ç‚¹å‡»è¿”å›ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•
ç›®å½• {:toc} 1. ä»‹ç» Nginx å†…å­˜æ± çš„å®ç°æ˜¯å…¶é«˜æ€§èƒ½ã€é«˜å¹¶å‘å¤„ç†èƒ½åŠ›çš„é‡è¦ç»„æˆéƒ¨åˆ†ä¹‹ä¸€ã€‚Nginx çš„å†…å­˜æ± ä¸»è¦ç”¨äºé«˜æ•ˆç®¡ç†å†…å­˜ï¼Œé¿å…é¢‘ç¹çš„å†…å­˜åˆ†é…ä¸é‡Šæ”¾æ“ä½œï¼Œå‡å°‘å†…å­˜ç¢ç‰‡ï¼Œæå‡æ€§èƒ½ã€‚Nginx å†…å­˜æ± çš„å®ç°éµå¾ªâ€œé¢„åˆ†é…ä¸€å—å†…å­˜ï¼Œç„¶åè¿›è¡Œå°å—åˆ†é…â€çš„ç­–ç•¥ï¼Œç±»ä¼¼äºå¸¸è§çš„å†…å­˜æ± æ¨¡å‹ã€‚
Nginxåœ¨ ngx_palloc.h å’Œ ngx_palloc.c ä¸­å®ç°äº†å†…å­˜æ± ã€‚
2. å†…å­˜æ± çš„å®ç°åŸç† 2.1 Nginx å†…å­˜æ± çš„ç»“æ„ ngx_pool_s ç»“æ„ä½“æ˜¯å†…å­˜æ± çš„æ ¸å¿ƒç»“æ„ï¼Œå®ƒç®¡ç†å†…å­˜å—çš„é“¾è¡¨ã€å†…å­˜æ± çš„å¤§å°ä¿¡æ¯ã€ä»¥åŠæ¸…ç†å‡½æ•°ç­‰ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š
struct ngx_pool_s { ngx_pool_data_t d; // å†…å­˜å—çš„æ•°æ® size_t max; // å¯ä»è¯¥å†…å­˜æ± åˆ†é…çš„æœ€å¤§å†…å­˜å—å¤§å° ngx_pool_t *current; // å½“å‰æ´»è·ƒçš„å†…å­˜å— ngx_chain_t *chain; // ç¼“å­˜é“¾ ngx_pool_large_t *large; // å¤§å—å†…å­˜é“¾è¡¨ ngx_pool_cleanup_t *cleanup; // æ¸…ç†å‡½æ•°é“¾è¡¨ ngx_log_t *log; // æ—¥å¿—å¯¹è±¡ }; å…¶ä¸­ï¼Œngx_pool_data_t å®šä¹‰äº†æ¯ä¸ªå†…å­˜å—çš„å…ƒæ•°æ®ï¼š
typedef struct { u_char *last; // å½“å‰å†…å­˜å—ä¸­å·²ä½¿ç”¨çš„æœ€åä½ç½® u_char *end; // å½“å‰å†…å­˜å—çš„æœ«å°¾ä½ç½® ngx_pool_t *next; // ä¸‹ä¸€ä¸ªå†…å­˜å—çš„æŒ‡é’ˆ ngx_uint_t failed; // åˆ†é…å¤±è´¥æ¬¡æ•° } ngx_pool_data_t; 2.2 å†…å­˜æ± çš„åˆ›å»ºå’Œé”€æ¯ ngx_create_poolå‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªå†…å­˜æ± ï¼Œåˆ†é…ä¸€ä¸ªåˆå§‹å¤§å°ä¸º size çš„å†…å­˜å—ï¼Œå¹¶åˆå§‹åŒ–å†…å­˜æ± çš„å„ç§å‚æ•°ï¼š">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">

  <meta itemprop="name" content="Wei Haoyu">
  <meta itemprop="description" content="ç‚¹å‡»è¿”å›ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•
ç›®å½• {:toc} 1. ä»‹ç» Nginx å†…å­˜æ± çš„å®ç°æ˜¯å…¶é«˜æ€§èƒ½ã€é«˜å¹¶å‘å¤„ç†èƒ½åŠ›çš„é‡è¦ç»„æˆéƒ¨åˆ†ä¹‹ä¸€ã€‚Nginx çš„å†…å­˜æ± ä¸»è¦ç”¨äºé«˜æ•ˆç®¡ç†å†…å­˜ï¼Œé¿å…é¢‘ç¹çš„å†…å­˜åˆ†é…ä¸é‡Šæ”¾æ“ä½œï¼Œå‡å°‘å†…å­˜ç¢ç‰‡ï¼Œæå‡æ€§èƒ½ã€‚Nginx å†…å­˜æ± çš„å®ç°éµå¾ªâ€œé¢„åˆ†é…ä¸€å—å†…å­˜ï¼Œç„¶åè¿›è¡Œå°å—åˆ†é…â€çš„ç­–ç•¥ï¼Œç±»ä¼¼äºå¸¸è§çš„å†…å­˜æ± æ¨¡å‹ã€‚
Nginxåœ¨ ngx_palloc.h å’Œ ngx_palloc.c ä¸­å®ç°äº†å†…å­˜æ± ã€‚
2. å†…å­˜æ± çš„å®ç°åŸç† 2.1 Nginx å†…å­˜æ± çš„ç»“æ„ ngx_pool_s ç»“æ„ä½“æ˜¯å†…å­˜æ± çš„æ ¸å¿ƒç»“æ„ï¼Œå®ƒç®¡ç†å†…å­˜å—çš„é“¾è¡¨ã€å†…å­˜æ± çš„å¤§å°ä¿¡æ¯ã€ä»¥åŠæ¸…ç†å‡½æ•°ç­‰ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š
struct ngx_pool_s { ngx_pool_data_t d; // å†…å­˜å—çš„æ•°æ® size_t max; // å¯ä»è¯¥å†…å­˜æ± åˆ†é…çš„æœ€å¤§å†…å­˜å—å¤§å° ngx_pool_t *current; // å½“å‰æ´»è·ƒçš„å†…å­˜å— ngx_chain_t *chain; // ç¼“å­˜é“¾ ngx_pool_large_t *large; // å¤§å—å†…å­˜é“¾è¡¨ ngx_pool_cleanup_t *cleanup; // æ¸…ç†å‡½æ•°é“¾è¡¨ ngx_log_t *log; // æ—¥å¿—å¯¹è±¡ }; å…¶ä¸­ï¼Œngx_pool_data_t å®šä¹‰äº†æ¯ä¸ªå†…å­˜å—çš„å…ƒæ•°æ®ï¼š
typedef struct { u_char *last; // å½“å‰å†…å­˜å—ä¸­å·²ä½¿ç”¨çš„æœ€åä½ç½® u_char *end; // å½“å‰å†…å­˜å—çš„æœ«å°¾ä½ç½® ngx_pool_t *next; // ä¸‹ä¸€ä¸ªå†…å­˜å—çš„æŒ‡é’ˆ ngx_uint_t failed; // åˆ†é…å¤±è´¥æ¬¡æ•° } ngx_pool_data_t; 2.2 å†…å­˜æ± çš„åˆ›å»ºå’Œé”€æ¯ ngx_create_poolå‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªå†…å­˜æ± ï¼Œåˆ†é…ä¸€ä¸ªåˆå§‹å¤§å°ä¸º size çš„å†…å­˜å—ï¼Œå¹¶åˆå§‹åŒ–å†…å­˜æ± çš„å„ç§å‚æ•°ï¼š">
  <meta itemprop="wordCount" content="436">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Wei Haoyu">
  <meta name="twitter:description" content="ç‚¹å‡»è¿”å›ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•
ç›®å½• {:toc} 1. ä»‹ç» Nginx å†…å­˜æ± çš„å®ç°æ˜¯å…¶é«˜æ€§èƒ½ã€é«˜å¹¶å‘å¤„ç†èƒ½åŠ›çš„é‡è¦ç»„æˆéƒ¨åˆ†ä¹‹ä¸€ã€‚Nginx çš„å†…å­˜æ± ä¸»è¦ç”¨äºé«˜æ•ˆç®¡ç†å†…å­˜ï¼Œé¿å…é¢‘ç¹çš„å†…å­˜åˆ†é…ä¸é‡Šæ”¾æ“ä½œï¼Œå‡å°‘å†…å­˜ç¢ç‰‡ï¼Œæå‡æ€§èƒ½ã€‚Nginx å†…å­˜æ± çš„å®ç°éµå¾ªâ€œé¢„åˆ†é…ä¸€å—å†…å­˜ï¼Œç„¶åè¿›è¡Œå°å—åˆ†é…â€çš„ç­–ç•¥ï¼Œç±»ä¼¼äºå¸¸è§çš„å†…å­˜æ± æ¨¡å‹ã€‚
Nginxåœ¨ ngx_palloc.h å’Œ ngx_palloc.c ä¸­å®ç°äº†å†…å­˜æ± ã€‚
2. å†…å­˜æ± çš„å®ç°åŸç† 2.1 Nginx å†…å­˜æ± çš„ç»“æ„ ngx_pool_s ç»“æ„ä½“æ˜¯å†…å­˜æ± çš„æ ¸å¿ƒç»“æ„ï¼Œå®ƒç®¡ç†å†…å­˜å—çš„é“¾è¡¨ã€å†…å­˜æ± çš„å¤§å°ä¿¡æ¯ã€ä»¥åŠæ¸…ç†å‡½æ•°ç­‰ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š
struct ngx_pool_s { ngx_pool_data_t d; // å†…å­˜å—çš„æ•°æ® size_t max; // å¯ä»è¯¥å†…å­˜æ± åˆ†é…çš„æœ€å¤§å†…å­˜å—å¤§å° ngx_pool_t *current; // å½“å‰æ´»è·ƒçš„å†…å­˜å— ngx_chain_t *chain; // ç¼“å­˜é“¾ ngx_pool_large_t *large; // å¤§å—å†…å­˜é“¾è¡¨ ngx_pool_cleanup_t *cleanup; // æ¸…ç†å‡½æ•°é“¾è¡¨ ngx_log_t *log; // æ—¥å¿—å¯¹è±¡ }; å…¶ä¸­ï¼Œngx_pool_data_t å®šä¹‰äº†æ¯ä¸ªå†…å­˜å—çš„å…ƒæ•°æ®ï¼š
typedef struct { u_char *last; // å½“å‰å†…å­˜å—ä¸­å·²ä½¿ç”¨çš„æœ€åä½ç½® u_char *end; // å½“å‰å†…å­˜å—çš„æœ«å°¾ä½ç½® ngx_pool_t *next; // ä¸‹ä¸€ä¸ªå†…å­˜å—çš„æŒ‡é’ˆ ngx_uint_t failed; // åˆ†é…å¤±è´¥æ¬¡æ•° } ngx_pool_data_t; 2.2 å†…å­˜æ± çš„åˆ›å»ºå’Œé”€æ¯ ngx_create_poolå‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªå†…å­˜æ± ï¼Œåˆ†é…ä¸€ä¸ªåˆå§‹å¤§å°ä¸º size çš„å†…å­˜å—ï¼Œå¹¶åˆå§‹åŒ–å†…å­˜æ± çš„å„ç§å‚æ•°ï¼š">

	
  </head><body class="ma0 avenir bg-near-white development">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        Wei Haoyu
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1"></h1>
      
      
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>ç‚¹å‡»è¿”å›<a href="https://2549141519.github.io/#/toc">ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•</a></p>
<ul>
<li>ç›®å½•
{:toc}</li>
</ul>
<!-- raw HTML omitted -->
<h1 id="1-ä»‹ç»">1. ä»‹ç»</h1>
<p>Nginx å†…å­˜æ± çš„å®ç°æ˜¯å…¶é«˜æ€§èƒ½ã€é«˜å¹¶å‘å¤„ç†èƒ½åŠ›çš„é‡è¦ç»„æˆéƒ¨åˆ†ä¹‹ä¸€ã€‚Nginx çš„å†…å­˜æ± ä¸»è¦ç”¨äºé«˜æ•ˆç®¡ç†å†…å­˜ï¼Œé¿å…é¢‘ç¹çš„å†…å­˜åˆ†é…ä¸é‡Šæ”¾æ“ä½œï¼Œå‡å°‘å†…å­˜ç¢ç‰‡ï¼Œæå‡æ€§èƒ½ã€‚Nginx å†…å­˜æ± çš„å®ç°éµå¾ªâ€œé¢„åˆ†é…ä¸€å—å†…å­˜ï¼Œç„¶åè¿›è¡Œå°å—åˆ†é…â€çš„ç­–ç•¥ï¼Œç±»ä¼¼äºå¸¸è§çš„å†…å­˜æ± æ¨¡å‹ã€‚<br>
Nginxåœ¨ <a href="https://github.com/nginx/nginx/blob/master/src/core/ngx_palloc.h">ngx_palloc.h</a> å’Œ <a href="https://github.com/nginx/nginx/blob/master/src/core/ngx_palloc.c">ngx_palloc.c</a> ä¸­å®ç°äº†å†…å­˜æ± ã€‚</p>
<h1 id="2-å†…å­˜æ± çš„å®ç°åŸç†">2. å†…å­˜æ± çš„å®ç°åŸç†</h1>
<h2 id="21-nginx-å†…å­˜æ± çš„ç»“æ„">2.1 Nginx å†…å­˜æ± çš„ç»“æ„</h2>
<p><code>ngx_pool_s</code> ç»“æ„ä½“æ˜¯å†…å­˜æ± çš„æ ¸å¿ƒç»“æ„ï¼Œå®ƒç®¡ç†å†…å­˜å—çš„é“¾è¡¨ã€å†…å­˜æ± çš„å¤§å°ä¿¡æ¯ã€ä»¥åŠæ¸…ç†å‡½æ•°ç­‰ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>struct ngx_pool_s {
    ngx_pool_data_t       d;         // å†…å­˜å—çš„æ•°æ®
    size_t                max;       // å¯ä»è¯¥å†…å­˜æ± åˆ†é…çš„æœ€å¤§å†…å­˜å—å¤§å°
    ngx_pool_t           *current;   // å½“å‰æ´»è·ƒçš„å†…å­˜å—
    ngx_chain_t          *chain;     // ç¼“å­˜é“¾
    ngx_pool_large_t     *large;     // å¤§å—å†…å­˜é“¾è¡¨
    ngx_pool_cleanup_t   *cleanup;   // æ¸…ç†å‡½æ•°é“¾è¡¨
    ngx_log_t            *log;       // æ—¥å¿—å¯¹è±¡
};
</code></pre><p>å…¶ä¸­ï¼Œngx_pool_data_t å®šä¹‰äº†æ¯ä¸ªå†…å­˜å—çš„å…ƒæ•°æ®ï¼š</p>
<pre tabindex="0"><code>typedef struct {
    u_char      *last;    // å½“å‰å†…å­˜å—ä¸­å·²ä½¿ç”¨çš„æœ€åä½ç½®
    u_char      *end;     // å½“å‰å†…å­˜å—çš„æœ«å°¾ä½ç½®
    ngx_pool_t  *next;    // ä¸‹ä¸€ä¸ªå†…å­˜å—çš„æŒ‡é’ˆ
    ngx_uint_t   failed;  // åˆ†é…å¤±è´¥æ¬¡æ•°
} ngx_pool_data_t;
</code></pre><h2 id="22-å†…å­˜æ± çš„åˆ›å»ºå’Œé”€æ¯">2.2 å†…å­˜æ± çš„åˆ›å»ºå’Œé”€æ¯</h2>
<p><code>ngx_create_pool</code>å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªå†…å­˜æ± ï¼Œåˆ†é…ä¸€ä¸ªåˆå§‹å¤§å°ä¸º size çš„å†…å­˜å—ï¼Œå¹¶åˆå§‹åŒ–å†…å­˜æ± çš„å„ç§å‚æ•°ï¼š</p>
<pre tabindex="0"><code>ngx_pool_t *ngx_create_pool(size_t size, ngx_log_t *log) {
    ngx_pool_t *p;

    p = ngx_memalign(NGX_POOL_ALIGNMENT, size, log);  // å¯¹é½åˆ†é…å†…å­˜
    if (p == NULL) {
        return NULL;
    }

    p-&gt;d.last = (u_char *) p + sizeof(ngx_pool_t);  // åˆå§‹åŒ–lastæŒ‡é’ˆ
    p-&gt;d.end = (u_char *) p + size;  // æŒ‡å‘å†…å­˜å—çš„æœ«å°¾
    p-&gt;d.next = NULL;  
    p-&gt;d.failed = 0;

    size = size - sizeof(ngx_pool_t);
    p-&gt;max = (size &lt; NGX_MAX_ALLOC_FROM_POOL) ? size : NGX_MAX_ALLOC_FROM_POOL;  // ç¡®å®šåˆ†é…å—çš„æœ€å¤§å€¼

    p-&gt;current = p;
    p-&gt;chain = NULL;
    p-&gt;large = NULL;
    p-&gt;cleanup = NULL;
    p-&gt;log = log;

    return p;
}
</code></pre><p><code>ngx_destroy_pool</code>ç”¨äºé”€æ¯å†…å­˜æ± ï¼Œä¼šéå†å†…å­˜æ± ä¸­çš„æ‰€æœ‰å†…å­˜å—ã€æ¸…ç†å¤§å—å†…å­˜ã€å¹¶æ‰§è¡Œæ‰€æœ‰æ³¨å†Œçš„æ¸…ç†å‡½æ•°ï¼š</p>
<pre tabindex="0"><code>void ngx_destroy_pool(ngx_pool_t *pool) {
    ngx_pool_t *p, *n;
    ngx_pool_large_t *l;
    ngx_pool_cleanup_t *c;

    // è°ƒç”¨æ‰€æœ‰æ³¨å†Œçš„æ¸…ç†å‡½æ•°
    for (c = pool-&gt;cleanup; c; c = c-&gt;next) {
        if (c-&gt;handler) {
            c-&gt;handler(c-&gt;data);
        }
    }

    // é‡Šæ”¾å¤§å—å†…å­˜
    for (l = pool-&gt;large; l; l = l-&gt;next) {
        if (l-&gt;alloc) {
            ngx_free(l-&gt;alloc);
        }
    }

    // é‡Šæ”¾å†…å­˜æ± ä¸­çš„æ‰€æœ‰å†…å­˜å—
    for (p = pool, n = pool-&gt;d.next; /* void */; p = n, n = n-&gt;d.next) {
        ngx_free(p);
        if (n == NULL) {
            break;
        }
    }
}
</code></pre><h1 id="3-å†…å­˜æ± çš„åˆ†é…ç­–ç•¥">3. å†…å­˜æ± çš„åˆ†é…ç­–ç•¥</h1>
<p>Nginx å†…å­˜æ± æ ¹æ®åˆ†é…å†…å­˜çš„å¤§å°æ¥å†³å®šä»å“ªé‡Œåˆ†é…ï¼š<br>
å°å—å†…å­˜ï¼ˆå°äº <code>max</code>ï¼‰ï¼šä»å†…å­˜æ± çš„ç°æœ‰å—ä¸­åˆ†é…ã€‚<br>
å¤§å—å†…å­˜ï¼ˆå¤§äº <code>max</code>ï¼‰ï¼šç›´æ¥ä»ç³»ç»Ÿä¸­åˆ†é…å†…å­˜å¹¶æŒ‚è½½åˆ° <code>large</code> é“¾è¡¨ä¸­ã€‚</p>
<h2 id="31-å°å—å†…å­˜åˆ†é…">3.1 å°å—å†…å­˜åˆ†é…</h2>
<p>é€šè¿‡<code>ngx_palloc_small</code>å‡½æ•°å®Œæˆã€‚å½“è¦åˆ†é…çš„å†…å­˜å—å°äº<code>max</code>æ—¶ï¼Œå®ƒä¼šä»å½“å‰å†…å­˜å—ä¸­åˆ†é…ã€‚</p>
<pre tabindex="0"><code>static ngx_inline void *ngx_palloc_small(ngx_pool_t *pool, size_t size, ngx_uint_t align) {
    u_char *m;
    ngx_pool_t *p = pool-&gt;current;

    do {
        m = p-&gt;d.last;

        if (align) {
            m = ngx_align_ptr(m, NGX_ALIGNMENT);  // åœ°å€å¯¹é½
        }

        if ((size_t) (p-&gt;d.end - m) &gt;= size) {
            p-&gt;d.last = m + size;
            return m;
        }

        p = p-&gt;d.next;  // å°è¯•ä¸‹ä¸€ä¸ªå†…å­˜å—
    } while (p);

    return ngx_palloc_block(pool, size);  // è‹¥å½“å‰å†…å­˜å—ä¸è¶³ï¼Œåˆ™åˆ†é…æ–°å†…å­˜å—
}
</code></pre><p><code>d.last</code>ï¼šæ£€æŸ¥å½“å‰å†…å­˜å—æ˜¯å¦æœ‰è¶³å¤Ÿç©ºé—´å¯åˆ†é…ã€‚</p>
<h2 id="32-å¤§å—å†…å­˜åˆ†é…">3.2 å¤§å—å†…å­˜åˆ†é…</h2>
<p>å½“éœ€è¦åˆ†é…çš„å†…å­˜å—å¤§äº <code>max </code>æ—¶ï¼Œè°ƒç”¨ <code>ngx_palloc_large</code> å‡½æ•°ï¼Œå®ƒç›´æ¥è°ƒç”¨ç³»ç»Ÿçš„å†…å­˜åˆ†é…å‡½æ•°ï¼Œå¹¶å°†å¤§å—å†…å­˜æŒ‚è½½åˆ°<code> large</code> é“¾è¡¨ä¸­ç®¡ç†ã€‚</p>
<pre tabindex="0"><code>static void *ngx_palloc_large(ngx_pool_t *pool, size_t size) {
    void *p = ngx_alloc(size, pool-&gt;log);  // ç³»ç»Ÿå†…å­˜åˆ†é…
    if (p == NULL) {
        return NULL;
    }

    ngx_pool_large_t *large = ngx_palloc_small(pool, sizeof(ngx_pool_large_t), 1);
    if (large == NULL) {
        ngx_free(p);
        return NULL;
    }

    large-&gt;alloc = p;  // å°†å¤§å—å†…å­˜æŒ‚è½½åˆ° large é“¾è¡¨ä¸­
    large-&gt;next = pool-&gt;large;
    pool-&gt;large = large;

    return p;
}
</code></pre><h1 id="4-å†…å­˜æ± çš„æ¸…ç†æœºåˆ¶">4. å†…å­˜æ± çš„æ¸…ç†æœºåˆ¶</h1>
<p>Nginx å†…å­˜æ± æ”¯æŒæ³¨å†Œæ¸…ç†å‡½æ•°ï¼Œåœ¨é”€æ¯å†…å­˜æ± æ—¶è‡ªåŠ¨è°ƒç”¨è¿™äº›å‡½æ•°è¿›è¡Œèµ„æºæ¸…ç†ã€‚</p>
<p><code>ngx_pool_cleanup_add</code>å‡½æ•°ç”¨äºæ³¨å†Œæ¸…ç†å‡½æ•°ã€‚å®ƒä¼šåˆ›å»ºä¸€ä¸ª <code>ngx_pool_cleanup_t </code>ç»“æ„ï¼Œå¹¶å°†å…¶åŠ å…¥åˆ°å†…å­˜æ± çš„æ¸…ç†é“¾è¡¨ä¸­ï¼š</p>
<pre tabindex="0"><code>ngx_pool_cleanup_t *ngx_pool_cleanup_add(ngx_pool_t *p, size_t size) {
    ngx_pool_cleanup_t *c = ngx_palloc(p, sizeof(ngx_pool_cleanup_t));
    if (c == NULL) {
        return NULL;
    }

    if (size) {
        c-&gt;data = ngx_palloc(p, size);
        if (c-&gt;data == NULL) {
            return NULL;
        }
    } else {
        c-&gt;data = NULL;
    }

    c-&gt;handler = NULL;  // æ¸…ç†å‡½æ•°æŒ‡é’ˆ
    c-&gt;next = p-&gt;cleanup;
    p-&gt;cleanup = c;

    return c;
}
</code></pre><ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="http://localhost:1313/" >
    &copy;  Wei Haoyu 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
