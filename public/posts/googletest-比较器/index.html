<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Nameless Monster</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="ç‚¹å‡»è¿”å›ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•

ç›®å½•
{:toc}


1. æ¯”è¾ƒå™¨
æœ¬æ–‡ä»‹ç»å¯¹äºkdbä¸­æ¯”è¾ƒå™¨Comparatorçš„å•å…ƒæµ‹è¯•ã€‚
æ¯”è¾ƒå™¨å®ç°é€»è¾‘å¦‚ä¸‹ï¼š
è§£æé”®çš„é•¿åº¦ï¼š ä»£ç é¦–å…ˆä» left å’Œ right å­—ç¬¦ä¸²è§†å›¾ä¸­è¯»å–é”®çš„é•¿åº¦ï¼ˆå‰é¢ç¼–ç æˆ Varint çš„ 32 ä½æ•´æ•°ï¼‰ã€‚é€šè¿‡ GetVarint32Ptr å‡½æ•°ä»æ•°æ®ä¸­è§£æå‡ºé”®çš„é•¿åº¦ï¼Œå¹¶è¿›è¡Œæ–­è¨€æ£€æŸ¥ç¡®ä¿è§£ææˆåŠŸã€‚

æå–é”®å€¼ï¼š é€šè¿‡ä» left_key_len_ptr å’Œ right_key_len_ptr è§£æå‡ºçš„é•¿åº¦ï¼Œåˆ›å»ºä¸¤ä¸ªæ–°çš„ std::string_view åˆ†åˆ«è¡¨ç¤º left å’Œ right çš„é”®å€¼ã€‚

æ¯”è¾ƒé”®å€¼ï¼š å¦‚æœä¸¤ä¸ªé”®å€¼ä¸åŒï¼Œç›´æ¥æ¯”è¾ƒå®ƒä»¬çš„å­—ç¬¦ä¸²å€¼ã€‚std::string_view æ”¯æŒå­—å…¸åºæ¯”è¾ƒï¼Œä»£ç é€šè¿‡ operator&lt; å’Œ operator&gt; æ¥è¿›è¡Œæ¯”è¾ƒï¼Œç»“æœä¸º -1ï¼ˆleft å°äº rightï¼‰ã€1ï¼ˆleft å¤§äº rightï¼‰ã€‚

å¦‚æœé”®å€¼ç›¸ç­‰ï¼š å½“ä¸¤ä¸ªé”®å€¼ç›¸ç­‰æ—¶ï¼Œä»£ç è¿›ä¸€æ­¥è§£æå¹¶æ¯”è¾ƒåºåˆ—å·ã€‚ä½¿ç”¨ GetVarint64Ptr å‡½æ•°ä»é”®å€¼ä¹‹åçš„ä½ç½®æå–å‡º 64 ä½åºåˆ—å·ï¼Œå¹¶è¿›è¡Œæ¯”è¾ƒã€‚æœ€ç»ˆè¿”å›æ¯”è¾ƒç»“æœã€‚

ç»“æœè¿”å›ï¼š è¿”å› -1 è¡¨ç¤º left å°äº rightï¼Œ1 è¡¨ç¤º left å¤§äº rightï¼Œ0 è¡¨ç¤ºå®ƒä»¬å®Œå…¨ç›¸åŒã€‚
2. GoogleTestå®ç°
ä¸ºæµ‹è¯•æ¯”è¾ƒå™¨ï¼Œå®ç°äº†ComparatorTestã€‚
ä¸ºäº†æ¨¡æ‹Ÿå·¥ä½œåœºæ™¯ï¼Œåœ¨æµ‹è¯•ä¸­å®ç°äº†Setå‡½æ•°ï¼Œç”¨äºå°†æ•°æ®ç¼–ç ä¸ºsstableå†…éƒ¨é”®çš„æ ¼å¼ã€‚
std::string Set(const std::shared_ptr&lt;SetContext&gt;&amp; set_context) {
  auto key_size = VarintLength(set_context-&gt;key.size());
  auto value_size = VarintLength(set_context-&gt;value.size());
  auto sequence_number = VarintLength(set_context-&gt;value.size());

  std::string simple_set_str = fmt::format(
      &#34;{}{}{}{}{}{}&#34;, format32_vec[key_size], set_context-&gt;key,
      format64_vec[sequence_number], kEmpty1Space,
      format32_vec[value_size], set_context-&gt;value);

  char* start_ptr = simple_set_str.data();
  start_ptr = EncodeVarint32(start_ptr, set_context-&gt;key.size());

  start_ptr &#43;= set_context-&gt;key.size();
  start_ptr = EncodeVarint64(start_ptr, set_context-&gt;number);

  EncodeFixed8(start_ptr,ValueType::kTypeValue);

  start_ptr &#43;= 1;
  EncodeVarint32(start_ptr, set_context-&gt;value.size());

  return simple_set_str;
}
å®ç°äº†ä¸‰ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š">
    <meta name="generator" content="Hugo 0.145.0">
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >




    


    
      

    

    

    
      <link rel="canonical" href="http://localhost:1313/posts/googletest-%E6%AF%94%E8%BE%83%E5%99%A8/">
    

    <meta property="og:url" content="http://localhost:1313/posts/googletest-%E6%AF%94%E8%BE%83%E5%99%A8/">
  <meta property="og:site_name" content="Nameless Monster">
  <meta property="og:title" content="Nameless Monster">
  <meta property="og:description" content="ç‚¹å‡»è¿”å›ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•
ç›®å½• {:toc} 1. æ¯”è¾ƒå™¨ æœ¬æ–‡ä»‹ç»å¯¹äºkdbä¸­æ¯”è¾ƒå™¨Comparatorçš„å•å…ƒæµ‹è¯•ã€‚
æ¯”è¾ƒå™¨å®ç°é€»è¾‘å¦‚ä¸‹ï¼š
è§£æé”®çš„é•¿åº¦ï¼š ä»£ç é¦–å…ˆä» left å’Œ right å­—ç¬¦ä¸²è§†å›¾ä¸­è¯»å–é”®çš„é•¿åº¦ï¼ˆå‰é¢ç¼–ç æˆ Varint çš„ 32 ä½æ•´æ•°ï¼‰ã€‚é€šè¿‡ GetVarint32Ptr å‡½æ•°ä»æ•°æ®ä¸­è§£æå‡ºé”®çš„é•¿åº¦ï¼Œå¹¶è¿›è¡Œæ–­è¨€æ£€æŸ¥ç¡®ä¿è§£ææˆåŠŸã€‚ æå–é”®å€¼ï¼š é€šè¿‡ä» left_key_len_ptr å’Œ right_key_len_ptr è§£æå‡ºçš„é•¿åº¦ï¼Œåˆ›å»ºä¸¤ä¸ªæ–°çš„ std::string_view åˆ†åˆ«è¡¨ç¤º left å’Œ right çš„é”®å€¼ã€‚ æ¯”è¾ƒé”®å€¼ï¼š å¦‚æœä¸¤ä¸ªé”®å€¼ä¸åŒï¼Œç›´æ¥æ¯”è¾ƒå®ƒä»¬çš„å­—ç¬¦ä¸²å€¼ã€‚std::string_view æ”¯æŒå­—å…¸åºæ¯”è¾ƒï¼Œä»£ç é€šè¿‡ operator&lt; å’Œ operator&gt; æ¥è¿›è¡Œæ¯”è¾ƒï¼Œç»“æœä¸º -1ï¼ˆleft å°äº rightï¼‰ã€1ï¼ˆleft å¤§äº rightï¼‰ã€‚ å¦‚æœé”®å€¼ç›¸ç­‰ï¼š å½“ä¸¤ä¸ªé”®å€¼ç›¸ç­‰æ—¶ï¼Œä»£ç è¿›ä¸€æ­¥è§£æå¹¶æ¯”è¾ƒåºåˆ—å·ã€‚ä½¿ç”¨ GetVarint64Ptr å‡½æ•°ä»é”®å€¼ä¹‹åçš„ä½ç½®æå–å‡º 64 ä½åºåˆ—å·ï¼Œå¹¶è¿›è¡Œæ¯”è¾ƒã€‚æœ€ç»ˆè¿”å›æ¯”è¾ƒç»“æœã€‚ ç»“æœè¿”å›ï¼š è¿”å› -1 è¡¨ç¤º left å°äº rightï¼Œ1 è¡¨ç¤º left å¤§äº rightï¼Œ0 è¡¨ç¤ºå®ƒä»¬å®Œå…¨ç›¸åŒã€‚ 2. GoogleTestå®ç° ä¸ºæµ‹è¯•æ¯”è¾ƒå™¨ï¼Œå®ç°äº†ComparatorTestã€‚
ä¸ºäº†æ¨¡æ‹Ÿå·¥ä½œåœºæ™¯ï¼Œåœ¨æµ‹è¯•ä¸­å®ç°äº†Setå‡½æ•°ï¼Œç”¨äºå°†æ•°æ®ç¼–ç ä¸ºsstableå†…éƒ¨é”®çš„æ ¼å¼ã€‚
std::string Set(const std::shared_ptr&lt;SetContext&gt;&amp; set_context) { auto key_size = VarintLength(set_context-&gt;key.size()); auto value_size = VarintLength(set_context-&gt;value.size()); auto sequence_number = VarintLength(set_context-&gt;value.size()); std::string simple_set_str = fmt::format( &#34;{}{}{}{}{}{}&#34;, format32_vec[key_size], set_context-&gt;key, format64_vec[sequence_number], kEmpty1Space, format32_vec[value_size], set_context-&gt;value); char* start_ptr = simple_set_str.data(); start_ptr = EncodeVarint32(start_ptr, set_context-&gt;key.size()); start_ptr &#43;= set_context-&gt;key.size(); start_ptr = EncodeVarint64(start_ptr, set_context-&gt;number); EncodeFixed8(start_ptr,ValueType::kTypeValue); start_ptr &#43;= 1; EncodeVarint32(start_ptr, set_context-&gt;value.size()); return simple_set_str; } å®ç°äº†ä¸‰ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">

  <meta itemprop="name" content="Nameless Monster">
  <meta itemprop="description" content="ç‚¹å‡»è¿”å›ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•
ç›®å½• {:toc} 1. æ¯”è¾ƒå™¨ æœ¬æ–‡ä»‹ç»å¯¹äºkdbä¸­æ¯”è¾ƒå™¨Comparatorçš„å•å…ƒæµ‹è¯•ã€‚
æ¯”è¾ƒå™¨å®ç°é€»è¾‘å¦‚ä¸‹ï¼š
è§£æé”®çš„é•¿åº¦ï¼š ä»£ç é¦–å…ˆä» left å’Œ right å­—ç¬¦ä¸²è§†å›¾ä¸­è¯»å–é”®çš„é•¿åº¦ï¼ˆå‰é¢ç¼–ç æˆ Varint çš„ 32 ä½æ•´æ•°ï¼‰ã€‚é€šè¿‡ GetVarint32Ptr å‡½æ•°ä»æ•°æ®ä¸­è§£æå‡ºé”®çš„é•¿åº¦ï¼Œå¹¶è¿›è¡Œæ–­è¨€æ£€æŸ¥ç¡®ä¿è§£ææˆåŠŸã€‚ æå–é”®å€¼ï¼š é€šè¿‡ä» left_key_len_ptr å’Œ right_key_len_ptr è§£æå‡ºçš„é•¿åº¦ï¼Œåˆ›å»ºä¸¤ä¸ªæ–°çš„ std::string_view åˆ†åˆ«è¡¨ç¤º left å’Œ right çš„é”®å€¼ã€‚ æ¯”è¾ƒé”®å€¼ï¼š å¦‚æœä¸¤ä¸ªé”®å€¼ä¸åŒï¼Œç›´æ¥æ¯”è¾ƒå®ƒä»¬çš„å­—ç¬¦ä¸²å€¼ã€‚std::string_view æ”¯æŒå­—å…¸åºæ¯”è¾ƒï¼Œä»£ç é€šè¿‡ operator&lt; å’Œ operator&gt; æ¥è¿›è¡Œæ¯”è¾ƒï¼Œç»“æœä¸º -1ï¼ˆleft å°äº rightï¼‰ã€1ï¼ˆleft å¤§äº rightï¼‰ã€‚ å¦‚æœé”®å€¼ç›¸ç­‰ï¼š å½“ä¸¤ä¸ªé”®å€¼ç›¸ç­‰æ—¶ï¼Œä»£ç è¿›ä¸€æ­¥è§£æå¹¶æ¯”è¾ƒåºåˆ—å·ã€‚ä½¿ç”¨ GetVarint64Ptr å‡½æ•°ä»é”®å€¼ä¹‹åçš„ä½ç½®æå–å‡º 64 ä½åºåˆ—å·ï¼Œå¹¶è¿›è¡Œæ¯”è¾ƒã€‚æœ€ç»ˆè¿”å›æ¯”è¾ƒç»“æœã€‚ ç»“æœè¿”å›ï¼š è¿”å› -1 è¡¨ç¤º left å°äº rightï¼Œ1 è¡¨ç¤º left å¤§äº rightï¼Œ0 è¡¨ç¤ºå®ƒä»¬å®Œå…¨ç›¸åŒã€‚ 2. GoogleTestå®ç° ä¸ºæµ‹è¯•æ¯”è¾ƒå™¨ï¼Œå®ç°äº†ComparatorTestã€‚
ä¸ºäº†æ¨¡æ‹Ÿå·¥ä½œåœºæ™¯ï¼Œåœ¨æµ‹è¯•ä¸­å®ç°äº†Setå‡½æ•°ï¼Œç”¨äºå°†æ•°æ®ç¼–ç ä¸ºsstableå†…éƒ¨é”®çš„æ ¼å¼ã€‚
std::string Set(const std::shared_ptr&lt;SetContext&gt;&amp; set_context) { auto key_size = VarintLength(set_context-&gt;key.size()); auto value_size = VarintLength(set_context-&gt;value.size()); auto sequence_number = VarintLength(set_context-&gt;value.size()); std::string simple_set_str = fmt::format( &#34;{}{}{}{}{}{}&#34;, format32_vec[key_size], set_context-&gt;key, format64_vec[sequence_number], kEmpty1Space, format32_vec[value_size], set_context-&gt;value); char* start_ptr = simple_set_str.data(); start_ptr = EncodeVarint32(start_ptr, set_context-&gt;key.size()); start_ptr &#43;= set_context-&gt;key.size(); start_ptr = EncodeVarint64(start_ptr, set_context-&gt;number); EncodeFixed8(start_ptr,ValueType::kTypeValue); start_ptr &#43;= 1; EncodeVarint32(start_ptr, set_context-&gt;value.size()); return simple_set_str; } å®ç°äº†ä¸‰ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š">
  <meta itemprop="wordCount" content="222">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Nameless Monster">
  <meta name="twitter:description" content="ç‚¹å‡»è¿”å›ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•
ç›®å½• {:toc} 1. æ¯”è¾ƒå™¨ æœ¬æ–‡ä»‹ç»å¯¹äºkdbä¸­æ¯”è¾ƒå™¨Comparatorçš„å•å…ƒæµ‹è¯•ã€‚
æ¯”è¾ƒå™¨å®ç°é€»è¾‘å¦‚ä¸‹ï¼š
è§£æé”®çš„é•¿åº¦ï¼š ä»£ç é¦–å…ˆä» left å’Œ right å­—ç¬¦ä¸²è§†å›¾ä¸­è¯»å–é”®çš„é•¿åº¦ï¼ˆå‰é¢ç¼–ç æˆ Varint çš„ 32 ä½æ•´æ•°ï¼‰ã€‚é€šè¿‡ GetVarint32Ptr å‡½æ•°ä»æ•°æ®ä¸­è§£æå‡ºé”®çš„é•¿åº¦ï¼Œå¹¶è¿›è¡Œæ–­è¨€æ£€æŸ¥ç¡®ä¿è§£ææˆåŠŸã€‚ æå–é”®å€¼ï¼š é€šè¿‡ä» left_key_len_ptr å’Œ right_key_len_ptr è§£æå‡ºçš„é•¿åº¦ï¼Œåˆ›å»ºä¸¤ä¸ªæ–°çš„ std::string_view åˆ†åˆ«è¡¨ç¤º left å’Œ right çš„é”®å€¼ã€‚ æ¯”è¾ƒé”®å€¼ï¼š å¦‚æœä¸¤ä¸ªé”®å€¼ä¸åŒï¼Œç›´æ¥æ¯”è¾ƒå®ƒä»¬çš„å­—ç¬¦ä¸²å€¼ã€‚std::string_view æ”¯æŒå­—å…¸åºæ¯”è¾ƒï¼Œä»£ç é€šè¿‡ operator&lt; å’Œ operator&gt; æ¥è¿›è¡Œæ¯”è¾ƒï¼Œç»“æœä¸º -1ï¼ˆleft å°äº rightï¼‰ã€1ï¼ˆleft å¤§äº rightï¼‰ã€‚ å¦‚æœé”®å€¼ç›¸ç­‰ï¼š å½“ä¸¤ä¸ªé”®å€¼ç›¸ç­‰æ—¶ï¼Œä»£ç è¿›ä¸€æ­¥è§£æå¹¶æ¯”è¾ƒåºåˆ—å·ã€‚ä½¿ç”¨ GetVarint64Ptr å‡½æ•°ä»é”®å€¼ä¹‹åçš„ä½ç½®æå–å‡º 64 ä½åºåˆ—å·ï¼Œå¹¶è¿›è¡Œæ¯”è¾ƒã€‚æœ€ç»ˆè¿”å›æ¯”è¾ƒç»“æœã€‚ ç»“æœè¿”å›ï¼š è¿”å› -1 è¡¨ç¤º left å°äº rightï¼Œ1 è¡¨ç¤º left å¤§äº rightï¼Œ0 è¡¨ç¤ºå®ƒä»¬å®Œå…¨ç›¸åŒã€‚ 2. GoogleTestå®ç° ä¸ºæµ‹è¯•æ¯”è¾ƒå™¨ï¼Œå®ç°äº†ComparatorTestã€‚
ä¸ºäº†æ¨¡æ‹Ÿå·¥ä½œåœºæ™¯ï¼Œåœ¨æµ‹è¯•ä¸­å®ç°äº†Setå‡½æ•°ï¼Œç”¨äºå°†æ•°æ®ç¼–ç ä¸ºsstableå†…éƒ¨é”®çš„æ ¼å¼ã€‚
std::string Set(const std::shared_ptr&lt;SetContext&gt;&amp; set_context) { auto key_size = VarintLength(set_context-&gt;key.size()); auto value_size = VarintLength(set_context-&gt;value.size()); auto sequence_number = VarintLength(set_context-&gt;value.size()); std::string simple_set_str = fmt::format( &#34;{}{}{}{}{}{}&#34;, format32_vec[key_size], set_context-&gt;key, format64_vec[sequence_number], kEmpty1Space, format32_vec[value_size], set_context-&gt;value); char* start_ptr = simple_set_str.data(); start_ptr = EncodeVarint32(start_ptr, set_context-&gt;key.size()); start_ptr &#43;= set_context-&gt;key.size(); start_ptr = EncodeVarint64(start_ptr, set_context-&gt;number); EncodeFixed8(start_ptr,ValueType::kTypeValue); start_ptr &#43;= 1; EncodeVarint32(start_ptr, set_context-&gt;value.size()); return simple_set_str; } å®ç°äº†ä¸‰ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š">

	
  </head><body class="ma0 avenir bg-near-white development">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        Nameless Monster
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1"></h1>
      
      
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>ç‚¹å‡»è¿”å›<a href="https://2549141519.github.io/#/toc">ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•</a></p>
<ul>
<li>ç›®å½•
{:toc}</li>
</ul>
<!-- raw HTML omitted -->
<h1 id="1-æ¯”è¾ƒå™¨">1. æ¯”è¾ƒå™¨</h1>
<p>æœ¬æ–‡ä»‹ç»å¯¹äºkdbä¸­æ¯”è¾ƒå™¨<a href="https://github.com/2549141519/kdb/src/db/comp.cpp"><code>Comparator</code></a>çš„å•å…ƒæµ‹è¯•ã€‚</p>
<p>æ¯”è¾ƒå™¨å®ç°é€»è¾‘å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>è§£æé”®çš„é•¿åº¦ï¼š ä»£ç é¦–å…ˆä» left å’Œ right å­—ç¬¦ä¸²è§†å›¾ä¸­è¯»å–é”®çš„é•¿åº¦ï¼ˆå‰é¢ç¼–ç æˆ Varint çš„ 32 ä½æ•´æ•°ï¼‰ã€‚é€šè¿‡ GetVarint32Ptr å‡½æ•°ä»æ•°æ®ä¸­è§£æå‡ºé”®çš„é•¿åº¦ï¼Œå¹¶è¿›è¡Œæ–­è¨€æ£€æŸ¥ç¡®ä¿è§£ææˆåŠŸã€‚

æå–é”®å€¼ï¼š é€šè¿‡ä» left_key_len_ptr å’Œ right_key_len_ptr è§£æå‡ºçš„é•¿åº¦ï¼Œåˆ›å»ºä¸¤ä¸ªæ–°çš„ std::string_view åˆ†åˆ«è¡¨ç¤º left å’Œ right çš„é”®å€¼ã€‚

æ¯”è¾ƒé”®å€¼ï¼š å¦‚æœä¸¤ä¸ªé”®å€¼ä¸åŒï¼Œç›´æ¥æ¯”è¾ƒå®ƒä»¬çš„å­—ç¬¦ä¸²å€¼ã€‚std::string_view æ”¯æŒå­—å…¸åºæ¯”è¾ƒï¼Œä»£ç é€šè¿‡ operator&lt; å’Œ operator&gt; æ¥è¿›è¡Œæ¯”è¾ƒï¼Œç»“æœä¸º -1ï¼ˆleft å°äº rightï¼‰ã€1ï¼ˆleft å¤§äº rightï¼‰ã€‚

å¦‚æœé”®å€¼ç›¸ç­‰ï¼š å½“ä¸¤ä¸ªé”®å€¼ç›¸ç­‰æ—¶ï¼Œä»£ç è¿›ä¸€æ­¥è§£æå¹¶æ¯”è¾ƒåºåˆ—å·ã€‚ä½¿ç”¨ GetVarint64Ptr å‡½æ•°ä»é”®å€¼ä¹‹åçš„ä½ç½®æå–å‡º 64 ä½åºåˆ—å·ï¼Œå¹¶è¿›è¡Œæ¯”è¾ƒã€‚æœ€ç»ˆè¿”å›æ¯”è¾ƒç»“æœã€‚

ç»“æœè¿”å›ï¼š è¿”å› -1 è¡¨ç¤º left å°äº rightï¼Œ1 è¡¨ç¤º left å¤§äº rightï¼Œ0 è¡¨ç¤ºå®ƒä»¬å®Œå…¨ç›¸åŒã€‚
</code></pre><h1 id="2-googletestå®ç°">2. GoogleTestå®ç°</h1>
<p>ä¸ºæµ‹è¯•æ¯”è¾ƒå™¨ï¼Œå®ç°äº†<a href="https://github.com/2549141519/kdb/src/db/test/comptest.cpp"><code>ComparatorTest</code></a>ã€‚</p>
<p>ä¸ºäº†æ¨¡æ‹Ÿå·¥ä½œåœºæ™¯ï¼Œåœ¨æµ‹è¯•ä¸­å®ç°äº†Setå‡½æ•°ï¼Œç”¨äºå°†æ•°æ®ç¼–ç ä¸ºsstableå†…éƒ¨é”®çš„æ ¼å¼ã€‚</p>
<pre tabindex="0"><code>std::string Set(const std::shared_ptr&lt;SetContext&gt;&amp; set_context) {
  auto key_size = VarintLength(set_context-&gt;key.size());
  auto value_size = VarintLength(set_context-&gt;value.size());
  auto sequence_number = VarintLength(set_context-&gt;value.size());

  std::string simple_set_str = fmt::format(
      &#34;{}{}{}{}{}{}&#34;, format32_vec[key_size], set_context-&gt;key,
      format64_vec[sequence_number], kEmpty1Space,
      format32_vec[value_size], set_context-&gt;value);

  char* start_ptr = simple_set_str.data();
  start_ptr = EncodeVarint32(start_ptr, set_context-&gt;key.size());

  start_ptr += set_context-&gt;key.size();
  start_ptr = EncodeVarint64(start_ptr, set_context-&gt;number);

  EncodeFixed8(start_ptr,ValueType::kTypeValue);

  start_ptr += 1;
  EncodeVarint32(start_ptr, set_context-&gt;value.size());

  return simple_set_str;
}
</code></pre><p>å®ç°äº†ä¸‰ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š</p>
<ol>
<li>æµ‹è¯•ä¸¤ä¸ªç›¸åŒçš„é”®å€¼ï¼š</li>
</ol>
<pre tabindex="0"><code>TEST_F(ComparatorTest, CompareEqualStringView) {
    SetContext context1(std::string_view(&#34;key1&#34;), std::string_view(&#34;key&#34;));
    context1.number = 1;
    SetContext context2(std::string_view(&#34;key2&#34;), std::string_view(&#34;key&#34;));
    context2.number = 2;

    std::string_view testcontext1 = Set(std::make_shared&lt;SetContext&gt;(context1));
    std::string_view testcontext2 = Set(std::make_shared&lt;SetContext&gt;(context2));

    EXPECT_EQ(-1,cmp(testcontext1, testcontext2));  // session1 &lt; session2ï¼Œ
    EXPECT_EQ(1,cmp(testcontext2, testcontext1)); // session2 &gt; session1ï¼Œ
}
</code></pre><p>åœ¨é”®å€¼ç›¸åŒæ—¶ï¼Œæ¯”è¾ƒåºåˆ—å·å¤§å°ã€‚</p>
<ol start="2">
<li>æµ‹è¯•ä¸¤ä¸ªä¸åŒçš„é”®å€¼ï¼š</li>
</ol>
<pre tabindex="0"><code>TEST_F(ComparatorTest, CompareDifferentStringView) {
    SetContext context1(std::string_view(&#34;key1&#34;), std::string_view(&#34;key1&#34;));
    SetContext context2(std::string_view(&#34;key2&#34;), std::string_view(&#34;key2&#34;));
    
    std::string_view testcontext1 = Set(std::make_shared&lt;SetContext&gt;(context1));
    std::string_view testcontext2 = Set(std::make_shared&lt;SetContext&gt;(context2));

    EXPECT_EQ(-1,cmp(testcontext1, testcontext2)); 
    EXPECT_EQ(1,cmp(testcontext2, testcontext1)); 
}
</code></pre><ol start="3">
<li>æµ‹è¯•ç©ºçš„é”®å€¼ï¼š</li>
</ol>
<pre tabindex="0"><code>TEST_F(ComparatorTest, CompareEmptyStringView) {
    SetContext context1(std::string_view(&#34;key1&#34;), std::string_view(&#34;&#34;));
    SetContext context2(std::string_view(&#34;key2&#34;), std::string_view(&#34;key&#34;));

    std::string_view testcontext1 = Set(std::make_shared&lt;SetContext&gt;(context1));
    std::string_view testcontext2 = Set(std::make_shared&lt;SetContext&gt;(context2));

    EXPECT_EQ(-1,cmp(testcontext1, testcontext2)); 
    EXPECT_EQ(1,cmp(testcontext2, testcontext1)); 
}
</code></pre><p>æµ‹è¯•å‘½ä»¤ï¼š<br>
<code>g++ -std=c++17 -I /usr/local/include -I /path/to/fmt/include -L /usr/local/lib comptest.cpp ../comp.cpp ../../utils/coding.cpp -o comptest -lgtest -lgtest_main -pthread -lfmt</code><br>
æ‰§è¡Œå‘½ä»¤åç”Ÿæˆcomptestæ–‡ä»¶ï¼Œæ‰§è¡Œ./comptestå³å¯ã€‚</p>
<p>æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š<br>
<img src="../blogImg/gtest1.PNG" alt="Alt text"></p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="http://localhost:1313/" >
    &copy;  Nameless Monster 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
