<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Wei Haoyu</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="ç‚¹å‡»è¿”å›ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•

ç›®å½•
{:toc}


1. Buffer Poolï¼ˆç¼“å†²æ± ï¼‰ä»‹ç»
Buffer Pool æ˜¯æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¸­ç”¨äºç®¡ç†å’Œä¼˜åŒ–å†…å­˜ä½¿ç”¨çš„ä¸€ä¸ªå…³é”®ç»„ä»¶ã€‚å…¶ä¸»è¦ä½œç”¨æ˜¯å°†ç£ç›˜ä¸Šçš„æ•°æ®é¡µç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œä»¥å‡å°‘å¯¹ç£ç›˜çš„è®¿é—®æ¬¡æ•°ï¼Œä»è€Œæé«˜æ•°æ®åº“çš„æ€§èƒ½ã€‚å¤§å¤šæ•°ç°ä»£æ•°æ®åº“ï¼ˆå¦‚ MySQLã€PostgreSQLã€OceanBase ç­‰ï¼‰éƒ½ä½¿ç”¨äº† Buffer Pool æ¥åŠ é€Ÿè¯»å†™æ“ä½œã€‚
1.1 Buffer Pool çš„æ ¸å¿ƒç»„ä»¶
Page (é¡µ)ï¼š
æ•°æ®åº“ä»¥é¡µï¼ˆpageï¼‰ä¸ºå•ä½ç®¡ç†æ•°æ®ã€‚é¡µæ˜¯æ•°æ®åº“ä¸­æ•°æ®çš„æœ€å°ç®¡ç†å•ä½ï¼Œé€šå¸¸å¤§å°ä¸º4KBã€8KBæˆ–16KBï¼ˆå…·ä½“å–å†³äºæ•°æ®åº“çš„é…ç½®ï¼‰ã€‚
Buffer Pool ä¸­çš„æ¯ä¸€ä¸ªç¼“å­˜å—éƒ½ä¼šç¼“å­˜ä¸€ä¸ªç£ç›˜ä¸Šçš„æ•°æ®é¡µï¼Œå½“å®¢æˆ·ç«¯è¯·æ±‚æŸä¸ªæ•°æ®æ—¶ï¼Œæ•°æ®åº“é¦–å…ˆä¼šæ£€æŸ¥è¯¥æ•°æ®é¡µæ˜¯å¦å·²ç»åœ¨ Buffer Pool ä¸­ï¼Œå¦‚æœåœ¨ï¼Œå°±å¯ä»¥ç›´æ¥ä»å†…å­˜è¯»å–æ•°æ®ï¼›å¦‚æœä¸åœ¨ï¼Œåˆ™éœ€è¦ä»ç£ç›˜åŠ è½½è¯¥é¡µåˆ° Buffer Pool ä¸­ã€‚
Buffer Frame (ç¼“å­˜å¸§)ï¼š
Buffer Pool ç”±å¤šä¸ª Buffer Frame ç»„æˆï¼Œæ¯ä¸ª Frame éƒ½å¯ä»¥å­˜å‚¨ä¸€ä¸ªæ•°æ®åº“é¡µã€‚å½“æ•°æ®åº“éœ€è¦è®¿é—®æŸä¸ªæ•°æ®é¡µæ—¶ï¼Œå¦‚æœè¯¥é¡µå·²ç»åœ¨æŸä¸ª Frame ä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ª Frame å°±ä¼šè¢«ç›´æ¥è¿”å›ã€‚å¦åˆ™ï¼Œå°†åˆ†é…ä¸€ä¸ªç©ºçš„æˆ–å¯é‡ç”¨çš„ Frame ç”¨æ¥å­˜å‚¨ä»ç£ç›˜è¯»å–çš„é¡µã€‚
Page Table (é¡µè¡¨)ï¼š
Buffer Pool ç»´æŠ¤ä¸€ä¸ªé¡µè¡¨ï¼ˆPage Tableï¼‰ï¼Œç”¨äºè®°å½•æ¯ä¸ªæ•°æ®é¡µåœ¨ Buffer Pool ä¸­çš„ä½ç½®ã€‚é€šè¿‡é¡µè¡¨ï¼Œæ•°æ®åº“å¯ä»¥å¿«é€Ÿæ‰¾åˆ°æŸä¸ªæ•°æ®é¡µæ˜¯å¦å·²ç»è¢«ç¼“å­˜ï¼Œä»¥åŠå®ƒä½äº Buffer Pool ä¸­çš„å“ªä¸ªç¼“å­˜å¸§ã€‚
Replacement Policy (æ›¿æ¢ç­–ç•¥)ï¼š
ç”±äºå†…å­˜æœ‰é™ï¼ŒBuffer Pool æ— æ³•æ— é™åˆ¶åœ°ç¼“å­˜æ‰€æœ‰æ•°æ®ã€‚å½“ Buffer Pool å·²æ»¡æ—¶ï¼Œæ•°æ®åº“éœ€è¦æ ¹æ®æŸç§æ›¿æ¢ç­–ç•¥å°†æŸäº›é¡µä» Buffer Pool ä¸­ç§»é™¤ï¼Œä»¥ä¾¿ä¸ºæ–°åŠ è½½çš„é¡µè…¾å‡ºç©ºé—´ã€‚å¸¸è§çš„æ›¿æ¢ç­–ç•¥åŒ…æ‹¬ï¼š
LRU (Least Recently Used)ï¼šæœ€ä¹…æœªä½¿ç”¨çš„é¡µä¼šè¢«ä¼˜å…ˆæ›¿æ¢ã€‚
MRU (Most Recently Used)ï¼šæœ€è¿‘ä½¿ç”¨çš„é¡µä¼šè¢«ä¼˜å…ˆæ›¿æ¢ã€‚
LFU (Least Frequently Used)ï¼šæœ€å°‘è¢«è®¿é—®çš„é¡µä¼šè¢«ä¼˜å…ˆæ›¿æ¢ã€‚
Dirty Page (è„é¡µ)ï¼š
å½“æŸä¸ªé¡µçš„æ•°æ®è¢«ä¿®æ”¹æ—¶ï¼Œè¯¥é¡µç§°ä¸ºè„é¡µã€‚è„é¡µè¡¨ç¤º Buffer Pool ä¸­çš„æ•°æ®å·²ç»ä¸ç£ç›˜ä¸Šçš„æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦åœ¨åˆé€‚çš„æ—¶å€™å°†è„é¡µå†™å›ç£ç›˜ä»¥ä¿è¯æ•°æ®çš„æŒä¹…æ€§ã€‚
æ•°æ®åº“ç³»ç»Ÿä¼šé€šè¿‡åå°çº¿ç¨‹å®šæœŸåœ°å°†è„é¡µåˆ·å›åˆ°ç£ç›˜ï¼Œæˆ–è€…åœ¨æŸäº›æ¡ä»¶ä¸‹å¼ºåˆ¶åˆ·æ–°ã€‚">
    <meta name="generator" content="Hugo 0.145.0">
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >




    


    
      

    

    

    
      <link rel="canonical" href="http://localhost:1313/posts/miniob-bufferpool/">
    

    <meta property="og:url" content="http://localhost:1313/posts/miniob-bufferpool/">
  <meta property="og:site_name" content="Wei Haoyu">
  <meta property="og:title" content="Wei Haoyu">
  <meta property="og:description" content="ç‚¹å‡»è¿”å›ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•
ç›®å½• {:toc} 1. Buffer Poolï¼ˆç¼“å†²æ± ï¼‰ä»‹ç» Buffer Pool æ˜¯æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¸­ç”¨äºç®¡ç†å’Œä¼˜åŒ–å†…å­˜ä½¿ç”¨çš„ä¸€ä¸ªå…³é”®ç»„ä»¶ã€‚å…¶ä¸»è¦ä½œç”¨æ˜¯å°†ç£ç›˜ä¸Šçš„æ•°æ®é¡µç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œä»¥å‡å°‘å¯¹ç£ç›˜çš„è®¿é—®æ¬¡æ•°ï¼Œä»è€Œæé«˜æ•°æ®åº“çš„æ€§èƒ½ã€‚å¤§å¤šæ•°ç°ä»£æ•°æ®åº“ï¼ˆå¦‚ MySQLã€PostgreSQLã€OceanBase ç­‰ï¼‰éƒ½ä½¿ç”¨äº† Buffer Pool æ¥åŠ é€Ÿè¯»å†™æ“ä½œã€‚
1.1 Buffer Pool çš„æ ¸å¿ƒç»„ä»¶ Page (é¡µ)ï¼š æ•°æ®åº“ä»¥é¡µï¼ˆpageï¼‰ä¸ºå•ä½ç®¡ç†æ•°æ®ã€‚é¡µæ˜¯æ•°æ®åº“ä¸­æ•°æ®çš„æœ€å°ç®¡ç†å•ä½ï¼Œé€šå¸¸å¤§å°ä¸º4KBã€8KBæˆ–16KBï¼ˆå…·ä½“å–å†³äºæ•°æ®åº“çš„é…ç½®ï¼‰ã€‚
Buffer Pool ä¸­çš„æ¯ä¸€ä¸ªç¼“å­˜å—éƒ½ä¼šç¼“å­˜ä¸€ä¸ªç£ç›˜ä¸Šçš„æ•°æ®é¡µï¼Œå½“å®¢æˆ·ç«¯è¯·æ±‚æŸä¸ªæ•°æ®æ—¶ï¼Œæ•°æ®åº“é¦–å…ˆä¼šæ£€æŸ¥è¯¥æ•°æ®é¡µæ˜¯å¦å·²ç»åœ¨ Buffer Pool ä¸­ï¼Œå¦‚æœåœ¨ï¼Œå°±å¯ä»¥ç›´æ¥ä»å†…å­˜è¯»å–æ•°æ®ï¼›å¦‚æœä¸åœ¨ï¼Œåˆ™éœ€è¦ä»ç£ç›˜åŠ è½½è¯¥é¡µåˆ° Buffer Pool ä¸­ã€‚
Buffer Frame (ç¼“å­˜å¸§)ï¼š
Buffer Pool ç”±å¤šä¸ª Buffer Frame ç»„æˆï¼Œæ¯ä¸ª Frame éƒ½å¯ä»¥å­˜å‚¨ä¸€ä¸ªæ•°æ®åº“é¡µã€‚å½“æ•°æ®åº“éœ€è¦è®¿é—®æŸä¸ªæ•°æ®é¡µæ—¶ï¼Œå¦‚æœè¯¥é¡µå·²ç»åœ¨æŸä¸ª Frame ä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ª Frame å°±ä¼šè¢«ç›´æ¥è¿”å›ã€‚å¦åˆ™ï¼Œå°†åˆ†é…ä¸€ä¸ªç©ºçš„æˆ–å¯é‡ç”¨çš„ Frame ç”¨æ¥å­˜å‚¨ä»ç£ç›˜è¯»å–çš„é¡µã€‚
Page Table (é¡µè¡¨)ï¼š
Buffer Pool ç»´æŠ¤ä¸€ä¸ªé¡µè¡¨ï¼ˆPage Tableï¼‰ï¼Œç”¨äºè®°å½•æ¯ä¸ªæ•°æ®é¡µåœ¨ Buffer Pool ä¸­çš„ä½ç½®ã€‚é€šè¿‡é¡µè¡¨ï¼Œæ•°æ®åº“å¯ä»¥å¿«é€Ÿæ‰¾åˆ°æŸä¸ªæ•°æ®é¡µæ˜¯å¦å·²ç»è¢«ç¼“å­˜ï¼Œä»¥åŠå®ƒä½äº Buffer Pool ä¸­çš„å“ªä¸ªç¼“å­˜å¸§ã€‚
Replacement Policy (æ›¿æ¢ç­–ç•¥)ï¼š
ç”±äºå†…å­˜æœ‰é™ï¼ŒBuffer Pool æ— æ³•æ— é™åˆ¶åœ°ç¼“å­˜æ‰€æœ‰æ•°æ®ã€‚å½“ Buffer Pool å·²æ»¡æ—¶ï¼Œæ•°æ®åº“éœ€è¦æ ¹æ®æŸç§æ›¿æ¢ç­–ç•¥å°†æŸäº›é¡µä» Buffer Pool ä¸­ç§»é™¤ï¼Œä»¥ä¾¿ä¸ºæ–°åŠ è½½çš„é¡µè…¾å‡ºç©ºé—´ã€‚å¸¸è§çš„æ›¿æ¢ç­–ç•¥åŒ…æ‹¬ï¼š
LRU (Least Recently Used)ï¼šæœ€ä¹…æœªä½¿ç”¨çš„é¡µä¼šè¢«ä¼˜å…ˆæ›¿æ¢ã€‚
MRU (Most Recently Used)ï¼šæœ€è¿‘ä½¿ç”¨çš„é¡µä¼šè¢«ä¼˜å…ˆæ›¿æ¢ã€‚
LFU (Least Frequently Used)ï¼šæœ€å°‘è¢«è®¿é—®çš„é¡µä¼šè¢«ä¼˜å…ˆæ›¿æ¢ã€‚
Dirty Page (è„é¡µ)ï¼š
å½“æŸä¸ªé¡µçš„æ•°æ®è¢«ä¿®æ”¹æ—¶ï¼Œè¯¥é¡µç§°ä¸ºè„é¡µã€‚è„é¡µè¡¨ç¤º Buffer Pool ä¸­çš„æ•°æ®å·²ç»ä¸ç£ç›˜ä¸Šçš„æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦åœ¨åˆé€‚çš„æ—¶å€™å°†è„é¡µå†™å›ç£ç›˜ä»¥ä¿è¯æ•°æ®çš„æŒä¹…æ€§ã€‚
æ•°æ®åº“ç³»ç»Ÿä¼šé€šè¿‡åå°çº¿ç¨‹å®šæœŸåœ°å°†è„é¡µåˆ·å›åˆ°ç£ç›˜ï¼Œæˆ–è€…åœ¨æŸäº›æ¡ä»¶ä¸‹å¼ºåˆ¶åˆ·æ–°ã€‚">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">

  <meta itemprop="name" content="Wei Haoyu">
  <meta itemprop="description" content="ç‚¹å‡»è¿”å›ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•
ç›®å½• {:toc} 1. Buffer Poolï¼ˆç¼“å†²æ± ï¼‰ä»‹ç» Buffer Pool æ˜¯æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¸­ç”¨äºç®¡ç†å’Œä¼˜åŒ–å†…å­˜ä½¿ç”¨çš„ä¸€ä¸ªå…³é”®ç»„ä»¶ã€‚å…¶ä¸»è¦ä½œç”¨æ˜¯å°†ç£ç›˜ä¸Šçš„æ•°æ®é¡µç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œä»¥å‡å°‘å¯¹ç£ç›˜çš„è®¿é—®æ¬¡æ•°ï¼Œä»è€Œæé«˜æ•°æ®åº“çš„æ€§èƒ½ã€‚å¤§å¤šæ•°ç°ä»£æ•°æ®åº“ï¼ˆå¦‚ MySQLã€PostgreSQLã€OceanBase ç­‰ï¼‰éƒ½ä½¿ç”¨äº† Buffer Pool æ¥åŠ é€Ÿè¯»å†™æ“ä½œã€‚
1.1 Buffer Pool çš„æ ¸å¿ƒç»„ä»¶ Page (é¡µ)ï¼š æ•°æ®åº“ä»¥é¡µï¼ˆpageï¼‰ä¸ºå•ä½ç®¡ç†æ•°æ®ã€‚é¡µæ˜¯æ•°æ®åº“ä¸­æ•°æ®çš„æœ€å°ç®¡ç†å•ä½ï¼Œé€šå¸¸å¤§å°ä¸º4KBã€8KBæˆ–16KBï¼ˆå…·ä½“å–å†³äºæ•°æ®åº“çš„é…ç½®ï¼‰ã€‚
Buffer Pool ä¸­çš„æ¯ä¸€ä¸ªç¼“å­˜å—éƒ½ä¼šç¼“å­˜ä¸€ä¸ªç£ç›˜ä¸Šçš„æ•°æ®é¡µï¼Œå½“å®¢æˆ·ç«¯è¯·æ±‚æŸä¸ªæ•°æ®æ—¶ï¼Œæ•°æ®åº“é¦–å…ˆä¼šæ£€æŸ¥è¯¥æ•°æ®é¡µæ˜¯å¦å·²ç»åœ¨ Buffer Pool ä¸­ï¼Œå¦‚æœåœ¨ï¼Œå°±å¯ä»¥ç›´æ¥ä»å†…å­˜è¯»å–æ•°æ®ï¼›å¦‚æœä¸åœ¨ï¼Œåˆ™éœ€è¦ä»ç£ç›˜åŠ è½½è¯¥é¡µåˆ° Buffer Pool ä¸­ã€‚
Buffer Frame (ç¼“å­˜å¸§)ï¼š
Buffer Pool ç”±å¤šä¸ª Buffer Frame ç»„æˆï¼Œæ¯ä¸ª Frame éƒ½å¯ä»¥å­˜å‚¨ä¸€ä¸ªæ•°æ®åº“é¡µã€‚å½“æ•°æ®åº“éœ€è¦è®¿é—®æŸä¸ªæ•°æ®é¡µæ—¶ï¼Œå¦‚æœè¯¥é¡µå·²ç»åœ¨æŸä¸ª Frame ä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ª Frame å°±ä¼šè¢«ç›´æ¥è¿”å›ã€‚å¦åˆ™ï¼Œå°†åˆ†é…ä¸€ä¸ªç©ºçš„æˆ–å¯é‡ç”¨çš„ Frame ç”¨æ¥å­˜å‚¨ä»ç£ç›˜è¯»å–çš„é¡µã€‚
Page Table (é¡µè¡¨)ï¼š
Buffer Pool ç»´æŠ¤ä¸€ä¸ªé¡µè¡¨ï¼ˆPage Tableï¼‰ï¼Œç”¨äºè®°å½•æ¯ä¸ªæ•°æ®é¡µåœ¨ Buffer Pool ä¸­çš„ä½ç½®ã€‚é€šè¿‡é¡µè¡¨ï¼Œæ•°æ®åº“å¯ä»¥å¿«é€Ÿæ‰¾åˆ°æŸä¸ªæ•°æ®é¡µæ˜¯å¦å·²ç»è¢«ç¼“å­˜ï¼Œä»¥åŠå®ƒä½äº Buffer Pool ä¸­çš„å“ªä¸ªç¼“å­˜å¸§ã€‚
Replacement Policy (æ›¿æ¢ç­–ç•¥)ï¼š
ç”±äºå†…å­˜æœ‰é™ï¼ŒBuffer Pool æ— æ³•æ— é™åˆ¶åœ°ç¼“å­˜æ‰€æœ‰æ•°æ®ã€‚å½“ Buffer Pool å·²æ»¡æ—¶ï¼Œæ•°æ®åº“éœ€è¦æ ¹æ®æŸç§æ›¿æ¢ç­–ç•¥å°†æŸäº›é¡µä» Buffer Pool ä¸­ç§»é™¤ï¼Œä»¥ä¾¿ä¸ºæ–°åŠ è½½çš„é¡µè…¾å‡ºç©ºé—´ã€‚å¸¸è§çš„æ›¿æ¢ç­–ç•¥åŒ…æ‹¬ï¼š
LRU (Least Recently Used)ï¼šæœ€ä¹…æœªä½¿ç”¨çš„é¡µä¼šè¢«ä¼˜å…ˆæ›¿æ¢ã€‚
MRU (Most Recently Used)ï¼šæœ€è¿‘ä½¿ç”¨çš„é¡µä¼šè¢«ä¼˜å…ˆæ›¿æ¢ã€‚
LFU (Least Frequently Used)ï¼šæœ€å°‘è¢«è®¿é—®çš„é¡µä¼šè¢«ä¼˜å…ˆæ›¿æ¢ã€‚
Dirty Page (è„é¡µ)ï¼š
å½“æŸä¸ªé¡µçš„æ•°æ®è¢«ä¿®æ”¹æ—¶ï¼Œè¯¥é¡µç§°ä¸ºè„é¡µã€‚è„é¡µè¡¨ç¤º Buffer Pool ä¸­çš„æ•°æ®å·²ç»ä¸ç£ç›˜ä¸Šçš„æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦åœ¨åˆé€‚çš„æ—¶å€™å°†è„é¡µå†™å›ç£ç›˜ä»¥ä¿è¯æ•°æ®çš„æŒä¹…æ€§ã€‚
æ•°æ®åº“ç³»ç»Ÿä¼šé€šè¿‡åå°çº¿ç¨‹å®šæœŸåœ°å°†è„é¡µåˆ·å›åˆ°ç£ç›˜ï¼Œæˆ–è€…åœ¨æŸäº›æ¡ä»¶ä¸‹å¼ºåˆ¶åˆ·æ–°ã€‚">
  <meta itemprop="wordCount" content="1444">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Wei Haoyu">
  <meta name="twitter:description" content="ç‚¹å‡»è¿”å›ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•
ç›®å½• {:toc} 1. Buffer Poolï¼ˆç¼“å†²æ± ï¼‰ä»‹ç» Buffer Pool æ˜¯æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¸­ç”¨äºç®¡ç†å’Œä¼˜åŒ–å†…å­˜ä½¿ç”¨çš„ä¸€ä¸ªå…³é”®ç»„ä»¶ã€‚å…¶ä¸»è¦ä½œç”¨æ˜¯å°†ç£ç›˜ä¸Šçš„æ•°æ®é¡µç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œä»¥å‡å°‘å¯¹ç£ç›˜çš„è®¿é—®æ¬¡æ•°ï¼Œä»è€Œæé«˜æ•°æ®åº“çš„æ€§èƒ½ã€‚å¤§å¤šæ•°ç°ä»£æ•°æ®åº“ï¼ˆå¦‚ MySQLã€PostgreSQLã€OceanBase ç­‰ï¼‰éƒ½ä½¿ç”¨äº† Buffer Pool æ¥åŠ é€Ÿè¯»å†™æ“ä½œã€‚
1.1 Buffer Pool çš„æ ¸å¿ƒç»„ä»¶ Page (é¡µ)ï¼š æ•°æ®åº“ä»¥é¡µï¼ˆpageï¼‰ä¸ºå•ä½ç®¡ç†æ•°æ®ã€‚é¡µæ˜¯æ•°æ®åº“ä¸­æ•°æ®çš„æœ€å°ç®¡ç†å•ä½ï¼Œé€šå¸¸å¤§å°ä¸º4KBã€8KBæˆ–16KBï¼ˆå…·ä½“å–å†³äºæ•°æ®åº“çš„é…ç½®ï¼‰ã€‚
Buffer Pool ä¸­çš„æ¯ä¸€ä¸ªç¼“å­˜å—éƒ½ä¼šç¼“å­˜ä¸€ä¸ªç£ç›˜ä¸Šçš„æ•°æ®é¡µï¼Œå½“å®¢æˆ·ç«¯è¯·æ±‚æŸä¸ªæ•°æ®æ—¶ï¼Œæ•°æ®åº“é¦–å…ˆä¼šæ£€æŸ¥è¯¥æ•°æ®é¡µæ˜¯å¦å·²ç»åœ¨ Buffer Pool ä¸­ï¼Œå¦‚æœåœ¨ï¼Œå°±å¯ä»¥ç›´æ¥ä»å†…å­˜è¯»å–æ•°æ®ï¼›å¦‚æœä¸åœ¨ï¼Œåˆ™éœ€è¦ä»ç£ç›˜åŠ è½½è¯¥é¡µåˆ° Buffer Pool ä¸­ã€‚
Buffer Frame (ç¼“å­˜å¸§)ï¼š
Buffer Pool ç”±å¤šä¸ª Buffer Frame ç»„æˆï¼Œæ¯ä¸ª Frame éƒ½å¯ä»¥å­˜å‚¨ä¸€ä¸ªæ•°æ®åº“é¡µã€‚å½“æ•°æ®åº“éœ€è¦è®¿é—®æŸä¸ªæ•°æ®é¡µæ—¶ï¼Œå¦‚æœè¯¥é¡µå·²ç»åœ¨æŸä¸ª Frame ä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ª Frame å°±ä¼šè¢«ç›´æ¥è¿”å›ã€‚å¦åˆ™ï¼Œå°†åˆ†é…ä¸€ä¸ªç©ºçš„æˆ–å¯é‡ç”¨çš„ Frame ç”¨æ¥å­˜å‚¨ä»ç£ç›˜è¯»å–çš„é¡µã€‚
Page Table (é¡µè¡¨)ï¼š
Buffer Pool ç»´æŠ¤ä¸€ä¸ªé¡µè¡¨ï¼ˆPage Tableï¼‰ï¼Œç”¨äºè®°å½•æ¯ä¸ªæ•°æ®é¡µåœ¨ Buffer Pool ä¸­çš„ä½ç½®ã€‚é€šè¿‡é¡µè¡¨ï¼Œæ•°æ®åº“å¯ä»¥å¿«é€Ÿæ‰¾åˆ°æŸä¸ªæ•°æ®é¡µæ˜¯å¦å·²ç»è¢«ç¼“å­˜ï¼Œä»¥åŠå®ƒä½äº Buffer Pool ä¸­çš„å“ªä¸ªç¼“å­˜å¸§ã€‚
Replacement Policy (æ›¿æ¢ç­–ç•¥)ï¼š
ç”±äºå†…å­˜æœ‰é™ï¼ŒBuffer Pool æ— æ³•æ— é™åˆ¶åœ°ç¼“å­˜æ‰€æœ‰æ•°æ®ã€‚å½“ Buffer Pool å·²æ»¡æ—¶ï¼Œæ•°æ®åº“éœ€è¦æ ¹æ®æŸç§æ›¿æ¢ç­–ç•¥å°†æŸäº›é¡µä» Buffer Pool ä¸­ç§»é™¤ï¼Œä»¥ä¾¿ä¸ºæ–°åŠ è½½çš„é¡µè…¾å‡ºç©ºé—´ã€‚å¸¸è§çš„æ›¿æ¢ç­–ç•¥åŒ…æ‹¬ï¼š
LRU (Least Recently Used)ï¼šæœ€ä¹…æœªä½¿ç”¨çš„é¡µä¼šè¢«ä¼˜å…ˆæ›¿æ¢ã€‚
MRU (Most Recently Used)ï¼šæœ€è¿‘ä½¿ç”¨çš„é¡µä¼šè¢«ä¼˜å…ˆæ›¿æ¢ã€‚
LFU (Least Frequently Used)ï¼šæœ€å°‘è¢«è®¿é—®çš„é¡µä¼šè¢«ä¼˜å…ˆæ›¿æ¢ã€‚
Dirty Page (è„é¡µ)ï¼š
å½“æŸä¸ªé¡µçš„æ•°æ®è¢«ä¿®æ”¹æ—¶ï¼Œè¯¥é¡µç§°ä¸ºè„é¡µã€‚è„é¡µè¡¨ç¤º Buffer Pool ä¸­çš„æ•°æ®å·²ç»ä¸ç£ç›˜ä¸Šçš„æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦åœ¨åˆé€‚çš„æ—¶å€™å°†è„é¡µå†™å›ç£ç›˜ä»¥ä¿è¯æ•°æ®çš„æŒä¹…æ€§ã€‚
æ•°æ®åº“ç³»ç»Ÿä¼šé€šè¿‡åå°çº¿ç¨‹å®šæœŸåœ°å°†è„é¡µåˆ·å›åˆ°ç£ç›˜ï¼Œæˆ–è€…åœ¨æŸäº›æ¡ä»¶ä¸‹å¼ºåˆ¶åˆ·æ–°ã€‚">

	
  </head><body class="ma0 avenir bg-near-white development">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        Wei Haoyu
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1"></h1>
      
      
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>ç‚¹å‡»è¿”å›<a href="https://2549141519.github.io/#/toc">ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•</a></p>
<ul>
<li>ç›®å½•
{:toc}</li>
</ul>
<!-- raw HTML omitted -->
<h1 id="1-buffer-poolç¼“å†²æ± ä»‹ç»">1. Buffer Poolï¼ˆç¼“å†²æ± ï¼‰ä»‹ç»</h1>
<p>Buffer Pool æ˜¯æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¸­ç”¨äºç®¡ç†å’Œä¼˜åŒ–å†…å­˜ä½¿ç”¨çš„ä¸€ä¸ªå…³é”®ç»„ä»¶ã€‚å…¶ä¸»è¦ä½œç”¨æ˜¯å°†ç£ç›˜ä¸Šçš„æ•°æ®é¡µç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œä»¥å‡å°‘å¯¹ç£ç›˜çš„è®¿é—®æ¬¡æ•°ï¼Œä»è€Œæé«˜æ•°æ®åº“çš„æ€§èƒ½ã€‚å¤§å¤šæ•°ç°ä»£æ•°æ®åº“ï¼ˆå¦‚ MySQLã€PostgreSQLã€OceanBase ç­‰ï¼‰éƒ½ä½¿ç”¨äº† Buffer Pool æ¥åŠ é€Ÿè¯»å†™æ“ä½œã€‚</p>
<h2 id="11-buffer-pool-çš„æ ¸å¿ƒç»„ä»¶">1.1 Buffer Pool çš„æ ¸å¿ƒç»„ä»¶</h2>
<p>Page (é¡µ)ï¼š
æ•°æ®åº“ä»¥é¡µï¼ˆpageï¼‰ä¸ºå•ä½ç®¡ç†æ•°æ®ã€‚é¡µæ˜¯æ•°æ®åº“ä¸­æ•°æ®çš„æœ€å°ç®¡ç†å•ä½ï¼Œé€šå¸¸å¤§å°ä¸º4KBã€8KBæˆ–16KBï¼ˆå…·ä½“å–å†³äºæ•°æ®åº“çš„é…ç½®ï¼‰ã€‚<br>
Buffer Pool ä¸­çš„æ¯ä¸€ä¸ªç¼“å­˜å—éƒ½ä¼šç¼“å­˜ä¸€ä¸ªç£ç›˜ä¸Šçš„æ•°æ®é¡µï¼Œå½“å®¢æˆ·ç«¯è¯·æ±‚æŸä¸ªæ•°æ®æ—¶ï¼Œæ•°æ®åº“é¦–å…ˆä¼šæ£€æŸ¥è¯¥æ•°æ®é¡µæ˜¯å¦å·²ç»åœ¨ Buffer Pool ä¸­ï¼Œå¦‚æœåœ¨ï¼Œå°±å¯ä»¥ç›´æ¥ä»å†…å­˜è¯»å–æ•°æ®ï¼›å¦‚æœä¸åœ¨ï¼Œåˆ™éœ€è¦ä»ç£ç›˜åŠ è½½è¯¥é¡µåˆ° Buffer Pool ä¸­ã€‚<br>
Buffer Frame (ç¼“å­˜å¸§)ï¼š<br>
Buffer Pool ç”±å¤šä¸ª Buffer Frame ç»„æˆï¼Œæ¯ä¸ª Frame éƒ½å¯ä»¥å­˜å‚¨ä¸€ä¸ªæ•°æ®åº“é¡µã€‚å½“æ•°æ®åº“éœ€è¦è®¿é—®æŸä¸ªæ•°æ®é¡µæ—¶ï¼Œå¦‚æœè¯¥é¡µå·²ç»åœ¨æŸä¸ª Frame ä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ª Frame å°±ä¼šè¢«ç›´æ¥è¿”å›ã€‚å¦åˆ™ï¼Œå°†åˆ†é…ä¸€ä¸ªç©ºçš„æˆ–å¯é‡ç”¨çš„ Frame ç”¨æ¥å­˜å‚¨ä»ç£ç›˜è¯»å–çš„é¡µã€‚<br>
Page Table (é¡µè¡¨)ï¼š<br>
Buffer Pool ç»´æŠ¤ä¸€ä¸ªé¡µè¡¨ï¼ˆPage Tableï¼‰ï¼Œç”¨äºè®°å½•æ¯ä¸ªæ•°æ®é¡µåœ¨ Buffer Pool ä¸­çš„ä½ç½®ã€‚é€šè¿‡é¡µè¡¨ï¼Œæ•°æ®åº“å¯ä»¥å¿«é€Ÿæ‰¾åˆ°æŸä¸ªæ•°æ®é¡µæ˜¯å¦å·²ç»è¢«ç¼“å­˜ï¼Œä»¥åŠå®ƒä½äº Buffer Pool ä¸­çš„å“ªä¸ªç¼“å­˜å¸§ã€‚<br>
Replacement Policy (æ›¿æ¢ç­–ç•¥)ï¼š<br>
ç”±äºå†…å­˜æœ‰é™ï¼ŒBuffer Pool æ— æ³•æ— é™åˆ¶åœ°ç¼“å­˜æ‰€æœ‰æ•°æ®ã€‚å½“ Buffer Pool å·²æ»¡æ—¶ï¼Œæ•°æ®åº“éœ€è¦æ ¹æ®æŸç§æ›¿æ¢ç­–ç•¥å°†æŸäº›é¡µä» Buffer Pool ä¸­ç§»é™¤ï¼Œä»¥ä¾¿ä¸ºæ–°åŠ è½½çš„é¡µè…¾å‡ºç©ºé—´ã€‚å¸¸è§çš„æ›¿æ¢ç­–ç•¥åŒ…æ‹¬ï¼š<br>
<strong>LRU (Least Recently Used)ï¼šæœ€ä¹…æœªä½¿ç”¨çš„é¡µä¼šè¢«ä¼˜å…ˆæ›¿æ¢ã€‚</strong><br>
<strong>MRU (Most Recently Used)ï¼šæœ€è¿‘ä½¿ç”¨çš„é¡µä¼šè¢«ä¼˜å…ˆæ›¿æ¢ã€‚</strong><br>
<strong>LFU (Least Frequently Used)ï¼šæœ€å°‘è¢«è®¿é—®çš„é¡µä¼šè¢«ä¼˜å…ˆæ›¿æ¢ã€‚</strong><br>
Dirty Page (è„é¡µ)ï¼š<br>
å½“æŸä¸ªé¡µçš„æ•°æ®è¢«ä¿®æ”¹æ—¶ï¼Œè¯¥é¡µç§°ä¸ºè„é¡µã€‚è„é¡µè¡¨ç¤º Buffer Pool ä¸­çš„æ•°æ®å·²ç»ä¸ç£ç›˜ä¸Šçš„æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦åœ¨åˆé€‚çš„æ—¶å€™å°†è„é¡µå†™å›ç£ç›˜ä»¥ä¿è¯æ•°æ®çš„æŒä¹…æ€§ã€‚<br>
æ•°æ®åº“ç³»ç»Ÿä¼šé€šè¿‡åå°çº¿ç¨‹å®šæœŸåœ°å°†è„é¡µåˆ·å›åˆ°ç£ç›˜ï¼Œæˆ–è€…åœ¨æŸäº›æ¡ä»¶ä¸‹å¼ºåˆ¶åˆ·æ–°ã€‚</p>
<h2 id="12-buffer-pool-çš„å·¥ä½œåŸç†">1.2 Buffer Pool çš„å·¥ä½œåŸç†</h2>
<p>è¯»å–æ•°æ®ï¼š<br>
å½“æ•°æ®åº“æ¥æ”¶åˆ°ä¸€ä¸ªæŸ¥è¯¢è¯·æ±‚æ—¶ï¼Œå®ƒé¦–å…ˆæ£€æŸ¥æ‰€éœ€çš„é¡µæ˜¯å¦åœ¨ Buffer Pool ä¸­ã€‚<br>
å¦‚æœè¯¥é¡µå·²ç»åœ¨ Buffer Pool ä¸­ï¼Œç§°ä¸º &ldquo;å‘½ä¸­&rdquo;ï¼ˆhitï¼‰ï¼Œç³»ç»Ÿå¯ä»¥ç›´æ¥ä»å†…å­˜ä¸­è¯»å–æ•°æ®ã€‚<br>
å¦‚æœè¯¥é¡µä¸åœ¨ Buffer Pool ä¸­ï¼Œç§°ä¸º &ldquo;æœªå‘½ä¸­&rdquo;ï¼ˆmissï¼‰ï¼Œæ•°æ®åº“ç³»ç»Ÿéœ€è¦ä»ç£ç›˜åŠ è½½è¯¥é¡µåˆ° Buffer Pool ä¸­ï¼Œå¹¶å°†å…¶å­˜æ”¾åœ¨æŸä¸ªå¯ç”¨çš„ç¼“å­˜å¸§ä¸­ã€‚</p>
<p>å†™å…¥æ•°æ®ï¼š<br>
å†™å…¥æ“ä½œä¼šé¦–å…ˆä¿®æ”¹ Buffer Pool ä¸­ç›¸åº”é¡µçš„å†…å®¹ï¼ŒåŒæ—¶å°†è¯¥é¡µæ ‡è®°ä¸º &ldquo;è„é¡µ&rdquo;ã€‚<br>
æ•°æ®åº“ä¸ä¼šç«‹åˆ»å°†è„é¡µå†™å›ç£ç›˜ï¼Œè€Œæ˜¯ä¼šå°†å†™å…¥è¯·æ±‚ç¼“å­˜ï¼Œç­‰åˆ°åˆé€‚çš„æ—¶æœºå†æ‰¹é‡åœ°å°†è„é¡µåˆ·å›ç£ç›˜ï¼Œä»¥æé«˜å†™å…¥æ•ˆç‡ã€‚</p>
<p>é¡µæ›¿æ¢ï¼š<br>
å½“ Buffer Pool å·²ç»æ»¡æ—¶ï¼Œå¦‚æœæœ‰æ–°çš„é¡µéœ€è¦åŠ è½½åˆ° Buffer Pool ä¸­ï¼Œæ•°æ®åº“ä¼šæ ¹æ®æ›¿æ¢ç­–ç•¥é€‰æ‹©ä¸€ä¸ªç°æœ‰çš„é¡µè¿›è¡Œæ›¿æ¢ã€‚<br>
å¦‚æœè¢«æ›¿æ¢çš„é¡µæ˜¯è„é¡µï¼Œåˆ™éœ€è¦åœ¨æ›¿æ¢ä¹‹å‰å°†å…¶å†™å›åˆ°ç£ç›˜ã€‚</p>
<h1 id="2-buffer-poolåœ¨miniobä¸­çš„å®ç°">2. Buffer Poolåœ¨miniobä¸­çš„å®ç°</h1>
<p>disk_buffer_pool.h å’Œ disk_buffer_pool.cpp:<br>
æ–‡ä»¶å®šä¹‰äº† <a href="#21-%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0"><code>DiskBufferPool</code></a> ç±»ï¼Œå®ƒæ˜¯ MiniOB ä¸­ç¼“å†²æ± çš„æ ¸å¿ƒå®ç°ã€‚<code>DiskBufferPool</code> è´Ÿè´£å°†æ•°æ®é¡µä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ï¼Œå¹¶ç®¡ç†è¿™äº›é¡µçš„å†…å­˜ç¼“å­˜ã€‚
è¯¥ç±»æä¾›äº†é¡µé¢çš„åˆ†é… (<a href="#212-diskbufferpoolallocate_pageframe-frame"><code>allocate_page</code></a>)ã€è¯»å– (<a href="#211-diskbufferpoolget_this_pagepagenum-page_num-frame-frame"><code>get_this_page</code></a>)ã€é‡Šæ”¾ (<a href="#214-rc-diskbufferpooldispose_pagepagenum-page_num"><code>dispose_page</code></a>) ä»¥åŠå°†å†…å­˜ä¸­çš„é¡µé¢æ•°æ®åˆ·æ–°å›ç£ç›˜ (<a href="#213-diskbufferpoolflush_pageframe-frame"><code>flush_page</code></a>) ç­‰åŠŸèƒ½ã€‚</p>
<p>frame.h å’Œ frame.cpp:<br>
æ–‡ä»¶å®šä¹‰äº† <a href="#22-%E7%BC%93%E5%AD%98%E9%A1%B5%E6%A1%86%E6%9E%B6"><code>Frame</code></a> ç±»ï¼Œè¡¨ç¤ºç¼“å†²æ± ä¸­çš„æ¯ä¸€ä¸ªç¼“å­˜é¡µæ¡†æ¶ã€‚<code>Frame</code> åŒ…å«é¡µæ¡†çš„å…ƒæ•°æ®ä¿¡æ¯ï¼ˆå¦‚ <code>buffer_pool_id</code>, <code>page_num</code> ç­‰ï¼‰ï¼Œå¹¶é€šè¿‡ <code>pin</code> å’Œ <code>unpin </code>æ–¹æ³•ç®¡ç†é¡µé¢çš„å¼•ç”¨è®¡æ•°ã€‚<br>
<code>Frame </code>ç±»è¿˜ç»´æŠ¤æ¯ä¸ªé¡µé¢çš„è„é¡µæ ‡è®°ï¼ˆ<code>dirty_</code>ï¼‰ï¼Œä»¥åŠ <code>pin_count_</code> ç”¨äºé˜²æ­¢æ­£åœ¨ä½¿ç”¨çš„é¡µé¢è¢«æ›¿æ¢ã€‚è¯¥ç±»è¿˜è´Ÿè´£é¡µé¢çš„åŠ é”ä¸è§£é”æ“ä½œã€‚</p>
<p>double_write_buffer.h å’Œ double_write_buffer.cpp:<br>
æ–‡ä»¶å®ç°äº†åŒå†™ç¼“å†²åŒºæœºåˆ¶ (DoubleWriteBuffer)ï¼Œç”¨äºåœ¨å†™å…¥ç£ç›˜ä¹‹å‰å°†é¡µé¢æ•°æ®å†™å…¥åˆ°ä¸€ä¸ªä¸´æ—¶çš„ç¼“å†²åŒºã€‚è¿™æ˜¯ä¸€ç§é˜²æ­¢éƒ¨åˆ†å†™å…¥ï¼ˆpartial writeï¼‰é—®é¢˜çš„æœºåˆ¶ï¼Œç¡®ä¿åœ¨é¡µé¢å†™å…¥å¤±è´¥æ—¶ä»ç„¶èƒ½å¤Ÿæ¢å¤æ•°æ®ã€‚</p>
<p><a href="#215-bpframemanager"><code>BPFrameManager </code></a>ç±»:<br>
è¯¥ç±»ç®¡ç†æ‰€æœ‰çš„ç¼“å†²é¡µæ¡†æ¶ï¼ˆ<code>Frame</code>ï¼‰ã€‚å½“ç³»ç»Ÿéœ€è¦åˆ†é…æ–°çš„é¡µé¢æˆ–é‡Šæ”¾å·²æœ‰é¡µé¢æ—¶ï¼Œå®ƒè´Ÿè´£åœ¨ç¼“å­˜æ± ä¸­æŸ¥æ‰¾æˆ–åˆ†é…ç©ºé—²çš„é¡µé¢æ¡†æ¶ï¼Œå¹¶ç¡®ä¿å†…å­˜ä½¿ç”¨çš„æœ‰æ•ˆæ€§ã€‚<br>
å®ƒè¿˜å®ç°äº†æ·˜æ±°ç­–ç•¥ï¼ˆ<a href="#23-%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5"><code>purge_frames</code></a> æ–¹æ³•ï¼‰ï¼Œä»¥ä¾¿åœ¨å†…å­˜ä¸è¶³æ—¶é‡Šæ”¾ä¸å¸¸ç”¨çš„é¡µé¢ã€‚</p>
<h2 id="21-æ ¸å¿ƒå®ç°">2.1 æ ¸å¿ƒå®ç°</h2>
<p><code>DiskBufferPool</code>:</p>
<pre tabindex="0"><code>class DiskBufferPool final
{
public:
  DiskBufferPool(BufferPoolManager &amp;bp_manager, BPFrameManager &amp;frame_manager, DoubleWriteBuffer &amp;dblwr_manager,
      LogHandler &amp;log_handler);
  ~DiskBufferPool();

  /**
   * æ ¹æ®æ–‡ä»¶åæ‰“å¼€ä¸€ä¸ªåˆ†é¡µæ–‡ä»¶
   */
  RC open_file(const char *file_name);

  /**
   * å…³é—­åˆ†é¡µæ–‡ä»¶
   */
  RC close_file();

  /**
   * æ ¹æ®æ–‡ä»¶IDå’Œé¡µå·è·å–æŒ‡å®šé¡µé¢åˆ°ç¼“å†²åŒºï¼Œè¿”å›é¡µé¢å¥æŸ„æŒ‡é’ˆã€‚
   */
  RC get_this_page(PageNum page_num, Frame **frame);

  /**
   * @brief åœ¨æŒ‡å®šæ–‡ä»¶ä¸­åˆ†é…ä¸€ä¸ªæ–°çš„é¡µé¢ï¼Œå¹¶å°†å…¶æ”¾å…¥ç¼“å†²åŒºï¼Œè¿”å›é¡µé¢å¥æŸ„æŒ‡é’ˆã€‚
   * @details åˆ†é…é¡µé¢æ—¶ï¼Œå¦‚æœæ–‡ä»¶ä¸­æœ‰ç©ºé—²é¡µï¼Œå°±ç›´æ¥åˆ†é…ä¸€ä¸ªç©ºé—²é¡µï¼›
   * å¦‚æœæ–‡ä»¶ä¸­æ²¡æœ‰ç©ºé—²é¡µï¼Œåˆ™æ‰©å±•æ–‡ä»¶è§„æ¨¡æ¥å¢åŠ æ–°çš„ç©ºé—²é¡µã€‚
   */
  RC allocate_page(Frame **frame);

  /**
   * @brief é‡Šæ”¾æŸä¸ªé¡µé¢ï¼Œå°†æ­¤é¡µé¢è®¾ç½®ä¸ºæœªåˆ†é…çŠ¶æ€
   *
   * @param page_num å¾…é‡Šæ”¾çš„é¡µé¢
   */
  RC dispose_page(PageNum page_num);

  /**
   * @brief é‡Šæ”¾æŒ‡å®šæ–‡ä»¶å…³è”çš„é¡µçš„å†…å­˜
   * å¦‚æœå·²ç»è„ï¼Œ åˆ™åˆ·åˆ°ç£ç›˜ï¼Œé™¤äº†pinned page
   */
  RC purge_page(PageNum page_num);
  RC purge_all_pages();

  /**
   * @brief ç”¨äºè§£é™¤pageHandleå¯¹åº”é¡µé¢çš„é©»ç•™ç¼“å†²åŒºé™åˆ¶
   *
   * åœ¨è°ƒç”¨GetThisPageæˆ–AllocatePageå‡½æ•°å°†ä¸€ä¸ªé¡µé¢è¯»å…¥ç¼“å†²åŒºåï¼Œ
   * è¯¥é¡µé¢è¢«è®¾ç½®ä¸ºé©»ç•™ç¼“å†²åŒºçŠ¶æ€ï¼Œä»¥é˜²æ­¢å…¶åœ¨å¤„ç†è¿‡ç¨‹ä¸­è¢«ç½®æ¢å‡ºå»ï¼Œ
   * å› æ­¤åœ¨è¯¥é¡µé¢ä½¿ç”¨å®Œä¹‹ååº”è°ƒç”¨æ­¤å‡½æ•°è§£é™¤è¯¥é™åˆ¶ï¼Œä½¿å¾—è¯¥é¡µé¢æ­¤åå¯ä»¥æ­£å¸¸åœ°è¢«æ·˜æ±°å‡ºç¼“å†²åŒº
   */
  RC unpin_page(Frame *frame);

  /**
   * æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é¡µé¢éƒ½æ˜¯pin count == 0çŠ¶æ€(é™¤äº†ç¬¬1ä¸ªé¡µé¢)
   * è°ƒè¯•ä½¿ç”¨
   */
  RC check_all_pages_unpinned();

  int file_desc() const;

  /**
   * å¦‚æœé¡µé¢æ˜¯è„çš„ï¼Œå°±å°†æ•°æ®åˆ·æ–°åˆ°double write buffer
   */
  RC flush_page(Frame &amp;frame);

  /**
   * åˆ·æ–°æ‰€æœ‰é¡µé¢åˆ°double write bufferï¼Œå³ä½¿pin countä¸æ˜¯0
   */
  RC flush_all_pages();

  /**
   * å›æ”¾æ—¥å¿—æ—¶å¤„ç†page0ä¸­å·²è¢«è®¤å®šä¸ºä¸å­˜åœ¨çš„page
   */
  RC recover_page(PageNum page_num);

  /**
   * åˆ·æ–°é¡µé¢åˆ°ç£ç›˜
   */
  RC write_page(PageNum page_num, Page &amp;page);

  RC redo_allocate_page(LSN lsn, PageNum page_num);
  RC redo_deallocate_page(LSN lsn, PageNum page_num);

public:
  int32_t id() const { return buffer_pool_id_; }

  const char *filename() const { return file_name_.c_str(); }

protected:
  RC allocate_frame(PageNum page_num, Frame **buf);

  /**
   * åˆ·æ–°æŒ‡å®šé¡µé¢åˆ°ç£ç›˜(flush)ï¼Œå¹¶ä¸”é‡Šæ”¾å…³è”çš„Frame
   */
  RC purge_frame(PageNum page_num, Frame *used_frame);
  RC check_page_num(PageNum page_num);

  /**
   * åŠ è½½æŒ‡å®šé¡µé¢çš„æ•°æ®åˆ°å†…å­˜ä¸­
   */
  RC load_page(PageNum page_num, Frame *frame);

  /**
   * å¦‚æœé¡µé¢æ˜¯è„çš„ï¼Œå°±å°†æ•°æ®åˆ·æ–°åˆ°ç£ç›˜
   */
  RC flush_page_internal(Frame &amp;frame);

private:
  BufferPoolManager   &amp;bp_manager_;     /// BufferPool ç®¡ç†å™¨
  BPFrameManager      &amp;frame_manager_;  /// Frame ç®¡ç†å™¨
  DoubleWriteBuffer   &amp;dblwr_manager_;  /// Double Write Buffer ç®¡ç†å™¨
  BufferPoolLogHandler log_handler_;    /// BufferPool æ—¥å¿—å¤„ç†å™¨

  int file_desc_ = -1;  /// æ–‡ä»¶æè¿°ç¬¦
  /// ç”±äºåœ¨æœ€å¼€å§‹æ‰“å¼€æ–‡ä»¶æ—¶ï¼Œæ²¡æœ‰æ­£ç¡®çš„buffer pool idä¸èƒ½åŠ è½½header frameï¼Œæ‰€ä»¥å•ç‹¬ä»æ–‡ä»¶ä¸­è¯»å–æ­¤æ ‡è¯†
  int32_t       buffer_pool_id_ = -1;
  Frame        *hdr_frame_      = nullptr;  /// æ–‡ä»¶å¤´é¡µé¢
  BPFileHeader *file_header_    = nullptr;  /// æ–‡ä»¶å¤´
  set&lt;PageNum&gt;  disposed_pages_;            /// å·²ç»é‡Šæ”¾çš„é¡µé¢

  string file_name_;  /// æ–‡ä»¶å

  common::Mutex lock_;
  common::Mutex wr_lock_;

private:
  friend class BufferPoolIterator;
};
</code></pre><h3 id="211-diskbufferpoolget_this_pagepagenum-page_num-frame-frame">2.1.1 <code>DiskBufferPool::get_this_page(PageNum page_num, Frame **frame)</code></h3>
<p>ä»ç£ç›˜æˆ–å†…å­˜ä¸­è·å–æŒ‡å®šçš„é¡µé¢ã€‚</p>
<pre tabindex="0"><code>RC DiskBufferPool::get_this_page(PageNum page_num, Frame **frame) {
  Frame *result_frame = nullptr;

  // æ£€æŸ¥é¡µé¢æ˜¯å¦å·²åŠ è½½åœ¨ç¼“å†²åŒº
  result_frame = frame_manager_.get(buffer_pool_id_, page_num);
  if (result_frame != nullptr) {
    *frame = result_frame;
    result_frame-&gt;pin();
    return RC::SUCCESS;
  }

  // å¦‚æœé¡µé¢ä¸åœ¨ç¼“å†²åŒºå†…ï¼Œåˆ™ä»ç£ç›˜åŠ è½½
  RC rc = allocate_frame(page_num, &amp;result_frame);
  if (rc != RC::SUCCESS) {
    return rc;
  }

  rc = load_page(page_num, result_frame);
  if (rc != RC::SUCCESS) {
    free(buffer_pool_id_, page_num, result_frame);
    return rc;
  }

  result_frame-&gt;pin();
  *frame = result_frame;
  return RC::SUCCESS;
}
</code></pre><p>é¦–å…ˆæ£€æŸ¥é¡µé¢æ˜¯å¦å·²ç»åœ¨å†…å­˜ä¸­çš„ç¼“å†²åŒºï¼ˆé€šè¿‡ <code>frame_manager_.get()</code> æ–¹æ³•ï¼‰ã€‚å¦‚æœå­˜åœ¨ï¼Œç›´æ¥è¿”å›è¯¥é¡µé¢ï¼Œå¹¶å¢åŠ  <code>pin</code> è®¡æ•°ã€‚
å¦‚æœé¡µé¢ä¸åœ¨å†…å­˜ä¸­ï¼Œè°ƒç”¨ <code>allocate_frame()</code> å‡½æ•°åˆ†é…ä¸€ä¸ªæ–°çš„ <code>Frame</code>ï¼Œå¹¶é€šè¿‡ <code>load_page()</code> å‡½æ•°ä»ç£ç›˜åŠ è½½è¯¥é¡µé¢åˆ°å†…å­˜ã€‚
æˆåŠŸåŠ è½½é¡µé¢åï¼Œå¢åŠ <code> pin</code> è®¡æ•°å¹¶è¿”å›ã€‚</p>
<h3 id="212-diskbufferpoolallocate_pageframe-frame">2.1.2 <code>DiskBufferPool::allocate_page(Frame **frame)</code></h3>
<p>åˆ†é…ä¸€ä¸ªæ–°çš„é¡µé¢åˆ°ç¼“å†²åŒºã€‚å¦‚æœæ²¡æœ‰ç©ºé—²é¡µé¢ï¼Œåˆ™æ‰©å±•æ–‡ä»¶ã€‚</p>
<pre tabindex="0"><code>RC DiskBufferPool::allocate_page(Frame **frame) {
  // ç¡®è®¤æ˜¯å¦æœ‰ç©ºé—²é¡µ
  if (file_header_-&gt;allocated_pages &gt;= file_header_-&gt;page_count) {
    // æ²¡æœ‰ç©ºé—²é¡µï¼Œæ‰©å±•æ–‡ä»¶
    RC rc = expand_file();
    if (rc != RC::SUCCESS) {
      return rc;
    }
  }

  // åˆ†é…é¡µé¢ï¼Œæ›´æ–°ä½å›¾çŠ¶æ€
  PageNum page_num = file_header_-&gt;allocated_pages++;
  file_header_-&gt;bitmap[page_num / 8] |= (1 &lt;&lt; (page_num % 8));

  // åˆ†é…å¸§
  return allocate_frame(page_num, frame);
}
</code></pre><p>é¦–å…ˆæ£€æŸ¥æ–‡ä»¶ä¸­æ˜¯å¦è¿˜æœ‰ç©ºé—²é¡µï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è°ƒç”¨ <code>expand_file()</code> æ¥æ‰©å±•æ–‡ä»¶ã€‚<br>
æˆåŠŸæ‰©å±•æ–‡ä»¶åï¼Œé€šè¿‡æ›´æ–° <code>bitmap</code> ä½å›¾æ ‡è®°é¡µé¢å·²åˆ†é…ã€‚<br>
ä½¿ç”¨ <code>allocate_frame()</code> æ–¹æ³•ä¸ºè¯¥é¡µé¢åˆ†é…å†…å­˜ã€‚</p>
<h3 id="213-diskbufferpoolflush_pageframe-frame">2.1.3 <code>DiskBufferPool::flush_page(Frame &amp;frame)</code></h3>
<p>å°†å†…å­˜ä¸­çš„é¡µé¢æ•°æ®å†™å›ç£ç›˜ï¼Œç¡®ä¿é¡µé¢çš„æŒä¹…åŒ–ã€‚</p>
<pre tabindex="0"><code>RC DiskBufferPool::flush_page(Frame &amp;frame) {
  if (!frame.dirty()) {
    return RC::SUCCESS;
  }

  // å°†é¡µé¢æ•°æ®å†™å…¥ç£ç›˜
  RC rc = write_page(frame.page_num(), frame.page());
  if (rc != RC::SUCCESS) {
    return rc;
  }

  frame.clear_dirty();
  return RC::SUCCESS;
}
</code></pre><p>å…ˆæ£€æŸ¥é¡µé¢æ˜¯å¦ä¸ºè„é¡µï¼ˆ<code>dirty()</code>ï¼‰ï¼Œå¦‚æœä¸æ˜¯è„é¡µï¼Œç›´æ¥è¿”å›ã€‚<br>
è°ƒç”¨ <code>write_page()</code> æ–¹æ³•å°†é¡µé¢æ•°æ®å†™å…¥ç£ç›˜ã€‚<br>
å†™å…¥æˆåŠŸåæ¸…é™¤é¡µé¢çš„è„æ ‡è®°ï¼Œå¹¶è¿”å›æˆåŠŸçŠ¶æ€ã€‚</p>
<h3 id="214-rc-diskbufferpooldispose_pagepagenum-page_num">2.1.4 <code>RC DiskBufferPool::dispose_page(PageNum page_num)</code></h3>
<p>è¯¥æ–¹æ³•ç”¨äºé‡Šæ”¾æŸä¸ªå·²åˆ†é…çš„é¡µé¢ï¼Œå°†å…¶ä»ç¼“å†²åŒºå’Œç£ç›˜æ–‡ä»¶ä¸­æ ‡è®°ä¸ºæœªåˆ†é…çŠ¶æ€ã€‚</p>
<pre tabindex="0"><code>RC DiskBufferPool::dispose_page(PageNum page_num)
{
  if (page_num == 0) {
    LOG_ERROR(&#34;Failed to dispose page %d, because it is the first page. filename=%s&#34;, page_num, file_name_.c_str());
    return RC::INTERNAL;
  }
  
  scoped_lock lock_guard(lock_);
  Frame           *used_frame = frame_manager_.get(id(), page_num);
  if (used_frame != nullptr) {
    ASSERT(&#34;the page try to dispose is in use. frame:%s&#34;, used_frame-&gt;to_string().c_str());
    frame_manager_.free(id(), page_num, used_frame);
  } else {
    LOG_DEBUG(&#34;page not found in memory while disposing it. pageNum=%d&#34;, page_num);
  }

  LSN lsn = 0;
  RC rc = log_handler_.deallocate_page(page_num, lsn);
  if (OB_FAIL(rc)) {
    LOG_ERROR(&#34;Failed to log deallocate page %d, rc=%s&#34;, page_num, strrc(rc));
    // ignore error handle
  }

  hdr_frame_-&gt;set_lsn(lsn);
  hdr_frame_-&gt;mark_dirty();
  file_header_-&gt;allocated_pages--;
  char tmp = 1 &lt;&lt; (page_num % 8);
  file_header_-&gt;bitmap[page_num / 8] &amp;= ~tmp;
  return RC::SUCCESS;
}
</code></pre><p>æ£€æŸ¥é¡µé¢å·ï¼Œç¡®ä¿æ–‡ä»¶å¤´é¡µé¢(<code>page_num</code>=0)ä¸ä¼šè¢«é‡Šæ”¾ã€‚<br>
æ£€æŸ¥é¡µé¢æ˜¯å¦åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœåœ¨å†…å­˜ä¸­åˆ™é‡Šæ”¾å®ƒã€‚<br>
è®°å½•æ—¥å¿—æ“ä½œï¼Œç¡®ä¿é‡Šæ”¾é¡µé¢çš„æ“ä½œå¯è¿½æº¯ã€‚<br>
æ›´æ–°æ–‡ä»¶å¤´çš„é¡µé¢åˆ†é…è®¡æ•°å’Œä½å›¾ï¼Œç¡®ä¿é¡µé¢é‡Šæ”¾çŠ¶æ€åŒæ­¥åˆ°æ–‡ä»¶:<br>
<code>hdr_frame_-&gt;set_lsn(lsn)</code>ï¼šå°†å½“å‰é¡µé¢å¤´æ–‡ä»¶çš„æ—¥å¿—åºåˆ—å·ï¼ˆ<code>LSN</code>ï¼‰æ›´æ–°ä¸ºæœ€æ–°çš„ <code>lsn</code>ï¼Œç¡®ä¿æ—¥å¿—é¡ºåºæ­£ç¡®ã€‚<br>
<code>hdr_frame_-&gt;mark_dirty()</code>ï¼šæ ‡è®°é¡µé¢ä¸ºè„é¡µï¼Œè¡¨ç¤ºé¡µé¢å¤´å·²ç»ä¿®æ”¹ï¼Œåœ¨é€‚å½“æ—¶æœºä¼šå°†å…¶åˆ·å›ç£ç›˜ã€‚<br>
<code>file_header_-&gt;allocated_pages--</code>ï¼šå‡å°‘æ–‡ä»¶å¤´ä¸­è®°å½•çš„å·²åˆ†é…é¡µé¢çš„è®¡æ•°ï¼Œè¡¨ç¤ºæœ‰ä¸€ä¸ªé¡µé¢è¢«é‡Šæ”¾ã€‚<br>
ä½å›¾æ›´æ–°ï¼š<code>bitmap</code> ç”¨äºè·Ÿè¸ªé¡µé¢çš„åˆ†é…çŠ¶æ€ã€‚é€šè¿‡ <code>file_header_-&gt;bitmap[page_num / 8] &amp;= ~tmp</code> è¿™è¡Œä»£ç ï¼Œæ¸…é™¤å¯¹åº”é¡µé¢çš„åˆ†é…æ ‡è®°ï¼ˆä½¿ç”¨æŒ‰ä½ä¸å’ŒæŒ‰ä½å–åæ“ä½œï¼‰ï¼Œå°†é¡µé¢æ ‡è®°ä¸ºæœªåˆ†é…ã€‚</p>
<h3 id="215-bpframemanager">2.1.5 <code>BPFrameManager</code></h3>
<pre tabindex="0"><code>class BPFrameManager
{
public:
  BPFrameManager(const char *tag);

  RC init(int pool_num);
  RC cleanup();

  /**
   * @brief è·å–æŒ‡å®šçš„é¡µé¢
   *
   * @param buffer_pool_id buffer Poolæ ‡è¯†
   * @param page_num  é¡µé¢å·
   * @return Frame* é¡µå¸§æŒ‡é’ˆ
   */
  Frame *get(int buffer_pool_id, PageNum page_num);

  /**
   * @brief åˆ—å‡ºæ‰€æœ‰æŒ‡å®šæ–‡ä»¶çš„é¡µé¢
   *
   * @param buffer_pool_id buffer Poolæ ‡è¯†
   * @return list&lt;Frame *&gt; é¡µå¸§åˆ—è¡¨
   */
  list&lt;Frame *&gt; find_list(int buffer_pool_id);

  /**
   * @brief åˆ†é…ä¸€ä¸ªæ–°çš„é¡µé¢
   *
   * @param buffer_pool_id buffer Poolæ ‡è¯†
   * @param page_num é¡µé¢ç¼–å·
   * @return Frame* é¡µå¸§æŒ‡é’ˆ
   */
  Frame *alloc(int buffer_pool_id, PageNum page_num);

  /**
   * å°½ç®¡frameä¸­å·²ç»åŒ…å«äº†buffer_pool_idå’Œpage_numï¼Œä½†æ˜¯ä¾ç„¶è¦æ±‚
   * ä¼ å…¥ï¼Œå› ä¸ºframeå¯èƒ½å¿˜è®°åˆå§‹åŒ–æˆ–è€…æ²¡æœ‰åˆå§‹åŒ–
   */
  RC free(int buffer_pool_id, PageNum page_num, Frame *frame);

  /**
   * å¦‚æœä¸èƒ½ä»ç©ºé—²é“¾è¡¨ä¸­åˆ†é…æ–°çš„é¡µé¢ï¼Œå°±ä½¿ç”¨è¿™ä¸ªæ¥å£ï¼Œ
   * å°è¯•ä»pin count=0çš„é¡µé¢ä¸­æ·˜æ±°ä¸€äº›
   * @param count æƒ³è¦purgeå¤šå°‘ä¸ªé¡µé¢
   * @param purger éœ€è¦åœ¨é‡Šæ”¾frameä¹‹å‰ï¼Œå¯¹é¡µé¢åšäº›ä»€ä¹ˆæ“ä½œã€‚å½“å‰æ˜¯åˆ·æ–°è„æ•°æ®åˆ°ç£ç›˜
   * @return è¿”å›æœ¬æ¬¡æ¸…ç†äº†å¤šå°‘ä¸ªé¡µé¢
   */
  int purge_frames(int count, function&lt;RC(Frame *frame)&gt; purger);

  size_t frame_num() const { return frames_.count(); }

  /**
   * æµ‹è¯•ä½¿ç”¨ã€‚è¿”å›å·²ç»ä»å†…å­˜ç”³è¯·çš„ä¸ªæ•°
   */
  size_t total_frame_num() const { return allocator_.get_size(); }

private:
  Frame *get_internal(const FrameId &amp;frame_id);
  RC     free_internal(const FrameId &amp;frame_id, Frame *frame);

private:
  class BPFrameIdHasher
  {
  public:
    size_t operator()(const FrameId &amp;frame_id) const { return frame_id.hash(); }
  };

  using FrameLruCache  = common::LruCache&lt;FrameId, Frame *, BPFrameIdHasher&gt;;
  using FrameAllocator = common::MemPoolSimple&lt;Frame&gt;;

  mutex          lock_;
  FrameLruCache  frames_;
  FrameAllocator allocator_;
};
</code></pre><h2 id="22-ç¼“å­˜é¡µæ¡†æ¶">2.2 ç¼“å­˜é¡µæ¡†æ¶</h2>
<p><code>Frame</code>:</p>
<pre tabindex="0"><code>class Frame
{
public:
  ~Frame()
  {
    // LOG_DEBUG(&#34;deallocate frame. this=%p, lbt=%s&#34;, this, common::lbt());
  }

  /**
   * @brief reinit å’Œ reset åœ¨ MemPoolSimple ä¸­ä½¿ç”¨
   * @details åœ¨ MemPoolSimple åˆ†é…å’Œé‡Šæ”¾ä¸€ä¸ªFrameå¯¹è±¡æ—¶ï¼Œä¸ä¼šè°ƒç”¨æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ï¼Œ
   * è€Œæ˜¯è°ƒç”¨reinitå’Œresetã€‚
   */
  void reinit() {}
  void reset() {}

  void clear_page() { memset(&amp;page_, 0, sizeof(page_)); }

  int  buffer_pool_id() const { return frame_id_.buffer_pool_id(); }
  void set_buffer_pool_id(int id) { frame_id_.set_buffer_pool_id(id); }

  /**
   * @brief åœ¨ç£ç›˜å’Œå†…å­˜ä¸­å†…å®¹å®Œå…¨ä¸€è‡´çš„æ•°æ®é¡µ
   * @details ç£ç›˜æ–‡ä»¶åˆ’åˆ†ä¸ºä¸€ä¸ªä¸ªé¡µé¢ï¼Œæ¯æ¬¡ä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªé¡µé¢ï¼Œå°±æ˜¯ Pageã€‚
   * frame æ˜¯ä¸ºäº†ç®¡ç†è¿™äº›é¡µé¢è€Œç»´æŠ¤çš„ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚
   */
  Page &amp;page() { return page_; }

  /**
   * @brief æ¯ä¸ªé¡µé¢éƒ½æœ‰ä¸€ä¸ªç¼–å·
   * @details å½“å‰é¡µé¢ç¼–å·è®°å½•åœ¨äº†é¡µé¢æ•°æ®ä¸­ï¼Œå…¶å®å¯ä»¥ä¸è®°å½•ï¼Œä»ç£ç›˜ä¸­åŠ è½½æ—¶è®°å½•åœ¨Frameä¿¡æ¯ä¸­å³å¯ã€‚
   */
  PageNum page_num() const { return frame_id_.page_num(); }
  void    set_page_num(PageNum page_num) { frame_id_.set_page_num(page_num); }
  FrameId frame_id() const { return frame_id_; }

  /**
   * @brief ä¸ºäº†å®ç°æŒä¹…åŒ–ï¼Œéœ€è¦å°†é¡µé¢çš„ä¿®æ”¹è®°å½•è®°å½•åˆ°æ—¥å¿—ä¸­ï¼Œè¿™é‡Œè®°å½•äº†æ—¥å¿—åºåˆ—å·
   * @details å¦‚æœå½“å‰é¡µé¢ä»ç£ç›˜ä¸­åŠ è½½å‡ºæ¥æ—¶ï¼Œå®ƒçš„æ—¥å¿—åºåˆ—å·æ¯”å½“å‰WAL(Write-Ahead-Logging)ä¸­çš„ä¸€äº›
   * åºåˆ—å·è¦å°ï¼Œé‚£å°±å¯ä»¥ä»æ—¥å¿—ä¸­è¯»å–è¿™äº›æ›´å¤§åºåˆ—å·çš„æ—¥å¿—ï¼Œåšé‡åšæ“ä½œï¼Œå°†é¡µé¢æ¢å¤åˆ°æœ€æ–°çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯redoã€‚
   */
  LSN  lsn() const { return page_.lsn; }
  void set_lsn(LSN lsn) { page_.lsn = lsn; }

  /**
   * @brief é¡µé¢æ ¡éªŒå’Œ
   * @details ç”¨äºæ ¡éªŒé¡µé¢å®Œæ•´æ€§ã€‚å¦‚æœé¡µé¢å†™å…¥ä¸€åŠæ—¶å‡ºç°å¼‚å¸¸ï¼Œå¯ä»¥é€šè¿‡æ ¡éªŒå’Œæ£€æµ‹å‡ºæ¥ã€‚
   */
  CheckSum check_sum() const { return page_.check_sum; }
  void     set_check_sum(CheckSum check_sum) { page_.check_sum = check_sum; }

  /**
   * @brief åˆ·æ–°å½“å‰å†…å­˜é¡µé¢çš„è®¿é—®æ—¶é—´
   * @details ç”±äºå†…å­˜æ˜¯æœ‰é™çš„ï¼Œæ¯”ç£ç›˜è¦å°å¾ˆå¤šã€‚é‚£å½“æˆ‘ä»¬è®¿é—®æŸäº›æ–‡ä»¶é¡µé¢æ—¶ï¼Œå¯èƒ½ç”±äºå†…å­˜ä¸è¶³
   * è€Œè¦æ·˜æ±°ä¸€äº›é¡µé¢ã€‚æˆ‘ä»¬é€‰æ‹©æ·˜æ±°å“ªäº›é¡µé¢å‘¢ï¼Ÿè¿™é‡Œä½¿ç”¨äº†LRUç®—æ³•ï¼Œå³æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„é¡µé¢è¢«æ·˜æ±°ã€‚
   * æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼Œé‡‡ç”¨çš„ä¾æ®å°±æ˜¯è®¿é—®æ—¶é—´ã€‚æ‰€ä»¥æ¯æ¬¡è®¿é—®æŸä¸ªé¡µé¢æ—¶ï¼Œæˆ‘ä»¬éƒ½è¦åˆ·æ–°ä¸€ä¸‹è®¿é—®æ—¶é—´ã€‚
   */
  void access();

  /**
   * @brief æ ‡è®°æŒ‡å®šé¡µé¢ä¸ºâ€œè„â€é¡µã€‚
   * @details å¦‚æœä¿®æ”¹äº†é¡µé¢çš„å†…å®¹ï¼Œåˆ™åº”è°ƒç”¨æ­¤å‡½æ•°ï¼Œ
   * ä»¥ä¾¿è¯¥é¡µé¢è¢«æ·˜æ±°å‡ºç¼“å†²åŒºæ—¶ç³»ç»Ÿå°†æ–°çš„é¡µé¢æ•°æ®å†™å…¥ç£ç›˜æ–‡ä»¶
   */
  void mark_dirty() { dirty_ = true; }

  /**
   * @brief é‡ç½®â€œè„â€æ ‡è®°
   * @details å¦‚æœé¡µé¢å·²ç»è¢«å†™å…¥ç£ç›˜æ–‡ä»¶ï¼Œåˆ™åº”è°ƒç”¨æ­¤å‡½æ•°ã€‚
   */
  void clear_dirty() { dirty_ = false; }
  bool dirty() const { return dirty_; }

  char *data() { return page_.data; }

  bool can_purge() { return pin_count_.load() == 0; }

  /**
   * @brief ç»™å½“å‰é¡µå¸§å¢åŠ å¼•ç”¨è®¡æ•°
   * piné€šå¸¸éƒ½ä¼šåŠ ç€frame manageré”æ¥è®¿é—®ã€‚
   * å½“æˆ‘ä»¬è®¿é—®æŸä¸ªé¡µé¢æ—¶ï¼Œæˆ‘ä»¬ä¸æœŸæœ›æ­¤é¡µé¢è¢«æ·˜æ±°ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå¢åŠ å¼•ç”¨è®¡æ•°ã€‚
   */
  void pin();

  /**
   * @brief é‡Šæ”¾ä¸€ä¸ªå½“å‰é¡µå¸§çš„å¼•ç”¨è®¡æ•°
   * ä¸pinå¯¹åº”ï¼Œä½†æ˜¯é€šå¸¸ä¸ä¼šåŠ ç€frame managerçš„é”æ¥è®¿é—®
   */
  int unpin();
  int pin_count() const { return pin_count_.load(); }

  void write_latch();
  void write_latch(intptr_t xid);

  void write_unlatch();
  void write_unlatch(intptr_t xid);

  void read_latch();
  void read_latch(intptr_t xid);
  bool try_read_latch();

  void read_unlatch();
  void read_unlatch(intptr_t xid);

  string to_string() const;

private:
  friend class BufferPool;

  bool          dirty_ = false;
  atomic&lt;int&gt;   pin_count_{0};
  unsigned long acc_time_ = 0;
  FrameId       frame_id_;
  Page          page_;

  /// åœ¨éå¹¶å‘ç¼–è¯‘æ—¶ï¼ŒåŠ é”è§£é”åŠ¨ä½œå°†ä»€ä¹ˆéƒ½ä¸åš
  common::RecursiveSharedMutex lock_;

  /// ä½¿ç”¨ä¸€äº›æ‰‹æ®µæ¥åšæµ‹è¯•ï¼Œæå‰æ£€æµ‹å‡ºå¤´ç–¼çš„æ­»é”é—®é¢˜
  /// å¦‚æœç¼–è¯‘æ—¶æ²¡æœ‰å¢åŠ è°ƒè¯•é€‰é¡¹ï¼Œè¿™äº›ä»£ç ä»€ä¹ˆéƒ½ä¸åš
  common::DebugMutex           debug_lock_;
  intptr_t                     write_locker_          = 0;
  int                          write_recursive_count_ = 0;
  unordered_map&lt;intptr_t, int&gt; read_lockers_;
};
</code></pre><p><code>Frame::pin()</code>ï¼š<br>
å¢åŠ é¡µé¢çš„ <code>pin_count_</code> è®¡æ•°ï¼Œé˜²æ­¢é¡µé¢è¢«æ·˜æ±°ã€‚</p>
<p><code>Frame::unpin()</code>:<br>
å‡å°‘é¡µé¢çš„ <code>pin_count_</code> è®¡æ•°ï¼Œå½“ <code>pin_count_</code> å½’é›¶æ—¶ï¼Œå…è®¸é¡µé¢è¢«æ·˜æ±°ã€‚</p>
<p><code>Frame::mark_dirty()</code>:<br>
æ ‡è®°é¡µé¢ä¸ºè„é¡µï¼Œè¡¨ç¤ºé¡µé¢å·²è¢«ä¿®æ”¹ï¼Œéœ€è¦åœ¨åˆé€‚çš„æ—¶æœºå°†æ•°æ®å†™å›ç£ç›˜ã€‚</p>
<p><code>Frame::write_latch()</code>:<br>
ä¸ºå½“å‰é¡µé¢åŠ å†™é”ï¼Œç¡®ä¿åœ¨å†™å…¥æ—¶ä¸è¢«å…¶ä»–çº¿ç¨‹è®¿é—®ã€‚</p>
<p><code>Frame::access()</code>:<br>
æ›´æ–°é¡µé¢çš„è®¿é—®æ—¶é—´ï¼Œç”¨äºæ›¿æ¢ç­–ç•¥ï¼Œæ ‡è¯†é¡µé¢æœ€è¿‘ä¸€æ¬¡è¢«è®¿é—®çš„æ—¶é—´ã€‚</p>
<h2 id="23-æ·˜æ±°ç­–ç•¥">2.3 æ·˜æ±°ç­–ç•¥</h2>
<pre tabindex="0"><code>int BPFrameManager::purge_frames(int count, function&lt;RC(Frame *frame)&gt; purger)
{
  lock_guard&lt;mutex&gt; lock_guard(lock_);

  vector&lt;Frame *&gt; frames_can_purge;
  if (count &lt;= 0) {
    count = 1;
  }
  frames_can_purge.reserve(count);

  auto purge_finder = [&amp;frames_can_purge, count](const FrameId &amp;frame_id, Frame *const frame) {
    if (frame-&gt;can_purge()) {
      frame-&gt;pin();
      frames_can_purge.push_back(frame);
      if (frames_can_purge.size() &gt;= static_cast&lt;size_t&gt;(count)) {
        return false;  // false to break the progress
      }
    }
    return true;  // true continue to look up
  };

  frames_.foreach_reverse(purge_finder);
  LOG_INFO(&#34;purge frames find %ld pages total&#34;, frames_can_purge.size());

  /// å½“å‰è¿˜åœ¨frameManagerçš„é”å†…ï¼Œè€Œ purger æ˜¯ä¸€ä¸ªéå¸¸è€—æ—¶çš„æ“ä½œ
  /// ä»–éœ€è¦æŠŠè„é¡µæ•°æ®åˆ·æ–°åˆ°ç£ç›˜ä¸Šå»ï¼Œæ‰€ä»¥è¿™é‡Œä¼šæå¤§åœ°é™ä½å¹¶å‘åº¦
  int freed_count = 0;
  for (Frame *frame : frames_can_purge) {
    RC rc = purger(frame);
    if (RC::SUCCESS == rc) {
      free_internal(frame-&gt;frame_id(), frame);
      freed_count++;
    } else {
      frame-&gt;unpin();
      LOG_WARN(&#34;failed to purge frame. frame_id=%s, rc=%s&#34;, 
               frame-&gt;frame_id().to_string().c_str(), strrc(rc));
    }
  }
  LOG_INFO(&#34;purge frame done. number=%d&#34;, freed_count);
  return freed_count;
}
</code></pre><p>æŸ¥æ‰¾å¯æ·˜æ±°çš„é¡µé¢:<br>
å®šä¹‰ä¸€ä¸ª <code>purge_finder</code> lambda å‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨äºéå†ç¼“å­˜ä¸­çš„æ‰€æœ‰é¡µé¢ï¼Œå¹¶å°†ç¬¦åˆæ¡ä»¶ï¼ˆå¯ä»¥æ·˜æ±°ï¼‰çš„é¡µé¢å­˜å‚¨åˆ° <code>frames_can_purge</code> å®¹å™¨ä¸­ã€‚<br>
<code>frame-&gt;can_purge()</code>ï¼šåˆ¤æ–­é¡µé¢æ˜¯å¦å¯ä»¥è¢«æ·˜æ±°ï¼Œé€šå¸¸æ˜¯é€šè¿‡ <code>pin_count == 0</code> æ¥åˆ¤æ–­é¡µé¢æ˜¯å¦æ­£åœ¨ä½¿ç”¨ï¼Œå¦‚æœé¡µé¢æœªè¢«å¼•ç”¨ï¼Œåˆ™å¯ä»¥æ·˜æ±°ã€‚<br>
<code>frame-&gt;pin()</code>ï¼šå¯¹è¯¥é¡µé¢æ‰§è¡Œ <code>pin</code> æ“ä½œï¼Œç¡®ä¿åœ¨å½“å‰çº¿ç¨‹ä½¿ç”¨è¯¥é¡µé¢æ—¶ï¼Œå®ƒä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ›¿æ¢æˆ–é‡Šæ”¾ã€‚<br>
å¦‚æœå·²ç»æ‰¾åˆ°äº†è¶³å¤Ÿæ•°é‡çš„é¡µé¢ï¼ˆå³<code> frames_can_purge.size() &gt;= count</code>ï¼‰ï¼Œåˆ™è¿”å› <code>false</code>ï¼Œä»¥ç»ˆæ­¢éå†ã€‚<br>
<code>frames_.foreach_reverse(purge_finder)</code>ï¼šéå†ç¼“å­˜æ± ä¸­çš„é¡µé¢ï¼ŒæŸ¥æ‰¾å¯ä»¥è¢«æ·˜æ±°çš„é¡µé¢ï¼Œå¹¶å­˜å‚¨åœ¨ <code>frames_can_purge</code> ä¸­ã€‚è¯¥éå†æ˜¯é€†åºè¿›è¡Œçš„ï¼ˆ<code>foreach_reverse</code>ï¼‰ï¼Œå¯èƒ½æ˜¯å› ä¸ºæœ€è¿‘ä½¿ç”¨çš„é¡µé¢æ’åœ¨é˜Ÿåˆ—çš„å‰é¢ï¼Œè€Œæœ€è¿‘æœªä½¿ç”¨çš„é¡µé¢æ’åœ¨åé¢ã€‚</p>
<p>æ‰§è¡Œæ·˜æ±°æ“ä½œ:<br>
åˆå§‹åŒ– <code>freed_count</code> å˜é‡ï¼Œç”¨äºç»Ÿè®¡æˆåŠŸæ·˜æ±°çš„é¡µé¢æ•°é‡ã€‚<br>
éå† <code>frames_can_purge</code> ä¸­çš„é¡µé¢ï¼Œå¹¶ä¸ºæ¯ä¸ªé¡µé¢è°ƒç”¨ä¼ å…¥çš„ <code>purger(frame)</code> å‡½æ•°æ‰§è¡Œæ·˜æ±°å‰çš„å¿…è¦æ“ä½œã€‚<br>
<code>purger(frame)</code>ï¼šè¿™æ˜¯ä¸€ä¸ªç”¨æˆ·æä¾›çš„å‡½æ•°ï¼Œé€šå¸¸ç”¨äºå°†è„é¡µï¼ˆä¿®æ”¹è¿‡ä½†å°šæœªåˆ·ç›˜çš„é¡µé¢ï¼‰å†™å›ç£ç›˜ã€‚è¿™ä¸ªæ“ä½œå¯èƒ½éå¸¸è€—æ—¶ï¼Œå› æ­¤æ˜¯å…³é”®æ­¥éª¤ã€‚<br>
å¦‚æœ <code>purger(frame)</code> æˆåŠŸï¼ˆè¿”å› <code>RC::SUCCESS</code>ï¼‰ï¼Œåˆ™è°ƒç”¨ <code>free_internal()</code> æ–¹æ³•é‡Šæ”¾è¯¥é¡µé¢ï¼Œå¹¶å¢åŠ å·²é‡Šæ”¾é¡µé¢çš„è®¡æ•° <code>freed_count</code>ã€‚<br>
å¦‚æœ <code>purger(frame)</code> å¤±è´¥ï¼Œè°ƒç”¨ <code>frame-&gt;unpin()</code> å–æ¶ˆä¹‹å‰å¯¹é¡µé¢çš„ <code>pin</code> æ“ä½œï¼Œå¹¶è®°å½•è­¦å‘Šæ—¥å¿—ã€‚</p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="http://localhost:1313/" >
    &copy;  Wei Haoyu 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
