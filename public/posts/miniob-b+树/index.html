<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Wei Haoyu</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="ç‚¹å‡»è¿”å›ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•

ç›®å½•
{:toc}


1. B&#43;æ ‘ä»‹ç»
B&#43;æ ‘æ˜¯ä¸€ç§å¹³è¡¡çš„æ ‘å½¢æ•°æ®ç»“æ„ï¼Œé€šå¸¸ç”¨äºæ•°æ®åº“å’Œæ–‡ä»¶ç³»ç»Ÿç­‰éœ€è¦é¢‘ç¹è¿›è¡Œç£ç›˜å­˜å–çš„å¤§å‹æ•°æ®ç®¡ç†ç³»ç»Ÿã€‚å®ƒæ˜¯Bæ ‘çš„æ‰©å±•ç‰ˆæœ¬ï¼Œå…·æœ‰æ›´é«˜æ•ˆçš„æŸ¥è¯¢å’ŒèŒƒå›´æŸ¥è¯¢èƒ½åŠ›ã€‚B&#43;æ ‘çš„è®¾è®¡åˆè¡·æ˜¯ä¸ºäº†ä¼˜åŒ–ç£ç›˜å­˜å–çš„æ•ˆç‡ï¼Œå› è€Œåœ¨å¤„ç†å¤§è§„æ¨¡æ•°æ®æ—¶éå¸¸é€‚åˆã€‚
1.1 B&#43;æ ‘çš„ç»“æ„ç‰¹ç‚¹
æ‰€æœ‰å…³é”®å­—éƒ½å‡ºç°åœ¨å¶å­èŠ‚ç‚¹ï¼š
B&#43;æ ‘ä¸Bæ ‘çš„ä¸»è¦åŒºåˆ«ä¹‹ä¸€æ˜¯ï¼ŒB&#43;æ ‘ä¸­æ‰€æœ‰çš„å…³é”®å­—éƒ½å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ä¸­ï¼Œå†…éƒ¨èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•ä¿¡æ¯ã€‚å¶å­èŠ‚ç‚¹æŒ‰ç…§å…³é”®å­—çš„é¡ºåºæ’åˆ—ï¼Œå¹¶é€šè¿‡æŒ‡é’ˆè¿æ¥ï¼Œå½¢æˆä¸€ä¸ªæœ‰åºçš„é“¾è¡¨ã€‚
å†…èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•è€Œä¸å­˜å‚¨æ•°æ®ï¼š
B&#43;æ ‘çš„éå¶å­èŠ‚ç‚¹ï¼ˆå†…èŠ‚ç‚¹ï¼‰ä¸å­˜å‚¨å®é™…æ•°æ®ï¼Œå®ƒä»¬åªæ˜¯ç”¨äºæŒ‡å¼•æŸ¥è¯¢è·¯å¾„çš„ç´¢å¼•ï¼ŒæŒ‡å‘å­æ ‘æˆ–å¶å­èŠ‚ç‚¹ã€‚
æ‰€æœ‰å¶å­èŠ‚ç‚¹åœ¨åŒä¸€å±‚ï¼š
B&#43;æ ‘æ˜¯é«˜åº¦å¹³è¡¡çš„ï¼Œå³æ‰€æœ‰å¶å­èŠ‚ç‚¹éƒ½åœ¨åŒä¸€å±‚ï¼Œç¡®ä¿æŸ¥è¯¢æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¸ºO(log n)ï¼Œå…¶ä¸­næ˜¯æ•°æ®é¡¹çš„æ€»æ•°ã€‚
å¶å­èŠ‚ç‚¹é“¾è¡¨ç»“æ„ï¼š
å¶å­èŠ‚ç‚¹ä¹‹é—´æ˜¯æœ‰åºé“¾è¡¨ï¼Œæ„å‘³ç€åœ¨è¿›è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶ï¼Œå¯ä»¥é€šè¿‡å¶å­èŠ‚ç‚¹çš„é¡ºåºè®¿é—®å¿«é€Ÿè·å–ä¸€ç»„è¿ç»­çš„ç»“æœã€‚
1.2 B&#43;æ ‘çš„ä¼˜ç‚¹
èŒƒå›´æŸ¥è¯¢æ€§èƒ½ä¼˜å¼‚ï¼š
ç”±äºå¶å­èŠ‚ç‚¹ä¹‹é—´çš„é“¾è¡¨ç»“æ„ï¼ŒB&#43;æ ‘åœ¨å¤„ç†èŒƒå›´æŸ¥è¯¢æ—¶è¡¨ç°æä¸ºä¼˜ç§€ï¼Œå¯ä»¥ä»èµ·å§‹ä½ç½®æ²¿ç€é“¾è¡¨é¡ºåºè¯»å–ã€‚
ç£ç›˜I/Oä¼˜åŒ–ï¼š
B&#43;æ ‘çš„è®¾è®¡ç›®æ ‡æ˜¯å‡å°‘ç£ç›˜I/Oæ“ä½œã€‚å†…èŠ‚ç‚¹ä¸å­˜å‚¨å®é™…æ•°æ®ï¼Œå› æ­¤å¯ä»¥å°†æ›´å¤šçš„ç´¢å¼•èŠ‚ç‚¹æ”¾å…¥å†…å­˜ä¸­ï¼Œå‡å°‘ä»ç£ç›˜è¯»å–æ•°æ®çš„æ¬¡æ•°ã€‚
å¹³è¡¡æ€§ï¼š
B&#43;æ ‘æ˜¯ä¸€ç§å¹³è¡¡æ ‘ï¼Œä¿è¯äº†æ’å…¥ã€åˆ é™¤ã€æŸ¥è¯¢æ“ä½œçš„æ—¶é—´å¤æ‚åº¦å§‹ç»ˆä¿æŒåœ¨O(log n)ã€‚
å­˜å‚¨å¯†åº¦é«˜ï¼š
ç”±äºå†…èŠ‚ç‚¹ä¸å­˜å‚¨æ•°æ®ï¼ŒB&#43;æ ‘å¯ä»¥å°†æ›´å¤šçš„ç´¢å¼•èŠ‚ç‚¹æ”¾å…¥å†…å­˜ï¼Œä»è€Œæœ‰æ•ˆåˆ©ç”¨ç³»ç»Ÿçš„ç¼“å­˜ã€‚
1.3 B&#43;æ ‘çš„åº”ç”¨åœºæ™¯
æ•°æ®åº“ç³»ç»Ÿï¼š
åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼ŒB&#43;æ ‘å¸¸ç”¨äºå®ç°ç´¢å¼•ï¼Œå¦‚MySQLä¸­çš„InnoDBå­˜å‚¨å¼•æ“å°±ä½¿ç”¨B&#43;æ ‘ä½œä¸ºå…¶ä¸»é”®ç´¢å¼•ç»“æ„ã€‚
æ–‡ä»¶ç³»ç»Ÿï¼š
ä¸€äº›æ–‡ä»¶ç³»ç»Ÿï¼Œå¦‚NTFSï¼Œä¹Ÿé‡‡ç”¨B&#43;æ ‘æ¥ç®¡ç†æ–‡ä»¶å’Œç›®å½•æ•°æ®ã€‚
å¤§è§„æ¨¡æ•°æ®å­˜å‚¨ï¼š
B&#43;æ ‘ç‰¹åˆ«é€‚åˆéœ€è¦åœ¨ç£ç›˜ä¸­ç®¡ç†å¤§è§„æ¨¡æ•°æ®çš„åœºæ™¯ï¼Œèƒ½å¤Ÿå¾ˆå¥½åœ°å¤„ç†ç£ç›˜I/Oã€‚
1.4 B&#43;æ ‘ä¸Bæ ‘çš„åŒºåˆ«
æ•°æ®å­˜å‚¨ä½ç½®ï¼š
Bæ ‘çš„æ•°æ®æ—¢å­˜å‚¨åœ¨å†…èŠ‚ç‚¹ä¹Ÿå­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼Œè€ŒB&#43;æ ‘çš„æ•°æ®åªå­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ã€‚
èŒƒå›´æŸ¥è¯¢æ•ˆç‡ï¼š
ç”±äºB&#43;æ ‘çš„å¶å­èŠ‚ç‚¹æ„æˆé“¾è¡¨ç»“æ„ï¼Œè¿›è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶å¯ä»¥ç›´æ¥ä»é“¾è¡¨ä¸­éå†ï¼Œè€ŒBæ ‘åˆ™éœ€è¦æ›´å¤šçš„æ ‘éå†æ“ä½œã€‚
èŠ‚ç‚¹ç»“æ„ï¼š
B&#43;æ ‘çš„å†…èŠ‚ç‚¹æ›´ä¸ºç´§å‡‘ï¼Œå› ä¸ºå®ƒä»¬åªå­˜å‚¨ç´¢å¼•ï¼Œè€ŒBæ ‘çš„å†…èŠ‚ç‚¹å­˜å‚¨ç´¢å¼•å’Œæ•°æ®ã€‚
2. B&#43;æ ‘åœ¨miniobçš„åº”ç”¨
2.1 B&#43;æ ‘çš„ç»“æ„ä¸èŠ‚ç‚¹
2.1.1 IndexFileHeader
IndexFileHeaderï¼š
ç”¨äºå­˜å‚¨ B&#43; æ ‘çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬æ ¹èŠ‚ç‚¹é¡µé¢ç¼–å·ã€å†…éƒ¨èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹çš„æœ€å¤§å¤§å°ã€å±æ€§é•¿åº¦ç­‰ã€‚
struct IndexFileHeader
{
  IndexFileHeader()
  {
    memset(this, 0, sizeof(IndexFileHeader));
    root_page = BP_INVALID_PAGE_NUM;
  }
  PageNum  root_page;          ///&lt; æ ¹èŠ‚ç‚¹åœ¨ç£ç›˜ä¸­çš„é¡µå·
  int32_t  internal_max_size;  ///&lt; å†…éƒ¨èŠ‚ç‚¹æœ€å¤§çš„é”®å€¼å¯¹æ•°
  int32_t  leaf_max_size;      ///&lt; å¶å­èŠ‚ç‚¹æœ€å¤§çš„é”®å€¼å¯¹æ•°
  int32_t  attr_length;        ///&lt; é”®å€¼çš„é•¿åº¦
  int32_t  key_length;         ///&lt; attr length &#43; sizeof(RID)
  AttrType attr_type;          ///&lt; é”®å€¼çš„ç±»å‹

  const string to_string() const
  {
    stringstream ss;

    ss &lt;&lt; &#34;attr_length:&#34; &lt;&lt; attr_length &lt;&lt; &#34;,&#34;
       &lt;&lt; &#34;key_length:&#34; &lt;&lt; key_length &lt;&lt; &#34;,&#34;
       &lt;&lt; &#34;attr_type:&#34; &lt;&lt; attr_type_to_string(attr_type) &lt;&lt; &#34;,&#34;
       &lt;&lt; &#34;root_page:&#34; &lt;&lt; root_page &lt;&lt; &#34;,&#34;
       &lt;&lt; &#34;internal_max_size:&#34; &lt;&lt; internal_max_size &lt;&lt; &#34;,&#34;
       &lt;&lt; &#34;leaf_max_size:&#34; &lt;&lt; leaf_max_size &lt;&lt; &#34;;&#34;;

    return ss.str();
  }
};
PageNum root_pageï¼š
è¯¥å˜é‡å­˜å‚¨äº†æ ¹èŠ‚ç‚¹åœ¨ç£ç›˜ä¸­çš„é¡µå·ï¼Œç”¨äºæŒ‡ç¤ºB&#43;æ ‘åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„å­˜å‚¨ä½ç½®ã€‚BP_INVALID_PAGE_NUM è¡¨ç¤ºä¸€ä¸ªæ— æ•ˆçš„é¡µå·ã€‚
int32_t internal_max_sizeï¼š
è¿™æ˜¯å†…éƒ¨èŠ‚ç‚¹ä¸­å¯ä»¥å­˜å‚¨çš„æœ€å¤§é”®å€¼å¯¹æ•°ã€‚å¯¹äºä¸€ä¸ªB&#43;æ ‘çš„å†…éƒ¨èŠ‚ç‚¹è€Œè¨€ï¼Œå®ƒå­˜å‚¨çš„æ˜¯ç´¢å¼•ä¿¡æ¯å’ŒæŒ‡å‘å­èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œå› æ­¤è¿™ä¸ªå€¼å†³å®šäº†å†…éƒ¨èŠ‚ç‚¹çš„åˆ†è£‚å’Œåˆå¹¶ç­–ç•¥ã€‚
int32_t leaf_max_sizeï¼š
å¶å­èŠ‚ç‚¹å¯ä»¥å­˜å‚¨çš„æœ€å¤§é”®å€¼å¯¹æ•°ã€‚å¶å­èŠ‚ç‚¹ä¸­å­˜å‚¨çš„æ˜¯å®é™…çš„æ•°æ®ï¼Œå®šä¹‰äº†B&#43;æ ‘ä¸­å¶å­èŠ‚ç‚¹çš„å­˜å‚¨å®¹é‡ï¼Œå½±å“äº†B&#43;æ ‘çš„æ·±åº¦å’ŒæŸ¥æ‰¾æ•ˆç‡ã€‚
int32_t attr_lengthï¼š
é”®å€¼çš„é•¿åº¦ï¼Œé€šå¸¸æ˜¯æŒ‡æ•°æ®åº“ä¸­ç´¢å¼•å­—æ®µçš„é•¿åº¦ã€‚å®ƒå†³å®šäº†æ¯ä¸ªé”®åœ¨æ ‘ä¸­å æ®çš„ç©ºé—´å¤§å°ã€‚
int32_t key_lengthï¼š
è¯¥å˜é‡è¡¨ç¤ºé”®å€¼çš„æ€»é•¿åº¦ï¼Œå³ attr_length åŠ ä¸Š sizeof(RID)ï¼Œå…¶ä¸­ RID æ˜¯æ•°æ®åº“ä¸­çš„è®°å½•æ ‡è¯†ç¬¦ï¼ˆRecord IDï¼‰ã€‚è¿™æ ·å¯ä»¥å­˜å‚¨ç´¢å¼•é”®åŠå…¶å¯¹åº”çš„è®°å½•ä½ç½®ã€‚
AttrType attr_typeï¼š
é”®å€¼çš„ç±»å‹ï¼Œå®šä¹‰äº†ç´¢å¼•æ‰€ä¾èµ–çš„å±æ€§ç±»å‹ï¼ˆå¦‚æ•´æ•°ã€å­—ç¬¦ä¸²ç­‰ï¼‰ã€‚è¯¥æšä¸¾ç±»å‹ç”¨äºæè¿°é”®å€¼çš„å®é™…æ•°æ®ç±»å‹ã€‚">
    <meta name="generator" content="Hugo 0.145.0">
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >




    


    
      

    

    

    
      <link rel="canonical" href="http://localhost:1313/posts/miniob-b&#43;%E6%A0%91/">
    

    <meta property="og:url" content="http://localhost:1313/posts/miniob-b&#43;%E6%A0%91/">
  <meta property="og:site_name" content="Wei Haoyu">
  <meta property="og:title" content="Wei Haoyu">
  <meta property="og:description" content="ç‚¹å‡»è¿”å›ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•
ç›®å½• {:toc} 1. B&#43;æ ‘ä»‹ç» B&#43;æ ‘æ˜¯ä¸€ç§å¹³è¡¡çš„æ ‘å½¢æ•°æ®ç»“æ„ï¼Œé€šå¸¸ç”¨äºæ•°æ®åº“å’Œæ–‡ä»¶ç³»ç»Ÿç­‰éœ€è¦é¢‘ç¹è¿›è¡Œç£ç›˜å­˜å–çš„å¤§å‹æ•°æ®ç®¡ç†ç³»ç»Ÿã€‚å®ƒæ˜¯Bæ ‘çš„æ‰©å±•ç‰ˆæœ¬ï¼Œå…·æœ‰æ›´é«˜æ•ˆçš„æŸ¥è¯¢å’ŒèŒƒå›´æŸ¥è¯¢èƒ½åŠ›ã€‚B&#43;æ ‘çš„è®¾è®¡åˆè¡·æ˜¯ä¸ºäº†ä¼˜åŒ–ç£ç›˜å­˜å–çš„æ•ˆç‡ï¼Œå› è€Œåœ¨å¤„ç†å¤§è§„æ¨¡æ•°æ®æ—¶éå¸¸é€‚åˆã€‚
1.1 B&#43;æ ‘çš„ç»“æ„ç‰¹ç‚¹ æ‰€æœ‰å…³é”®å­—éƒ½å‡ºç°åœ¨å¶å­èŠ‚ç‚¹ï¼š
B&#43;æ ‘ä¸Bæ ‘çš„ä¸»è¦åŒºåˆ«ä¹‹ä¸€æ˜¯ï¼ŒB&#43;æ ‘ä¸­æ‰€æœ‰çš„å…³é”®å­—éƒ½å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ä¸­ï¼Œå†…éƒ¨èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•ä¿¡æ¯ã€‚å¶å­èŠ‚ç‚¹æŒ‰ç…§å…³é”®å­—çš„é¡ºåºæ’åˆ—ï¼Œå¹¶é€šè¿‡æŒ‡é’ˆè¿æ¥ï¼Œå½¢æˆä¸€ä¸ªæœ‰åºçš„é“¾è¡¨ã€‚
å†…èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•è€Œä¸å­˜å‚¨æ•°æ®ï¼š
B&#43;æ ‘çš„éå¶å­èŠ‚ç‚¹ï¼ˆå†…èŠ‚ç‚¹ï¼‰ä¸å­˜å‚¨å®é™…æ•°æ®ï¼Œå®ƒä»¬åªæ˜¯ç”¨äºæŒ‡å¼•æŸ¥è¯¢è·¯å¾„çš„ç´¢å¼•ï¼ŒæŒ‡å‘å­æ ‘æˆ–å¶å­èŠ‚ç‚¹ã€‚
æ‰€æœ‰å¶å­èŠ‚ç‚¹åœ¨åŒä¸€å±‚ï¼š
B&#43;æ ‘æ˜¯é«˜åº¦å¹³è¡¡çš„ï¼Œå³æ‰€æœ‰å¶å­èŠ‚ç‚¹éƒ½åœ¨åŒä¸€å±‚ï¼Œç¡®ä¿æŸ¥è¯¢æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¸ºO(log n)ï¼Œå…¶ä¸­næ˜¯æ•°æ®é¡¹çš„æ€»æ•°ã€‚
å¶å­èŠ‚ç‚¹é“¾è¡¨ç»“æ„ï¼š
å¶å­èŠ‚ç‚¹ä¹‹é—´æ˜¯æœ‰åºé“¾è¡¨ï¼Œæ„å‘³ç€åœ¨è¿›è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶ï¼Œå¯ä»¥é€šè¿‡å¶å­èŠ‚ç‚¹çš„é¡ºåºè®¿é—®å¿«é€Ÿè·å–ä¸€ç»„è¿ç»­çš„ç»“æœã€‚
1.2 B&#43;æ ‘çš„ä¼˜ç‚¹ èŒƒå›´æŸ¥è¯¢æ€§èƒ½ä¼˜å¼‚ï¼š
ç”±äºå¶å­èŠ‚ç‚¹ä¹‹é—´çš„é“¾è¡¨ç»“æ„ï¼ŒB&#43;æ ‘åœ¨å¤„ç†èŒƒå›´æŸ¥è¯¢æ—¶è¡¨ç°æä¸ºä¼˜ç§€ï¼Œå¯ä»¥ä»èµ·å§‹ä½ç½®æ²¿ç€é“¾è¡¨é¡ºåºè¯»å–ã€‚
ç£ç›˜I/Oä¼˜åŒ–ï¼š
B&#43;æ ‘çš„è®¾è®¡ç›®æ ‡æ˜¯å‡å°‘ç£ç›˜I/Oæ“ä½œã€‚å†…èŠ‚ç‚¹ä¸å­˜å‚¨å®é™…æ•°æ®ï¼Œå› æ­¤å¯ä»¥å°†æ›´å¤šçš„ç´¢å¼•èŠ‚ç‚¹æ”¾å…¥å†…å­˜ä¸­ï¼Œå‡å°‘ä»ç£ç›˜è¯»å–æ•°æ®çš„æ¬¡æ•°ã€‚
å¹³è¡¡æ€§ï¼š
B&#43;æ ‘æ˜¯ä¸€ç§å¹³è¡¡æ ‘ï¼Œä¿è¯äº†æ’å…¥ã€åˆ é™¤ã€æŸ¥è¯¢æ“ä½œçš„æ—¶é—´å¤æ‚åº¦å§‹ç»ˆä¿æŒåœ¨O(log n)ã€‚
å­˜å‚¨å¯†åº¦é«˜ï¼š
ç”±äºå†…èŠ‚ç‚¹ä¸å­˜å‚¨æ•°æ®ï¼ŒB&#43;æ ‘å¯ä»¥å°†æ›´å¤šçš„ç´¢å¼•èŠ‚ç‚¹æ”¾å…¥å†…å­˜ï¼Œä»è€Œæœ‰æ•ˆåˆ©ç”¨ç³»ç»Ÿçš„ç¼“å­˜ã€‚
1.3 B&#43;æ ‘çš„åº”ç”¨åœºæ™¯ æ•°æ®åº“ç³»ç»Ÿï¼š
åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼ŒB&#43;æ ‘å¸¸ç”¨äºå®ç°ç´¢å¼•ï¼Œå¦‚MySQLä¸­çš„InnoDBå­˜å‚¨å¼•æ“å°±ä½¿ç”¨B&#43;æ ‘ä½œä¸ºå…¶ä¸»é”®ç´¢å¼•ç»“æ„ã€‚
æ–‡ä»¶ç³»ç»Ÿï¼š
ä¸€äº›æ–‡ä»¶ç³»ç»Ÿï¼Œå¦‚NTFSï¼Œä¹Ÿé‡‡ç”¨B&#43;æ ‘æ¥ç®¡ç†æ–‡ä»¶å’Œç›®å½•æ•°æ®ã€‚
å¤§è§„æ¨¡æ•°æ®å­˜å‚¨ï¼š
B&#43;æ ‘ç‰¹åˆ«é€‚åˆéœ€è¦åœ¨ç£ç›˜ä¸­ç®¡ç†å¤§è§„æ¨¡æ•°æ®çš„åœºæ™¯ï¼Œèƒ½å¤Ÿå¾ˆå¥½åœ°å¤„ç†ç£ç›˜I/Oã€‚
1.4 B&#43;æ ‘ä¸Bæ ‘çš„åŒºåˆ« æ•°æ®å­˜å‚¨ä½ç½®ï¼š
Bæ ‘çš„æ•°æ®æ—¢å­˜å‚¨åœ¨å†…èŠ‚ç‚¹ä¹Ÿå­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼Œè€ŒB&#43;æ ‘çš„æ•°æ®åªå­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ã€‚
èŒƒå›´æŸ¥è¯¢æ•ˆç‡ï¼š
ç”±äºB&#43;æ ‘çš„å¶å­èŠ‚ç‚¹æ„æˆé“¾è¡¨ç»“æ„ï¼Œè¿›è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶å¯ä»¥ç›´æ¥ä»é“¾è¡¨ä¸­éå†ï¼Œè€ŒBæ ‘åˆ™éœ€è¦æ›´å¤šçš„æ ‘éå†æ“ä½œã€‚
èŠ‚ç‚¹ç»“æ„ï¼š
B&#43;æ ‘çš„å†…èŠ‚ç‚¹æ›´ä¸ºç´§å‡‘ï¼Œå› ä¸ºå®ƒä»¬åªå­˜å‚¨ç´¢å¼•ï¼Œè€ŒBæ ‘çš„å†…èŠ‚ç‚¹å­˜å‚¨ç´¢å¼•å’Œæ•°æ®ã€‚
2. B&#43;æ ‘åœ¨miniobçš„åº”ç”¨ 2.1 B&#43;æ ‘çš„ç»“æ„ä¸èŠ‚ç‚¹ 2.1.1 IndexFileHeader IndexFileHeaderï¼š
ç”¨äºå­˜å‚¨ B&#43; æ ‘çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬æ ¹èŠ‚ç‚¹é¡µé¢ç¼–å·ã€å†…éƒ¨èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹çš„æœ€å¤§å¤§å°ã€å±æ€§é•¿åº¦ç­‰ã€‚
struct IndexFileHeader { IndexFileHeader() { memset(this, 0, sizeof(IndexFileHeader)); root_page = BP_INVALID_PAGE_NUM; } PageNum root_page; ///&lt; æ ¹èŠ‚ç‚¹åœ¨ç£ç›˜ä¸­çš„é¡µå· int32_t internal_max_size; ///&lt; å†…éƒ¨èŠ‚ç‚¹æœ€å¤§çš„é”®å€¼å¯¹æ•° int32_t leaf_max_size; ///&lt; å¶å­èŠ‚ç‚¹æœ€å¤§çš„é”®å€¼å¯¹æ•° int32_t attr_length; ///&lt; é”®å€¼çš„é•¿åº¦ int32_t key_length; ///&lt; attr length &#43; sizeof(RID) AttrType attr_type; ///&lt; é”®å€¼çš„ç±»å‹ const string to_string() const { stringstream ss; ss &lt;&lt; &#34;attr_length:&#34; &lt;&lt; attr_length &lt;&lt; &#34;,&#34; &lt;&lt; &#34;key_length:&#34; &lt;&lt; key_length &lt;&lt; &#34;,&#34; &lt;&lt; &#34;attr_type:&#34; &lt;&lt; attr_type_to_string(attr_type) &lt;&lt; &#34;,&#34; &lt;&lt; &#34;root_page:&#34; &lt;&lt; root_page &lt;&lt; &#34;,&#34; &lt;&lt; &#34;internal_max_size:&#34; &lt;&lt; internal_max_size &lt;&lt; &#34;,&#34; &lt;&lt; &#34;leaf_max_size:&#34; &lt;&lt; leaf_max_size &lt;&lt; &#34;;&#34;; return ss.str(); } }; PageNum root_pageï¼š
è¯¥å˜é‡å­˜å‚¨äº†æ ¹èŠ‚ç‚¹åœ¨ç£ç›˜ä¸­çš„é¡µå·ï¼Œç”¨äºæŒ‡ç¤ºB&#43;æ ‘åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„å­˜å‚¨ä½ç½®ã€‚BP_INVALID_PAGE_NUM è¡¨ç¤ºä¸€ä¸ªæ— æ•ˆçš„é¡µå·ã€‚
int32_t internal_max_sizeï¼š
è¿™æ˜¯å†…éƒ¨èŠ‚ç‚¹ä¸­å¯ä»¥å­˜å‚¨çš„æœ€å¤§é”®å€¼å¯¹æ•°ã€‚å¯¹äºä¸€ä¸ªB&#43;æ ‘çš„å†…éƒ¨èŠ‚ç‚¹è€Œè¨€ï¼Œå®ƒå­˜å‚¨çš„æ˜¯ç´¢å¼•ä¿¡æ¯å’ŒæŒ‡å‘å­èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œå› æ­¤è¿™ä¸ªå€¼å†³å®šäº†å†…éƒ¨èŠ‚ç‚¹çš„åˆ†è£‚å’Œåˆå¹¶ç­–ç•¥ã€‚
int32_t leaf_max_sizeï¼š
å¶å­èŠ‚ç‚¹å¯ä»¥å­˜å‚¨çš„æœ€å¤§é”®å€¼å¯¹æ•°ã€‚å¶å­èŠ‚ç‚¹ä¸­å­˜å‚¨çš„æ˜¯å®é™…çš„æ•°æ®ï¼Œå®šä¹‰äº†B&#43;æ ‘ä¸­å¶å­èŠ‚ç‚¹çš„å­˜å‚¨å®¹é‡ï¼Œå½±å“äº†B&#43;æ ‘çš„æ·±åº¦å’ŒæŸ¥æ‰¾æ•ˆç‡ã€‚
int32_t attr_lengthï¼š
é”®å€¼çš„é•¿åº¦ï¼Œé€šå¸¸æ˜¯æŒ‡æ•°æ®åº“ä¸­ç´¢å¼•å­—æ®µçš„é•¿åº¦ã€‚å®ƒå†³å®šäº†æ¯ä¸ªé”®åœ¨æ ‘ä¸­å æ®çš„ç©ºé—´å¤§å°ã€‚
int32_t key_lengthï¼š
è¯¥å˜é‡è¡¨ç¤ºé”®å€¼çš„æ€»é•¿åº¦ï¼Œå³ attr_length åŠ ä¸Š sizeof(RID)ï¼Œå…¶ä¸­ RID æ˜¯æ•°æ®åº“ä¸­çš„è®°å½•æ ‡è¯†ç¬¦ï¼ˆRecord IDï¼‰ã€‚è¿™æ ·å¯ä»¥å­˜å‚¨ç´¢å¼•é”®åŠå…¶å¯¹åº”çš„è®°å½•ä½ç½®ã€‚
AttrType attr_typeï¼š
é”®å€¼çš„ç±»å‹ï¼Œå®šä¹‰äº†ç´¢å¼•æ‰€ä¾èµ–çš„å±æ€§ç±»å‹ï¼ˆå¦‚æ•´æ•°ã€å­—ç¬¦ä¸²ç­‰ï¼‰ã€‚è¯¥æšä¸¾ç±»å‹ç”¨äºæè¿°é”®å€¼çš„å®é™…æ•°æ®ç±»å‹ã€‚">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">

  <meta itemprop="name" content="Wei Haoyu">
  <meta itemprop="description" content="ç‚¹å‡»è¿”å›ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•
ç›®å½• {:toc} 1. B&#43;æ ‘ä»‹ç» B&#43;æ ‘æ˜¯ä¸€ç§å¹³è¡¡çš„æ ‘å½¢æ•°æ®ç»“æ„ï¼Œé€šå¸¸ç”¨äºæ•°æ®åº“å’Œæ–‡ä»¶ç³»ç»Ÿç­‰éœ€è¦é¢‘ç¹è¿›è¡Œç£ç›˜å­˜å–çš„å¤§å‹æ•°æ®ç®¡ç†ç³»ç»Ÿã€‚å®ƒæ˜¯Bæ ‘çš„æ‰©å±•ç‰ˆæœ¬ï¼Œå…·æœ‰æ›´é«˜æ•ˆçš„æŸ¥è¯¢å’ŒèŒƒå›´æŸ¥è¯¢èƒ½åŠ›ã€‚B&#43;æ ‘çš„è®¾è®¡åˆè¡·æ˜¯ä¸ºäº†ä¼˜åŒ–ç£ç›˜å­˜å–çš„æ•ˆç‡ï¼Œå› è€Œåœ¨å¤„ç†å¤§è§„æ¨¡æ•°æ®æ—¶éå¸¸é€‚åˆã€‚
1.1 B&#43;æ ‘çš„ç»“æ„ç‰¹ç‚¹ æ‰€æœ‰å…³é”®å­—éƒ½å‡ºç°åœ¨å¶å­èŠ‚ç‚¹ï¼š
B&#43;æ ‘ä¸Bæ ‘çš„ä¸»è¦åŒºåˆ«ä¹‹ä¸€æ˜¯ï¼ŒB&#43;æ ‘ä¸­æ‰€æœ‰çš„å…³é”®å­—éƒ½å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ä¸­ï¼Œå†…éƒ¨èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•ä¿¡æ¯ã€‚å¶å­èŠ‚ç‚¹æŒ‰ç…§å…³é”®å­—çš„é¡ºåºæ’åˆ—ï¼Œå¹¶é€šè¿‡æŒ‡é’ˆè¿æ¥ï¼Œå½¢æˆä¸€ä¸ªæœ‰åºçš„é“¾è¡¨ã€‚
å†…èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•è€Œä¸å­˜å‚¨æ•°æ®ï¼š
B&#43;æ ‘çš„éå¶å­èŠ‚ç‚¹ï¼ˆå†…èŠ‚ç‚¹ï¼‰ä¸å­˜å‚¨å®é™…æ•°æ®ï¼Œå®ƒä»¬åªæ˜¯ç”¨äºæŒ‡å¼•æŸ¥è¯¢è·¯å¾„çš„ç´¢å¼•ï¼ŒæŒ‡å‘å­æ ‘æˆ–å¶å­èŠ‚ç‚¹ã€‚
æ‰€æœ‰å¶å­èŠ‚ç‚¹åœ¨åŒä¸€å±‚ï¼š
B&#43;æ ‘æ˜¯é«˜åº¦å¹³è¡¡çš„ï¼Œå³æ‰€æœ‰å¶å­èŠ‚ç‚¹éƒ½åœ¨åŒä¸€å±‚ï¼Œç¡®ä¿æŸ¥è¯¢æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¸ºO(log n)ï¼Œå…¶ä¸­næ˜¯æ•°æ®é¡¹çš„æ€»æ•°ã€‚
å¶å­èŠ‚ç‚¹é“¾è¡¨ç»“æ„ï¼š
å¶å­èŠ‚ç‚¹ä¹‹é—´æ˜¯æœ‰åºé“¾è¡¨ï¼Œæ„å‘³ç€åœ¨è¿›è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶ï¼Œå¯ä»¥é€šè¿‡å¶å­èŠ‚ç‚¹çš„é¡ºåºè®¿é—®å¿«é€Ÿè·å–ä¸€ç»„è¿ç»­çš„ç»“æœã€‚
1.2 B&#43;æ ‘çš„ä¼˜ç‚¹ èŒƒå›´æŸ¥è¯¢æ€§èƒ½ä¼˜å¼‚ï¼š
ç”±äºå¶å­èŠ‚ç‚¹ä¹‹é—´çš„é“¾è¡¨ç»“æ„ï¼ŒB&#43;æ ‘åœ¨å¤„ç†èŒƒå›´æŸ¥è¯¢æ—¶è¡¨ç°æä¸ºä¼˜ç§€ï¼Œå¯ä»¥ä»èµ·å§‹ä½ç½®æ²¿ç€é“¾è¡¨é¡ºåºè¯»å–ã€‚
ç£ç›˜I/Oä¼˜åŒ–ï¼š
B&#43;æ ‘çš„è®¾è®¡ç›®æ ‡æ˜¯å‡å°‘ç£ç›˜I/Oæ“ä½œã€‚å†…èŠ‚ç‚¹ä¸å­˜å‚¨å®é™…æ•°æ®ï¼Œå› æ­¤å¯ä»¥å°†æ›´å¤šçš„ç´¢å¼•èŠ‚ç‚¹æ”¾å…¥å†…å­˜ä¸­ï¼Œå‡å°‘ä»ç£ç›˜è¯»å–æ•°æ®çš„æ¬¡æ•°ã€‚
å¹³è¡¡æ€§ï¼š
B&#43;æ ‘æ˜¯ä¸€ç§å¹³è¡¡æ ‘ï¼Œä¿è¯äº†æ’å…¥ã€åˆ é™¤ã€æŸ¥è¯¢æ“ä½œçš„æ—¶é—´å¤æ‚åº¦å§‹ç»ˆä¿æŒåœ¨O(log n)ã€‚
å­˜å‚¨å¯†åº¦é«˜ï¼š
ç”±äºå†…èŠ‚ç‚¹ä¸å­˜å‚¨æ•°æ®ï¼ŒB&#43;æ ‘å¯ä»¥å°†æ›´å¤šçš„ç´¢å¼•èŠ‚ç‚¹æ”¾å…¥å†…å­˜ï¼Œä»è€Œæœ‰æ•ˆåˆ©ç”¨ç³»ç»Ÿçš„ç¼“å­˜ã€‚
1.3 B&#43;æ ‘çš„åº”ç”¨åœºæ™¯ æ•°æ®åº“ç³»ç»Ÿï¼š
åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼ŒB&#43;æ ‘å¸¸ç”¨äºå®ç°ç´¢å¼•ï¼Œå¦‚MySQLä¸­çš„InnoDBå­˜å‚¨å¼•æ“å°±ä½¿ç”¨B&#43;æ ‘ä½œä¸ºå…¶ä¸»é”®ç´¢å¼•ç»“æ„ã€‚
æ–‡ä»¶ç³»ç»Ÿï¼š
ä¸€äº›æ–‡ä»¶ç³»ç»Ÿï¼Œå¦‚NTFSï¼Œä¹Ÿé‡‡ç”¨B&#43;æ ‘æ¥ç®¡ç†æ–‡ä»¶å’Œç›®å½•æ•°æ®ã€‚
å¤§è§„æ¨¡æ•°æ®å­˜å‚¨ï¼š
B&#43;æ ‘ç‰¹åˆ«é€‚åˆéœ€è¦åœ¨ç£ç›˜ä¸­ç®¡ç†å¤§è§„æ¨¡æ•°æ®çš„åœºæ™¯ï¼Œèƒ½å¤Ÿå¾ˆå¥½åœ°å¤„ç†ç£ç›˜I/Oã€‚
1.4 B&#43;æ ‘ä¸Bæ ‘çš„åŒºåˆ« æ•°æ®å­˜å‚¨ä½ç½®ï¼š
Bæ ‘çš„æ•°æ®æ—¢å­˜å‚¨åœ¨å†…èŠ‚ç‚¹ä¹Ÿå­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼Œè€ŒB&#43;æ ‘çš„æ•°æ®åªå­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ã€‚
èŒƒå›´æŸ¥è¯¢æ•ˆç‡ï¼š
ç”±äºB&#43;æ ‘çš„å¶å­èŠ‚ç‚¹æ„æˆé“¾è¡¨ç»“æ„ï¼Œè¿›è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶å¯ä»¥ç›´æ¥ä»é“¾è¡¨ä¸­éå†ï¼Œè€ŒBæ ‘åˆ™éœ€è¦æ›´å¤šçš„æ ‘éå†æ“ä½œã€‚
èŠ‚ç‚¹ç»“æ„ï¼š
B&#43;æ ‘çš„å†…èŠ‚ç‚¹æ›´ä¸ºç´§å‡‘ï¼Œå› ä¸ºå®ƒä»¬åªå­˜å‚¨ç´¢å¼•ï¼Œè€ŒBæ ‘çš„å†…èŠ‚ç‚¹å­˜å‚¨ç´¢å¼•å’Œæ•°æ®ã€‚
2. B&#43;æ ‘åœ¨miniobçš„åº”ç”¨ 2.1 B&#43;æ ‘çš„ç»“æ„ä¸èŠ‚ç‚¹ 2.1.1 IndexFileHeader IndexFileHeaderï¼š
ç”¨äºå­˜å‚¨ B&#43; æ ‘çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬æ ¹èŠ‚ç‚¹é¡µé¢ç¼–å·ã€å†…éƒ¨èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹çš„æœ€å¤§å¤§å°ã€å±æ€§é•¿åº¦ç­‰ã€‚
struct IndexFileHeader { IndexFileHeader() { memset(this, 0, sizeof(IndexFileHeader)); root_page = BP_INVALID_PAGE_NUM; } PageNum root_page; ///&lt; æ ¹èŠ‚ç‚¹åœ¨ç£ç›˜ä¸­çš„é¡µå· int32_t internal_max_size; ///&lt; å†…éƒ¨èŠ‚ç‚¹æœ€å¤§çš„é”®å€¼å¯¹æ•° int32_t leaf_max_size; ///&lt; å¶å­èŠ‚ç‚¹æœ€å¤§çš„é”®å€¼å¯¹æ•° int32_t attr_length; ///&lt; é”®å€¼çš„é•¿åº¦ int32_t key_length; ///&lt; attr length &#43; sizeof(RID) AttrType attr_type; ///&lt; é”®å€¼çš„ç±»å‹ const string to_string() const { stringstream ss; ss &lt;&lt; &#34;attr_length:&#34; &lt;&lt; attr_length &lt;&lt; &#34;,&#34; &lt;&lt; &#34;key_length:&#34; &lt;&lt; key_length &lt;&lt; &#34;,&#34; &lt;&lt; &#34;attr_type:&#34; &lt;&lt; attr_type_to_string(attr_type) &lt;&lt; &#34;,&#34; &lt;&lt; &#34;root_page:&#34; &lt;&lt; root_page &lt;&lt; &#34;,&#34; &lt;&lt; &#34;internal_max_size:&#34; &lt;&lt; internal_max_size &lt;&lt; &#34;,&#34; &lt;&lt; &#34;leaf_max_size:&#34; &lt;&lt; leaf_max_size &lt;&lt; &#34;;&#34;; return ss.str(); } }; PageNum root_pageï¼š
è¯¥å˜é‡å­˜å‚¨äº†æ ¹èŠ‚ç‚¹åœ¨ç£ç›˜ä¸­çš„é¡µå·ï¼Œç”¨äºæŒ‡ç¤ºB&#43;æ ‘åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„å­˜å‚¨ä½ç½®ã€‚BP_INVALID_PAGE_NUM è¡¨ç¤ºä¸€ä¸ªæ— æ•ˆçš„é¡µå·ã€‚
int32_t internal_max_sizeï¼š
è¿™æ˜¯å†…éƒ¨èŠ‚ç‚¹ä¸­å¯ä»¥å­˜å‚¨çš„æœ€å¤§é”®å€¼å¯¹æ•°ã€‚å¯¹äºä¸€ä¸ªB&#43;æ ‘çš„å†…éƒ¨èŠ‚ç‚¹è€Œè¨€ï¼Œå®ƒå­˜å‚¨çš„æ˜¯ç´¢å¼•ä¿¡æ¯å’ŒæŒ‡å‘å­èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œå› æ­¤è¿™ä¸ªå€¼å†³å®šäº†å†…éƒ¨èŠ‚ç‚¹çš„åˆ†è£‚å’Œåˆå¹¶ç­–ç•¥ã€‚
int32_t leaf_max_sizeï¼š
å¶å­èŠ‚ç‚¹å¯ä»¥å­˜å‚¨çš„æœ€å¤§é”®å€¼å¯¹æ•°ã€‚å¶å­èŠ‚ç‚¹ä¸­å­˜å‚¨çš„æ˜¯å®é™…çš„æ•°æ®ï¼Œå®šä¹‰äº†B&#43;æ ‘ä¸­å¶å­èŠ‚ç‚¹çš„å­˜å‚¨å®¹é‡ï¼Œå½±å“äº†B&#43;æ ‘çš„æ·±åº¦å’ŒæŸ¥æ‰¾æ•ˆç‡ã€‚
int32_t attr_lengthï¼š
é”®å€¼çš„é•¿åº¦ï¼Œé€šå¸¸æ˜¯æŒ‡æ•°æ®åº“ä¸­ç´¢å¼•å­—æ®µçš„é•¿åº¦ã€‚å®ƒå†³å®šäº†æ¯ä¸ªé”®åœ¨æ ‘ä¸­å æ®çš„ç©ºé—´å¤§å°ã€‚
int32_t key_lengthï¼š
è¯¥å˜é‡è¡¨ç¤ºé”®å€¼çš„æ€»é•¿åº¦ï¼Œå³ attr_length åŠ ä¸Š sizeof(RID)ï¼Œå…¶ä¸­ RID æ˜¯æ•°æ®åº“ä¸­çš„è®°å½•æ ‡è¯†ç¬¦ï¼ˆRecord IDï¼‰ã€‚è¿™æ ·å¯ä»¥å­˜å‚¨ç´¢å¼•é”®åŠå…¶å¯¹åº”çš„è®°å½•ä½ç½®ã€‚
AttrType attr_typeï¼š
é”®å€¼çš„ç±»å‹ï¼Œå®šä¹‰äº†ç´¢å¼•æ‰€ä¾èµ–çš„å±æ€§ç±»å‹ï¼ˆå¦‚æ•´æ•°ã€å­—ç¬¦ä¸²ç­‰ï¼‰ã€‚è¯¥æšä¸¾ç±»å‹ç”¨äºæè¿°é”®å€¼çš„å®é™…æ•°æ®ç±»å‹ã€‚">
  <meta itemprop="wordCount" content="1430">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Wei Haoyu">
  <meta name="twitter:description" content="ç‚¹å‡»è¿”å›ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•
ç›®å½• {:toc} 1. B&#43;æ ‘ä»‹ç» B&#43;æ ‘æ˜¯ä¸€ç§å¹³è¡¡çš„æ ‘å½¢æ•°æ®ç»“æ„ï¼Œé€šå¸¸ç”¨äºæ•°æ®åº“å’Œæ–‡ä»¶ç³»ç»Ÿç­‰éœ€è¦é¢‘ç¹è¿›è¡Œç£ç›˜å­˜å–çš„å¤§å‹æ•°æ®ç®¡ç†ç³»ç»Ÿã€‚å®ƒæ˜¯Bæ ‘çš„æ‰©å±•ç‰ˆæœ¬ï¼Œå…·æœ‰æ›´é«˜æ•ˆçš„æŸ¥è¯¢å’ŒèŒƒå›´æŸ¥è¯¢èƒ½åŠ›ã€‚B&#43;æ ‘çš„è®¾è®¡åˆè¡·æ˜¯ä¸ºäº†ä¼˜åŒ–ç£ç›˜å­˜å–çš„æ•ˆç‡ï¼Œå› è€Œåœ¨å¤„ç†å¤§è§„æ¨¡æ•°æ®æ—¶éå¸¸é€‚åˆã€‚
1.1 B&#43;æ ‘çš„ç»“æ„ç‰¹ç‚¹ æ‰€æœ‰å…³é”®å­—éƒ½å‡ºç°åœ¨å¶å­èŠ‚ç‚¹ï¼š
B&#43;æ ‘ä¸Bæ ‘çš„ä¸»è¦åŒºåˆ«ä¹‹ä¸€æ˜¯ï¼ŒB&#43;æ ‘ä¸­æ‰€æœ‰çš„å…³é”®å­—éƒ½å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ä¸­ï¼Œå†…éƒ¨èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•ä¿¡æ¯ã€‚å¶å­èŠ‚ç‚¹æŒ‰ç…§å…³é”®å­—çš„é¡ºåºæ’åˆ—ï¼Œå¹¶é€šè¿‡æŒ‡é’ˆè¿æ¥ï¼Œå½¢æˆä¸€ä¸ªæœ‰åºçš„é“¾è¡¨ã€‚
å†…èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•è€Œä¸å­˜å‚¨æ•°æ®ï¼š
B&#43;æ ‘çš„éå¶å­èŠ‚ç‚¹ï¼ˆå†…èŠ‚ç‚¹ï¼‰ä¸å­˜å‚¨å®é™…æ•°æ®ï¼Œå®ƒä»¬åªæ˜¯ç”¨äºæŒ‡å¼•æŸ¥è¯¢è·¯å¾„çš„ç´¢å¼•ï¼ŒæŒ‡å‘å­æ ‘æˆ–å¶å­èŠ‚ç‚¹ã€‚
æ‰€æœ‰å¶å­èŠ‚ç‚¹åœ¨åŒä¸€å±‚ï¼š
B&#43;æ ‘æ˜¯é«˜åº¦å¹³è¡¡çš„ï¼Œå³æ‰€æœ‰å¶å­èŠ‚ç‚¹éƒ½åœ¨åŒä¸€å±‚ï¼Œç¡®ä¿æŸ¥è¯¢æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¸ºO(log n)ï¼Œå…¶ä¸­næ˜¯æ•°æ®é¡¹çš„æ€»æ•°ã€‚
å¶å­èŠ‚ç‚¹é“¾è¡¨ç»“æ„ï¼š
å¶å­èŠ‚ç‚¹ä¹‹é—´æ˜¯æœ‰åºé“¾è¡¨ï¼Œæ„å‘³ç€åœ¨è¿›è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶ï¼Œå¯ä»¥é€šè¿‡å¶å­èŠ‚ç‚¹çš„é¡ºåºè®¿é—®å¿«é€Ÿè·å–ä¸€ç»„è¿ç»­çš„ç»“æœã€‚
1.2 B&#43;æ ‘çš„ä¼˜ç‚¹ èŒƒå›´æŸ¥è¯¢æ€§èƒ½ä¼˜å¼‚ï¼š
ç”±äºå¶å­èŠ‚ç‚¹ä¹‹é—´çš„é“¾è¡¨ç»“æ„ï¼ŒB&#43;æ ‘åœ¨å¤„ç†èŒƒå›´æŸ¥è¯¢æ—¶è¡¨ç°æä¸ºä¼˜ç§€ï¼Œå¯ä»¥ä»èµ·å§‹ä½ç½®æ²¿ç€é“¾è¡¨é¡ºåºè¯»å–ã€‚
ç£ç›˜I/Oä¼˜åŒ–ï¼š
B&#43;æ ‘çš„è®¾è®¡ç›®æ ‡æ˜¯å‡å°‘ç£ç›˜I/Oæ“ä½œã€‚å†…èŠ‚ç‚¹ä¸å­˜å‚¨å®é™…æ•°æ®ï¼Œå› æ­¤å¯ä»¥å°†æ›´å¤šçš„ç´¢å¼•èŠ‚ç‚¹æ”¾å…¥å†…å­˜ä¸­ï¼Œå‡å°‘ä»ç£ç›˜è¯»å–æ•°æ®çš„æ¬¡æ•°ã€‚
å¹³è¡¡æ€§ï¼š
B&#43;æ ‘æ˜¯ä¸€ç§å¹³è¡¡æ ‘ï¼Œä¿è¯äº†æ’å…¥ã€åˆ é™¤ã€æŸ¥è¯¢æ“ä½œçš„æ—¶é—´å¤æ‚åº¦å§‹ç»ˆä¿æŒåœ¨O(log n)ã€‚
å­˜å‚¨å¯†åº¦é«˜ï¼š
ç”±äºå†…èŠ‚ç‚¹ä¸å­˜å‚¨æ•°æ®ï¼ŒB&#43;æ ‘å¯ä»¥å°†æ›´å¤šçš„ç´¢å¼•èŠ‚ç‚¹æ”¾å…¥å†…å­˜ï¼Œä»è€Œæœ‰æ•ˆåˆ©ç”¨ç³»ç»Ÿçš„ç¼“å­˜ã€‚
1.3 B&#43;æ ‘çš„åº”ç”¨åœºæ™¯ æ•°æ®åº“ç³»ç»Ÿï¼š
åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼ŒB&#43;æ ‘å¸¸ç”¨äºå®ç°ç´¢å¼•ï¼Œå¦‚MySQLä¸­çš„InnoDBå­˜å‚¨å¼•æ“å°±ä½¿ç”¨B&#43;æ ‘ä½œä¸ºå…¶ä¸»é”®ç´¢å¼•ç»“æ„ã€‚
æ–‡ä»¶ç³»ç»Ÿï¼š
ä¸€äº›æ–‡ä»¶ç³»ç»Ÿï¼Œå¦‚NTFSï¼Œä¹Ÿé‡‡ç”¨B&#43;æ ‘æ¥ç®¡ç†æ–‡ä»¶å’Œç›®å½•æ•°æ®ã€‚
å¤§è§„æ¨¡æ•°æ®å­˜å‚¨ï¼š
B&#43;æ ‘ç‰¹åˆ«é€‚åˆéœ€è¦åœ¨ç£ç›˜ä¸­ç®¡ç†å¤§è§„æ¨¡æ•°æ®çš„åœºæ™¯ï¼Œèƒ½å¤Ÿå¾ˆå¥½åœ°å¤„ç†ç£ç›˜I/Oã€‚
1.4 B&#43;æ ‘ä¸Bæ ‘çš„åŒºåˆ« æ•°æ®å­˜å‚¨ä½ç½®ï¼š
Bæ ‘çš„æ•°æ®æ—¢å­˜å‚¨åœ¨å†…èŠ‚ç‚¹ä¹Ÿå­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼Œè€ŒB&#43;æ ‘çš„æ•°æ®åªå­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ã€‚
èŒƒå›´æŸ¥è¯¢æ•ˆç‡ï¼š
ç”±äºB&#43;æ ‘çš„å¶å­èŠ‚ç‚¹æ„æˆé“¾è¡¨ç»“æ„ï¼Œè¿›è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶å¯ä»¥ç›´æ¥ä»é“¾è¡¨ä¸­éå†ï¼Œè€ŒBæ ‘åˆ™éœ€è¦æ›´å¤šçš„æ ‘éå†æ“ä½œã€‚
èŠ‚ç‚¹ç»“æ„ï¼š
B&#43;æ ‘çš„å†…èŠ‚ç‚¹æ›´ä¸ºç´§å‡‘ï¼Œå› ä¸ºå®ƒä»¬åªå­˜å‚¨ç´¢å¼•ï¼Œè€ŒBæ ‘çš„å†…èŠ‚ç‚¹å­˜å‚¨ç´¢å¼•å’Œæ•°æ®ã€‚
2. B&#43;æ ‘åœ¨miniobçš„åº”ç”¨ 2.1 B&#43;æ ‘çš„ç»“æ„ä¸èŠ‚ç‚¹ 2.1.1 IndexFileHeader IndexFileHeaderï¼š
ç”¨äºå­˜å‚¨ B&#43; æ ‘çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬æ ¹èŠ‚ç‚¹é¡µé¢ç¼–å·ã€å†…éƒ¨èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹çš„æœ€å¤§å¤§å°ã€å±æ€§é•¿åº¦ç­‰ã€‚
struct IndexFileHeader { IndexFileHeader() { memset(this, 0, sizeof(IndexFileHeader)); root_page = BP_INVALID_PAGE_NUM; } PageNum root_page; ///&lt; æ ¹èŠ‚ç‚¹åœ¨ç£ç›˜ä¸­çš„é¡µå· int32_t internal_max_size; ///&lt; å†…éƒ¨èŠ‚ç‚¹æœ€å¤§çš„é”®å€¼å¯¹æ•° int32_t leaf_max_size; ///&lt; å¶å­èŠ‚ç‚¹æœ€å¤§çš„é”®å€¼å¯¹æ•° int32_t attr_length; ///&lt; é”®å€¼çš„é•¿åº¦ int32_t key_length; ///&lt; attr length &#43; sizeof(RID) AttrType attr_type; ///&lt; é”®å€¼çš„ç±»å‹ const string to_string() const { stringstream ss; ss &lt;&lt; &#34;attr_length:&#34; &lt;&lt; attr_length &lt;&lt; &#34;,&#34; &lt;&lt; &#34;key_length:&#34; &lt;&lt; key_length &lt;&lt; &#34;,&#34; &lt;&lt; &#34;attr_type:&#34; &lt;&lt; attr_type_to_string(attr_type) &lt;&lt; &#34;,&#34; &lt;&lt; &#34;root_page:&#34; &lt;&lt; root_page &lt;&lt; &#34;,&#34; &lt;&lt; &#34;internal_max_size:&#34; &lt;&lt; internal_max_size &lt;&lt; &#34;,&#34; &lt;&lt; &#34;leaf_max_size:&#34; &lt;&lt; leaf_max_size &lt;&lt; &#34;;&#34;; return ss.str(); } }; PageNum root_pageï¼š
è¯¥å˜é‡å­˜å‚¨äº†æ ¹èŠ‚ç‚¹åœ¨ç£ç›˜ä¸­çš„é¡µå·ï¼Œç”¨äºæŒ‡ç¤ºB&#43;æ ‘åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„å­˜å‚¨ä½ç½®ã€‚BP_INVALID_PAGE_NUM è¡¨ç¤ºä¸€ä¸ªæ— æ•ˆçš„é¡µå·ã€‚
int32_t internal_max_sizeï¼š
è¿™æ˜¯å†…éƒ¨èŠ‚ç‚¹ä¸­å¯ä»¥å­˜å‚¨çš„æœ€å¤§é”®å€¼å¯¹æ•°ã€‚å¯¹äºä¸€ä¸ªB&#43;æ ‘çš„å†…éƒ¨èŠ‚ç‚¹è€Œè¨€ï¼Œå®ƒå­˜å‚¨çš„æ˜¯ç´¢å¼•ä¿¡æ¯å’ŒæŒ‡å‘å­èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œå› æ­¤è¿™ä¸ªå€¼å†³å®šäº†å†…éƒ¨èŠ‚ç‚¹çš„åˆ†è£‚å’Œåˆå¹¶ç­–ç•¥ã€‚
int32_t leaf_max_sizeï¼š
å¶å­èŠ‚ç‚¹å¯ä»¥å­˜å‚¨çš„æœ€å¤§é”®å€¼å¯¹æ•°ã€‚å¶å­èŠ‚ç‚¹ä¸­å­˜å‚¨çš„æ˜¯å®é™…çš„æ•°æ®ï¼Œå®šä¹‰äº†B&#43;æ ‘ä¸­å¶å­èŠ‚ç‚¹çš„å­˜å‚¨å®¹é‡ï¼Œå½±å“äº†B&#43;æ ‘çš„æ·±åº¦å’ŒæŸ¥æ‰¾æ•ˆç‡ã€‚
int32_t attr_lengthï¼š
é”®å€¼çš„é•¿åº¦ï¼Œé€šå¸¸æ˜¯æŒ‡æ•°æ®åº“ä¸­ç´¢å¼•å­—æ®µçš„é•¿åº¦ã€‚å®ƒå†³å®šäº†æ¯ä¸ªé”®åœ¨æ ‘ä¸­å æ®çš„ç©ºé—´å¤§å°ã€‚
int32_t key_lengthï¼š
è¯¥å˜é‡è¡¨ç¤ºé”®å€¼çš„æ€»é•¿åº¦ï¼Œå³ attr_length åŠ ä¸Š sizeof(RID)ï¼Œå…¶ä¸­ RID æ˜¯æ•°æ®åº“ä¸­çš„è®°å½•æ ‡è¯†ç¬¦ï¼ˆRecord IDï¼‰ã€‚è¿™æ ·å¯ä»¥å­˜å‚¨ç´¢å¼•é”®åŠå…¶å¯¹åº”çš„è®°å½•ä½ç½®ã€‚
AttrType attr_typeï¼š
é”®å€¼çš„ç±»å‹ï¼Œå®šä¹‰äº†ç´¢å¼•æ‰€ä¾èµ–çš„å±æ€§ç±»å‹ï¼ˆå¦‚æ•´æ•°ã€å­—ç¬¦ä¸²ç­‰ï¼‰ã€‚è¯¥æšä¸¾ç±»å‹ç”¨äºæè¿°é”®å€¼çš„å®é™…æ•°æ®ç±»å‹ã€‚">

	
  </head><body class="ma0 avenir bg-near-white development">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        Wei Haoyu
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1"></h1>
      
      
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>ç‚¹å‡»è¿”å›<a href="https://2549141519.github.io/#/toc">ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•</a></p>
<ul>
<li>ç›®å½•
{:toc}</li>
</ul>
<!-- raw HTML omitted -->
<h1 id="1-bæ ‘ä»‹ç»">1. B+æ ‘ä»‹ç»</h1>
<p>B+æ ‘æ˜¯ä¸€ç§å¹³è¡¡çš„æ ‘å½¢æ•°æ®ç»“æ„ï¼Œé€šå¸¸ç”¨äºæ•°æ®åº“å’Œæ–‡ä»¶ç³»ç»Ÿç­‰éœ€è¦é¢‘ç¹è¿›è¡Œç£ç›˜å­˜å–çš„å¤§å‹æ•°æ®ç®¡ç†ç³»ç»Ÿã€‚å®ƒæ˜¯Bæ ‘çš„æ‰©å±•ç‰ˆæœ¬ï¼Œå…·æœ‰æ›´é«˜æ•ˆçš„æŸ¥è¯¢å’ŒèŒƒå›´æŸ¥è¯¢èƒ½åŠ›ã€‚B+æ ‘çš„è®¾è®¡åˆè¡·æ˜¯ä¸ºäº†ä¼˜åŒ–ç£ç›˜å­˜å–çš„æ•ˆç‡ï¼Œå› è€Œåœ¨å¤„ç†å¤§è§„æ¨¡æ•°æ®æ—¶éå¸¸é€‚åˆã€‚</p>
<h2 id="11-bæ ‘çš„ç»“æ„ç‰¹ç‚¹">1.1 B+æ ‘çš„ç»“æ„ç‰¹ç‚¹</h2>
<p>æ‰€æœ‰å…³é”®å­—éƒ½å‡ºç°åœ¨å¶å­èŠ‚ç‚¹ï¼š<br>
B+æ ‘ä¸Bæ ‘çš„ä¸»è¦åŒºåˆ«ä¹‹ä¸€æ˜¯ï¼ŒB+æ ‘ä¸­æ‰€æœ‰çš„å…³é”®å­—éƒ½å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ä¸­ï¼Œå†…éƒ¨èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•ä¿¡æ¯ã€‚å¶å­èŠ‚ç‚¹æŒ‰ç…§å…³é”®å­—çš„é¡ºåºæ’åˆ—ï¼Œå¹¶é€šè¿‡æŒ‡é’ˆè¿æ¥ï¼Œå½¢æˆä¸€ä¸ªæœ‰åºçš„é“¾è¡¨ã€‚</p>
<p>å†…èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•è€Œä¸å­˜å‚¨æ•°æ®ï¼š<br>
B+æ ‘çš„éå¶å­èŠ‚ç‚¹ï¼ˆå†…èŠ‚ç‚¹ï¼‰ä¸å­˜å‚¨å®é™…æ•°æ®ï¼Œå®ƒä»¬åªæ˜¯ç”¨äºæŒ‡å¼•æŸ¥è¯¢è·¯å¾„çš„ç´¢å¼•ï¼ŒæŒ‡å‘å­æ ‘æˆ–å¶å­èŠ‚ç‚¹ã€‚</p>
<p>æ‰€æœ‰å¶å­èŠ‚ç‚¹åœ¨åŒä¸€å±‚ï¼š<br>
B+æ ‘æ˜¯é«˜åº¦å¹³è¡¡çš„ï¼Œå³æ‰€æœ‰å¶å­èŠ‚ç‚¹éƒ½åœ¨åŒä¸€å±‚ï¼Œç¡®ä¿æŸ¥è¯¢æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¸º<code>O(log n)</code>ï¼Œå…¶ä¸­<code>n</code>æ˜¯æ•°æ®é¡¹çš„æ€»æ•°ã€‚</p>
<p>å¶å­èŠ‚ç‚¹é“¾è¡¨ç»“æ„ï¼š<br>
å¶å­èŠ‚ç‚¹ä¹‹é—´æ˜¯æœ‰åºé“¾è¡¨ï¼Œæ„å‘³ç€åœ¨è¿›è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶ï¼Œå¯ä»¥é€šè¿‡å¶å­èŠ‚ç‚¹çš„é¡ºåºè®¿é—®å¿«é€Ÿè·å–ä¸€ç»„è¿ç»­çš„ç»“æœã€‚</p>
<h2 id="12-bæ ‘çš„ä¼˜ç‚¹">1.2 B+æ ‘çš„ä¼˜ç‚¹</h2>
<p>èŒƒå›´æŸ¥è¯¢æ€§èƒ½ä¼˜å¼‚ï¼š<br>
ç”±äºå¶å­èŠ‚ç‚¹ä¹‹é—´çš„é“¾è¡¨ç»“æ„ï¼ŒB+æ ‘åœ¨å¤„ç†èŒƒå›´æŸ¥è¯¢æ—¶è¡¨ç°æä¸ºä¼˜ç§€ï¼Œå¯ä»¥ä»èµ·å§‹ä½ç½®æ²¿ç€é“¾è¡¨é¡ºåºè¯»å–ã€‚</p>
<p>ç£ç›˜I/Oä¼˜åŒ–ï¼š<br>
B+æ ‘çš„è®¾è®¡ç›®æ ‡æ˜¯å‡å°‘ç£ç›˜I/Oæ“ä½œã€‚å†…èŠ‚ç‚¹ä¸å­˜å‚¨å®é™…æ•°æ®ï¼Œå› æ­¤å¯ä»¥å°†æ›´å¤šçš„ç´¢å¼•èŠ‚ç‚¹æ”¾å…¥å†…å­˜ä¸­ï¼Œå‡å°‘ä»ç£ç›˜è¯»å–æ•°æ®çš„æ¬¡æ•°ã€‚</p>
<p>å¹³è¡¡æ€§ï¼š<br>
B+æ ‘æ˜¯ä¸€ç§å¹³è¡¡æ ‘ï¼Œä¿è¯äº†æ’å…¥ã€åˆ é™¤ã€æŸ¥è¯¢æ“ä½œçš„æ—¶é—´å¤æ‚åº¦å§‹ç»ˆä¿æŒåœ¨<code>O(log n)</code>ã€‚</p>
<p>å­˜å‚¨å¯†åº¦é«˜ï¼š<br>
ç”±äºå†…èŠ‚ç‚¹ä¸å­˜å‚¨æ•°æ®ï¼ŒB+æ ‘å¯ä»¥å°†æ›´å¤šçš„ç´¢å¼•èŠ‚ç‚¹æ”¾å…¥å†…å­˜ï¼Œä»è€Œæœ‰æ•ˆåˆ©ç”¨ç³»ç»Ÿçš„ç¼“å­˜ã€‚</p>
<h2 id="13-bæ ‘çš„åº”ç”¨åœºæ™¯">1.3 B+æ ‘çš„åº”ç”¨åœºæ™¯</h2>
<p>æ•°æ®åº“ç³»ç»Ÿï¼š<br>
åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼ŒB+æ ‘å¸¸ç”¨äºå®ç°ç´¢å¼•ï¼Œå¦‚MySQLä¸­çš„InnoDBå­˜å‚¨å¼•æ“å°±ä½¿ç”¨B+æ ‘ä½œä¸ºå…¶ä¸»é”®ç´¢å¼•ç»“æ„ã€‚</p>
<p>æ–‡ä»¶ç³»ç»Ÿï¼š<br>
ä¸€äº›æ–‡ä»¶ç³»ç»Ÿï¼Œå¦‚NTFSï¼Œä¹Ÿé‡‡ç”¨B+æ ‘æ¥ç®¡ç†æ–‡ä»¶å’Œç›®å½•æ•°æ®ã€‚</p>
<p>å¤§è§„æ¨¡æ•°æ®å­˜å‚¨ï¼š<br>
B+æ ‘ç‰¹åˆ«é€‚åˆéœ€è¦åœ¨ç£ç›˜ä¸­ç®¡ç†å¤§è§„æ¨¡æ•°æ®çš„åœºæ™¯ï¼Œèƒ½å¤Ÿå¾ˆå¥½åœ°å¤„ç†ç£ç›˜I/Oã€‚</p>
<h2 id="14-bæ ‘ä¸bæ ‘çš„åŒºåˆ«">1.4 B+æ ‘ä¸Bæ ‘çš„åŒºåˆ«</h2>
<p>æ•°æ®å­˜å‚¨ä½ç½®ï¼š<br>
Bæ ‘çš„æ•°æ®æ—¢å­˜å‚¨åœ¨å†…èŠ‚ç‚¹ä¹Ÿå­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼Œè€ŒB+æ ‘çš„æ•°æ®åªå­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ã€‚</p>
<p>èŒƒå›´æŸ¥è¯¢æ•ˆç‡ï¼š<br>
ç”±äºB+æ ‘çš„å¶å­èŠ‚ç‚¹æ„æˆé“¾è¡¨ç»“æ„ï¼Œè¿›è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶å¯ä»¥ç›´æ¥ä»é“¾è¡¨ä¸­éå†ï¼Œè€ŒBæ ‘åˆ™éœ€è¦æ›´å¤šçš„æ ‘éå†æ“ä½œã€‚</p>
<p>èŠ‚ç‚¹ç»“æ„ï¼š<br>
B+æ ‘çš„å†…èŠ‚ç‚¹æ›´ä¸ºç´§å‡‘ï¼Œå› ä¸ºå®ƒä»¬åªå­˜å‚¨ç´¢å¼•ï¼Œè€ŒBæ ‘çš„å†…èŠ‚ç‚¹å­˜å‚¨ç´¢å¼•å’Œæ•°æ®ã€‚</p>
<h1 id="2-bæ ‘åœ¨miniobçš„åº”ç”¨">2. B+æ ‘åœ¨miniobçš„åº”ç”¨</h1>
<h2 id="21-bæ ‘çš„ç»“æ„ä¸èŠ‚ç‚¹">2.1 B+æ ‘çš„ç»“æ„ä¸èŠ‚ç‚¹</h2>
<h3 id="211-indexfileheader">2.1.1 <code>IndexFileHeader</code></h3>
<p><code>IndexFileHeader</code>ï¼š<br>
ç”¨äºå­˜å‚¨ B+ æ ‘çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬æ ¹èŠ‚ç‚¹é¡µé¢ç¼–å·ã€å†…éƒ¨èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹çš„æœ€å¤§å¤§å°ã€å±æ€§é•¿åº¦ç­‰ã€‚</p>
<pre tabindex="0"><code>struct IndexFileHeader
{
  IndexFileHeader()
  {
    memset(this, 0, sizeof(IndexFileHeader));
    root_page = BP_INVALID_PAGE_NUM;
  }
  PageNum  root_page;          ///&lt; æ ¹èŠ‚ç‚¹åœ¨ç£ç›˜ä¸­çš„é¡µå·
  int32_t  internal_max_size;  ///&lt; å†…éƒ¨èŠ‚ç‚¹æœ€å¤§çš„é”®å€¼å¯¹æ•°
  int32_t  leaf_max_size;      ///&lt; å¶å­èŠ‚ç‚¹æœ€å¤§çš„é”®å€¼å¯¹æ•°
  int32_t  attr_length;        ///&lt; é”®å€¼çš„é•¿åº¦
  int32_t  key_length;         ///&lt; attr length + sizeof(RID)
  AttrType attr_type;          ///&lt; é”®å€¼çš„ç±»å‹

  const string to_string() const
  {
    stringstream ss;

    ss &lt;&lt; &#34;attr_length:&#34; &lt;&lt; attr_length &lt;&lt; &#34;,&#34;
       &lt;&lt; &#34;key_length:&#34; &lt;&lt; key_length &lt;&lt; &#34;,&#34;
       &lt;&lt; &#34;attr_type:&#34; &lt;&lt; attr_type_to_string(attr_type) &lt;&lt; &#34;,&#34;
       &lt;&lt; &#34;root_page:&#34; &lt;&lt; root_page &lt;&lt; &#34;,&#34;
       &lt;&lt; &#34;internal_max_size:&#34; &lt;&lt; internal_max_size &lt;&lt; &#34;,&#34;
       &lt;&lt; &#34;leaf_max_size:&#34; &lt;&lt; leaf_max_size &lt;&lt; &#34;;&#34;;

    return ss.str();
  }
};
</code></pre><p><code>PageNum root_page</code>ï¼š<br>
è¯¥å˜é‡å­˜å‚¨äº†æ ¹èŠ‚ç‚¹åœ¨ç£ç›˜ä¸­çš„é¡µå·ï¼Œç”¨äºæŒ‡ç¤ºB+æ ‘åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„å­˜å‚¨ä½ç½®ã€‚<code>BP_INVALID_PAGE_NUM</code> è¡¨ç¤ºä¸€ä¸ªæ— æ•ˆçš„é¡µå·ã€‚<br>
<code>int32_t internal_max_size</code>ï¼š<br>
è¿™æ˜¯å†…éƒ¨èŠ‚ç‚¹ä¸­å¯ä»¥å­˜å‚¨çš„æœ€å¤§é”®å€¼å¯¹æ•°ã€‚å¯¹äºä¸€ä¸ªB+æ ‘çš„å†…éƒ¨èŠ‚ç‚¹è€Œè¨€ï¼Œå®ƒå­˜å‚¨çš„æ˜¯ç´¢å¼•ä¿¡æ¯å’ŒæŒ‡å‘å­èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œå› æ­¤è¿™ä¸ªå€¼å†³å®šäº†å†…éƒ¨èŠ‚ç‚¹çš„åˆ†è£‚å’Œåˆå¹¶ç­–ç•¥ã€‚<br>
<code>int32_t leaf_max_size</code>ï¼š<br>
å¶å­èŠ‚ç‚¹å¯ä»¥å­˜å‚¨çš„æœ€å¤§é”®å€¼å¯¹æ•°ã€‚å¶å­èŠ‚ç‚¹ä¸­å­˜å‚¨çš„æ˜¯å®é™…çš„æ•°æ®ï¼Œå®šä¹‰äº†B+æ ‘ä¸­å¶å­èŠ‚ç‚¹çš„å­˜å‚¨å®¹é‡ï¼Œå½±å“äº†B+æ ‘çš„æ·±åº¦å’ŒæŸ¥æ‰¾æ•ˆç‡ã€‚<br>
<code>int32_t attr_length</code>ï¼š<br>
é”®å€¼çš„é•¿åº¦ï¼Œé€šå¸¸æ˜¯æŒ‡æ•°æ®åº“ä¸­ç´¢å¼•å­—æ®µçš„é•¿åº¦ã€‚å®ƒå†³å®šäº†æ¯ä¸ªé”®åœ¨æ ‘ä¸­å æ®çš„ç©ºé—´å¤§å°ã€‚<br>
<code>int32_t key_length</code>ï¼š<br>
è¯¥å˜é‡è¡¨ç¤ºé”®å€¼çš„æ€»é•¿åº¦ï¼Œå³ <code>attr_length</code> åŠ ä¸Š <code>sizeof(RID)</code>ï¼Œå…¶ä¸­ <code>RID </code>æ˜¯æ•°æ®åº“ä¸­çš„è®°å½•æ ‡è¯†ç¬¦ï¼ˆRecord IDï¼‰ã€‚è¿™æ ·å¯ä»¥å­˜å‚¨ç´¢å¼•é”®åŠå…¶å¯¹åº”çš„è®°å½•ä½ç½®ã€‚<br>
<code>AttrType attr_type</code>ï¼š<br>
é”®å€¼çš„ç±»å‹ï¼Œå®šä¹‰äº†ç´¢å¼•æ‰€ä¾èµ–çš„å±æ€§ç±»å‹ï¼ˆå¦‚æ•´æ•°ã€å­—ç¬¦ä¸²ç­‰ï¼‰ã€‚è¯¥æšä¸¾ç±»å‹ç”¨äºæè¿°é”®å€¼çš„å®é™…æ•°æ®ç±»å‹ã€‚</p>
<p><code>to_string </code>å‡½æ•°:<br>
å®ƒå°†ç»“æ„ä½“çš„å…³é”®å­—æ®µéƒ½æ ¼å¼åŒ–ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¾“å‡ºå±æ€§é•¿åº¦ã€é”®é•¿åº¦ã€å±æ€§ç±»å‹ã€æ ¹é¡µå·ã€å†…éƒ¨èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹çš„æœ€å¤§å®¹é‡ç­‰ä¿¡æ¯,æ–¹ä¾¿è°ƒè¯•æˆ–è¾“å‡ºã€‚</p>
<h3 id="212-indexnode">2.1.2 <code>IndexNode</code></h3>
<p><code>IndexNode</code>ï¼š<br>
é€šç”¨çš„ B+ æ ‘èŠ‚ç‚¹ç»“æ„ï¼ŒåŒ…æ‹¬é¡µé¢ç±»å‹ã€é”®å€¼å¯¹æ•°é‡ä»¥åŠçˆ¶èŠ‚ç‚¹çš„é¡µé¢ç¼–å·ã€‚</p>
<pre tabindex="0"><code>struct IndexNode
{
  static constexpr int HEADER_SIZE = 12;

  bool    is_leaf;  /// å½“å‰æ˜¯å¶å­èŠ‚ç‚¹è¿˜æ˜¯å†…éƒ¨èŠ‚ç‚¹
  int     key_num;  /// å½“å‰é¡µé¢ä¸Šä¸€å…±æœ‰å¤šå°‘ä¸ªé”®å€¼å¯¹
  PageNum parent;   /// çˆ¶èŠ‚ç‚¹é¡µé¢ç¼–å·
};
</code></pre><h3 id="213-leafindexnode">2.1.3 <code>LeafIndexNode</code></h3>
<p><code>LeafIndexNode</code>ï¼š<br>
å¶å­èŠ‚ç‚¹çš„ç»“æ„ï¼Œå­˜å‚¨å®é™…çš„æ•°æ®å’ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹çš„æŒ‡é’ˆã€‚</p>
<pre tabindex="0"><code>struct LeafIndexNode : public IndexNode
{
  static constexpr int HEADER_SIZE = IndexNode::HEADER_SIZE + 4;

  PageNum next_brother;

  char array[0];
};
</code></pre><h3 id="214-internalindexnode">2.1.4 <code>InternalIndexNode</code></h3>
<p><code>InternalIndexNode</code>ï¼š<br>
å†…éƒ¨èŠ‚ç‚¹çš„ç»“æ„ï¼Œå­˜å‚¨é”®å€¼å’Œå­é¡µé¢ç¼–å·ã€‚</p>
<pre tabindex="0"><code>struct InternalIndexNode : public IndexNode
{
  static constexpr int HEADER_SIZE = IndexNode::HEADER_SIZE;

  char array[0];
};  
</code></pre><h2 id="22-bæ ‘çš„æ“ä½œ">2.2 B+æ ‘çš„æ“ä½œ</h2>
<h3 id="221-æ’å…¥æ“ä½œ">2.2.1 æ’å…¥æ“ä½œ</h3>
<p>é€šè¿‡ <code>insert_entry</code> æ–¹æ³•å°†é”®å€¼å¯¹æ’å…¥ B+ æ ‘ä¸­ã€‚å¦‚æœå¶å­èŠ‚ç‚¹æˆ–å†…éƒ¨èŠ‚ç‚¹æ»¡äº†ï¼Œè°ƒç”¨ <a href="#241-%E5%88%86%E8%A3%82"><code>split</code></a> æ–¹æ³•è¿›è¡ŒèŠ‚ç‚¹åˆ†è£‚ã€‚</p>
<pre tabindex="0"><code>RC BplusTreeHandler::insert_entry(const char *user_key, const RID *rid)
{
  if (user_key == nullptr || rid == nullptr) {
    LOG_WARN(&#34;Invalid arguments, key is empty or rid is empty&#34;);
    return RC::INVALID_ARGUMENT;
  }

  MemPoolItem::item_unique_ptr pkey = make_key(user_key, *rid);
  if (pkey == nullptr) {
    LOG_WARN(&#34;Failed to alloc memory for key.&#34;);
    return RC::NOMEM;
  }

  RC rc = RC::SUCCESS;

  BplusTreeMiniTransaction mtr(*this, &amp;rc);

  char *key = static_cast&lt;char *&gt;(pkey.get());

  if (is_empty()) {
    root_lock_.lock();
    if (is_empty()) {
      rc = create_new_tree(mtr, key, rid);
      root_lock_.unlock();
      return rc;
    }
    root_lock_.unlock();
  }

  Frame *frame = nullptr;

  rc = find_leaf(mtr, BplusTreeOperationType::INSERT, key, frame);
  if (OB_FAIL(rc)) {
    LOG_WARN(&#34;Failed to find leaf %s. rc=%d:%s&#34;, rid-&gt;to_string().c_str(), rc, strrc(rc));
    return rc;
  }

  rc = insert_entry_into_leaf_node(mtr, frame, key, rid);
  if (OB_FAIL(rc)) {
    LOG_TRACE(&#34;Failed to insert into leaf of index, rid:%s. rc=%s&#34;, rid-&gt;to_string().c_str(), strrc(rc));
    return rc;
  }

  LOG_TRACE(&#34;insert entry success&#34;);
  return RC::SUCCESS;
}
</code></pre><p><code>const char *user_key</code>ï¼š<br>
ç”¨æˆ·æä¾›çš„é”®å€¼ï¼Œè¡¨ç¤ºéœ€è¦æ’å…¥åˆ°B+æ ‘ä¸­çš„æ•°æ®ã€‚<br>
<code>const RID *rid</code>ï¼š<br>
è®°å½•æ ‡è¯†ç¬¦ï¼ˆRecord IDï¼‰ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†ä¸€æ¡è®°å½•åœ¨æ•°æ®åº“ä¸­çš„ä½ç½®ã€‚æ¯ä¸ª<code>user_key</code>éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„<code>rid</code>ã€‚</p>
<p>è¾“å…¥æ£€æŸ¥ï¼š<br>
åœ¨æ’å…¥æ“ä½œä¹‹å‰ï¼Œé¦–å…ˆæ£€æŸ¥ <code>user_key</code> å’Œ<code>rid</code>æ˜¯å¦ä¸ºç©ºï¼Œç¡®ä¿è¾“å…¥å‚æ•°çš„åˆæ³•æ€§ã€‚å¦‚æœä¸ºç©ºï¼Œåˆ™è®°å½•ä¸€ä¸ªè­¦å‘Šæ—¥å¿—å¹¶è¿”å› <code>RC::INVALID_ARGUMENT</code> é”™è¯¯ç ã€‚<br>
åˆ›å»ºé”®çš„å‰¯æœ¬ï¼š<br>
ä½¿ç”¨ <code>make_key</code> å‡½æ•°å°† <code>user_key</code> å’Œ <code>rid</code> ç»„åˆæˆä¸€ä¸ªé”®å€¼å¯¹ï¼Œå¹¶ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ <code>MemPoolItem::item_unique_ptr</code> æ¥ç®¡ç†å…¶å†…å­˜ã€‚å¦‚æœå†…å­˜åˆ†é…å¤±è´¥ï¼Œè¿”å› <code>RC::NOMEM</code>ã€‚<br>
<code>BplusTreeMiniTransaction mtr(*this, &amp;rc);</code>:<br>
åˆ›å»ºä¸€ä¸ª <code>BplusTreeMiniTransaction</code> å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡é€šå¸¸ç”¨äºç®¡ç†B+æ ‘çš„äº‹åŠ¡æ“ä½œï¼Œç¡®ä¿åœ¨æ’å…¥æ“ä½œè¿‡ç¨‹ä¸­çš„ä¸€è‡´æ€§å’Œå¹¶å‘æ§åˆ¶ã€‚<code>mtr</code> è¡¨ç¤ºäº‹åŠ¡å¯¹è±¡ï¼Œå®ƒä¼šè·Ÿè¸ªå¹¶å¤„ç†æ’å…¥è¿‡ç¨‹ä¸­å¯èƒ½å‘ç”Ÿçš„é”™è¯¯ã€‚<br>
ç©ºæ ‘å¤„ç†ï¼š<br>
å¦‚æœå½“å‰B+æ ‘ä¸ºç©ºï¼ˆå³è¿˜æ²¡æœ‰æ ¹èŠ‚ç‚¹ï¼‰ï¼Œä½¿ç”¨ <code>root_lock_</code> é”å®šæ ¹èŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨ <code>create_new_tree</code> æ¥åˆ›å»ºä¸€ä¸ªæ–°æ ‘ç»“æ„ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ’å…¥æ“ä½œç›´æ¥è¿”å›åˆ›å»ºæ ‘çš„ç»“æœã€‚<code>is_empty()</code> åˆ¤æ–­æ ‘æ˜¯å¦ä¸ºç©ºï¼Œé€šè¿‡åŒé‡æ£€æŸ¥é”æœºåˆ¶é¿å…é‡å¤åˆ›å»ºæ ‘ã€‚<br>
æŸ¥æ‰¾å¶å­èŠ‚ç‚¹ï¼š<br>
ä½¿ç”¨<code>find_leaf</code>å‡½æ•°æ ¹æ® <code>key </code>æ‰¾åˆ°é€‚åˆæ’å…¥çš„å¶å­èŠ‚ç‚¹ã€‚<code>find_leaf</code> æ˜¯æŸ¥æ‰¾å¶å­èŠ‚ç‚¹çš„æ ¸å¿ƒæ“ä½œä¹‹ä¸€ï¼Œå®ƒå°†éå†B+æ ‘ç›´åˆ°æ‰¾åˆ°åŒ…å«æ­¤é”®çš„å¶å­èŠ‚ç‚¹ã€‚å¦‚æœæŸ¥æ‰¾å¤±è´¥ï¼ˆ<code>OB_FAIL(rc)</code>ï¼‰ï¼Œè®°å½•è­¦å‘Šæ—¥å¿—å¹¶è¿”å›ç›¸åº”çš„é”™è¯¯ç ã€‚<br>
æ’å…¥å¶å­èŠ‚ç‚¹ï¼š<br>
æ‰¾åˆ°ç›®æ ‡å¶å­èŠ‚ç‚¹åï¼Œè°ƒç”¨ <code>insert_entry_into_leaf_node</code> å‡½æ•°ï¼Œå°† <code>key </code>å’Œ <code>rid</code> æ’å…¥åˆ°å¶å­èŠ‚ç‚¹ä¸­ã€‚</p>
<h3 id="222-åˆ é™¤æ“ä½œ">2.2.2 åˆ é™¤æ“ä½œ</h3>
<p>é€šè¿‡ <code>delete_entry</code> æ–¹æ³•åˆ é™¤é”®å€¼å¯¹ã€‚åˆ é™¤æ—¶å¦‚æœèŠ‚ç‚¹æ•°é‡å°äºæœ€å°å®¹é‡ï¼Œåˆ™å¯èƒ½éœ€è¦åˆå¹¶ç›¸é‚»èŠ‚ç‚¹æˆ–é‡æ–°åˆ†é…èŠ‚ç‚¹ä¸­çš„å…ƒç´ ã€‚</p>
<pre tabindex="0"><code>RC BplusTreeHandler::delete_entry_internal(BplusTreeMiniTransaction &amp;mtr, Frame *leaf_frame, const char *key)
{
  LeafIndexNodeHandler leaf_index_node(mtr, file_header_, leaf_frame);

  const int remove_count = leaf_index_node.remove(key, key_comparator_);
  if (remove_count == 0) {
    LOG_TRACE(&#34;no data need to remove&#34;);
    // disk_buffer_pool_-&gt;unpin_page(leaf_frame);
    return RC::RECORD_NOT_EXIST;
  }
  // leaf_index_node.validate(key_comparator_, disk_buffer_pool_, file_id_);

  leaf_frame-&gt;mark_dirty();

  if (leaf_index_node.size() &gt;= leaf_index_node.min_size()) {
    return RC::SUCCESS;
  }

  return coalesce_or_redistribute&lt;LeafIndexNodeHandler&gt;(mtr, leaf_frame);
}

RC BplusTreeHandler::delete_entry(const char *user_key, const RID *rid)
{
  MemPoolItem::item_unique_ptr pkey = mem_pool_item_-&gt;alloc_unique_ptr();
  if (nullptr == pkey) {
    LOG_WARN(&#34;Failed to alloc memory for key. size=%d&#34;, file_header_.key_length);
    return RC::NOMEM;
  }
  char *key = static_cast&lt;char *&gt;(pkey.get());

  memcpy(key, user_key, file_header_.attr_length);
  memcpy(key + file_header_.attr_length, rid, sizeof(*rid));

  BplusTreeOperationType op = BplusTreeOperationType::DELETE;

  RC rc = RC::SUCCESS;

  BplusTreeMiniTransaction mtr(*this, &amp;rc);

  Frame *leaf_frame = nullptr;

  rc = find_leaf(mtr, op, key, leaf_frame);
  if (rc == RC::EMPTY) {
    rc = RC::RECORD_NOT_EXIST;
    return rc;
  }

  if (OB_FAIL(rc)) {
    LOG_WARN(&#34;failed to find leaf page. rc =%s&#34;, strrc(rc));
    return rc;
  }

  rc = delete_entry_internal(mtr, leaf_frame, key);
  return rc;
}
</code></pre><p><code>delete_entry</code>å‡½æ•°ï¼šB+æ ‘åˆ é™¤æ“ä½œçš„å…¥å£ã€‚<br>
å†…å­˜åˆ†é…å¹¶æ„é€ åˆ é™¤é”®ï¼š<br>
é¦–å…ˆä»å†…å­˜æ±  <code>mem_pool_item_</code> åˆ†é…ä¸€ä¸ªæŒ‡å‘ <code>key </code>çš„å†…å­˜æŒ‡é’ˆã€‚å¦‚æœåˆ†é…å¤±è´¥ï¼Œåˆ™è®°å½•è­¦å‘Šæ—¥å¿—å¹¶è¿”å›<code>RC::NOMEM</code>é”™è¯¯ç ã€‚<br>
ç„¶åå°†<code>user_key</code>å’Œ<code>rid</code>ç»„åˆæˆä¸€ä¸ªé”®ï¼Œå­˜å‚¨åœ¨<code>key</code>å˜é‡ä¸­ã€‚è¿™ä¸€æ­¥æ˜¯å°†ç”¨æˆ·æä¾›çš„é”®å’Œè®°å½•IDåˆå¹¶æˆä¸€ä¸ªå¯ä»¥åœ¨B+æ ‘ä¸­æŸ¥æ‰¾å’Œåˆ é™¤çš„å®Œæ•´é”®ã€‚<br>
æŸ¥æ‰¾å¶å­èŠ‚ç‚¹ï¼š<br>
åˆ›å»ºä¸€ä¸ª <code>BplusTreeMiniTransaction</code> æ¥ä¿è¯B+æ ‘åœ¨æ“ä½œä¸­çš„ä¸€è‡´æ€§ã€‚<br>
ä½¿ç”¨<code>find_leaf</code>å‡½æ•°æ ¹æ®<code>key</code>æ‰¾åˆ°ç›®æ ‡å¶å­èŠ‚ç‚¹æ‰€åœ¨çš„é¡µæ¡†<code> leaf_frame</code>ã€‚<br>
å¦‚æœè¿”å›å€¼ä¸º <code>RC::EMPTY</code>ï¼Œè¡¨ç¤ºB+æ ‘ä¸­æ²¡æœ‰æ•°æ®ï¼Œç›´æ¥è¿”å› <code>RC::RECORD_NOT_EXIST</code> è¡¨ç¤ºè®°å½•ä¸å­˜åœ¨ã€‚</p>
<p><code>delete_entry_internal</code>å‡½æ•°ï¼šå¤„ç†åˆ é™¤æ“ä½œçš„æ ¸å¿ƒé€»è¾‘ã€‚<br>
åˆ é™¤é”®å€¼å¯¹ï¼š<br>
ä½¿ç”¨ <code>LeafIndexNodeHandler</code> æ¥å¤„ç†å¶å­èŠ‚ç‚¹çš„æ“ä½œï¼Œå¹¶é€šè¿‡ <code>remove</code> å‡½æ•°å°è¯•åˆ é™¤ç›®æ ‡é”®ã€‚<br>
<code>remove_count</code> è®°å½•åˆ é™¤çš„é”®å€¼å¯¹æ•°é‡ï¼Œå¦‚æœä¸º0ï¼Œè¡¨ç¤ºæ²¡æœ‰æ‰¾åˆ°éœ€è¦åˆ é™¤çš„é”®ï¼Œè®°å½•æ—¥å¿—å¹¶è¿”å›<code> RC::RECORD_NOT_EXIST</code>ã€‚<br>
æ ‡è®°å¶å­èŠ‚ç‚¹ä¸º<code>dirty</code>ï¼š<code>leaf_frame-&gt;mark_dirty();</code><br>
åˆ é™¤æˆåŠŸåï¼Œå°†å¶å­èŠ‚ç‚¹æ ‡è®°ä¸ºâ€œè„â€ï¼Œå³éœ€è¦å†™å›ç£ç›˜ã€‚<br>
æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦éœ€è¦åˆå¹¶æˆ–é‡åˆ†é…ï¼š<br>
æ£€æŸ¥å¶å­èŠ‚ç‚¹çš„å½“å‰å¤§å°æ˜¯å¦å¤§äºç­‰äºæœ€å°å€¼ <code>min_size</code>ï¼Œå¦‚æœæ˜¯ï¼Œè¡¨ç¤ºèŠ‚ç‚¹ä»ç„¶ä¿æŒå¹³è¡¡ï¼Œä¸éœ€è¦è¿›ä¸€æ­¥å¤„ç†ï¼Œè¿”å› <code>RC::SUCCESS</code>ã€‚<br>
å¦‚æœèŠ‚ç‚¹çš„å¤§å°å°äºæœ€å°å€¼ï¼Œè°ƒç”¨ <code>coalesce_or_redistribute</code> å‡½æ•°ï¼Œå°è¯•å°†èŠ‚ç‚¹ä¸ç›¸é‚»èŠ‚ç‚¹åˆå¹¶æˆ–ä»ç›¸é‚»èŠ‚ç‚¹ä¸­é‡åˆ†é…ä¸€äº›æ•°æ®ï¼Œä»¥ç»´æŒB+æ ‘çš„å¹³è¡¡ã€‚</p>
<h3 id="223-æŸ¥æ‰¾æ“ä½œ">2.2.3 æŸ¥æ‰¾æ“ä½œ</h3>
<p><code>get_entry </code>æ–¹æ³•ç”¨äºæŸ¥æ‰¾æŒ‡å®šçš„é”®å€¼å¯¹ï¼Œ<code>find_leaf</code> ç”¨äºæ‰¾åˆ°åŒ…å«æŒ‡å®šé”®å€¼çš„å¶å­èŠ‚ç‚¹ã€‚</p>
<pre tabindex="0"><code>RC BplusTreeHandler::get_entry(const char *user_key, int key_len, list&lt;RID&gt; &amp;rids)
{
  BplusTreeScanner scanner(*this);
  RC rc = scanner.open(user_key, key_len, true /*left_inclusive*/, user_key, key_len, true /*right_inclusive*/);
  if (OB_FAIL(rc)) {
    LOG_WARN(&#34;failed to open scanner. rc=%s&#34;, strrc(rc));
    return rc;
  }

  RID rid;
  while ((rc = scanner.next_entry(rid)) == RC::SUCCESS) {
    rids.push_back(rid);
  }

  scanner.close();
  if (rc != RC::RECORD_EOF) {
    LOG_WARN(&#34;scanner return error. rc=%s&#34;, strrc(rc));
  } else {
    rc = RC::SUCCESS;
  }
  return rc;
}

RC BplusTreeHandler::find_leaf(BplusTreeMiniTransaction &amp;mtr, BplusTreeOperationType op, const char *key, Frame *&amp;frame)
{
  auto child_page_getter = [this, key](InternalIndexNodeHandler &amp;internal_node) {
    return internal_node.value_at(internal_node.lookup(key_comparator_, key));
  };
  return find_leaf_internal(mtr, op, child_page_getter, frame);
}
</code></pre><p><code>get_entry </code>å‡½æ•°:<br>
ç”¨äºæ ¹æ®ç»™å®šçš„<code>user_key</code>ä»B+æ ‘ä¸­æ‰¾åˆ°å¯¹åº”çš„è®°å½•IDåˆ—è¡¨<code> rids</code>ï¼Œå®ƒä¸»è¦ä½¿ç”¨äº†ä¸€ä¸ª<a href="#25-b%E6%A0%91%E7%9A%84%E6%89%AB%E6%8F%8F"><code>BplusTreeScanner</code></a>æ¥æ‰«ææ ‘ä¸­çš„ç¬¦åˆæ¡ä»¶çš„é”®ã€‚<br>
åˆå§‹åŒ–<code> BplusTreeScanner</code>ï¼š<br>
é¦–å…ˆåˆå§‹åŒ–ä¸€ä¸ª <code>BplusTreeScanner</code> å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡è´Ÿè´£éå†å’Œæ‰«æB+æ ‘çš„èŠ‚ç‚¹ã€‚<br>
è°ƒç”¨ <code>scanner.open()</code> æ¥è®¾ç½®æ‰«æçš„èŒƒå›´ã€‚è¿™é‡Œæ‰«æèŒƒå›´è®¾å®šä¸ºä»<code>user_key</code>å¼€å§‹ï¼Œ<code>left_inclusive</code> å’Œ <code>right_inclusive</code> è¡¨ç¤ºæ˜¯å¦åŒ…å«è¾¹ç•Œé”®ï¼Œå³æ­¤å¤„æ˜¯æŸ¥æ‰¾ç­‰äº <code>user_key</code> çš„æ¡ç›®ã€‚<br>
éå†å¹¶è·å–è®°å½•IDï¼š<br>
ä½¿ç”¨ <code>scanner.next_entry(rid)</code> ä¸æ–­è·å–ä¸‹ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„ <code>RID</code>ã€‚æ¯æ¬¡æˆåŠŸè·å–åˆ° <code>RID</code> åï¼Œå°†å…¶æ·»åŠ åˆ° <code>rids</code> åˆ—è¡¨ä¸­ã€‚<br>
å…³é—­æ‰«æå™¨å¹¶è¿”å›ç»“æœï¼š<br>
åœ¨å®Œæˆæ‰«æåï¼Œè°ƒç”¨<code>scanner.close()</code>å…³é—­æ‰«æå™¨ã€‚</p>
<p><code>find_leaf </code>å‡½æ•°:<br>
ç”¨äºåœ¨B+æ ‘ä¸­æŸ¥æ‰¾åŒ…å«ç‰¹å®š<code>key</code>çš„å¶å­èŠ‚ç‚¹ï¼Œå®ƒé€šè¿‡é€’å½’éå†æ ‘çš„å†…éƒ¨èŠ‚ç‚¹ï¼Œç›´åˆ°æ‰¾åˆ°ç›®æ ‡å¶å­èŠ‚ç‚¹ã€‚<br>
æŸ¥æ‰¾å­èŠ‚ç‚¹é¡µå·çš„å›è°ƒå‡½æ•°: <br>
å®šä¹‰ä¸€ä¸ª<code>child_page_getter</code>lambda å‡½æ•°ï¼Œç”¨äºä»å†…éƒ¨èŠ‚ç‚¹è·å–å­èŠ‚ç‚¹çš„é¡µå·ã€‚<br>
<code>internal_node.lookup(key_comparator_, key)</code> ä¼šæ ¹æ® <code>key </code>ä½¿ç”¨ <code>key_comparator_ </code>æ¥æŸ¥æ‰¾åœ¨å†…éƒ¨èŠ‚ç‚¹ä¸­çš„ä½ç½®ï¼Œå¹¶é€šè¿‡<code>value_at()</code>è·å–å¯¹åº”å­èŠ‚ç‚¹çš„é¡µå·ã€‚<br>
è°ƒç”¨ <code>find_leaf_internal</code>ï¼š<br>
ä¼ å…¥äº‹åŠ¡å¯¹è±¡ <code>mtr</code>ã€æ“ä½œç±»å‹ <code>op</code>ï¼ˆå¦‚åˆ é™¤ã€æ’å…¥ç­‰ï¼‰ã€è·å–å­èŠ‚ç‚¹é¡µå·çš„ <code>child_page_getter</code> ä»¥åŠé¡µæ¡† <code>frame</code>ã€‚</p>
<h2 id="23-bæ ‘çš„äº‹åŠ¡">2.3 B+æ ‘çš„äº‹åŠ¡</h2>
<p><code>BplusTreeMiniTransaction</code>ï¼šç”¨äºå°è£… MiniOB ä¸­çš„ B+ æ ‘äº‹åŠ¡ã€‚</p>
<pre tabindex="0"><code>class BplusTreeMiniTransaction final
{
public:

  BplusTreeMiniTransaction(BplusTreeHandler &amp;tree_handler, RC *operation_result = nullptr);
  ~BplusTreeMiniTransaction();

  LatchMemo       &amp;latch_memo() { return latch_memo_; }
  BplusTreeLogger &amp;logger() { return logger_; }

  RC commit();
  RC rollback();

private:
  BplusTreeHandler &amp;tree_handler_;
  RC               *operation_result_ = nullptr;
  LatchMemo         latch_memo_;
  BplusTreeLogger   logger_;
};
</code></pre><p><code>BplusTreeMiniTransaction(BplusTreeHandler &amp;tree_handler, RC *operation_result = nullptr)</code>ï¼š<br>
æ„é€ å‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ª<code>BplusTreeHandler</code>å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œè¿™ä¸ªå¯¹è±¡ä»£è¡¨äº†å¯¹ B+ æ ‘çš„å…·ä½“æ“ä½œç®¡ç†ã€‚<br>
å‚æ•° operation_result æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>RC</code>ï¼ˆè¿”å›ç ï¼‰çš„æŒ‡é’ˆã€‚å¦‚æœä¸ä¸º <code>nullptr</code>ï¼Œåœ¨äº‹åŠ¡ç»“æŸæ—¶ï¼Œä¼šæ ¹æ®æ“ä½œç»“æœæ¥å†³å®šæ˜¯å¦æäº¤æˆ–å›æ»šã€‚<br>
è¯¥æ„é€ å‡½æ•°é€šå¸¸ä¼šåœ¨äº‹åŠ¡å¼€å§‹æ—¶è¢«è°ƒç”¨ï¼Œè´Ÿè´£åˆå§‹åŒ–äº‹åŠ¡å¯¹è±¡ï¼Œå‡†å¤‡åç»­çš„æ“ä½œã€‚<br>
<code>~BplusTreeMiniTransaction()</code>ï¼š<br>
ææ„å‡½æ•°ï¼Œè´Ÿè´£æ¸…ç†äº‹åŠ¡èµ„æºã€‚å¦‚æœåœ¨äº‹åŠ¡ç»“æŸä¹‹å‰æ²¡æœ‰æ˜¾å¼åœ°è°ƒç”¨ <code>commit()</code> æˆ– <code>rollback()</code>ï¼Œææ„å‡½æ•°å¯èƒ½ä¼šå¤„ç†æœªå†³çš„äº‹åŠ¡ï¼Œç¡®ä¿ä¸ä¼šæœ‰æœªæäº¤æˆ–æœªå›æ»šçš„æ“ä½œæ®‹ç•™ã€‚<br>
<code>RC commit()</code>ï¼š<br>
è¯¥å‡½æ•°ç”¨äºæäº¤äº‹åŠ¡ã€‚å½“äº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œéƒ½æˆåŠŸæ‰§è¡Œæ—¶ï¼Œè°ƒç”¨ <code>commit()</code> ä¼šå°†æ“ä½œçš„ç»“æœæäº¤åˆ°B+æ ‘ï¼Œå¹¶å°†ç›¸å…³çš„æ—¥å¿—æ¸…é™¤æˆ–æ ‡è®°ä¸ºå·²å®Œæˆã€‚<br>
<code>RC rollback()</code>ï¼š<br>
è¯¥å‡½æ•°ç”¨äºå›æ»šäº‹åŠ¡ã€‚åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‘ç”Ÿé”™è¯¯æˆ–æ“ä½œå¤±è´¥ï¼Œè°ƒç”¨ <code>rollback()</code> ä¼šæ’¤é”€äº‹åŠ¡ä¸­çš„æ‰€æœ‰ä¿®æ”¹ï¼Œæ¢å¤åˆ°æ“ä½œå‰çš„çŠ¶æ€ã€‚<br>
å›æ»šæ“ä½œä½¿ç”¨ <code>BplusTreeLogger</code> ä¸­è®°å½•çš„æ—¥å¿—æ¥è¿˜åŸä¹‹å‰çš„çŠ¶æ€ã€‚</p>
<p><code>tree_handler_</code> æ˜¯å¯¹ B+ æ ‘æ“ä½œçš„ç®¡ç†å™¨ï¼Œå®ƒè´Ÿè´£å¯¹ B+ æ ‘æ‰§è¡Œå®é™…çš„æ“ä½œã€‚äº‹åŠ¡ç±»é€šè¿‡ä¸ <code>tree_handler_</code> äº¤äº’æ¥è¿›è¡Œæ ‘çš„æ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾ç­‰æ“ä½œã€‚<br>
<code>operation_result_</code> æ˜¯ä¸€ä¸ªè¿”å›ç çš„æŒ‡é’ˆï¼Œç”¨æ¥æ ‡è®°äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„çŠ¶æ€ã€‚å¦‚æœè¿™ä¸ªæŒ‡é’ˆä¸ä¸ºç©ºï¼Œäº‹åŠ¡ç»“æŸæ—¶ä¼šæ ¹æ®å®ƒçš„å€¼æ¥è‡ªåŠ¨å†³å®šæ˜¯å¦æäº¤æˆ–å›æ»šã€‚<br>
<code>latch_memo_</code> æ˜¯ä¸€ä¸ªé”å®šæœºåˆ¶çš„è®°å¿†è®°å½•å¯¹è±¡,è·Ÿè¸ªäº‹åŠ¡æœŸé—´è·å–çš„é”å®šèµ„æºï¼Œç¡®ä¿åœ¨äº‹åŠ¡ç»“æŸæ—¶èƒ½å¤Ÿæ­£ç¡®é‡Šæ”¾èµ„æºï¼Œé¿å…æ­»é”æˆ–èµ„æºæ³„æ¼ã€‚<br>
<code>logger_ </code>æ˜¯äº‹åŠ¡æ“ä½œçš„æ—¥å¿—è®°å½•å™¨ï¼Œå®ƒä¼šè®°å½•äº‹åŠ¡æœŸé—´å¯¹ B+ æ ‘è¿›è¡Œçš„æ‰€æœ‰æ“ä½œï¼Œä»¥ä¾¿åœ¨äº‹åŠ¡å›æ»šæ—¶èƒ½å¤Ÿè¿˜åŸæ•°æ®ï¼Œæˆ–è€…åœ¨å´©æºƒæ¢å¤æ—¶é‡æ–°åº”ç”¨äº‹åŠ¡ã€‚</p>
<h2 id="24-bæ ‘çš„åˆ†è£‚ä¸åˆå¹¶">2.4 B+æ ‘çš„åˆ†è£‚ä¸åˆå¹¶</h2>
<h3 id="241-åˆ†è£‚">2.4.1 åˆ†è£‚</h3>
<p>å½“èŠ‚ç‚¹æ»¡æ—¶ï¼Œ<code>split </code>æ–¹æ³•å°†èŠ‚ç‚¹åˆ†è£‚æˆä¸¤ä¸ªï¼Œå¹¶å°†ä¸­é—´çš„é”®æ’å…¥åˆ°çˆ¶èŠ‚ç‚¹ã€‚</p>
<pre tabindex="0"><code>template &lt;typename IndexNodeHandlerType&gt;
RC BplusTreeHandler::split(BplusTreeMiniTransaction &amp;mtr, Frame *frame, Frame *&amp;new_frame)
{
  IndexNodeHandlerType old_node(mtr, file_header_, frame);

  // add a new node
  RC rc = mtr.latch_memo().allocate_page(new_frame);
  if (OB_FAIL(rc)) {
    LOG_WARN(&#34;Failed to split index page due to failed to allocate page, rc=%d:%s&#34;, rc, strrc(rc));
    return rc;
  }

  mtr.latch_memo().xlatch(new_frame);

  IndexNodeHandlerType new_node(mtr, file_header_, new_frame);
  new_node.init_empty();
  new_node.set_parent_page_num(old_node.parent_page_num());

  old_node.move_half_to(new_node);

  frame-&gt;mark_dirty();
  new_frame-&gt;mark_dirty();
  return RC::SUCCESS;
}
</code></pre><p>åˆ†é…æ–°é¡µï¼šä¸ºæ–°èŠ‚ç‚¹åˆ†é…é¡µæ¡†å¹¶åŠ é”ã€‚<br>
ç§»åŠ¨æ•°æ®ï¼šå°†æ—§èŠ‚ç‚¹çš„ä¸€åŠæ•°æ®ç§»åŠ¨åˆ°æ–°èŠ‚ç‚¹ã€‚<br>
æ›´æ–°å…ƒæ•°æ®ï¼šç¡®ä¿æ–°èŠ‚ç‚¹ç»§æ‰¿æ—§èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹å…³ç³»ã€‚<br>
æ ‡è®°ä¿®æ”¹ï¼šæ ‡è®°ä¿®æ”¹åçš„é¡µæ¡†ï¼Œä»¥ä¾¿äº‹åŠ¡æäº¤æ—¶æ›´æ–°ç£ç›˜ä¸­çš„æ•°æ®ã€‚</p>
<h3 id="242-åˆå¹¶">2.4.2 åˆå¹¶</h3>
<p>å½“åˆ é™¤å¯¼è‡´èŠ‚ç‚¹ä¸­çš„å…ƒç´ è¿‡å°‘æ—¶ï¼Œ<code>coalesce</code> æ–¹æ³•åˆå¹¶ç›¸é‚»èŠ‚ç‚¹ã€‚</p>
<pre tabindex="0"><code>template &lt;typename IndexNodeHandlerType&gt;
RC BplusTreeHandler::coalesce(
    BplusTreeMiniTransaction &amp;mtr, Frame *neighbor_frame, Frame *frame, Frame *parent_frame, int index)
{
  InternalIndexNodeHandler parent_node(mtr, file_header_, parent_frame);

  // å…ˆåŒºåˆ†å‡ºæ¥å·¦å³èŠ‚ç‚¹
  Frame *left_frame  = nullptr;
  Frame *right_frame = nullptr;
  if (index == 0) {
    // neighbor node is at right
    left_frame  = frame;
    right_frame = neighbor_frame;
    index++;
  } else {
    left_frame  = neighbor_frame;
    right_frame = frame;
    // neighbor is at left
  }

  // æŠŠå³è¾¹èŠ‚ç‚¹çš„æ•°æ®å¤åˆ¶åˆ°å·¦è¾¹èŠ‚ç‚¹ä¸Šå»
  IndexNodeHandlerType left_node(mtr, file_header_, left_frame);
  IndexNodeHandlerType right_node(mtr, file_header_, right_frame);

  parent_node.remove(index);
  // parent_node.validate(key_comparator_, disk_buffer_pool_, file_id_);
  RC rc = right_node.move_to(left_node);
  if (OB_FAIL(rc)) {
    LOG_WARN(&#34;failed to move right node to left. rc=%d:%s&#34;, rc, strrc(rc));
    return rc;
  }
  // left_node.validate(key_comparator_);

  // å¶å­èŠ‚ç‚¹ç»´æŠ¤next_pageæŒ‡é’ˆ
  if (left_node.is_leaf()) {
    LeafIndexNodeHandler left_leaf_node(mtr, file_header_, left_frame);
    LeafIndexNodeHandler right_leaf_node(mtr, file_header_, right_frame);
    left_leaf_node.set_next_page(right_leaf_node.next_page());
  }

  // é‡Šæ”¾å³è¾¹èŠ‚ç‚¹
  mtr.latch_memo().dispose_page(right_frame-&gt;page_num());

  // é€’å½’çš„æ£€æŸ¥çˆ¶èŠ‚ç‚¹æ˜¯å¦éœ€è¦åšåˆå¹¶æˆ–è€…é‡æ–°åˆ†é…èŠ‚ç‚¹æ•°æ®
  return coalesce_or_redistribute&lt;InternalIndexNodeHandler&gt;(mtr, parent_frame);
}
</code></pre><p>ç¡®å®šå·¦å³èŠ‚ç‚¹ï¼šæ ¹æ® <code>index</code> æ¥åŒºåˆ†å½“å‰èŠ‚ç‚¹å’Œç›¸é‚»èŠ‚ç‚¹ï¼ˆå·¦æˆ–å³ï¼‰ã€‚<br>
åˆ é™¤çˆ¶èŠ‚ç‚¹ä¸­çš„ç´¢å¼•ï¼šç§»é™¤çˆ¶èŠ‚ç‚¹ä¸­ä¸å³èŠ‚ç‚¹å¯¹åº”çš„ç´¢å¼•é”®ã€‚<br>
åˆå¹¶å·¦å³èŠ‚ç‚¹ï¼šå°†å³èŠ‚ç‚¹ä¸­çš„æ•°æ®ç§»åŠ¨åˆ°å·¦èŠ‚ç‚¹ä¸­ï¼Œå¦‚æœæ˜¯å¶å­èŠ‚ç‚¹ï¼Œæ›´æ–°å…¶<code> next_page</code> æŒ‡é’ˆã€‚<br>
é‡Šæ”¾å³èŠ‚ç‚¹ï¼šåˆå¹¶åé‡Šæ”¾å³èŠ‚ç‚¹çš„èµ„æºã€‚<br>
é€’å½’å¤„ç†çˆ¶èŠ‚ç‚¹ï¼šåˆå¹¶å®Œæˆåé€’å½’æ£€æŸ¥çˆ¶èŠ‚ç‚¹ï¼Œçœ‹çœ‹æ˜¯å¦éœ€è¦è¿›ä¸€æ­¥çš„åˆå¹¶æˆ–é‡æ–°åˆ†é…ã€‚</p>
<h3 id="243-é‡æ–°åˆ†é…">2.4.3 é‡æ–°åˆ†é…</h3>
<p><code>redistribute </code>æ–¹æ³•é‡æ–°åˆ†é…ç›¸é‚»èŠ‚ç‚¹ä¸­çš„å…ƒç´ ä»¥ä¿æŒå¹³è¡¡ã€‚</p>
<pre tabindex="0"><code>template &lt;typename IndexNodeHandlerType&gt;
RC BplusTreeHandler::redistribute(BplusTreeMiniTransaction &amp;mtr, Frame *neighbor_frame, Frame *frame, Frame *parent_frame, int index)
{
  InternalIndexNodeHandler parent_node(mtr, file_header_, parent_frame);
  IndexNodeHandlerType     neighbor_node(mtr, file_header_, neighbor_frame);
  IndexNodeHandlerType     node(mtr, file_header_, frame);
  if (neighbor_node.size() &lt; node.size()) {
    LOG_ERROR(&#34;got invalid nodes. neighbor node size %d, this node size %d&#34;, neighbor_node.size(), node.size());
  }
  if (index == 0) {
    // the neighbor is at right
    neighbor_node.move_first_to_end(node);
    // neighbor_node.validate(key_comparator_, disk_buffer_pool_, file_id_);
    // node.validate(key_comparator_, disk_buffer_pool_, file_id_);
    parent_node.set_key_at(index + 1, neighbor_node.key_at(0));
    // parent_node.validate(key_comparator_, disk_buffer_pool_, file_id_);
  } else {
    // the neighbor is at left
    neighbor_node.move_last_to_front(node);
    // neighbor_node.validate(key_comparator_, disk_buffer_pool_, file_id_);
    // node.validate(key_comparator_, disk_buffer_pool_, file_id_);
    parent_node.set_key_at(index, node.key_at(0));
    // parent_node.validate(key_comparator_, disk_buffer_pool_, file_id_);
  }

  neighbor_frame-&gt;mark_dirty();
  frame-&gt;mark_dirty();
  parent_frame-&gt;mark_dirty();

  return RC::SUCCESS;
}
</code></pre><p>åˆå§‹åŒ–èŠ‚ç‚¹å’Œæ£€æŸ¥èŠ‚ç‚¹å¤§å°ï¼šå‡†å¤‡å¥½ç›¸é‚»èŠ‚ç‚¹ã€å½“å‰èŠ‚ç‚¹å’Œçˆ¶èŠ‚ç‚¹ï¼Œç¡®ä¿ç›¸é‚»èŠ‚ç‚¹æœ‰è¶³å¤Ÿçš„å…ƒç´ å¯ä»¥å€Ÿå‡ºã€‚<br>
æ ¹æ®ç›¸é‚»èŠ‚ç‚¹çš„ä½ç½®é‡æ–°åˆ†é…å…ƒç´ ï¼š<br>
å¦‚æœç›¸é‚»èŠ‚ç‚¹åœ¨å³ä¾§ï¼Œå°†å³èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªå…ƒç´ ç§»åŠ¨åˆ°å½“å‰èŠ‚ç‚¹çš„æœ«å°¾ï¼Œå¹¶æ›´æ–°çˆ¶èŠ‚ç‚¹é”®å€¼ã€‚<br>
å¦‚æœç›¸é‚»èŠ‚ç‚¹åœ¨å·¦ä¾§ï¼Œå°†å·¦èŠ‚ç‚¹çš„æœ€åä¸€ä¸ªå…ƒç´ ç§»åŠ¨åˆ°å½“å‰èŠ‚ç‚¹çš„å¼€å¤´ï¼Œå¹¶æ›´æ–°çˆ¶èŠ‚ç‚¹é”®å€¼ã€‚<br>
æ ‡è®°ä¿®æ”¹ï¼šæ ‡è®°æ‰€æœ‰è¢«ä¿®æ”¹çš„èŠ‚ç‚¹é¡µæ¡†ï¼Œä»¥ä¾¿åç»­æäº¤åˆ°ç£ç›˜ã€‚<br>
è¿”å›ç»“æœï¼šæ“ä½œæˆåŠŸåè¿”å› <code>RC::SUCCESS</code>ã€‚</p>
<h2 id="25-bæ ‘çš„æ‰«æ">2.5 B+æ ‘çš„æ‰«æ</h2>
<p><code>BplusTreeScanner </code>ç±»å…è®¸å¯¹ B+ æ ‘çš„èŒƒå›´æ‰«æã€‚å¯ä»¥è®¾ç½®å·¦è¾¹ç•Œå’Œå³è¾¹ç•Œï¼Œæ‰«ææ»¡è¶³æ¡ä»¶çš„é”®å€¼å¯¹ã€‚</p>
<pre tabindex="0"><code>class BplusTreeScanner
{
public:
  BplusTreeScanner(BplusTreeHandler &amp;tree_handler);
  ~BplusTreeScanner();

  /**
   * @brief æ‰«ææŒ‡å®šèŒƒå›´çš„æ•°æ®
   * @param left_user_key æ‰«æèŒƒå›´çš„å·¦è¾¹ç•Œï¼Œå¦‚æœæ˜¯nullï¼Œåˆ™æ²¡æœ‰å·¦è¾¹ç•Œ
   * @param left_len left_user_key çš„å†…å­˜å¤§å°(åªæœ‰åœ¨å˜é•¿å­—æ®µä¸­æ‰ä¼šå…³æ³¨)
   * @param left_inclusive å·¦è¾¹ç•Œçš„å€¼æ˜¯å¦åŒ…å«åœ¨å†…
   * @param right_user_key æ‰«æèŒƒå›´çš„å³è¾¹ç•Œã€‚å¦‚æœæ˜¯nullï¼Œåˆ™æ²¡æœ‰å³è¾¹ç•Œ
   * @param right_len right_user_key çš„å†…å­˜å¤§å°(åªæœ‰åœ¨å˜é•¿å­—æ®µä¸­æ‰ä¼šå…³æ³¨)
   * @param right_inclusive å³è¾¹ç•Œçš„å€¼æ˜¯å¦åŒ…å«åœ¨å†…
   * TODO é‡æ„å‚æ•°è¡¨ç¤ºæ–¹æ³•
   */
  RC open(const char *left_user_key, int left_len, bool left_inclusive, const char *right_user_key, int right_len,
      bool right_inclusive);

  /**
   * @brief è·å–ä¸‹ä¸€æ¡è®°å½•
   *
   * @param rid å½“å‰é»˜è®¤æ‰€æœ‰å€¼éƒ½æ˜¯RIDç±»å‹ã€‚å¯¹B+æ ‘æ¥è¯´å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„æŠ½è±¡
   * @return RC RECORD_EOF è¡¨ç¤ºéå†å®Œæˆ
   * TODO éœ€è¦å¢åŠ è¿”å› key çš„æ¥å£
   * @warning ä¸è¦åœ¨éå†æ—¶åˆ é™¤æ•°æ®ã€‚åˆ é™¤æ•°æ®ä¼šå¯¼è‡´éå†å™¨å¤±æ•ˆã€‚
   * å½“å‰é»˜è®¤çš„èµ°ç´¢å¼•åˆ é™¤çš„é€»è¾‘å°±æ˜¯è¿™æ ·åšçš„ï¼Œæ‰€ä»¥åˆ é™¤é€»è¾‘æœ‰BUGã€‚
   */
  RC next_entry(RID &amp;rid);

  /**
   * @brief å…³é—­å½“å‰æ‰«æå™¨
   * @details å¯ä»¥ä¸è°ƒç”¨ï¼Œåœ¨ææ„å‡½æ•°æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œ
   */
  RC close();

private:
  /**
   * å¦‚æœkeyçš„ç±»å‹æ˜¯CHARS, æ‰©å±•æˆ–ç¼©å‡user_keyçš„å¤§å°åˆšå¥½æ˜¯schemaä¸­å®šä¹‰çš„å¤§å°
   */
  RC fix_user_key(const char *user_key, int key_len, bool want_greater, char **fixed_key, bool *should_inclusive);

  void fetch_item(RID &amp;rid);

  /**
   * @brief åˆ¤æ–­æ˜¯å¦åˆ°äº†æ‰«æçš„ç»“æŸä½ç½®
   */
  bool touch_end();

private:
  bool                     inited_ = false;
  BplusTreeHandler        &amp;tree_handler_;
  BplusTreeMiniTransaction mtr_;

  /// ä½¿ç”¨å·¦å³å¶å­èŠ‚ç‚¹å’Œä½ç½®æ¥è¡¨ç¤ºæ‰«æçš„èµ·å§‹ä½ç½®å’Œç»ˆæ­¢ä½ç½®
  /// èµ·å§‹ä½ç½®å’Œç»ˆæ­¢ä½ç½®éƒ½æ˜¯æœ‰æ•ˆçš„æ•°æ®
  Frame *current_frame_ = nullptr;

  common::MemPoolItem::item_unique_ptr right_key_;
  int                                  iter_index_    = -1;
  bool                                 first_emitted_ = false;
};
</code></pre><p>åˆå§‹åŒ–æ‰«æå™¨ï¼š<br>
åˆ›å»º <code>BplusTreeScanner </code>å¯¹è±¡å¹¶è°ƒç”¨<code>open</code>å‡½æ•°ï¼Œè®¾ç½®æ‰«æçš„èŒƒå›´ï¼ˆå·¦è¾¹ç•Œå’Œå³è¾¹ç•Œï¼‰ã€‚<br>
è·å–è®°å½•ï¼š<br>
è°ƒç”¨<code>next_entry</code>å‡½æ•°è·å–ä¸€æ¡è®°å½•ï¼Œå¹¶å¾ªç¯è°ƒç”¨ç›´åˆ°è¿”å›<code> RC::RECORD_EOF</code>ï¼Œè¡¨ç¤ºéå†å®Œæˆã€‚<br>
å…³é—­æ‰«æå™¨ï¼š<br>
æ‰«æå®Œæˆåè°ƒç”¨<code>close</code>å‡½æ•°å…³é—­æ‰«æå™¨ã€‚å…³é—­æ‰«æå™¨ä¼šé‡Šæ”¾ç›¸å…³èµ„æºï¼Œå¦‚æœæœªæ˜¾å¼è°ƒç”¨ï¼Œä¹Ÿä¼šåœ¨ææ„å‡½æ•°ä¸­è‡ªåŠ¨å…³é—­ã€‚</p>
<h2 id="26-bæ ‘çš„éªŒè¯">2.6 B+æ ‘çš„éªŒè¯</h2>
<p>é€šè¿‡ <code>validate_tree </code>æ–¹æ³•å¯ä»¥æ£€æŸ¥ B+ æ ‘çš„åˆæ³•æ€§ï¼ŒåŒ…æ‹¬èŠ‚ç‚¹ä¹‹é—´çš„é“¾æ¥ã€é”®å€¼çš„é¡ºåºç­‰ã€‚</p>
<pre tabindex="0"><code>bool BplusTreeHandler::validate_tree()
{
  if (is_empty()) {
    return true;
  }

  BplusTreeMiniTransaction mtr(*this);
  LatchMemo &amp;latch_memo = mtr.latch_memo();
  Frame    *frame = nullptr;

  RC rc = latch_memo.get_page(file_header_.root_page, frame);  // è¿™é‡Œä»…ä»…è°ƒè¯•ä½¿ç”¨ï¼Œä¸åŠ rooté”
  if (OB_FAIL(rc)) {
    LOG_WARN(&#34;failed to fetch root page. page id=%d, rc=%d:%s&#34;, file_header_.root_page, rc, strrc(rc));
    return false;
  }

  if (!validate_node_recursive(mtr, frame) || !validate_leaf_link(mtr)) {
    LOG_WARN(&#34;Current B+ Tree is invalid&#34;);
    print_tree();
    return false;
  }

  LOG_INFO(&#34;great! current tree is valid&#34;);
  return true;
}
</code></pre><p>ç»“æ„éªŒè¯ï¼š<br>
<code>validate_tree </code>é€šè¿‡é€’å½’æ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹çš„ç»“æ„ï¼ˆ<code>validate_node_recursive</code>ï¼‰å’Œå¶å­èŠ‚ç‚¹çš„é“¾è¡¨é“¾æ¥ï¼ˆ<code>validate_leaf_link</code>ï¼‰ï¼Œç¡®ä¿B+æ ‘çš„å„ä¸ªéƒ¨åˆ†ç¬¦åˆè§„èŒƒã€‚<br>
è°ƒè¯•å·¥å…·ï¼š<br>
å½“æ ‘ç»“æ„æ— æ•ˆæ—¶ï¼Œå‡½æ•°ä¼šæ‰“å°æ•´ä¸ªæ ‘çš„ç»“æ„ï¼Œä¾¿äºå¼€å‘è€…è¿›è¡Œè°ƒè¯•å’Œé—®é¢˜æ’æŸ¥ã€‚</p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="http://localhost:1313/" >
    &copy;  Wei Haoyu 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
