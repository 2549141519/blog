<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Wei Haoyu</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="">
    <meta name="generator" content="Hugo 0.145.0">
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >




    


    
      

    

    
    
      <link href="/posts/index.xml" rel="alternate" type="application/rss+xml" title="Wei Haoyu" />
      <link href="/posts/index.xml" rel="feed" type="application/rss+xml" title="Wei Haoyu" />
      
    

    
      <link rel="canonical" href="http://localhost:1313/posts/">
    

    <meta property="og:url" content="http://localhost:1313/posts/">
  <meta property="og:site_name" content="Wei Haoyu">
  <meta property="og:title" content="Posts">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="website">

  <meta itemprop="name" content="Posts">
  <meta itemprop="datePublished" content="2025-07-27T21:06:51+08:00">
  <meta itemprop="dateModified" content="2025-07-27T21:06:51+08:00">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Posts">

	
  </head><body class="ma0 avenir bg-near-white development">

    

  <header>
    <div class="pb3-m pb6-l bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        Wei Haoyu
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

      <div class="tc-l pv3 ph3 ph4-ns">
        <h1 class="f2 f-subheadline-l fw2 light-silver mb0 lh-title">
          Posts
        </h1>
        
      </div>
    </div>
  </header>


    <main class="pb7" role="main">
      
  <article class="pa3 pa4-ns nested-copy-line-height">
    <section class="cf ph3 ph5-l pv3 pv4-l f4 tc-l center measure-wide lh-copy nested-links mid-gray"></section>
    <section class="flex-ns mt5 flex-wrap justify-around">
      
        <div class="w-100 w-30-l mb4 relative bg-white">
          <div class="w-100 mb4 nested-copy-line-height relative bg-white">
  <div class="mb3 pa4 gray overflow-hidden bg-white">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/mapreduce-for-nosql/" class="link black dim">
        
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <p>ç‚¹å‡»è¿”å›<a href="https://2549141519.github.io/#/toc">ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•</a></p>
<ul>
<li>ç›®å½•
{:toc}</li>
</ul>
<!-- raw HTML omitted -->
<h1 id="1-å‰è¨€">1. å‰è¨€</h1>
<p>æœ¬æ–‡å°†å®ç°MapReduceå’ŒNoSQLæ•°æ®åº“çš„äº¤äº’ï¼Œç»Ÿè®¡å•è¯å‡ºç°æ¬¡æ•°ã€‚
NoSQLæ•°æ®åº“é€‰ç”¨redis6.0ï¼Œä»¥ä¸‹æ˜¯redisæ“ä½œçš„ä¸€äº›å‘½ä»¤(æˆ‘è®¾ç½®çš„redis6.0ç«¯å£ä¸º6380)ï¼š</p>
<blockquote>
<p>sudo redis-server /etc/redis/redis.conf<br>
//å¯åŠ¨redis6.0å®ä¾‹<br>
redis-cli -p 6380<br>
//è¿æ¥redis6.0å®ä¾‹,6380ä¸ºç«¯å£å·<br>
redis-cli -p 6380 KEYS &ldquo;key*&rdquo; | xargs redis-cli -p 6380 DEL<br>
//åˆ é™¤redis6.0å®ä¾‹ä¸­ä»¥key*ä¸ºå‰ç¼€çš„æ‰€æœ‰key</p></blockquote>
<h1 id="2-ä½¿ç”¨goè¯­è¨€å®ç°">2. ä½¿ç”¨goè¯­è¨€å®ç°</h1>
<h2 id="21-ç”Ÿæˆéšæœºæ•°æ®å¹¶å­˜å…¥redis">2.1 ç”Ÿæˆéšæœºæ•°æ®å¹¶å­˜å…¥Redis</h2>
<p>éšæœºç”Ÿæˆ1ä¸‡ä¸ªå•è¯ï¼Œå¹¶å†™å…¥redisæ•°æ®åº“ä¸­ï¼š</p>
<blockquote>
<p>package main<br>
import (<br>
&ldquo;context&rdquo;<br>
&ldquo;fmt&rdquo;<br>
&ldquo;math/rand&rdquo;<br>
&ldquo;time&rdquo;<br>
&ldquo;github.com/go-redis/redis/v8&rdquo;<br>
)<br>
// ç”Ÿæˆéšæœºå­—ç¬¦ä¸²<br>
func randomString(n int) string {<br>
letters := []rune(&ldquo;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&rdquo;)<br>
s := make([]rune, n)<br>
for i := range s {<br>
s[i] = letters[rand.Intn(len(letters))]<br>
}<br>
return string(s)<br>
}<br>
// ç”Ÿæˆéšæœºæ•°æ®å¹¶å­˜å…¥Redis<br>
func generateDataAndSaveToRedis(rdb *redis.Client, count int) {<br>
ctx := context.Background()<br>
for i := 0; i &lt; count; i++ {<br>
key := fmt.Sprintf(&ldquo;key%d&rdquo;, i)<br>
value := randomString(3) // ç”Ÿæˆé•¿åº¦ä¸º3çš„éšæœºå­—ç¬¦ä¸²<br>
err := rdb.Set(ctx, key, value, 0).Err()<br>
if err != nil {<br>
panic(err)<br>
}<br>
}<br>
fmt.Printf(&ldquo;Successfully generated and saved %d random data entries to Redis.\n&rdquo;, count)<br>
}<br>
func main() {<br>
// è®¾ç½®éšæœºç§å­<br>
rand.Seed(time.Now().UnixNano())<br>
// è¿æ¥åˆ°Redis<br>
rdb := redis.NewClient(&amp;redis.Options{<br>
Addr: &ldquo;localhost:6380&rdquo;, // RedisæœåŠ¡å™¨åœ°å€<br>
DB:   0,                // ä½¿ç”¨é»˜è®¤çš„DB<br>
})<br>
// ç”Ÿæˆ10000ä¸ªéšæœºæ•°æ®å¹¶å­˜å…¥Redis<br>
generateDataAndSaveToRedis(rdb, 10000)<br>
}</p></blockquote>
<p>æ‰§è¡Œå‘½ä»¤ï¼šgo run Generate_random_data.go<br>
<img src="../blogImg/MapReduce1.PNG" alt="Alt text"></p>
<h2 id="22-è¯»å–redisæ•°æ®åˆ°æ–‡ä»¶">2.2 è¯»å–Redisæ•°æ®åˆ°æ–‡ä»¶</h2>
<p>è¯»å–Redisæ•°æ®åˆ°æ–‡ä»¶ï¼š</p>
<blockquote>
<p>package main<br>
import (<br>
&ldquo;bufio&rdquo;<br>
&ldquo;context&rdquo;<br>
&ldquo;fmt&rdquo;<br>
&ldquo;os&rdquo;<br>
&ldquo;github.com/go-redis/redis/v8&rdquo;<br>
)<br>
// ä»Redisä¸­è¯»å–æ‰€æœ‰æ•°æ®<br>
func fetchDataFromRedis(rdb <em>redis.Client) map[string]string {<br>
ctx := context.Background()<br>
keys, err := rdb.Keys(ctx, &ldquo;</em>&rdquo;).Result()<br>
if err != nil {<br>
panic(err)<br>
}<br>
data := make(map[string]string)<br>
for _, key := range keys {<br>
value, err := rdb.Get(ctx, key).Result()<br>
if err != nil {<br>
panic(err)<br>
}<br>
data[key] = value<br>
}<br>
return data<br>
}<br>
// å°†æ•°æ®å†™å…¥åˆ°æ–‡ä»¶<br>
func writeDataToFile(data map[string]string, filename string) {<br>
file, err := os.Create(filename)<br>
if err != nil {<br>
panic(err)<br>
}<br>
defer file.Close()<br>
writer := bufio.NewWriter(file)<br>
for key, value := range data {<br>
fmt.Fprintf(writer, &ldquo;%s\t%s\n&rdquo;, key, value)<br>
}<br>
writer.Flush()<br>
fmt.Printf(&ldquo;Data successfully written to %s\n&rdquo;, filename)<br>
}<br>
func main() {<br>
// è¿æ¥åˆ°Redis<br>
rdb := redis.NewClient(&amp;redis.Options{<br>
Addr: &ldquo;localhost:6380&rdquo;, // RedisæœåŠ¡å™¨åœ°å€<br>
DB:   0,                // ä½¿ç”¨é»˜è®¤çš„DB<br>
})<br>
// ä»Redisä¸­è¯»å–æ•°æ®<br>
data := fetchDataFromRedis(rdb)<br>
// å°†æ•°æ®å†™å…¥åˆ°æ–‡ä»¶ä½œä¸ºMapReduceè¾“å…¥<br>
writeDataToFile(data, &ldquo;input.txt&rdquo;)<br>
}</p></blockquote>
<p>æ‰§è¡Œå‘½ä»¤ï¼šgo run Read_data.go<br>
<img src="../blogImg/MapReduce2.PNG" alt="Alt text"></p>
<p>æ­¤æ—¶input.txtæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š<br>
<img src="../blogImg/MapReduce3.PNG" alt="Alt text"></p>
<h2 id="23-mapreduceå®ç°">2.3 MapReduceå®ç°</h2>
<p>MapReduceå®ç°ï¼š</p>
<blockquote>
<p>package main<br>
import (<br>
&ldquo;bufio&rdquo;<br>
&ldquo;fmt&rdquo;<br>
&ldquo;os&rdquo;<br>
&ldquo;strings&rdquo;<br>
)<br>
// Mapå‡½æ•°å°†è¯»å–è¾“å…¥æ–‡ä»¶ï¼Œå¹¶è¾“å‡ºæ¯ä¸ªå•è¯çš„é”®å€¼å¯¹ï¼ˆword, 1ï¼‰<br>
func mapFunction(filename string) map[string]int {<br>
file, err := os.Open(filename)<br>
if err != nil {<br>
panic(err)<br>
}<br>
defer file.Close()<br>
wordCount := make(map[string]int)<br>
scanner := bufio.NewScanner(file)<br>
for scanner.Scan() {<br>
line := scanner.Text()<br>
// å‡è®¾è¾“å…¥æ–‡ä»¶æ¯è¡Œçš„æ ¼å¼æ˜¯ &ldquo;key\tvalue&rdquo;<br>
parts := strings.Split(line, &ldquo;\t&rdquo;)<br>
if len(parts) != 2 {<br>
continue // è·³è¿‡æ ¼å¼ä¸æ­£ç¡®çš„è¡Œ<br>
}<br>
value := parts[1]<br>
words := strings.Fields(value)<br>
for _, word := range words {<br>
wordCount[word] += 1<br>
}<br>
}<br>
if err := scanner.Err(); err != nil {<br>
panic(err)<br>
}<br>
return wordCount<br>
}<br>
// Reduceå‡½æ•°å°†æ±‡æ€»Mapå‡½æ•°çš„è¾“å‡ºï¼Œè®¡ç®—æ¯ä¸ªå•è¯çš„æ€»æ¬¡æ•°<br>
func reduceFunction(mappedData map[string]int) map[string]int {<br>
reducedData := make(map[string]int)<br>
for word, count := range mappedData {<br>
reducedData[word] += count<br>
}<br>
return reducedData<br>
}<br>
// å°†ç»“æœå†™å…¥åˆ°æ–‡ä»¶ä¸­<br>
func writeResultToFile(result map[string]int, outputFilename string) {<br>
file, err := os.Create(outputFilename)<br>
if err != nil {<br>
panic(err)<br>
}<br>
defer file.Close()<br>
writer := bufio.NewWriter(file)<br>
for word, count := range result {<br>
fmt.Fprintf(writer, &ldquo;%s  %d\n&rdquo;, word, count)<br>
}<br>
writer.Flush()<br>
}<br>
func main() {<br>
// Mapé˜¶æ®µ<br>
mappedData := mapFunction(&ldquo;input.txt&rdquo;)<br>
// Reduceé˜¶æ®µ<br>
reducedData := reduceFunction(mappedData)<br>
// è¾“å‡ºç»“æœåˆ°æ–‡ä»¶<br>
writeResultToFile(reducedData, &ldquo;output.txt&rdquo;)<br>
fmt.Println(&ldquo;MapReduce job completed. Results written to output.txt&rdquo;)<br>
}</p></blockquote>
<p>æ‰§è¡Œå‘½ä»¤ï¼šgo run MapReduce.go<br>
<img src="../blogImg/MapReduce4.PNG" alt="Alt text"></p>
<p>output.txtæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š<br>
<img src="../blogImg/MapReduce5.PNG" alt="Alt text"></p>

    </div>
    <a href="/posts/mapreduce-for-nosql/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="w-100 w-30-l mb4 relative bg-white">
          <div class="w-100 mb4 nested-copy-line-height relative bg-white">
  <div class="mb3 pa4 gray overflow-hidden bg-white">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/mapreduce/" class="link black dim">
        
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <p>ç‚¹å‡»è¿”å›<a href="https://2549141519.github.io/#/toc">ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•</a></p>
<ul>
<li>ç›®å½•
{:toc}</li>
</ul>
<!-- raw HTML omitted -->
<p>paper <a href="https://static.googleusercontent.com/media/research.google.com/en//archive/mapreduce-osdi04.pdf">link</a></p>
<h1 id="1ä»‹ç»">1.ä»‹ç»</h1>
<p>MapReduce æ˜¯ä¸€ç§ç”¨äºå¤„ç†å’Œç”Ÿæˆå¤§è§„æ¨¡æ•°æ®é›†çš„ç¼–ç¨‹æ¨¡å‹ã€‚å®ƒå°†æ•°æ®å¤„ç†åˆ†ä¸ºä¸¤ä¸ªä¸»è¦é˜¶æ®µï¼šMap å’Œ Reduceï¼Œä»è€Œå®ç°å¯¹å¤§æ•°æ®çš„å¹¶è¡Œè®¡ç®—å’Œåˆ†å¸ƒå¼å¤„ç†ã€‚MapReduceçš„è®¾è®¡ç›®æ ‡æ˜¯èƒ½å¤Ÿåœ¨è®¡ç®—æœºé›†ç¾¤ä¸Šé«˜æ•ˆå¤„ç†TBçº§ç”šè‡³PBçº§çš„æ•°æ®é›†ã€‚</p>
<h1 id="2ç¼–ç¨‹æ¨¡å‹">2.ç¼–ç¨‹æ¨¡å‹</h1>
<p>ä¾‹å¦‚å¤§å‹æ–‡æ¡£é›†åˆä¸­æ¯ä¸ªå•è¯å‡ºç°æ¬¡æ•°çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨MapReduceå¤„ç†ï¼Œä¸‹æ–‡å°†é»˜è®¤å¤„ç†è¯¥é—®é¢˜ã€‚</p>
<h2 id="21example">2.1Example</h2>
<p>ä¼ªä»£ç ï¼š</p>
<blockquote>
<p>map(String key, String value):<br>
// key: document name<br>
// value: document contents<br>
for each word w in value:<br>
EmitIntermediate(w, &ldquo;1&rdquo;);<br>
reduce(String key, Iterator values):<br>
// key: a word<br>
// values: a list of counts<br>
int result = 0;<br>
for each v in values:<br>
result += ParseInt(v);<br>
Emit(AsString(result));</p></blockquote>
<p>mapå‡½æ•°å‘å‡ºæ¯ä¸ªå•è¯åŠ ä¸Šä¸€ä¸ªç›¸å…³çš„å‡ºç°æ¬¡æ•°è®¡æ•°(åœ¨è¿™ä¸ªç®€å•çš„ç¤ºä¾‹ä¸­åªæœ‰&rsquo; 1 &lsquo;)ã€‚reduceå‡½æ•°å°†é’ˆå¯¹ç‰¹å®šå•è¯å‘å‡ºçš„æ‰€æœ‰è®¡æ•°æ±‚å’Œã€‚
mapTaskå‡½æ•°å…·ä½“å®ç°ï¼š</p>
<blockquote>
<p>func mapTask(mapf func(string, string) []KeyValue, file string, mapID int, nReduce int) (map[string][]KeyValue, error) {<br>
// è¯»å–æ–‡ä»¶å†…å®¹<br>
content, err := os.ReadFile(file)<br>
if err != nil {<br>
return nil, fmt.Errorf(&ldquo;cannot read file %v: %v&rdquo;, file, err)<br>
}<br>
// è°ƒç”¨ç”¨æˆ·æä¾›çš„ map å‡½æ•°ç”Ÿæˆé”®å€¼å¯¹<br>
kvs := mapf(file, string(content))<br>
// åˆå§‹åŒ–ä¸­é—´æ•°æ®<br>
intermediateData := make(map[string][]KeyValue)<br>
// åˆå§‹åŒ–ä¸­é—´æ–‡ä»¶å’Œç¼–ç å™¨<br>
intermediateFiles := make([]*os.File, nReduce)<br>
encoders := make([]*json.Encoder, nReduce)<br>
for i := 0; i &lt; nReduce; i++ {<br>
intermediateFileName := fmt.Sprintf(&ldquo;mr-%d-%d&rdquo;, mapID, i)<br>
intermediateFile, err := os.Create(intermediateFileName)<br>
if err != nil {<br>
log.Printf(&ldquo;Worker: Cannot create intermediate file %s: %v&rdquo;, intermediateFileName, err)<br>
return nil, fmt.Errorf(&ldquo;cannot create intermediate file %s: %v&rdquo;, intermediateFileName, err)<br>
}<br>
defer intermediateFile.Close()<br>
intermediateFiles[i] = intermediateFile<br>
encoders[i] = json.NewEncoder(intermediateFile)<br>
}<br>
// å¯¹æ¯ä¸ªé”®å€¼å¯¹è¿›è¡Œå“ˆå¸Œï¼Œæ ¹æ®å“ˆå¸Œå€¼å†³å®šå†™å…¥å“ªä¸ªReduceä»»åŠ¡çš„ä¸­é—´æ–‡ä»¶<br>
for _, kv := range kvs {<br>
reduceTask := ihash(kv.Key) % nReduce<br>
if err := encoders[reduceTask].Encode(&amp;kv); err != nil {<br>
log.Printf(&ldquo;Worker: Cannot encode intermediate data for reduce task %d: %v&rdquo;, reduceTask, err)<br>
return nil, fmt.Errorf(&ldquo;cannot encode intermediate data for reduce task %d: %v&rdquo;, reduceTask, err)<br>
}<br>
intermediateData[fmt.Sprintf(&ldquo;mr-%d-%d&rdquo;, mapID, reduceTask)] = append(intermediateData[fmt.Sprintf(&ldquo;mr-%d-%d&rdquo;, mapID, reduceTask)], kv)<br>
}<br>
return intermediateData, nil<br>
}</p></blockquote>
<p>reduceTaskå‡½æ•°å…·ä½“å®ç°ï¼š</p>
<blockquote>
<p>func reduceTask(reducef func(string, []string) string, reduceID int, nMap int) error {<br>
intermediate := []KeyValue{}<br>
// è¯»å–æ‰€æœ‰ä¸­é—´æ–‡ä»¶å¹¶è§£æé”®å€¼å¯¹<br>
for i := 0; i &lt; nMap; i++ {<br>
intermediateFileName := fmt.Sprintf(&ldquo;mr-%d-%d&rdquo;, i, reduceID)<br>
file, err := os.Open(intermediateFileName)<br>
if err != nil {<br>
return fmt.Errorf(&ldquo;cannot open intermediate file %s: %v&rdquo;, intermediateFileName, err)<br>
}<br>
dec := json.NewDecoder(file)<br>
for {<br>
var kv KeyValue<br>
if err := dec.Decode(&amp;kv); err != nil {<br>
if err.Error() == &ldquo;EOF&rdquo; {<br>
break<br>
}<br>
return fmt.Errorf(&ldquo;error decoding intermediate file %s: %v&rdquo;, intermediateFileName, err)<br>
}<br>
intermediate = append(intermediate, kv)<br>
}<br>
defer file.Close() // ç¡®ä¿åœ¨æ¯æ¬¡è¯»å–æ–‡ä»¶åå…³é—­æ–‡ä»¶<br>
}<br>
// æŒ‰é”®æ’åº<br>
sort.Slice(intermediate, func(i, j int) bool {<br>
return intermediate[i].Key &lt; intermediate[j].Key<br>
})<br>
// åˆ›å»ºè¾“å‡ºæ–‡ä»¶<br>
outputFileName := fmt.Sprintf(&ldquo;mr-out-%d&rdquo;, reduceID)<br>
ofile, err := os.Create(outputFileName)<br>
if err != nil {<br>
return fmt.Errorf(&ldquo;cannot create output file %s: %v&rdquo;, outputFileName, err)<br>
}<br>
defer ofile.Close()<br>
// Reduceé˜¶æ®µï¼ŒæŒ‰é”®åˆå¹¶ç›¸åŒçš„é”®ï¼Œå¹¶è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„Reduceå‡½æ•°<br>
i := 0<br>
for i &lt; len(intermediate) {<br>
j := i + 1<br>
// æ‰¾å‡ºæ‰€æœ‰å…·æœ‰ç›¸åŒé”®çš„å€¼<br>
for j &lt; len(intermediate) &amp;&amp; intermediate[j].Key == intermediate[i].Key {<br>
j++<br>
}<br>
values := []string{}<br>
for k := i; k &lt; j; k++ {<br>
values = append(values, intermediate[k].Value)<br>
}<br>
// è°ƒç”¨ç”¨æˆ·æä¾›çš„Reduceå‡½æ•°å¤„ç†å€¼<br>
output := reducef(intermediate[i].Key, values)<br>
// æŒ‰æŒ‡å®šæ ¼å¼è¾“å‡ºç»“æœ<br>
fmt.Fprintf(ofile, &ldquo;%v %v\n&rdquo;, intermediate[i].Key, output)<br>
i = j<br>
}<br>
return nil<br>
}</p></blockquote>
<h2 id="22æ‰§è¡Œæ¦‚è¿°">2.2æ‰§è¡Œæ¦‚è¿°</h2>
<p><img src="../blogImg/%E6%89%A7%E8%A1%8C%E6%A6%82%E8%BF%B0.PNG" alt="Alt text"></p>
<p>Mapé˜¶æ®µï¼šåœ¨Mapé˜¶æ®µï¼Œè¾“å…¥æ•°æ®è¢«åˆ†æˆå¤šä¸ªå°ç‰‡æ®µï¼ˆç§°ä¸ºåˆ†ç‰‡ï¼Œsplitï¼‰ï¼Œæ¯ä¸ªåˆ†ç‰‡éƒ½ä½œä¸ºä¸€ä¸ªé”®å€¼å¯¹ï¼ˆkey-value pairï¼‰ä¼ é€’ç»™Mapå‡½æ•°ã€‚Mapå‡½æ•°å¯¹è¾“å…¥çš„é”®å€¼å¯¹è¿›è¡Œå¤„ç†ï¼Œç„¶åç”Ÿæˆä¸€ç»„ä¸­é—´çš„é”®å€¼å¯¹ã€‚è¿™äº›ä¸­é—´é”®å€¼å¯¹é€šå¸¸ä¼šæŒ‰ç…§é”®è¿›è¡Œåˆ†ç»„ï¼Œä»¥ä¾¿åç»­çš„Reduceé˜¶æ®µè¿›è¡Œå¤„ç†ã€‚
ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ç»Ÿè®¡ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ä¸­æ¯ä¸ªå•è¯å‡ºç°çš„æ¬¡æ•°ï¼ŒMapå‡½æ•°çš„è¾“å…¥æ˜¯æ–‡ä»¶ä¸­çš„æ¯ä¸€è¡Œï¼ˆä½œä¸ºvalueï¼‰ï¼Œæ¯ä¸€è¡Œè¢«åˆ†å‰²æˆå•è¯ï¼Œç„¶åMapå‡½æ•°è¾“å‡ºä¸€ä¸ªå•è¯å’Œè®¡æ•°å€¼ï¼ˆåˆå§‹ä¸º1ï¼‰çš„é”®å€¼å¯¹ã€‚</p>
<p>æœ‰ä¸€ä¸ªç‰¹æ®Šçš„masterå’Œå¤šä¸ªç”±masteråˆ†é…çš„workerã€‚
æœ‰Mä¸ªmapä»»åŠ¡å’ŒRä¸ªreduceä»»åŠ¡è¦åˆ†é…ã€‚masteré€‰æ‹©ç©ºé—²çš„workerï¼Œå¹¶ä¸ºæ¯ä¸ªworkeråˆ†é…ä¸€ä¸ªmapä»»åŠ¡æˆ–reduceä»»åŠ¡ã€‚</p>
<p>ä¸€ä¸ªè¢«åˆ†é…Mapä»»åŠ¡çš„workeréœ€è¦ä»åˆ‡ç‰‡ä¸­è¯»å–å†…å®¹ï¼Œä»ä¸­è§£æå‡ºkey/valueå¯¹åä¼ å…¥ç”¨æˆ·å®šä¹‰çš„mapæ–¹æ³•ï¼Œmapæ–¹æ³•äº§ç”Ÿçš„ä¸­é—´key/valueå¯¹æ”¾åœ¨å†…å­˜ç¼“å†²åŒºä¸­ã€‚</p>
<p>è¿™äº›key/valueå¯¹å‘¨æœŸæ€§çš„å†™å…¥ç£ç›˜ï¼Œå®ƒä»¬åœ¨ç£ç›˜çš„ä½ç½®è¢«ä¼ é€’ç»™masterï¼Œmasterå°†è¿™äº›æ•°æ®åˆ†é…ç»™æ‰§è¡Œreduceä»»åŠ¡çš„workerã€‚</p>
<p>å½“reduce workerè¯»å–äº†æ‰€æœ‰ä¸­é—´æ•°æ®åï¼Œå®ƒæŒ‰ä¸­é—´é”®å¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œä»¥ä¾¿å°†æ‰€æœ‰å‡ºç°çš„ç›¸åŒé”®åˆ†ç»„åœ¨ä¸€èµ·ã€‚</p>
<p>reduce workeréå†æ‰€æœ‰çš„ä¸­é—´æ•°æ®ï¼Œå°†æ¯ä¸ªå”¯ä¸€çš„ä¸­é—´æ•°æ®ä¼ ç»™ç”¨æˆ·å®šä¹‰çš„reduceå‡½æ•°ã€‚</p>
<h2 id="23master-data-structures">2.3Master Data Structures</h2>
<p>Masterç»“æ„ä½“çš„å®šä¹‰ä¸¾ä¾‹ï¼š</p>
<blockquote>
<p>type Master struct {<br>
files            []string                      // è¾“å…¥æ–‡ä»¶åˆ—è¡¨<br>
nReduce          int                           // reduce ä»»åŠ¡æ•°é‡<br>
mapTasks         int                           // map ä»»åŠ¡æ•°é‡<br>
reduceTasks      int                           // reduce ä»»åŠ¡æ•°é‡<br>
taskStatus       map[int]string                // ä»»åŠ¡çŠ¶æ€<br>
taskMutex        sync.Mutex                    // äº’æ–¥é”<br>
done             bool                          // ä»»åŠ¡æ˜¯å¦å®Œæˆ<br>
intermediateData map[int]map[string][]KeyValue // ä¸­é—´æ•°æ®<br>
taskTimeout      map[int]time.Time             // ä»»åŠ¡è¶…æ—¶æ—¶é—´<br>
timeout          time.Duration                 // ä»»åŠ¡è¶…æ—¶æ—¶é—´é—´éš”<br>
}</p></blockquote>
<h2 id="24åˆ†é…ä»»åŠ¡">2.4åˆ†é…ä»»åŠ¡</h2>
<p>ä¸‹é¢æ˜¯åˆ†é…ä»»åŠ¡å‡½æ•°ï¼ˆGetTaskï¼‰ä¾‹å­ï¼š</p>
<blockquote>
<p>func (m *Master) GetTask(args *TaskRequest, reply *TaskReply) error {<br>
m.taskMutex.Lock()<br>
defer m.taskMutex.Unlock()<br>
// æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ä»»åŠ¡éƒ½å·²å®Œæˆ<br>
if m.done {<br>
reply.TaskType = &quot;&quot; // æ˜¾å¼è®¾ç½®ä¸ºç©ºçš„ä»»åŠ¡ç±»å‹ä»¥è¡¨ç¤ºæ²¡æœ‰æ›´å¤šä»»åŠ¡<br>
return nil<br>
}<br>
now := time.Now()<br>
taskAssigned := false<br>
// é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ‰€æœ‰ Map ä»»åŠ¡å®Œæˆ<br>
allMapCompleted := true<br>
for i := 0; i &lt; m.mapTasks; i++ {<br>
status, ok := m.taskStatus[i]<br>
if !ok || status != &ldquo;completed&rdquo; {<br>
allMapCompleted = false<br>
break<br>
}<br>
}<br>
if !allMapCompleted {<br>
// åˆ†é… Map ä»»åŠ¡<br>
for i := 0; i &lt; m.mapTasks; i++ {<br>
status, ok := m.taskStatus[i]<br>
if (!ok || status == &ldquo;pending&rdquo;) || (status == &ldquo;in-progress&rdquo; &amp;&amp; now.Sub(m.taskTimeout[i]) &gt; m.timeout) {<br>
reply.TaskType = string(Map)<br>
reply.TaskID = i<br>
reply.NMap = len(m.files)<br>
reply.File = m.files[i]<br>
reply.NReduce = m.nReduce<br>
reply.Data = make(map[string][]KeyValue)<br>
m.taskStatus[i] = &ldquo;in-progress&rdquo;<br>
m.taskTimeout[i] = now<br>
taskAssigned = true<br>
break<br>
}<br>
}<br>
} else {<br>
// å¦‚æœæ‰€æœ‰ Map ä»»åŠ¡å®Œæˆï¼Œåˆ†é… Reduce ä»»åŠ¡<br>
for i := 0; i &lt; m.reduceTasks; i++ {<br>
status, ok := m.taskStatus[i+m.mapTasks]<br>
if (!ok || status == &ldquo;pending&rdquo;) || (status == &ldquo;in-progress&rdquo; &amp;&amp; now.Sub(m.taskTimeout[i+m.mapTasks]) &gt; m.timeout) {<br>
reply.TaskType = string(Reduce)<br>
reply.TaskID = i + m.mapTasks<br>
reply.NMap = len(m.files)<br>
reply.ReduceID = i<br>
reply.NReduce = m.nReduce<br>
reply.Data = make(map[string][]KeyValue)<br>
m.taskStatus[i+m.mapTasks] = &ldquo;in-progress&rdquo;<br>
m.taskTimeout[i+m.mapTasks] = now<br>
taskAssigned = true<br>
break<br>
}<br>
}<br>
}<br>
if taskAssigned {<br>
return nil<br>
}<br>
// å¦‚æœæ²¡æœ‰å¯åˆ†é…çš„ä»»åŠ¡ï¼Œæ£€æŸ¥æ‰€æœ‰ä»»åŠ¡æ˜¯å¦å®Œæˆ<br>
allCompleted := true<br>
for _, status := range m.taskStatus {<br>
if status != &ldquo;completed&rdquo; {<br>
allCompleted = false<br>
break<br>
}<br>
}<br>
if allCompleted {<br>
m.done = true<br>
reply.TaskType = &quot;&quot; // æ²¡æœ‰æ›´å¤šä»»åŠ¡æ—¶æ˜¾å¼è®¾ç½®ä¸ºç©º<br>
}<br>
return nil<br>
}</p></blockquote>
<h1 id="3é«˜å¯ç”¨">3.é«˜å¯ç”¨</h1>
<h2 id="31workerå®•æœº">3.1workerå®•æœº</h2>
<p>masterå®šæœŸpingæ¯ä¸ªworkerã€‚å¦‚æœåœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°æ¥è‡ªworkerçš„å“åº”ï¼Œåˆ™masterå°†è¯¥workeræ ‡è®°ä¸ºå¤±è´¥ã€‚å·¥ä½œçº¿ç¨‹å®Œæˆçš„ä»»ä½•maptaskéƒ½è¢«é‡ç½®å›å…¶åˆå§‹ç©ºé—²çŠ¶æ€ï¼Œå› æ­¤å¯ä»¥åœ¨å…¶ä»–å·¥ä½œçº¿ç¨‹ä¸Šè°ƒåº¦ã€‚åœ¨å¤±è´¥çš„workerä¸Šæ­£åœ¨è¿›è¡Œçš„ä»»ä½•mapä»»åŠ¡æˆ–reducetaskä¹Ÿè¢«é‡ç½®ä¸ºç©ºé—²ï¼Œå¹¶æœ‰èµ„æ ¼é‡æ–°è°ƒåº¦ã€‚
å®Œæˆçš„mapä»»åŠ¡åœ¨å‘ç”Ÿæ•…éšœæ—¶é‡æ–°æ‰§è¡Œï¼Œå› ä¸ºå®ƒä»¬çš„è¾“å‡ºå­˜å‚¨åœ¨æ•…éšœæœºå™¨çš„æœ¬åœ°ç£ç›˜ä¸Šï¼Œå› æ­¤æ— æ³•è®¿é—®ã€‚
å®Œæˆçš„reduceä»»åŠ¡ä¸éœ€è¦é‡æ–°æ‰§è¡Œï¼Œå› ä¸ºå®ƒä»¬çš„è¾“å‡ºå­˜å‚¨åœ¨å…¨å±€æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚å½“mapä»»åŠ¡é¦–å…ˆç”±worker Aæ‰§è¡Œï¼Œç„¶åç”±worker Bæ‰§è¡Œ(å› ä¸ºAå¤±è´¥)æ—¶ï¼Œmasterä¼šé€šçŸ¥æ‰§è¡Œreduceä»»åŠ¡çš„workeré‡æ‰§è¡Œã€‚ä»»ä½•å°šæœªä»worker Aè¯»å–æ•°æ®çš„reduceä»»åŠ¡éƒ½å°†ä»worker Bè¯»å–æ•°æ®ã€‚</p>
<h2 id="32masterå®•æœº">3.2masterå®•æœº</h2>
<p>masterå®šæœŸå°†å®ƒç»´æŠ¤çš„å…³é”®æ•°æ®ç»“æ„ï¼ˆå¦‚ä»»åŠ¡çŠ¶æ€ã€èµ„æºåˆ†é…ä¿¡æ¯ç­‰ï¼‰å†™å…¥æ£€æŸ¥ç‚¹ï¼ˆcheckpointï¼‰ã€‚å¦‚æœmasterå®•æœºäº†ï¼Œç³»ç»Ÿå¯ä»¥ä»æœ€åä¸€æ¬¡æ£€æŸ¥ç‚¹çš„çŠ¶æ€æ¢å¤ï¼Œè€Œä¸éœ€è¦ä»å¤´å¼€å§‹æ•´ä¸ªè®¡ç®—ã€‚
å¦‚æœmasterçš„ä»»åŠ¡å¤±è´¥ï¼ˆå³masterå®•æœºæˆ–å´©æºƒï¼‰ï¼Œå¯ä»¥ä»æœ€åä¸€æ¬¡æ£€æŸ¥ç‚¹çš„çŠ¶æ€é‡æ–°å¯åŠ¨ä¸€ä¸ªæ–°çš„masterå‰¯æœ¬ã€‚è¿™ä¸ªæ–°çš„masterå°†ä»ä¿å­˜çš„æ£€æŸ¥ç‚¹çŠ¶æ€ä¸­æ¢å¤ï¼Œç»§ç»­è¿›è¡ŒMapReduceè®¡ç®—ã€‚</p>

    </div>
    <a href="/posts/mapreduce/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="w-100 w-30-l mb4 relative bg-white">
          <div class="w-100 mb4 nested-copy-line-height relative bg-white">
  <div class="mb3 pa4 gray overflow-hidden bg-white">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/miniob-b&#43;%E6%A0%91/" class="link black dim">
        
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <p>ç‚¹å‡»è¿”å›<a href="https://2549141519.github.io/#/toc">ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•</a></p>
<ul>
<li>ç›®å½•
{:toc}</li>
</ul>
<!-- raw HTML omitted -->
<h1 id="1-bæ ‘ä»‹ç»">1. B+æ ‘ä»‹ç»</h1>
<p>B+æ ‘æ˜¯ä¸€ç§å¹³è¡¡çš„æ ‘å½¢æ•°æ®ç»“æ„ï¼Œé€šå¸¸ç”¨äºæ•°æ®åº“å’Œæ–‡ä»¶ç³»ç»Ÿç­‰éœ€è¦é¢‘ç¹è¿›è¡Œç£ç›˜å­˜å–çš„å¤§å‹æ•°æ®ç®¡ç†ç³»ç»Ÿã€‚å®ƒæ˜¯Bæ ‘çš„æ‰©å±•ç‰ˆæœ¬ï¼Œå…·æœ‰æ›´é«˜æ•ˆçš„æŸ¥è¯¢å’ŒèŒƒå›´æŸ¥è¯¢èƒ½åŠ›ã€‚B+æ ‘çš„è®¾è®¡åˆè¡·æ˜¯ä¸ºäº†ä¼˜åŒ–ç£ç›˜å­˜å–çš„æ•ˆç‡ï¼Œå› è€Œåœ¨å¤„ç†å¤§è§„æ¨¡æ•°æ®æ—¶éå¸¸é€‚åˆã€‚</p>
<h2 id="11-bæ ‘çš„ç»“æ„ç‰¹ç‚¹">1.1 B+æ ‘çš„ç»“æ„ç‰¹ç‚¹</h2>
<p>æ‰€æœ‰å…³é”®å­—éƒ½å‡ºç°åœ¨å¶å­èŠ‚ç‚¹ï¼š<br>
B+æ ‘ä¸Bæ ‘çš„ä¸»è¦åŒºåˆ«ä¹‹ä¸€æ˜¯ï¼ŒB+æ ‘ä¸­æ‰€æœ‰çš„å…³é”®å­—éƒ½å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ä¸­ï¼Œå†…éƒ¨èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•ä¿¡æ¯ã€‚å¶å­èŠ‚ç‚¹æŒ‰ç…§å…³é”®å­—çš„é¡ºåºæ’åˆ—ï¼Œå¹¶é€šè¿‡æŒ‡é’ˆè¿æ¥ï¼Œå½¢æˆä¸€ä¸ªæœ‰åºçš„é“¾è¡¨ã€‚</p>
<p>å†…èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•è€Œä¸å­˜å‚¨æ•°æ®ï¼š<br>
B+æ ‘çš„éå¶å­èŠ‚ç‚¹ï¼ˆå†…èŠ‚ç‚¹ï¼‰ä¸å­˜å‚¨å®é™…æ•°æ®ï¼Œå®ƒä»¬åªæ˜¯ç”¨äºæŒ‡å¼•æŸ¥è¯¢è·¯å¾„çš„ç´¢å¼•ï¼ŒæŒ‡å‘å­æ ‘æˆ–å¶å­èŠ‚ç‚¹ã€‚</p>
<p>æ‰€æœ‰å¶å­èŠ‚ç‚¹åœ¨åŒä¸€å±‚ï¼š<br>
B+æ ‘æ˜¯é«˜åº¦å¹³è¡¡çš„ï¼Œå³æ‰€æœ‰å¶å­èŠ‚ç‚¹éƒ½åœ¨åŒä¸€å±‚ï¼Œç¡®ä¿æŸ¥è¯¢æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¸º<code>O(log n)</code>ï¼Œå…¶ä¸­<code>n</code>æ˜¯æ•°æ®é¡¹çš„æ€»æ•°ã€‚</p>
<p>å¶å­èŠ‚ç‚¹é“¾è¡¨ç»“æ„ï¼š<br>
å¶å­èŠ‚ç‚¹ä¹‹é—´æ˜¯æœ‰åºé“¾è¡¨ï¼Œæ„å‘³ç€åœ¨è¿›è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶ï¼Œå¯ä»¥é€šè¿‡å¶å­èŠ‚ç‚¹çš„é¡ºåºè®¿é—®å¿«é€Ÿè·å–ä¸€ç»„è¿ç»­çš„ç»“æœã€‚</p>
<h2 id="12-bæ ‘çš„ä¼˜ç‚¹">1.2 B+æ ‘çš„ä¼˜ç‚¹</h2>
<p>èŒƒå›´æŸ¥è¯¢æ€§èƒ½ä¼˜å¼‚ï¼š<br>
ç”±äºå¶å­èŠ‚ç‚¹ä¹‹é—´çš„é“¾è¡¨ç»“æ„ï¼ŒB+æ ‘åœ¨å¤„ç†èŒƒå›´æŸ¥è¯¢æ—¶è¡¨ç°æä¸ºä¼˜ç§€ï¼Œå¯ä»¥ä»èµ·å§‹ä½ç½®æ²¿ç€é“¾è¡¨é¡ºåºè¯»å–ã€‚</p>
<p>ç£ç›˜I/Oä¼˜åŒ–ï¼š<br>
B+æ ‘çš„è®¾è®¡ç›®æ ‡æ˜¯å‡å°‘ç£ç›˜I/Oæ“ä½œã€‚å†…èŠ‚ç‚¹ä¸å­˜å‚¨å®é™…æ•°æ®ï¼Œå› æ­¤å¯ä»¥å°†æ›´å¤šçš„ç´¢å¼•èŠ‚ç‚¹æ”¾å…¥å†…å­˜ä¸­ï¼Œå‡å°‘ä»ç£ç›˜è¯»å–æ•°æ®çš„æ¬¡æ•°ã€‚</p>
<p>å¹³è¡¡æ€§ï¼š<br>
B+æ ‘æ˜¯ä¸€ç§å¹³è¡¡æ ‘ï¼Œä¿è¯äº†æ’å…¥ã€åˆ é™¤ã€æŸ¥è¯¢æ“ä½œçš„æ—¶é—´å¤æ‚åº¦å§‹ç»ˆä¿æŒåœ¨<code>O(log n)</code>ã€‚</p>
<p>å­˜å‚¨å¯†åº¦é«˜ï¼š<br>
ç”±äºå†…èŠ‚ç‚¹ä¸å­˜å‚¨æ•°æ®ï¼ŒB+æ ‘å¯ä»¥å°†æ›´å¤šçš„ç´¢å¼•èŠ‚ç‚¹æ”¾å…¥å†…å­˜ï¼Œä»è€Œæœ‰æ•ˆåˆ©ç”¨ç³»ç»Ÿçš„ç¼“å­˜ã€‚</p>
<h2 id="13-bæ ‘çš„åº”ç”¨åœºæ™¯">1.3 B+æ ‘çš„åº”ç”¨åœºæ™¯</h2>
<p>æ•°æ®åº“ç³»ç»Ÿï¼š<br>
åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼ŒB+æ ‘å¸¸ç”¨äºå®ç°ç´¢å¼•ï¼Œå¦‚MySQLä¸­çš„InnoDBå­˜å‚¨å¼•æ“å°±ä½¿ç”¨B+æ ‘ä½œä¸ºå…¶ä¸»é”®ç´¢å¼•ç»“æ„ã€‚</p>
<p>æ–‡ä»¶ç³»ç»Ÿï¼š<br>
ä¸€äº›æ–‡ä»¶ç³»ç»Ÿï¼Œå¦‚NTFSï¼Œä¹Ÿé‡‡ç”¨B+æ ‘æ¥ç®¡ç†æ–‡ä»¶å’Œç›®å½•æ•°æ®ã€‚</p>
<p>å¤§è§„æ¨¡æ•°æ®å­˜å‚¨ï¼š<br>
B+æ ‘ç‰¹åˆ«é€‚åˆéœ€è¦åœ¨ç£ç›˜ä¸­ç®¡ç†å¤§è§„æ¨¡æ•°æ®çš„åœºæ™¯ï¼Œèƒ½å¤Ÿå¾ˆå¥½åœ°å¤„ç†ç£ç›˜I/Oã€‚</p>
<h2 id="14-bæ ‘ä¸bæ ‘çš„åŒºåˆ«">1.4 B+æ ‘ä¸Bæ ‘çš„åŒºåˆ«</h2>
<p>æ•°æ®å­˜å‚¨ä½ç½®ï¼š<br>
Bæ ‘çš„æ•°æ®æ—¢å­˜å‚¨åœ¨å†…èŠ‚ç‚¹ä¹Ÿå­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼Œè€ŒB+æ ‘çš„æ•°æ®åªå­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ã€‚</p>
<p>èŒƒå›´æŸ¥è¯¢æ•ˆç‡ï¼š<br>
ç”±äºB+æ ‘çš„å¶å­èŠ‚ç‚¹æ„æˆé“¾è¡¨ç»“æ„ï¼Œè¿›è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶å¯ä»¥ç›´æ¥ä»é“¾è¡¨ä¸­éå†ï¼Œè€ŒBæ ‘åˆ™éœ€è¦æ›´å¤šçš„æ ‘éå†æ“ä½œã€‚</p>
<p>èŠ‚ç‚¹ç»“æ„ï¼š<br>
B+æ ‘çš„å†…èŠ‚ç‚¹æ›´ä¸ºç´§å‡‘ï¼Œå› ä¸ºå®ƒä»¬åªå­˜å‚¨ç´¢å¼•ï¼Œè€ŒBæ ‘çš„å†…èŠ‚ç‚¹å­˜å‚¨ç´¢å¼•å’Œæ•°æ®ã€‚</p>
<h1 id="2-bæ ‘åœ¨miniobçš„åº”ç”¨">2. B+æ ‘åœ¨miniobçš„åº”ç”¨</h1>
<h2 id="21-bæ ‘çš„ç»“æ„ä¸èŠ‚ç‚¹">2.1 B+æ ‘çš„ç»“æ„ä¸èŠ‚ç‚¹</h2>
<h3 id="211-indexfileheader">2.1.1 <code>IndexFileHeader</code></h3>
<p><code>IndexFileHeader</code>ï¼š<br>
ç”¨äºå­˜å‚¨ B+ æ ‘çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬æ ¹èŠ‚ç‚¹é¡µé¢ç¼–å·ã€å†…éƒ¨èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹çš„æœ€å¤§å¤§å°ã€å±æ€§é•¿åº¦ç­‰ã€‚</p>
<pre tabindex="0"><code>struct IndexFileHeader
{
  IndexFileHeader()
  {
    memset(this, 0, sizeof(IndexFileHeader));
    root_page = BP_INVALID_PAGE_NUM;
  }
  PageNum  root_page;          ///&lt; æ ¹èŠ‚ç‚¹åœ¨ç£ç›˜ä¸­çš„é¡µå·
  int32_t  internal_max_size;  ///&lt; å†…éƒ¨èŠ‚ç‚¹æœ€å¤§çš„é”®å€¼å¯¹æ•°
  int32_t  leaf_max_size;      ///&lt; å¶å­èŠ‚ç‚¹æœ€å¤§çš„é”®å€¼å¯¹æ•°
  int32_t  attr_length;        ///&lt; é”®å€¼çš„é•¿åº¦
  int32_t  key_length;         ///&lt; attr length + sizeof(RID)
  AttrType attr_type;          ///&lt; é”®å€¼çš„ç±»å‹

  const string to_string() const
  {
    stringstream ss;

    ss &lt;&lt; &#34;attr_length:&#34; &lt;&lt; attr_length &lt;&lt; &#34;,&#34;
       &lt;&lt; &#34;key_length:&#34; &lt;&lt; key_length &lt;&lt; &#34;,&#34;
       &lt;&lt; &#34;attr_type:&#34; &lt;&lt; attr_type_to_string(attr_type) &lt;&lt; &#34;,&#34;
       &lt;&lt; &#34;root_page:&#34; &lt;&lt; root_page &lt;&lt; &#34;,&#34;
       &lt;&lt; &#34;internal_max_size:&#34; &lt;&lt; internal_max_size &lt;&lt; &#34;,&#34;
       &lt;&lt; &#34;leaf_max_size:&#34; &lt;&lt; leaf_max_size &lt;&lt; &#34;;&#34;;

    return ss.str();
  }
};
</code></pre><p><code>PageNum root_page</code>ï¼š<br>
è¯¥å˜é‡å­˜å‚¨äº†æ ¹èŠ‚ç‚¹åœ¨ç£ç›˜ä¸­çš„é¡µå·ï¼Œç”¨äºæŒ‡ç¤ºB+æ ‘åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„å­˜å‚¨ä½ç½®ã€‚<code>BP_INVALID_PAGE_NUM</code> è¡¨ç¤ºä¸€ä¸ªæ— æ•ˆçš„é¡µå·ã€‚<br>
<code>int32_t internal_max_size</code>ï¼š<br>
è¿™æ˜¯å†…éƒ¨èŠ‚ç‚¹ä¸­å¯ä»¥å­˜å‚¨çš„æœ€å¤§é”®å€¼å¯¹æ•°ã€‚å¯¹äºä¸€ä¸ªB+æ ‘çš„å†…éƒ¨èŠ‚ç‚¹è€Œè¨€ï¼Œå®ƒå­˜å‚¨çš„æ˜¯ç´¢å¼•ä¿¡æ¯å’ŒæŒ‡å‘å­èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œå› æ­¤è¿™ä¸ªå€¼å†³å®šäº†å†…éƒ¨èŠ‚ç‚¹çš„åˆ†è£‚å’Œåˆå¹¶ç­–ç•¥ã€‚<br>
<code>int32_t leaf_max_size</code>ï¼š<br>
å¶å­èŠ‚ç‚¹å¯ä»¥å­˜å‚¨çš„æœ€å¤§é”®å€¼å¯¹æ•°ã€‚å¶å­èŠ‚ç‚¹ä¸­å­˜å‚¨çš„æ˜¯å®é™…çš„æ•°æ®ï¼Œå®šä¹‰äº†B+æ ‘ä¸­å¶å­èŠ‚ç‚¹çš„å­˜å‚¨å®¹é‡ï¼Œå½±å“äº†B+æ ‘çš„æ·±åº¦å’ŒæŸ¥æ‰¾æ•ˆç‡ã€‚<br>
<code>int32_t attr_length</code>ï¼š<br>
é”®å€¼çš„é•¿åº¦ï¼Œé€šå¸¸æ˜¯æŒ‡æ•°æ®åº“ä¸­ç´¢å¼•å­—æ®µçš„é•¿åº¦ã€‚å®ƒå†³å®šäº†æ¯ä¸ªé”®åœ¨æ ‘ä¸­å æ®çš„ç©ºé—´å¤§å°ã€‚<br>
<code>int32_t key_length</code>ï¼š<br>
è¯¥å˜é‡è¡¨ç¤ºé”®å€¼çš„æ€»é•¿åº¦ï¼Œå³ <code>attr_length</code> åŠ ä¸Š <code>sizeof(RID)</code>ï¼Œå…¶ä¸­ <code>RID </code>æ˜¯æ•°æ®åº“ä¸­çš„è®°å½•æ ‡è¯†ç¬¦ï¼ˆRecord IDï¼‰ã€‚è¿™æ ·å¯ä»¥å­˜å‚¨ç´¢å¼•é”®åŠå…¶å¯¹åº”çš„è®°å½•ä½ç½®ã€‚<br>
<code>AttrType attr_type</code>ï¼š<br>
é”®å€¼çš„ç±»å‹ï¼Œå®šä¹‰äº†ç´¢å¼•æ‰€ä¾èµ–çš„å±æ€§ç±»å‹ï¼ˆå¦‚æ•´æ•°ã€å­—ç¬¦ä¸²ç­‰ï¼‰ã€‚è¯¥æšä¸¾ç±»å‹ç”¨äºæè¿°é”®å€¼çš„å®é™…æ•°æ®ç±»å‹ã€‚</p>
<p><code>to_string </code>å‡½æ•°:<br>
å®ƒå°†ç»“æ„ä½“çš„å…³é”®å­—æ®µéƒ½æ ¼å¼åŒ–ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¾“å‡ºå±æ€§é•¿åº¦ã€é”®é•¿åº¦ã€å±æ€§ç±»å‹ã€æ ¹é¡µå·ã€å†…éƒ¨èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹çš„æœ€å¤§å®¹é‡ç­‰ä¿¡æ¯,æ–¹ä¾¿è°ƒè¯•æˆ–è¾“å‡ºã€‚</p>
<h3 id="212-indexnode">2.1.2 <code>IndexNode</code></h3>
<p><code>IndexNode</code>ï¼š<br>
é€šç”¨çš„ B+ æ ‘èŠ‚ç‚¹ç»“æ„ï¼ŒåŒ…æ‹¬é¡µé¢ç±»å‹ã€é”®å€¼å¯¹æ•°é‡ä»¥åŠçˆ¶èŠ‚ç‚¹çš„é¡µé¢ç¼–å·ã€‚</p>
<pre tabindex="0"><code>struct IndexNode
{
  static constexpr int HEADER_SIZE = 12;

  bool    is_leaf;  /// å½“å‰æ˜¯å¶å­èŠ‚ç‚¹è¿˜æ˜¯å†…éƒ¨èŠ‚ç‚¹
  int     key_num;  /// å½“å‰é¡µé¢ä¸Šä¸€å…±æœ‰å¤šå°‘ä¸ªé”®å€¼å¯¹
  PageNum parent;   /// çˆ¶èŠ‚ç‚¹é¡µé¢ç¼–å·
};
</code></pre><h3 id="213-leafindexnode">2.1.3 <code>LeafIndexNode</code></h3>
<p><code>LeafIndexNode</code>ï¼š<br>
å¶å­èŠ‚ç‚¹çš„ç»“æ„ï¼Œå­˜å‚¨å®é™…çš„æ•°æ®å’ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹çš„æŒ‡é’ˆã€‚</p>
<pre tabindex="0"><code>struct LeafIndexNode : public IndexNode
{
  static constexpr int HEADER_SIZE = IndexNode::HEADER_SIZE + 4;

  PageNum next_brother;

  char array[0];
};
</code></pre><h3 id="214-internalindexnode">2.1.4 <code>InternalIndexNode</code></h3>
<p><code>InternalIndexNode</code>ï¼š<br>
å†…éƒ¨èŠ‚ç‚¹çš„ç»“æ„ï¼Œå­˜å‚¨é”®å€¼å’Œå­é¡µé¢ç¼–å·ã€‚</p>
<pre tabindex="0"><code>struct InternalIndexNode : public IndexNode
{
  static constexpr int HEADER_SIZE = IndexNode::HEADER_SIZE;

  char array[0];
};  
</code></pre><h2 id="22-bæ ‘çš„æ“ä½œ">2.2 B+æ ‘çš„æ“ä½œ</h2>
<h3 id="221-æ’å…¥æ“ä½œ">2.2.1 æ’å…¥æ“ä½œ</h3>
<p>é€šè¿‡ <code>insert_entry</code> æ–¹æ³•å°†é”®å€¼å¯¹æ’å…¥ B+ æ ‘ä¸­ã€‚å¦‚æœå¶å­èŠ‚ç‚¹æˆ–å†…éƒ¨èŠ‚ç‚¹æ»¡äº†ï¼Œè°ƒç”¨ <a href="#241-%E5%88%86%E8%A3%82"><code>split</code></a> æ–¹æ³•è¿›è¡ŒèŠ‚ç‚¹åˆ†è£‚ã€‚</p>
<pre tabindex="0"><code>RC BplusTreeHandler::insert_entry(const char *user_key, const RID *rid)
{
  if (user_key == nullptr || rid == nullptr) {
    LOG_WARN(&#34;Invalid arguments, key is empty or rid is empty&#34;);
    return RC::INVALID_ARGUMENT;
  }

  MemPoolItem::item_unique_ptr pkey = make_key(user_key, *rid);
  if (pkey == nullptr) {
    LOG_WARN(&#34;Failed to alloc memory for key.&#34;);
    return RC::NOMEM;
  }

  RC rc = RC::SUCCESS;

  BplusTreeMiniTransaction mtr(*this, &amp;rc);

  char *key = static_cast&lt;char *&gt;(pkey.get());

  if (is_empty()) {
    root_lock_.lock();
    if (is_empty()) {
      rc = create_new_tree(mtr, key, rid);
      root_lock_.unlock();
      return rc;
    }
    root_lock_.unlock();
  }

  Frame *frame = nullptr;

  rc = find_leaf(mtr, BplusTreeOperationType::INSERT, key, frame);
  if (OB_FAIL(rc)) {
    LOG_WARN(&#34;Failed to find leaf %s. rc=%d:%s&#34;, rid-&gt;to_string().c_str(), rc, strrc(rc));
    return rc;
  }

  rc = insert_entry_into_leaf_node(mtr, frame, key, rid);
  if (OB_FAIL(rc)) {
    LOG_TRACE(&#34;Failed to insert into leaf of index, rid:%s. rc=%s&#34;, rid-&gt;to_string().c_str(), strrc(rc));
    return rc;
  }

  LOG_TRACE(&#34;insert entry success&#34;);
  return RC::SUCCESS;
}
</code></pre><p><code>const char *user_key</code>ï¼š<br>
ç”¨æˆ·æä¾›çš„é”®å€¼ï¼Œè¡¨ç¤ºéœ€è¦æ’å…¥åˆ°B+æ ‘ä¸­çš„æ•°æ®ã€‚<br>
<code>const RID *rid</code>ï¼š<br>
è®°å½•æ ‡è¯†ç¬¦ï¼ˆRecord IDï¼‰ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†ä¸€æ¡è®°å½•åœ¨æ•°æ®åº“ä¸­çš„ä½ç½®ã€‚æ¯ä¸ª<code>user_key</code>éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„<code>rid</code>ã€‚</p>
<p>è¾“å…¥æ£€æŸ¥ï¼š<br>
åœ¨æ’å…¥æ“ä½œä¹‹å‰ï¼Œé¦–å…ˆæ£€æŸ¥ <code>user_key</code> å’Œ<code>rid</code>æ˜¯å¦ä¸ºç©ºï¼Œç¡®ä¿è¾“å…¥å‚æ•°çš„åˆæ³•æ€§ã€‚å¦‚æœä¸ºç©ºï¼Œåˆ™è®°å½•ä¸€ä¸ªè­¦å‘Šæ—¥å¿—å¹¶è¿”å› <code>RC::INVALID_ARGUMENT</code> é”™è¯¯ç ã€‚<br>
åˆ›å»ºé”®çš„å‰¯æœ¬ï¼š<br>
ä½¿ç”¨ <code>make_key</code> å‡½æ•°å°† <code>user_key</code> å’Œ <code>rid</code> ç»„åˆæˆä¸€ä¸ªé”®å€¼å¯¹ï¼Œå¹¶ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ <code>MemPoolItem::item_unique_ptr</code> æ¥ç®¡ç†å…¶å†…å­˜ã€‚å¦‚æœå†…å­˜åˆ†é…å¤±è´¥ï¼Œè¿”å› <code>RC::NOMEM</code>ã€‚<br>
<code>BplusTreeMiniTransaction mtr(*this, &amp;rc);</code>:<br>
åˆ›å»ºä¸€ä¸ª <code>BplusTreeMiniTransaction</code> å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡é€šå¸¸ç”¨äºç®¡ç†B+æ ‘çš„äº‹åŠ¡æ“ä½œï¼Œç¡®ä¿åœ¨æ’å…¥æ“ä½œè¿‡ç¨‹ä¸­çš„ä¸€è‡´æ€§å’Œå¹¶å‘æ§åˆ¶ã€‚<code>mtr</code> è¡¨ç¤ºäº‹åŠ¡å¯¹è±¡ï¼Œå®ƒä¼šè·Ÿè¸ªå¹¶å¤„ç†æ’å…¥è¿‡ç¨‹ä¸­å¯èƒ½å‘ç”Ÿçš„é”™è¯¯ã€‚<br>
ç©ºæ ‘å¤„ç†ï¼š<br>
å¦‚æœå½“å‰B+æ ‘ä¸ºç©ºï¼ˆå³è¿˜æ²¡æœ‰æ ¹èŠ‚ç‚¹ï¼‰ï¼Œä½¿ç”¨ <code>root_lock_</code> é”å®šæ ¹èŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨ <code>create_new_tree</code> æ¥åˆ›å»ºä¸€ä¸ªæ–°æ ‘ç»“æ„ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ’å…¥æ“ä½œç›´æ¥è¿”å›åˆ›å»ºæ ‘çš„ç»“æœã€‚<code>is_empty()</code> åˆ¤æ–­æ ‘æ˜¯å¦ä¸ºç©ºï¼Œé€šè¿‡åŒé‡æ£€æŸ¥é”æœºåˆ¶é¿å…é‡å¤åˆ›å»ºæ ‘ã€‚<br>
æŸ¥æ‰¾å¶å­èŠ‚ç‚¹ï¼š<br>
ä½¿ç”¨<code>find_leaf</code>å‡½æ•°æ ¹æ® <code>key </code>æ‰¾åˆ°é€‚åˆæ’å…¥çš„å¶å­èŠ‚ç‚¹ã€‚<code>find_leaf</code> æ˜¯æŸ¥æ‰¾å¶å­èŠ‚ç‚¹çš„æ ¸å¿ƒæ“ä½œä¹‹ä¸€ï¼Œå®ƒå°†éå†B+æ ‘ç›´åˆ°æ‰¾åˆ°åŒ…å«æ­¤é”®çš„å¶å­èŠ‚ç‚¹ã€‚å¦‚æœæŸ¥æ‰¾å¤±è´¥ï¼ˆ<code>OB_FAIL(rc)</code>ï¼‰ï¼Œè®°å½•è­¦å‘Šæ—¥å¿—å¹¶è¿”å›ç›¸åº”çš„é”™è¯¯ç ã€‚<br>
æ’å…¥å¶å­èŠ‚ç‚¹ï¼š<br>
æ‰¾åˆ°ç›®æ ‡å¶å­èŠ‚ç‚¹åï¼Œè°ƒç”¨ <code>insert_entry_into_leaf_node</code> å‡½æ•°ï¼Œå°† <code>key </code>å’Œ <code>rid</code> æ’å…¥åˆ°å¶å­èŠ‚ç‚¹ä¸­ã€‚</p>
<h3 id="222-åˆ é™¤æ“ä½œ">2.2.2 åˆ é™¤æ“ä½œ</h3>
<p>é€šè¿‡ <code>delete_entry</code> æ–¹æ³•åˆ é™¤é”®å€¼å¯¹ã€‚åˆ é™¤æ—¶å¦‚æœèŠ‚ç‚¹æ•°é‡å°äºæœ€å°å®¹é‡ï¼Œåˆ™å¯èƒ½éœ€è¦åˆå¹¶ç›¸é‚»èŠ‚ç‚¹æˆ–é‡æ–°åˆ†é…èŠ‚ç‚¹ä¸­çš„å…ƒç´ ã€‚</p>
<pre tabindex="0"><code>RC BplusTreeHandler::delete_entry_internal(BplusTreeMiniTransaction &amp;mtr, Frame *leaf_frame, const char *key)
{
  LeafIndexNodeHandler leaf_index_node(mtr, file_header_, leaf_frame);

  const int remove_count = leaf_index_node.remove(key, key_comparator_);
  if (remove_count == 0) {
    LOG_TRACE(&#34;no data need to remove&#34;);
    // disk_buffer_pool_-&gt;unpin_page(leaf_frame);
    return RC::RECORD_NOT_EXIST;
  }
  // leaf_index_node.validate(key_comparator_, disk_buffer_pool_, file_id_);

  leaf_frame-&gt;mark_dirty();

  if (leaf_index_node.size() &gt;= leaf_index_node.min_size()) {
    return RC::SUCCESS;
  }

  return coalesce_or_redistribute&lt;LeafIndexNodeHandler&gt;(mtr, leaf_frame);
}

RC BplusTreeHandler::delete_entry(const char *user_key, const RID *rid)
{
  MemPoolItem::item_unique_ptr pkey = mem_pool_item_-&gt;alloc_unique_ptr();
  if (nullptr == pkey) {
    LOG_WARN(&#34;Failed to alloc memory for key. size=%d&#34;, file_header_.key_length);
    return RC::NOMEM;
  }
  char *key = static_cast&lt;char *&gt;(pkey.get());

  memcpy(key, user_key, file_header_.attr_length);
  memcpy(key + file_header_.attr_length, rid, sizeof(*rid));

  BplusTreeOperationType op = BplusTreeOperationType::DELETE;

  RC rc = RC::SUCCESS;

  BplusTreeMiniTransaction mtr(*this, &amp;rc);

  Frame *leaf_frame = nullptr;

  rc = find_leaf(mtr, op, key, leaf_frame);
  if (rc == RC::EMPTY) {
    rc = RC::RECORD_NOT_EXIST;
    return rc;
  }

  if (OB_FAIL(rc)) {
    LOG_WARN(&#34;failed to find leaf page. rc =%s&#34;, strrc(rc));
    return rc;
  }

  rc = delete_entry_internal(mtr, leaf_frame, key);
  return rc;
}
</code></pre><p><code>delete_entry</code>å‡½æ•°ï¼šB+æ ‘åˆ é™¤æ“ä½œçš„å…¥å£ã€‚<br>
å†…å­˜åˆ†é…å¹¶æ„é€ åˆ é™¤é”®ï¼š<br>
é¦–å…ˆä»å†…å­˜æ±  <code>mem_pool_item_</code> åˆ†é…ä¸€ä¸ªæŒ‡å‘ <code>key </code>çš„å†…å­˜æŒ‡é’ˆã€‚å¦‚æœåˆ†é…å¤±è´¥ï¼Œåˆ™è®°å½•è­¦å‘Šæ—¥å¿—å¹¶è¿”å›<code>RC::NOMEM</code>é”™è¯¯ç ã€‚<br>
ç„¶åå°†<code>user_key</code>å’Œ<code>rid</code>ç»„åˆæˆä¸€ä¸ªé”®ï¼Œå­˜å‚¨åœ¨<code>key</code>å˜é‡ä¸­ã€‚è¿™ä¸€æ­¥æ˜¯å°†ç”¨æˆ·æä¾›çš„é”®å’Œè®°å½•IDåˆå¹¶æˆä¸€ä¸ªå¯ä»¥åœ¨B+æ ‘ä¸­æŸ¥æ‰¾å’Œåˆ é™¤çš„å®Œæ•´é”®ã€‚<br>
æŸ¥æ‰¾å¶å­èŠ‚ç‚¹ï¼š<br>
åˆ›å»ºä¸€ä¸ª <code>BplusTreeMiniTransaction</code> æ¥ä¿è¯B+æ ‘åœ¨æ“ä½œä¸­çš„ä¸€è‡´æ€§ã€‚<br>
ä½¿ç”¨<code>find_leaf</code>å‡½æ•°æ ¹æ®<code>key</code>æ‰¾åˆ°ç›®æ ‡å¶å­èŠ‚ç‚¹æ‰€åœ¨çš„é¡µæ¡†<code> leaf_frame</code>ã€‚<br>
å¦‚æœè¿”å›å€¼ä¸º <code>RC::EMPTY</code>ï¼Œè¡¨ç¤ºB+æ ‘ä¸­æ²¡æœ‰æ•°æ®ï¼Œç›´æ¥è¿”å› <code>RC::RECORD_NOT_EXIST</code> è¡¨ç¤ºè®°å½•ä¸å­˜åœ¨ã€‚</p>
<p><code>delete_entry_internal</code>å‡½æ•°ï¼šå¤„ç†åˆ é™¤æ“ä½œçš„æ ¸å¿ƒé€»è¾‘ã€‚<br>
åˆ é™¤é”®å€¼å¯¹ï¼š<br>
ä½¿ç”¨ <code>LeafIndexNodeHandler</code> æ¥å¤„ç†å¶å­èŠ‚ç‚¹çš„æ“ä½œï¼Œå¹¶é€šè¿‡ <code>remove</code> å‡½æ•°å°è¯•åˆ é™¤ç›®æ ‡é”®ã€‚<br>
<code>remove_count</code> è®°å½•åˆ é™¤çš„é”®å€¼å¯¹æ•°é‡ï¼Œå¦‚æœä¸º0ï¼Œè¡¨ç¤ºæ²¡æœ‰æ‰¾åˆ°éœ€è¦åˆ é™¤çš„é”®ï¼Œè®°å½•æ—¥å¿—å¹¶è¿”å›<code> RC::RECORD_NOT_EXIST</code>ã€‚<br>
æ ‡è®°å¶å­èŠ‚ç‚¹ä¸º<code>dirty</code>ï¼š<code>leaf_frame-&gt;mark_dirty();</code><br>
åˆ é™¤æˆåŠŸåï¼Œå°†å¶å­èŠ‚ç‚¹æ ‡è®°ä¸ºâ€œè„â€ï¼Œå³éœ€è¦å†™å›ç£ç›˜ã€‚<br>
æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦éœ€è¦åˆå¹¶æˆ–é‡åˆ†é…ï¼š<br>
æ£€æŸ¥å¶å­èŠ‚ç‚¹çš„å½“å‰å¤§å°æ˜¯å¦å¤§äºç­‰äºæœ€å°å€¼ <code>min_size</code>ï¼Œå¦‚æœæ˜¯ï¼Œè¡¨ç¤ºèŠ‚ç‚¹ä»ç„¶ä¿æŒå¹³è¡¡ï¼Œä¸éœ€è¦è¿›ä¸€æ­¥å¤„ç†ï¼Œè¿”å› <code>RC::SUCCESS</code>ã€‚<br>
å¦‚æœèŠ‚ç‚¹çš„å¤§å°å°äºæœ€å°å€¼ï¼Œè°ƒç”¨ <code>coalesce_or_redistribute</code> å‡½æ•°ï¼Œå°è¯•å°†èŠ‚ç‚¹ä¸ç›¸é‚»èŠ‚ç‚¹åˆå¹¶æˆ–ä»ç›¸é‚»èŠ‚ç‚¹ä¸­é‡åˆ†é…ä¸€äº›æ•°æ®ï¼Œä»¥ç»´æŒB+æ ‘çš„å¹³è¡¡ã€‚</p>
<h3 id="223-æŸ¥æ‰¾æ“ä½œ">2.2.3 æŸ¥æ‰¾æ“ä½œ</h3>
<p><code>get_entry </code>æ–¹æ³•ç”¨äºæŸ¥æ‰¾æŒ‡å®šçš„é”®å€¼å¯¹ï¼Œ<code>find_leaf</code> ç”¨äºæ‰¾åˆ°åŒ…å«æŒ‡å®šé”®å€¼çš„å¶å­èŠ‚ç‚¹ã€‚</p>
<pre tabindex="0"><code>RC BplusTreeHandler::get_entry(const char *user_key, int key_len, list&lt;RID&gt; &amp;rids)
{
  BplusTreeScanner scanner(*this);
  RC rc = scanner.open(user_key, key_len, true /*left_inclusive*/, user_key, key_len, true /*right_inclusive*/);
  if (OB_FAIL(rc)) {
    LOG_WARN(&#34;failed to open scanner. rc=%s&#34;, strrc(rc));
    return rc;
  }

  RID rid;
  while ((rc = scanner.next_entry(rid)) == RC::SUCCESS) {
    rids.push_back(rid);
  }

  scanner.close();
  if (rc != RC::RECORD_EOF) {
    LOG_WARN(&#34;scanner return error. rc=%s&#34;, strrc(rc));
  } else {
    rc = RC::SUCCESS;
  }
  return rc;
}

RC BplusTreeHandler::find_leaf(BplusTreeMiniTransaction &amp;mtr, BplusTreeOperationType op, const char *key, Frame *&amp;frame)
{
  auto child_page_getter = [this, key](InternalIndexNodeHandler &amp;internal_node) {
    return internal_node.value_at(internal_node.lookup(key_comparator_, key));
  };
  return find_leaf_internal(mtr, op, child_page_getter, frame);
}
</code></pre><p><code>get_entry </code>å‡½æ•°:<br>
ç”¨äºæ ¹æ®ç»™å®šçš„<code>user_key</code>ä»B+æ ‘ä¸­æ‰¾åˆ°å¯¹åº”çš„è®°å½•IDåˆ—è¡¨<code> rids</code>ï¼Œå®ƒä¸»è¦ä½¿ç”¨äº†ä¸€ä¸ª<a href="#25-b%E6%A0%91%E7%9A%84%E6%89%AB%E6%8F%8F"><code>BplusTreeScanner</code></a>æ¥æ‰«ææ ‘ä¸­çš„ç¬¦åˆæ¡ä»¶çš„é”®ã€‚<br>
åˆå§‹åŒ–<code> BplusTreeScanner</code>ï¼š<br>
é¦–å…ˆåˆå§‹åŒ–ä¸€ä¸ª <code>BplusTreeScanner</code> å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡è´Ÿè´£éå†å’Œæ‰«æB+æ ‘çš„èŠ‚ç‚¹ã€‚<br>
è°ƒç”¨ <code>scanner.open()</code> æ¥è®¾ç½®æ‰«æçš„èŒƒå›´ã€‚è¿™é‡Œæ‰«æèŒƒå›´è®¾å®šä¸ºä»<code>user_key</code>å¼€å§‹ï¼Œ<code>left_inclusive</code> å’Œ <code>right_inclusive</code> è¡¨ç¤ºæ˜¯å¦åŒ…å«è¾¹ç•Œé”®ï¼Œå³æ­¤å¤„æ˜¯æŸ¥æ‰¾ç­‰äº <code>user_key</code> çš„æ¡ç›®ã€‚<br>
éå†å¹¶è·å–è®°å½•IDï¼š<br>
ä½¿ç”¨ <code>scanner.next_entry(rid)</code> ä¸æ–­è·å–ä¸‹ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„ <code>RID</code>ã€‚æ¯æ¬¡æˆåŠŸè·å–åˆ° <code>RID</code> åï¼Œå°†å…¶æ·»åŠ åˆ° <code>rids</code> åˆ—è¡¨ä¸­ã€‚<br>
å…³é—­æ‰«æå™¨å¹¶è¿”å›ç»“æœï¼š<br>
åœ¨å®Œæˆæ‰«æåï¼Œè°ƒç”¨<code>scanner.close()</code>å…³é—­æ‰«æå™¨ã€‚</p>
<p><code>find_leaf </code>å‡½æ•°:<br>
ç”¨äºåœ¨B+æ ‘ä¸­æŸ¥æ‰¾åŒ…å«ç‰¹å®š<code>key</code>çš„å¶å­èŠ‚ç‚¹ï¼Œå®ƒé€šè¿‡é€’å½’éå†æ ‘çš„å†…éƒ¨èŠ‚ç‚¹ï¼Œç›´åˆ°æ‰¾åˆ°ç›®æ ‡å¶å­èŠ‚ç‚¹ã€‚<br>
æŸ¥æ‰¾å­èŠ‚ç‚¹é¡µå·çš„å›è°ƒå‡½æ•°: <br>
å®šä¹‰ä¸€ä¸ª<code>child_page_getter</code>lambda å‡½æ•°ï¼Œç”¨äºä»å†…éƒ¨èŠ‚ç‚¹è·å–å­èŠ‚ç‚¹çš„é¡µå·ã€‚<br>
<code>internal_node.lookup(key_comparator_, key)</code> ä¼šæ ¹æ® <code>key </code>ä½¿ç”¨ <code>key_comparator_ </code>æ¥æŸ¥æ‰¾åœ¨å†…éƒ¨èŠ‚ç‚¹ä¸­çš„ä½ç½®ï¼Œå¹¶é€šè¿‡<code>value_at()</code>è·å–å¯¹åº”å­èŠ‚ç‚¹çš„é¡µå·ã€‚<br>
è°ƒç”¨ <code>find_leaf_internal</code>ï¼š<br>
ä¼ å…¥äº‹åŠ¡å¯¹è±¡ <code>mtr</code>ã€æ“ä½œç±»å‹ <code>op</code>ï¼ˆå¦‚åˆ é™¤ã€æ’å…¥ç­‰ï¼‰ã€è·å–å­èŠ‚ç‚¹é¡µå·çš„ <code>child_page_getter</code> ä»¥åŠé¡µæ¡† <code>frame</code>ã€‚</p>
<h2 id="23-bæ ‘çš„äº‹åŠ¡">2.3 B+æ ‘çš„äº‹åŠ¡</h2>
<p><code>BplusTreeMiniTransaction</code>ï¼šç”¨äºå°è£… MiniOB ä¸­çš„ B+ æ ‘äº‹åŠ¡ã€‚</p>
<pre tabindex="0"><code>class BplusTreeMiniTransaction final
{
public:

  BplusTreeMiniTransaction(BplusTreeHandler &amp;tree_handler, RC *operation_result = nullptr);
  ~BplusTreeMiniTransaction();

  LatchMemo       &amp;latch_memo() { return latch_memo_; }
  BplusTreeLogger &amp;logger() { return logger_; }

  RC commit();
  RC rollback();

private:
  BplusTreeHandler &amp;tree_handler_;
  RC               *operation_result_ = nullptr;
  LatchMemo         latch_memo_;
  BplusTreeLogger   logger_;
};
</code></pre><p><code>BplusTreeMiniTransaction(BplusTreeHandler &amp;tree_handler, RC *operation_result = nullptr)</code>ï¼š<br>
æ„é€ å‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ª<code>BplusTreeHandler</code>å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œè¿™ä¸ªå¯¹è±¡ä»£è¡¨äº†å¯¹ B+ æ ‘çš„å…·ä½“æ“ä½œç®¡ç†ã€‚<br>
å‚æ•° operation_result æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>RC</code>ï¼ˆè¿”å›ç ï¼‰çš„æŒ‡é’ˆã€‚å¦‚æœä¸ä¸º <code>nullptr</code>ï¼Œåœ¨äº‹åŠ¡ç»“æŸæ—¶ï¼Œä¼šæ ¹æ®æ“ä½œç»“æœæ¥å†³å®šæ˜¯å¦æäº¤æˆ–å›æ»šã€‚<br>
è¯¥æ„é€ å‡½æ•°é€šå¸¸ä¼šåœ¨äº‹åŠ¡å¼€å§‹æ—¶è¢«è°ƒç”¨ï¼Œè´Ÿè´£åˆå§‹åŒ–äº‹åŠ¡å¯¹è±¡ï¼Œå‡†å¤‡åç»­çš„æ“ä½œã€‚<br>
<code>~BplusTreeMiniTransaction()</code>ï¼š<br>
ææ„å‡½æ•°ï¼Œè´Ÿè´£æ¸…ç†äº‹åŠ¡èµ„æºã€‚å¦‚æœåœ¨äº‹åŠ¡ç»“æŸä¹‹å‰æ²¡æœ‰æ˜¾å¼åœ°è°ƒç”¨ <code>commit()</code> æˆ– <code>rollback()</code>ï¼Œææ„å‡½æ•°å¯èƒ½ä¼šå¤„ç†æœªå†³çš„äº‹åŠ¡ï¼Œç¡®ä¿ä¸ä¼šæœ‰æœªæäº¤æˆ–æœªå›æ»šçš„æ“ä½œæ®‹ç•™ã€‚<br>
<code>RC commit()</code>ï¼š<br>
è¯¥å‡½æ•°ç”¨äºæäº¤äº‹åŠ¡ã€‚å½“äº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œéƒ½æˆåŠŸæ‰§è¡Œæ—¶ï¼Œè°ƒç”¨ <code>commit()</code> ä¼šå°†æ“ä½œçš„ç»“æœæäº¤åˆ°B+æ ‘ï¼Œå¹¶å°†ç›¸å…³çš„æ—¥å¿—æ¸…é™¤æˆ–æ ‡è®°ä¸ºå·²å®Œæˆã€‚<br>
<code>RC rollback()</code>ï¼š<br>
è¯¥å‡½æ•°ç”¨äºå›æ»šäº‹åŠ¡ã€‚åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‘ç”Ÿé”™è¯¯æˆ–æ“ä½œå¤±è´¥ï¼Œè°ƒç”¨ <code>rollback()</code> ä¼šæ’¤é”€äº‹åŠ¡ä¸­çš„æ‰€æœ‰ä¿®æ”¹ï¼Œæ¢å¤åˆ°æ“ä½œå‰çš„çŠ¶æ€ã€‚<br>
å›æ»šæ“ä½œä½¿ç”¨ <code>BplusTreeLogger</code> ä¸­è®°å½•çš„æ—¥å¿—æ¥è¿˜åŸä¹‹å‰çš„çŠ¶æ€ã€‚</p>
<p><code>tree_handler_</code> æ˜¯å¯¹ B+ æ ‘æ“ä½œçš„ç®¡ç†å™¨ï¼Œå®ƒè´Ÿè´£å¯¹ B+ æ ‘æ‰§è¡Œå®é™…çš„æ“ä½œã€‚äº‹åŠ¡ç±»é€šè¿‡ä¸ <code>tree_handler_</code> äº¤äº’æ¥è¿›è¡Œæ ‘çš„æ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾ç­‰æ“ä½œã€‚<br>
<code>operation_result_</code> æ˜¯ä¸€ä¸ªè¿”å›ç çš„æŒ‡é’ˆï¼Œç”¨æ¥æ ‡è®°äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„çŠ¶æ€ã€‚å¦‚æœè¿™ä¸ªæŒ‡é’ˆä¸ä¸ºç©ºï¼Œäº‹åŠ¡ç»“æŸæ—¶ä¼šæ ¹æ®å®ƒçš„å€¼æ¥è‡ªåŠ¨å†³å®šæ˜¯å¦æäº¤æˆ–å›æ»šã€‚<br>
<code>latch_memo_</code> æ˜¯ä¸€ä¸ªé”å®šæœºåˆ¶çš„è®°å¿†è®°å½•å¯¹è±¡,è·Ÿè¸ªäº‹åŠ¡æœŸé—´è·å–çš„é”å®šèµ„æºï¼Œç¡®ä¿åœ¨äº‹åŠ¡ç»“æŸæ—¶èƒ½å¤Ÿæ­£ç¡®é‡Šæ”¾èµ„æºï¼Œé¿å…æ­»é”æˆ–èµ„æºæ³„æ¼ã€‚<br>
<code>logger_ </code>æ˜¯äº‹åŠ¡æ“ä½œçš„æ—¥å¿—è®°å½•å™¨ï¼Œå®ƒä¼šè®°å½•äº‹åŠ¡æœŸé—´å¯¹ B+ æ ‘è¿›è¡Œçš„æ‰€æœ‰æ“ä½œï¼Œä»¥ä¾¿åœ¨äº‹åŠ¡å›æ»šæ—¶èƒ½å¤Ÿè¿˜åŸæ•°æ®ï¼Œæˆ–è€…åœ¨å´©æºƒæ¢å¤æ—¶é‡æ–°åº”ç”¨äº‹åŠ¡ã€‚</p>
<h2 id="24-bæ ‘çš„åˆ†è£‚ä¸åˆå¹¶">2.4 B+æ ‘çš„åˆ†è£‚ä¸åˆå¹¶</h2>
<h3 id="241-åˆ†è£‚">2.4.1 åˆ†è£‚</h3>
<p>å½“èŠ‚ç‚¹æ»¡æ—¶ï¼Œ<code>split </code>æ–¹æ³•å°†èŠ‚ç‚¹åˆ†è£‚æˆä¸¤ä¸ªï¼Œå¹¶å°†ä¸­é—´çš„é”®æ’å…¥åˆ°çˆ¶èŠ‚ç‚¹ã€‚</p>
<pre tabindex="0"><code>template &lt;typename IndexNodeHandlerType&gt;
RC BplusTreeHandler::split(BplusTreeMiniTransaction &amp;mtr, Frame *frame, Frame *&amp;new_frame)
{
  IndexNodeHandlerType old_node(mtr, file_header_, frame);

  // add a new node
  RC rc = mtr.latch_memo().allocate_page(new_frame);
  if (OB_FAIL(rc)) {
    LOG_WARN(&#34;Failed to split index page due to failed to allocate page, rc=%d:%s&#34;, rc, strrc(rc));
    return rc;
  }

  mtr.latch_memo().xlatch(new_frame);

  IndexNodeHandlerType new_node(mtr, file_header_, new_frame);
  new_node.init_empty();
  new_node.set_parent_page_num(old_node.parent_page_num());

  old_node.move_half_to(new_node);

  frame-&gt;mark_dirty();
  new_frame-&gt;mark_dirty();
  return RC::SUCCESS;
}
</code></pre><p>åˆ†é…æ–°é¡µï¼šä¸ºæ–°èŠ‚ç‚¹åˆ†é…é¡µæ¡†å¹¶åŠ é”ã€‚<br>
ç§»åŠ¨æ•°æ®ï¼šå°†æ—§èŠ‚ç‚¹çš„ä¸€åŠæ•°æ®ç§»åŠ¨åˆ°æ–°èŠ‚ç‚¹ã€‚<br>
æ›´æ–°å…ƒæ•°æ®ï¼šç¡®ä¿æ–°èŠ‚ç‚¹ç»§æ‰¿æ—§èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹å…³ç³»ã€‚<br>
æ ‡è®°ä¿®æ”¹ï¼šæ ‡è®°ä¿®æ”¹åçš„é¡µæ¡†ï¼Œä»¥ä¾¿äº‹åŠ¡æäº¤æ—¶æ›´æ–°ç£ç›˜ä¸­çš„æ•°æ®ã€‚</p>
<h3 id="242-åˆå¹¶">2.4.2 åˆå¹¶</h3>
<p>å½“åˆ é™¤å¯¼è‡´èŠ‚ç‚¹ä¸­çš„å…ƒç´ è¿‡å°‘æ—¶ï¼Œ<code>coalesce</code> æ–¹æ³•åˆå¹¶ç›¸é‚»èŠ‚ç‚¹ã€‚</p>
<pre tabindex="0"><code>template &lt;typename IndexNodeHandlerType&gt;
RC BplusTreeHandler::coalesce(
    BplusTreeMiniTransaction &amp;mtr, Frame *neighbor_frame, Frame *frame, Frame *parent_frame, int index)
{
  InternalIndexNodeHandler parent_node(mtr, file_header_, parent_frame);

  // å…ˆåŒºåˆ†å‡ºæ¥å·¦å³èŠ‚ç‚¹
  Frame *left_frame  = nullptr;
  Frame *right_frame = nullptr;
  if (index == 0) {
    // neighbor node is at right
    left_frame  = frame;
    right_frame = neighbor_frame;
    index++;
  } else {
    left_frame  = neighbor_frame;
    right_frame = frame;
    // neighbor is at left
  }

  // æŠŠå³è¾¹èŠ‚ç‚¹çš„æ•°æ®å¤åˆ¶åˆ°å·¦è¾¹èŠ‚ç‚¹ä¸Šå»
  IndexNodeHandlerType left_node(mtr, file_header_, left_frame);
  IndexNodeHandlerType right_node(mtr, file_header_, right_frame);

  parent_node.remove(index);
  // parent_node.validate(key_comparator_, disk_buffer_pool_, file_id_);
  RC rc = right_node.move_to(left_node);
  if (OB_FAIL(rc)) {
    LOG_WARN(&#34;failed to move right node to left. rc=%d:%s&#34;, rc, strrc(rc));
    return rc;
  }
  // left_node.validate(key_comparator_);

  // å¶å­èŠ‚ç‚¹ç»´æŠ¤next_pageæŒ‡é’ˆ
  if (left_node.is_leaf()) {
    LeafIndexNodeHandler left_leaf_node(mtr, file_header_, left_frame);
    LeafIndexNodeHandler right_leaf_node(mtr, file_header_, right_frame);
    left_leaf_node.set_next_page(right_leaf_node.next_page());
  }

  // é‡Šæ”¾å³è¾¹èŠ‚ç‚¹
  mtr.latch_memo().dispose_page(right_frame-&gt;page_num());

  // é€’å½’çš„æ£€æŸ¥çˆ¶èŠ‚ç‚¹æ˜¯å¦éœ€è¦åšåˆå¹¶æˆ–è€…é‡æ–°åˆ†é…èŠ‚ç‚¹æ•°æ®
  return coalesce_or_redistribute&lt;InternalIndexNodeHandler&gt;(mtr, parent_frame);
}
</code></pre><p>ç¡®å®šå·¦å³èŠ‚ç‚¹ï¼šæ ¹æ® <code>index</code> æ¥åŒºåˆ†å½“å‰èŠ‚ç‚¹å’Œç›¸é‚»èŠ‚ç‚¹ï¼ˆå·¦æˆ–å³ï¼‰ã€‚<br>
åˆ é™¤çˆ¶èŠ‚ç‚¹ä¸­çš„ç´¢å¼•ï¼šç§»é™¤çˆ¶èŠ‚ç‚¹ä¸­ä¸å³èŠ‚ç‚¹å¯¹åº”çš„ç´¢å¼•é”®ã€‚<br>
åˆå¹¶å·¦å³èŠ‚ç‚¹ï¼šå°†å³èŠ‚ç‚¹ä¸­çš„æ•°æ®ç§»åŠ¨åˆ°å·¦èŠ‚ç‚¹ä¸­ï¼Œå¦‚æœæ˜¯å¶å­èŠ‚ç‚¹ï¼Œæ›´æ–°å…¶<code> next_page</code> æŒ‡é’ˆã€‚<br>
é‡Šæ”¾å³èŠ‚ç‚¹ï¼šåˆå¹¶åé‡Šæ”¾å³èŠ‚ç‚¹çš„èµ„æºã€‚<br>
é€’å½’å¤„ç†çˆ¶èŠ‚ç‚¹ï¼šåˆå¹¶å®Œæˆåé€’å½’æ£€æŸ¥çˆ¶èŠ‚ç‚¹ï¼Œçœ‹çœ‹æ˜¯å¦éœ€è¦è¿›ä¸€æ­¥çš„åˆå¹¶æˆ–é‡æ–°åˆ†é…ã€‚</p>
<h3 id="243-é‡æ–°åˆ†é…">2.4.3 é‡æ–°åˆ†é…</h3>
<p><code>redistribute </code>æ–¹æ³•é‡æ–°åˆ†é…ç›¸é‚»èŠ‚ç‚¹ä¸­çš„å…ƒç´ ä»¥ä¿æŒå¹³è¡¡ã€‚</p>
<pre tabindex="0"><code>template &lt;typename IndexNodeHandlerType&gt;
RC BplusTreeHandler::redistribute(BplusTreeMiniTransaction &amp;mtr, Frame *neighbor_frame, Frame *frame, Frame *parent_frame, int index)
{
  InternalIndexNodeHandler parent_node(mtr, file_header_, parent_frame);
  IndexNodeHandlerType     neighbor_node(mtr, file_header_, neighbor_frame);
  IndexNodeHandlerType     node(mtr, file_header_, frame);
  if (neighbor_node.size() &lt; node.size()) {
    LOG_ERROR(&#34;got invalid nodes. neighbor node size %d, this node size %d&#34;, neighbor_node.size(), node.size());
  }
  if (index == 0) {
    // the neighbor is at right
    neighbor_node.move_first_to_end(node);
    // neighbor_node.validate(key_comparator_, disk_buffer_pool_, file_id_);
    // node.validate(key_comparator_, disk_buffer_pool_, file_id_);
    parent_node.set_key_at(index + 1, neighbor_node.key_at(0));
    // parent_node.validate(key_comparator_, disk_buffer_pool_, file_id_);
  } else {
    // the neighbor is at left
    neighbor_node.move_last_to_front(node);
    // neighbor_node.validate(key_comparator_, disk_buffer_pool_, file_id_);
    // node.validate(key_comparator_, disk_buffer_pool_, file_id_);
    parent_node.set_key_at(index, node.key_at(0));
    // parent_node.validate(key_comparator_, disk_buffer_pool_, file_id_);
  }

  neighbor_frame-&gt;mark_dirty();
  frame-&gt;mark_dirty();
  parent_frame-&gt;mark_dirty();

  return RC::SUCCESS;
}
</code></pre><p>åˆå§‹åŒ–èŠ‚ç‚¹å’Œæ£€æŸ¥èŠ‚ç‚¹å¤§å°ï¼šå‡†å¤‡å¥½ç›¸é‚»èŠ‚ç‚¹ã€å½“å‰èŠ‚ç‚¹å’Œçˆ¶èŠ‚ç‚¹ï¼Œç¡®ä¿ç›¸é‚»èŠ‚ç‚¹æœ‰è¶³å¤Ÿçš„å…ƒç´ å¯ä»¥å€Ÿå‡ºã€‚<br>
æ ¹æ®ç›¸é‚»èŠ‚ç‚¹çš„ä½ç½®é‡æ–°åˆ†é…å…ƒç´ ï¼š<br>
å¦‚æœç›¸é‚»èŠ‚ç‚¹åœ¨å³ä¾§ï¼Œå°†å³èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªå…ƒç´ ç§»åŠ¨åˆ°å½“å‰èŠ‚ç‚¹çš„æœ«å°¾ï¼Œå¹¶æ›´æ–°çˆ¶èŠ‚ç‚¹é”®å€¼ã€‚<br>
å¦‚æœç›¸é‚»èŠ‚ç‚¹åœ¨å·¦ä¾§ï¼Œå°†å·¦èŠ‚ç‚¹çš„æœ€åä¸€ä¸ªå…ƒç´ ç§»åŠ¨åˆ°å½“å‰èŠ‚ç‚¹çš„å¼€å¤´ï¼Œå¹¶æ›´æ–°çˆ¶èŠ‚ç‚¹é”®å€¼ã€‚<br>
æ ‡è®°ä¿®æ”¹ï¼šæ ‡è®°æ‰€æœ‰è¢«ä¿®æ”¹çš„èŠ‚ç‚¹é¡µæ¡†ï¼Œä»¥ä¾¿åç»­æäº¤åˆ°ç£ç›˜ã€‚<br>
è¿”å›ç»“æœï¼šæ“ä½œæˆåŠŸåè¿”å› <code>RC::SUCCESS</code>ã€‚</p>
<h2 id="25-bæ ‘çš„æ‰«æ">2.5 B+æ ‘çš„æ‰«æ</h2>
<p><code>BplusTreeScanner </code>ç±»å…è®¸å¯¹ B+ æ ‘çš„èŒƒå›´æ‰«æã€‚å¯ä»¥è®¾ç½®å·¦è¾¹ç•Œå’Œå³è¾¹ç•Œï¼Œæ‰«ææ»¡è¶³æ¡ä»¶çš„é”®å€¼å¯¹ã€‚</p>
<pre tabindex="0"><code>class BplusTreeScanner
{
public:
  BplusTreeScanner(BplusTreeHandler &amp;tree_handler);
  ~BplusTreeScanner();

  /**
   * @brief æ‰«ææŒ‡å®šèŒƒå›´çš„æ•°æ®
   * @param left_user_key æ‰«æèŒƒå›´çš„å·¦è¾¹ç•Œï¼Œå¦‚æœæ˜¯nullï¼Œåˆ™æ²¡æœ‰å·¦è¾¹ç•Œ
   * @param left_len left_user_key çš„å†…å­˜å¤§å°(åªæœ‰åœ¨å˜é•¿å­—æ®µä¸­æ‰ä¼šå…³æ³¨)
   * @param left_inclusive å·¦è¾¹ç•Œçš„å€¼æ˜¯å¦åŒ…å«åœ¨å†…
   * @param right_user_key æ‰«æèŒƒå›´çš„å³è¾¹ç•Œã€‚å¦‚æœæ˜¯nullï¼Œåˆ™æ²¡æœ‰å³è¾¹ç•Œ
   * @param right_len right_user_key çš„å†…å­˜å¤§å°(åªæœ‰åœ¨å˜é•¿å­—æ®µä¸­æ‰ä¼šå…³æ³¨)
   * @param right_inclusive å³è¾¹ç•Œçš„å€¼æ˜¯å¦åŒ…å«åœ¨å†…
   * TODO é‡æ„å‚æ•°è¡¨ç¤ºæ–¹æ³•
   */
  RC open(const char *left_user_key, int left_len, bool left_inclusive, const char *right_user_key, int right_len,
      bool right_inclusive);

  /**
   * @brief è·å–ä¸‹ä¸€æ¡è®°å½•
   *
   * @param rid å½“å‰é»˜è®¤æ‰€æœ‰å€¼éƒ½æ˜¯RIDç±»å‹ã€‚å¯¹B+æ ‘æ¥è¯´å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„æŠ½è±¡
   * @return RC RECORD_EOF è¡¨ç¤ºéå†å®Œæˆ
   * TODO éœ€è¦å¢åŠ è¿”å› key çš„æ¥å£
   * @warning ä¸è¦åœ¨éå†æ—¶åˆ é™¤æ•°æ®ã€‚åˆ é™¤æ•°æ®ä¼šå¯¼è‡´éå†å™¨å¤±æ•ˆã€‚
   * å½“å‰é»˜è®¤çš„èµ°ç´¢å¼•åˆ é™¤çš„é€»è¾‘å°±æ˜¯è¿™æ ·åšçš„ï¼Œæ‰€ä»¥åˆ é™¤é€»è¾‘æœ‰BUGã€‚
   */
  RC next_entry(RID &amp;rid);

  /**
   * @brief å…³é—­å½“å‰æ‰«æå™¨
   * @details å¯ä»¥ä¸è°ƒç”¨ï¼Œåœ¨ææ„å‡½æ•°æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œ
   */
  RC close();

private:
  /**
   * å¦‚æœkeyçš„ç±»å‹æ˜¯CHARS, æ‰©å±•æˆ–ç¼©å‡user_keyçš„å¤§å°åˆšå¥½æ˜¯schemaä¸­å®šä¹‰çš„å¤§å°
   */
  RC fix_user_key(const char *user_key, int key_len, bool want_greater, char **fixed_key, bool *should_inclusive);

  void fetch_item(RID &amp;rid);

  /**
   * @brief åˆ¤æ–­æ˜¯å¦åˆ°äº†æ‰«æçš„ç»“æŸä½ç½®
   */
  bool touch_end();

private:
  bool                     inited_ = false;
  BplusTreeHandler        &amp;tree_handler_;
  BplusTreeMiniTransaction mtr_;

  /// ä½¿ç”¨å·¦å³å¶å­èŠ‚ç‚¹å’Œä½ç½®æ¥è¡¨ç¤ºæ‰«æçš„èµ·å§‹ä½ç½®å’Œç»ˆæ­¢ä½ç½®
  /// èµ·å§‹ä½ç½®å’Œç»ˆæ­¢ä½ç½®éƒ½æ˜¯æœ‰æ•ˆçš„æ•°æ®
  Frame *current_frame_ = nullptr;

  common::MemPoolItem::item_unique_ptr right_key_;
  int                                  iter_index_    = -1;
  bool                                 first_emitted_ = false;
};
</code></pre><p>åˆå§‹åŒ–æ‰«æå™¨ï¼š<br>
åˆ›å»º <code>BplusTreeScanner </code>å¯¹è±¡å¹¶è°ƒç”¨<code>open</code>å‡½æ•°ï¼Œè®¾ç½®æ‰«æçš„èŒƒå›´ï¼ˆå·¦è¾¹ç•Œå’Œå³è¾¹ç•Œï¼‰ã€‚<br>
è·å–è®°å½•ï¼š<br>
è°ƒç”¨<code>next_entry</code>å‡½æ•°è·å–ä¸€æ¡è®°å½•ï¼Œå¹¶å¾ªç¯è°ƒç”¨ç›´åˆ°è¿”å›<code> RC::RECORD_EOF</code>ï¼Œè¡¨ç¤ºéå†å®Œæˆã€‚<br>
å…³é—­æ‰«æå™¨ï¼š<br>
æ‰«æå®Œæˆåè°ƒç”¨<code>close</code>å‡½æ•°å…³é—­æ‰«æå™¨ã€‚å…³é—­æ‰«æå™¨ä¼šé‡Šæ”¾ç›¸å…³èµ„æºï¼Œå¦‚æœæœªæ˜¾å¼è°ƒç”¨ï¼Œä¹Ÿä¼šåœ¨ææ„å‡½æ•°ä¸­è‡ªåŠ¨å…³é—­ã€‚</p>
<h2 id="26-bæ ‘çš„éªŒè¯">2.6 B+æ ‘çš„éªŒè¯</h2>
<p>é€šè¿‡ <code>validate_tree </code>æ–¹æ³•å¯ä»¥æ£€æŸ¥ B+ æ ‘çš„åˆæ³•æ€§ï¼ŒåŒ…æ‹¬èŠ‚ç‚¹ä¹‹é—´çš„é“¾æ¥ã€é”®å€¼çš„é¡ºåºç­‰ã€‚</p>
<pre tabindex="0"><code>bool BplusTreeHandler::validate_tree()
{
  if (is_empty()) {
    return true;
  }

  BplusTreeMiniTransaction mtr(*this);
  LatchMemo &amp;latch_memo = mtr.latch_memo();
  Frame    *frame = nullptr;

  RC rc = latch_memo.get_page(file_header_.root_page, frame);  // è¿™é‡Œä»…ä»…è°ƒè¯•ä½¿ç”¨ï¼Œä¸åŠ rooté”
  if (OB_FAIL(rc)) {
    LOG_WARN(&#34;failed to fetch root page. page id=%d, rc=%d:%s&#34;, file_header_.root_page, rc, strrc(rc));
    return false;
  }

  if (!validate_node_recursive(mtr, frame) || !validate_leaf_link(mtr)) {
    LOG_WARN(&#34;Current B+ Tree is invalid&#34;);
    print_tree();
    return false;
  }

  LOG_INFO(&#34;great! current tree is valid&#34;);
  return true;
}
</code></pre><p>ç»“æ„éªŒè¯ï¼š<br>
<code>validate_tree </code>é€šè¿‡é€’å½’æ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹çš„ç»“æ„ï¼ˆ<code>validate_node_recursive</code>ï¼‰å’Œå¶å­èŠ‚ç‚¹çš„é“¾è¡¨é“¾æ¥ï¼ˆ<code>validate_leaf_link</code>ï¼‰ï¼Œç¡®ä¿B+æ ‘çš„å„ä¸ªéƒ¨åˆ†ç¬¦åˆè§„èŒƒã€‚<br>
è°ƒè¯•å·¥å…·ï¼š<br>
å½“æ ‘ç»“æ„æ— æ•ˆæ—¶ï¼Œå‡½æ•°ä¼šæ‰“å°æ•´ä¸ªæ ‘çš„ç»“æ„ï¼Œä¾¿äºå¼€å‘è€…è¿›è¡Œè°ƒè¯•å’Œé—®é¢˜æ’æŸ¥ã€‚</p>

    </div>
    <a href="/posts/miniob-b&#43;%E6%A0%91/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="w-100 w-30-l mb4 relative bg-white">
          <div class="w-100 mb4 nested-copy-line-height relative bg-white">
  <div class="mb3 pa4 gray overflow-hidden bg-white">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/miniob-bufferpool/" class="link black dim">
        
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <p>ç‚¹å‡»è¿”å›<a href="https://2549141519.github.io/#/toc">ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•</a></p>
<ul>
<li>ç›®å½•
{:toc}</li>
</ul>
<!-- raw HTML omitted -->
<h1 id="1-buffer-poolç¼“å†²æ± ä»‹ç»">1. Buffer Poolï¼ˆç¼“å†²æ± ï¼‰ä»‹ç»</h1>
<p>Buffer Pool æ˜¯æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¸­ç”¨äºç®¡ç†å’Œä¼˜åŒ–å†…å­˜ä½¿ç”¨çš„ä¸€ä¸ªå…³é”®ç»„ä»¶ã€‚å…¶ä¸»è¦ä½œç”¨æ˜¯å°†ç£ç›˜ä¸Šçš„æ•°æ®é¡µç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œä»¥å‡å°‘å¯¹ç£ç›˜çš„è®¿é—®æ¬¡æ•°ï¼Œä»è€Œæé«˜æ•°æ®åº“çš„æ€§èƒ½ã€‚å¤§å¤šæ•°ç°ä»£æ•°æ®åº“ï¼ˆå¦‚ MySQLã€PostgreSQLã€OceanBase ç­‰ï¼‰éƒ½ä½¿ç”¨äº† Buffer Pool æ¥åŠ é€Ÿè¯»å†™æ“ä½œã€‚</p>
<h2 id="11-buffer-pool-çš„æ ¸å¿ƒç»„ä»¶">1.1 Buffer Pool çš„æ ¸å¿ƒç»„ä»¶</h2>
<p>Page (é¡µ)ï¼š
æ•°æ®åº“ä»¥é¡µï¼ˆpageï¼‰ä¸ºå•ä½ç®¡ç†æ•°æ®ã€‚é¡µæ˜¯æ•°æ®åº“ä¸­æ•°æ®çš„æœ€å°ç®¡ç†å•ä½ï¼Œé€šå¸¸å¤§å°ä¸º4KBã€8KBæˆ–16KBï¼ˆå…·ä½“å–å†³äºæ•°æ®åº“çš„é…ç½®ï¼‰ã€‚<br>
Buffer Pool ä¸­çš„æ¯ä¸€ä¸ªç¼“å­˜å—éƒ½ä¼šç¼“å­˜ä¸€ä¸ªç£ç›˜ä¸Šçš„æ•°æ®é¡µï¼Œå½“å®¢æˆ·ç«¯è¯·æ±‚æŸä¸ªæ•°æ®æ—¶ï¼Œæ•°æ®åº“é¦–å…ˆä¼šæ£€æŸ¥è¯¥æ•°æ®é¡µæ˜¯å¦å·²ç»åœ¨ Buffer Pool ä¸­ï¼Œå¦‚æœåœ¨ï¼Œå°±å¯ä»¥ç›´æ¥ä»å†…å­˜è¯»å–æ•°æ®ï¼›å¦‚æœä¸åœ¨ï¼Œåˆ™éœ€è¦ä»ç£ç›˜åŠ è½½è¯¥é¡µåˆ° Buffer Pool ä¸­ã€‚<br>
Buffer Frame (ç¼“å­˜å¸§)ï¼š<br>
Buffer Pool ç”±å¤šä¸ª Buffer Frame ç»„æˆï¼Œæ¯ä¸ª Frame éƒ½å¯ä»¥å­˜å‚¨ä¸€ä¸ªæ•°æ®åº“é¡µã€‚å½“æ•°æ®åº“éœ€è¦è®¿é—®æŸä¸ªæ•°æ®é¡µæ—¶ï¼Œå¦‚æœè¯¥é¡µå·²ç»åœ¨æŸä¸ª Frame ä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ª Frame å°±ä¼šè¢«ç›´æ¥è¿”å›ã€‚å¦åˆ™ï¼Œå°†åˆ†é…ä¸€ä¸ªç©ºçš„æˆ–å¯é‡ç”¨çš„ Frame ç”¨æ¥å­˜å‚¨ä»ç£ç›˜è¯»å–çš„é¡µã€‚<br>
Page Table (é¡µè¡¨)ï¼š<br>
Buffer Pool ç»´æŠ¤ä¸€ä¸ªé¡µè¡¨ï¼ˆPage Tableï¼‰ï¼Œç”¨äºè®°å½•æ¯ä¸ªæ•°æ®é¡µåœ¨ Buffer Pool ä¸­çš„ä½ç½®ã€‚é€šè¿‡é¡µè¡¨ï¼Œæ•°æ®åº“å¯ä»¥å¿«é€Ÿæ‰¾åˆ°æŸä¸ªæ•°æ®é¡µæ˜¯å¦å·²ç»è¢«ç¼“å­˜ï¼Œä»¥åŠå®ƒä½äº Buffer Pool ä¸­çš„å“ªä¸ªç¼“å­˜å¸§ã€‚<br>
Replacement Policy (æ›¿æ¢ç­–ç•¥)ï¼š<br>
ç”±äºå†…å­˜æœ‰é™ï¼ŒBuffer Pool æ— æ³•æ— é™åˆ¶åœ°ç¼“å­˜æ‰€æœ‰æ•°æ®ã€‚å½“ Buffer Pool å·²æ»¡æ—¶ï¼Œæ•°æ®åº“éœ€è¦æ ¹æ®æŸç§æ›¿æ¢ç­–ç•¥å°†æŸäº›é¡µä» Buffer Pool ä¸­ç§»é™¤ï¼Œä»¥ä¾¿ä¸ºæ–°åŠ è½½çš„é¡µè…¾å‡ºç©ºé—´ã€‚å¸¸è§çš„æ›¿æ¢ç­–ç•¥åŒ…æ‹¬ï¼š<br>
<strong>LRU (Least Recently Used)ï¼šæœ€ä¹…æœªä½¿ç”¨çš„é¡µä¼šè¢«ä¼˜å…ˆæ›¿æ¢ã€‚</strong><br>
<strong>MRU (Most Recently Used)ï¼šæœ€è¿‘ä½¿ç”¨çš„é¡µä¼šè¢«ä¼˜å…ˆæ›¿æ¢ã€‚</strong><br>
<strong>LFU (Least Frequently Used)ï¼šæœ€å°‘è¢«è®¿é—®çš„é¡µä¼šè¢«ä¼˜å…ˆæ›¿æ¢ã€‚</strong><br>
Dirty Page (è„é¡µ)ï¼š<br>
å½“æŸä¸ªé¡µçš„æ•°æ®è¢«ä¿®æ”¹æ—¶ï¼Œè¯¥é¡µç§°ä¸ºè„é¡µã€‚è„é¡µè¡¨ç¤º Buffer Pool ä¸­çš„æ•°æ®å·²ç»ä¸ç£ç›˜ä¸Šçš„æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦åœ¨åˆé€‚çš„æ—¶å€™å°†è„é¡µå†™å›ç£ç›˜ä»¥ä¿è¯æ•°æ®çš„æŒä¹…æ€§ã€‚<br>
æ•°æ®åº“ç³»ç»Ÿä¼šé€šè¿‡åå°çº¿ç¨‹å®šæœŸåœ°å°†è„é¡µåˆ·å›åˆ°ç£ç›˜ï¼Œæˆ–è€…åœ¨æŸäº›æ¡ä»¶ä¸‹å¼ºåˆ¶åˆ·æ–°ã€‚</p>
<h2 id="12-buffer-pool-çš„å·¥ä½œåŸç†">1.2 Buffer Pool çš„å·¥ä½œåŸç†</h2>
<p>è¯»å–æ•°æ®ï¼š<br>
å½“æ•°æ®åº“æ¥æ”¶åˆ°ä¸€ä¸ªæŸ¥è¯¢è¯·æ±‚æ—¶ï¼Œå®ƒé¦–å…ˆæ£€æŸ¥æ‰€éœ€çš„é¡µæ˜¯å¦åœ¨ Buffer Pool ä¸­ã€‚<br>
å¦‚æœè¯¥é¡µå·²ç»åœ¨ Buffer Pool ä¸­ï¼Œç§°ä¸º &ldquo;å‘½ä¸­&rdquo;ï¼ˆhitï¼‰ï¼Œç³»ç»Ÿå¯ä»¥ç›´æ¥ä»å†…å­˜ä¸­è¯»å–æ•°æ®ã€‚<br>
å¦‚æœè¯¥é¡µä¸åœ¨ Buffer Pool ä¸­ï¼Œç§°ä¸º &ldquo;æœªå‘½ä¸­&rdquo;ï¼ˆmissï¼‰ï¼Œæ•°æ®åº“ç³»ç»Ÿéœ€è¦ä»ç£ç›˜åŠ è½½è¯¥é¡µåˆ° Buffer Pool ä¸­ï¼Œå¹¶å°†å…¶å­˜æ”¾åœ¨æŸä¸ªå¯ç”¨çš„ç¼“å­˜å¸§ä¸­ã€‚</p>
<p>å†™å…¥æ•°æ®ï¼š<br>
å†™å…¥æ“ä½œä¼šé¦–å…ˆä¿®æ”¹ Buffer Pool ä¸­ç›¸åº”é¡µçš„å†…å®¹ï¼ŒåŒæ—¶å°†è¯¥é¡µæ ‡è®°ä¸º &ldquo;è„é¡µ&rdquo;ã€‚<br>
æ•°æ®åº“ä¸ä¼šç«‹åˆ»å°†è„é¡µå†™å›ç£ç›˜ï¼Œè€Œæ˜¯ä¼šå°†å†™å…¥è¯·æ±‚ç¼“å­˜ï¼Œç­‰åˆ°åˆé€‚çš„æ—¶æœºå†æ‰¹é‡åœ°å°†è„é¡µåˆ·å›ç£ç›˜ï¼Œä»¥æé«˜å†™å…¥æ•ˆç‡ã€‚</p>
<p>é¡µæ›¿æ¢ï¼š<br>
å½“ Buffer Pool å·²ç»æ»¡æ—¶ï¼Œå¦‚æœæœ‰æ–°çš„é¡µéœ€è¦åŠ è½½åˆ° Buffer Pool ä¸­ï¼Œæ•°æ®åº“ä¼šæ ¹æ®æ›¿æ¢ç­–ç•¥é€‰æ‹©ä¸€ä¸ªç°æœ‰çš„é¡µè¿›è¡Œæ›¿æ¢ã€‚<br>
å¦‚æœè¢«æ›¿æ¢çš„é¡µæ˜¯è„é¡µï¼Œåˆ™éœ€è¦åœ¨æ›¿æ¢ä¹‹å‰å°†å…¶å†™å›åˆ°ç£ç›˜ã€‚</p>
<h1 id="2-buffer-poolåœ¨miniobä¸­çš„å®ç°">2. Buffer Poolåœ¨miniobä¸­çš„å®ç°</h1>
<p>disk_buffer_pool.h å’Œ disk_buffer_pool.cpp:<br>
æ–‡ä»¶å®šä¹‰äº† <a href="#21-%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0"><code>DiskBufferPool</code></a> ç±»ï¼Œå®ƒæ˜¯ MiniOB ä¸­ç¼“å†²æ± çš„æ ¸å¿ƒå®ç°ã€‚<code>DiskBufferPool</code> è´Ÿè´£å°†æ•°æ®é¡µä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ï¼Œå¹¶ç®¡ç†è¿™äº›é¡µçš„å†…å­˜ç¼“å­˜ã€‚
è¯¥ç±»æä¾›äº†é¡µé¢çš„åˆ†é… (<a href="#212-diskbufferpoolallocate_pageframe-frame"><code>allocate_page</code></a>)ã€è¯»å– (<a href="#211-diskbufferpoolget_this_pagepagenum-page_num-frame-frame"><code>get_this_page</code></a>)ã€é‡Šæ”¾ (<a href="#214-rc-diskbufferpooldispose_pagepagenum-page_num"><code>dispose_page</code></a>) ä»¥åŠå°†å†…å­˜ä¸­çš„é¡µé¢æ•°æ®åˆ·æ–°å›ç£ç›˜ (<a href="#213-diskbufferpoolflush_pageframe-frame"><code>flush_page</code></a>) ç­‰åŠŸèƒ½ã€‚</p>
<p>frame.h å’Œ frame.cpp:<br>
æ–‡ä»¶å®šä¹‰äº† <a href="#22-%E7%BC%93%E5%AD%98%E9%A1%B5%E6%A1%86%E6%9E%B6"><code>Frame</code></a> ç±»ï¼Œè¡¨ç¤ºç¼“å†²æ± ä¸­çš„æ¯ä¸€ä¸ªç¼“å­˜é¡µæ¡†æ¶ã€‚<code>Frame</code> åŒ…å«é¡µæ¡†çš„å…ƒæ•°æ®ä¿¡æ¯ï¼ˆå¦‚ <code>buffer_pool_id</code>, <code>page_num</code> ç­‰ï¼‰ï¼Œå¹¶é€šè¿‡ <code>pin</code> å’Œ <code>unpin </code>æ–¹æ³•ç®¡ç†é¡µé¢çš„å¼•ç”¨è®¡æ•°ã€‚<br>
<code>Frame </code>ç±»è¿˜ç»´æŠ¤æ¯ä¸ªé¡µé¢çš„è„é¡µæ ‡è®°ï¼ˆ<code>dirty_</code>ï¼‰ï¼Œä»¥åŠ <code>pin_count_</code> ç”¨äºé˜²æ­¢æ­£åœ¨ä½¿ç”¨çš„é¡µé¢è¢«æ›¿æ¢ã€‚è¯¥ç±»è¿˜è´Ÿè´£é¡µé¢çš„åŠ é”ä¸è§£é”æ“ä½œã€‚</p>
<p>double_write_buffer.h å’Œ double_write_buffer.cpp:<br>
æ–‡ä»¶å®ç°äº†åŒå†™ç¼“å†²åŒºæœºåˆ¶ (DoubleWriteBuffer)ï¼Œç”¨äºåœ¨å†™å…¥ç£ç›˜ä¹‹å‰å°†é¡µé¢æ•°æ®å†™å…¥åˆ°ä¸€ä¸ªä¸´æ—¶çš„ç¼“å†²åŒºã€‚è¿™æ˜¯ä¸€ç§é˜²æ­¢éƒ¨åˆ†å†™å…¥ï¼ˆpartial writeï¼‰é—®é¢˜çš„æœºåˆ¶ï¼Œç¡®ä¿åœ¨é¡µé¢å†™å…¥å¤±è´¥æ—¶ä»ç„¶èƒ½å¤Ÿæ¢å¤æ•°æ®ã€‚</p>
<p><a href="#215-bpframemanager"><code>BPFrameManager </code></a>ç±»:<br>
è¯¥ç±»ç®¡ç†æ‰€æœ‰çš„ç¼“å†²é¡µæ¡†æ¶ï¼ˆ<code>Frame</code>ï¼‰ã€‚å½“ç³»ç»Ÿéœ€è¦åˆ†é…æ–°çš„é¡µé¢æˆ–é‡Šæ”¾å·²æœ‰é¡µé¢æ—¶ï¼Œå®ƒè´Ÿè´£åœ¨ç¼“å­˜æ± ä¸­æŸ¥æ‰¾æˆ–åˆ†é…ç©ºé—²çš„é¡µé¢æ¡†æ¶ï¼Œå¹¶ç¡®ä¿å†…å­˜ä½¿ç”¨çš„æœ‰æ•ˆæ€§ã€‚<br>
å®ƒè¿˜å®ç°äº†æ·˜æ±°ç­–ç•¥ï¼ˆ<a href="#23-%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5"><code>purge_frames</code></a> æ–¹æ³•ï¼‰ï¼Œä»¥ä¾¿åœ¨å†…å­˜ä¸è¶³æ—¶é‡Šæ”¾ä¸å¸¸ç”¨çš„é¡µé¢ã€‚</p>
<h2 id="21-æ ¸å¿ƒå®ç°">2.1 æ ¸å¿ƒå®ç°</h2>
<p><code>DiskBufferPool</code>:</p>
<pre tabindex="0"><code>class DiskBufferPool final
{
public:
  DiskBufferPool(BufferPoolManager &amp;bp_manager, BPFrameManager &amp;frame_manager, DoubleWriteBuffer &amp;dblwr_manager,
      LogHandler &amp;log_handler);
  ~DiskBufferPool();

  /**
   * æ ¹æ®æ–‡ä»¶åæ‰“å¼€ä¸€ä¸ªåˆ†é¡µæ–‡ä»¶
   */
  RC open_file(const char *file_name);

  /**
   * å…³é—­åˆ†é¡µæ–‡ä»¶
   */
  RC close_file();

  /**
   * æ ¹æ®æ–‡ä»¶IDå’Œé¡µå·è·å–æŒ‡å®šé¡µé¢åˆ°ç¼“å†²åŒºï¼Œè¿”å›é¡µé¢å¥æŸ„æŒ‡é’ˆã€‚
   */
  RC get_this_page(PageNum page_num, Frame **frame);

  /**
   * @brief åœ¨æŒ‡å®šæ–‡ä»¶ä¸­åˆ†é…ä¸€ä¸ªæ–°çš„é¡µé¢ï¼Œå¹¶å°†å…¶æ”¾å…¥ç¼“å†²åŒºï¼Œè¿”å›é¡µé¢å¥æŸ„æŒ‡é’ˆã€‚
   * @details åˆ†é…é¡µé¢æ—¶ï¼Œå¦‚æœæ–‡ä»¶ä¸­æœ‰ç©ºé—²é¡µï¼Œå°±ç›´æ¥åˆ†é…ä¸€ä¸ªç©ºé—²é¡µï¼›
   * å¦‚æœæ–‡ä»¶ä¸­æ²¡æœ‰ç©ºé—²é¡µï¼Œåˆ™æ‰©å±•æ–‡ä»¶è§„æ¨¡æ¥å¢åŠ æ–°çš„ç©ºé—²é¡µã€‚
   */
  RC allocate_page(Frame **frame);

  /**
   * @brief é‡Šæ”¾æŸä¸ªé¡µé¢ï¼Œå°†æ­¤é¡µé¢è®¾ç½®ä¸ºæœªåˆ†é…çŠ¶æ€
   *
   * @param page_num å¾…é‡Šæ”¾çš„é¡µé¢
   */
  RC dispose_page(PageNum page_num);

  /**
   * @brief é‡Šæ”¾æŒ‡å®šæ–‡ä»¶å…³è”çš„é¡µçš„å†…å­˜
   * å¦‚æœå·²ç»è„ï¼Œ åˆ™åˆ·åˆ°ç£ç›˜ï¼Œé™¤äº†pinned page
   */
  RC purge_page(PageNum page_num);
  RC purge_all_pages();

  /**
   * @brief ç”¨äºè§£é™¤pageHandleå¯¹åº”é¡µé¢çš„é©»ç•™ç¼“å†²åŒºé™åˆ¶
   *
   * åœ¨è°ƒç”¨GetThisPageæˆ–AllocatePageå‡½æ•°å°†ä¸€ä¸ªé¡µé¢è¯»å…¥ç¼“å†²åŒºåï¼Œ
   * è¯¥é¡µé¢è¢«è®¾ç½®ä¸ºé©»ç•™ç¼“å†²åŒºçŠ¶æ€ï¼Œä»¥é˜²æ­¢å…¶åœ¨å¤„ç†è¿‡ç¨‹ä¸­è¢«ç½®æ¢å‡ºå»ï¼Œ
   * å› æ­¤åœ¨è¯¥é¡µé¢ä½¿ç”¨å®Œä¹‹ååº”è°ƒç”¨æ­¤å‡½æ•°è§£é™¤è¯¥é™åˆ¶ï¼Œä½¿å¾—è¯¥é¡µé¢æ­¤åå¯ä»¥æ­£å¸¸åœ°è¢«æ·˜æ±°å‡ºç¼“å†²åŒº
   */
  RC unpin_page(Frame *frame);

  /**
   * æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é¡µé¢éƒ½æ˜¯pin count == 0çŠ¶æ€(é™¤äº†ç¬¬1ä¸ªé¡µé¢)
   * è°ƒè¯•ä½¿ç”¨
   */
  RC check_all_pages_unpinned();

  int file_desc() const;

  /**
   * å¦‚æœé¡µé¢æ˜¯è„çš„ï¼Œå°±å°†æ•°æ®åˆ·æ–°åˆ°double write buffer
   */
  RC flush_page(Frame &amp;frame);

  /**
   * åˆ·æ–°æ‰€æœ‰é¡µé¢åˆ°double write bufferï¼Œå³ä½¿pin countä¸æ˜¯0
   */
  RC flush_all_pages();

  /**
   * å›æ”¾æ—¥å¿—æ—¶å¤„ç†page0ä¸­å·²è¢«è®¤å®šä¸ºä¸å­˜åœ¨çš„page
   */
  RC recover_page(PageNum page_num);

  /**
   * åˆ·æ–°é¡µé¢åˆ°ç£ç›˜
   */
  RC write_page(PageNum page_num, Page &amp;page);

  RC redo_allocate_page(LSN lsn, PageNum page_num);
  RC redo_deallocate_page(LSN lsn, PageNum page_num);

public:
  int32_t id() const { return buffer_pool_id_; }

  const char *filename() const { return file_name_.c_str(); }

protected:
  RC allocate_frame(PageNum page_num, Frame **buf);

  /**
   * åˆ·æ–°æŒ‡å®šé¡µé¢åˆ°ç£ç›˜(flush)ï¼Œå¹¶ä¸”é‡Šæ”¾å…³è”çš„Frame
   */
  RC purge_frame(PageNum page_num, Frame *used_frame);
  RC check_page_num(PageNum page_num);

  /**
   * åŠ è½½æŒ‡å®šé¡µé¢çš„æ•°æ®åˆ°å†…å­˜ä¸­
   */
  RC load_page(PageNum page_num, Frame *frame);

  /**
   * å¦‚æœé¡µé¢æ˜¯è„çš„ï¼Œå°±å°†æ•°æ®åˆ·æ–°åˆ°ç£ç›˜
   */
  RC flush_page_internal(Frame &amp;frame);

private:
  BufferPoolManager   &amp;bp_manager_;     /// BufferPool ç®¡ç†å™¨
  BPFrameManager      &amp;frame_manager_;  /// Frame ç®¡ç†å™¨
  DoubleWriteBuffer   &amp;dblwr_manager_;  /// Double Write Buffer ç®¡ç†å™¨
  BufferPoolLogHandler log_handler_;    /// BufferPool æ—¥å¿—å¤„ç†å™¨

  int file_desc_ = -1;  /// æ–‡ä»¶æè¿°ç¬¦
  /// ç”±äºåœ¨æœ€å¼€å§‹æ‰“å¼€æ–‡ä»¶æ—¶ï¼Œæ²¡æœ‰æ­£ç¡®çš„buffer pool idä¸èƒ½åŠ è½½header frameï¼Œæ‰€ä»¥å•ç‹¬ä»æ–‡ä»¶ä¸­è¯»å–æ­¤æ ‡è¯†
  int32_t       buffer_pool_id_ = -1;
  Frame        *hdr_frame_      = nullptr;  /// æ–‡ä»¶å¤´é¡µé¢
  BPFileHeader *file_header_    = nullptr;  /// æ–‡ä»¶å¤´
  set&lt;PageNum&gt;  disposed_pages_;            /// å·²ç»é‡Šæ”¾çš„é¡µé¢

  string file_name_;  /// æ–‡ä»¶å

  common::Mutex lock_;
  common::Mutex wr_lock_;

private:
  friend class BufferPoolIterator;
};
</code></pre><h3 id="211-diskbufferpoolget_this_pagepagenum-page_num-frame-frame">2.1.1 <code>DiskBufferPool::get_this_page(PageNum page_num, Frame **frame)</code></h3>
<p>ä»ç£ç›˜æˆ–å†…å­˜ä¸­è·å–æŒ‡å®šçš„é¡µé¢ã€‚</p>
<pre tabindex="0"><code>RC DiskBufferPool::get_this_page(PageNum page_num, Frame **frame) {
  Frame *result_frame = nullptr;

  // æ£€æŸ¥é¡µé¢æ˜¯å¦å·²åŠ è½½åœ¨ç¼“å†²åŒº
  result_frame = frame_manager_.get(buffer_pool_id_, page_num);
  if (result_frame != nullptr) {
    *frame = result_frame;
    result_frame-&gt;pin();
    return RC::SUCCESS;
  }

  // å¦‚æœé¡µé¢ä¸åœ¨ç¼“å†²åŒºå†…ï¼Œåˆ™ä»ç£ç›˜åŠ è½½
  RC rc = allocate_frame(page_num, &amp;result_frame);
  if (rc != RC::SUCCESS) {
    return rc;
  }

  rc = load_page(page_num, result_frame);
  if (rc != RC::SUCCESS) {
    free(buffer_pool_id_, page_num, result_frame);
    return rc;
  }

  result_frame-&gt;pin();
  *frame = result_frame;
  return RC::SUCCESS;
}
</code></pre><p>é¦–å…ˆæ£€æŸ¥é¡µé¢æ˜¯å¦å·²ç»åœ¨å†…å­˜ä¸­çš„ç¼“å†²åŒºï¼ˆé€šè¿‡ <code>frame_manager_.get()</code> æ–¹æ³•ï¼‰ã€‚å¦‚æœå­˜åœ¨ï¼Œç›´æ¥è¿”å›è¯¥é¡µé¢ï¼Œå¹¶å¢åŠ  <code>pin</code> è®¡æ•°ã€‚
å¦‚æœé¡µé¢ä¸åœ¨å†…å­˜ä¸­ï¼Œè°ƒç”¨ <code>allocate_frame()</code> å‡½æ•°åˆ†é…ä¸€ä¸ªæ–°çš„ <code>Frame</code>ï¼Œå¹¶é€šè¿‡ <code>load_page()</code> å‡½æ•°ä»ç£ç›˜åŠ è½½è¯¥é¡µé¢åˆ°å†…å­˜ã€‚
æˆåŠŸåŠ è½½é¡µé¢åï¼Œå¢åŠ <code> pin</code> è®¡æ•°å¹¶è¿”å›ã€‚</p>
<h3 id="212-diskbufferpoolallocate_pageframe-frame">2.1.2 <code>DiskBufferPool::allocate_page(Frame **frame)</code></h3>
<p>åˆ†é…ä¸€ä¸ªæ–°çš„é¡µé¢åˆ°ç¼“å†²åŒºã€‚å¦‚æœæ²¡æœ‰ç©ºé—²é¡µé¢ï¼Œåˆ™æ‰©å±•æ–‡ä»¶ã€‚</p>
<pre tabindex="0"><code>RC DiskBufferPool::allocate_page(Frame **frame) {
  // ç¡®è®¤æ˜¯å¦æœ‰ç©ºé—²é¡µ
  if (file_header_-&gt;allocated_pages &gt;= file_header_-&gt;page_count) {
    // æ²¡æœ‰ç©ºé—²é¡µï¼Œæ‰©å±•æ–‡ä»¶
    RC rc = expand_file();
    if (rc != RC::SUCCESS) {
      return rc;
    }
  }

  // åˆ†é…é¡µé¢ï¼Œæ›´æ–°ä½å›¾çŠ¶æ€
  PageNum page_num = file_header_-&gt;allocated_pages++;
  file_header_-&gt;bitmap[page_num / 8] |= (1 &lt;&lt; (page_num % 8));

  // åˆ†é…å¸§
  return allocate_frame(page_num, frame);
}
</code></pre><p>é¦–å…ˆæ£€æŸ¥æ–‡ä»¶ä¸­æ˜¯å¦è¿˜æœ‰ç©ºé—²é¡µï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è°ƒç”¨ <code>expand_file()</code> æ¥æ‰©å±•æ–‡ä»¶ã€‚<br>
æˆåŠŸæ‰©å±•æ–‡ä»¶åï¼Œé€šè¿‡æ›´æ–° <code>bitmap</code> ä½å›¾æ ‡è®°é¡µé¢å·²åˆ†é…ã€‚<br>
ä½¿ç”¨ <code>allocate_frame()</code> æ–¹æ³•ä¸ºè¯¥é¡µé¢åˆ†é…å†…å­˜ã€‚</p>
<h3 id="213-diskbufferpoolflush_pageframe-frame">2.1.3 <code>DiskBufferPool::flush_page(Frame &amp;frame)</code></h3>
<p>å°†å†…å­˜ä¸­çš„é¡µé¢æ•°æ®å†™å›ç£ç›˜ï¼Œç¡®ä¿é¡µé¢çš„æŒä¹…åŒ–ã€‚</p>
<pre tabindex="0"><code>RC DiskBufferPool::flush_page(Frame &amp;frame) {
  if (!frame.dirty()) {
    return RC::SUCCESS;
  }

  // å°†é¡µé¢æ•°æ®å†™å…¥ç£ç›˜
  RC rc = write_page(frame.page_num(), frame.page());
  if (rc != RC::SUCCESS) {
    return rc;
  }

  frame.clear_dirty();
  return RC::SUCCESS;
}
</code></pre><p>å…ˆæ£€æŸ¥é¡µé¢æ˜¯å¦ä¸ºè„é¡µï¼ˆ<code>dirty()</code>ï¼‰ï¼Œå¦‚æœä¸æ˜¯è„é¡µï¼Œç›´æ¥è¿”å›ã€‚<br>
è°ƒç”¨ <code>write_page()</code> æ–¹æ³•å°†é¡µé¢æ•°æ®å†™å…¥ç£ç›˜ã€‚<br>
å†™å…¥æˆåŠŸåæ¸…é™¤é¡µé¢çš„è„æ ‡è®°ï¼Œå¹¶è¿”å›æˆåŠŸçŠ¶æ€ã€‚</p>
<h3 id="214-rc-diskbufferpooldispose_pagepagenum-page_num">2.1.4 <code>RC DiskBufferPool::dispose_page(PageNum page_num)</code></h3>
<p>è¯¥æ–¹æ³•ç”¨äºé‡Šæ”¾æŸä¸ªå·²åˆ†é…çš„é¡µé¢ï¼Œå°†å…¶ä»ç¼“å†²åŒºå’Œç£ç›˜æ–‡ä»¶ä¸­æ ‡è®°ä¸ºæœªåˆ†é…çŠ¶æ€ã€‚</p>
<pre tabindex="0"><code>RC DiskBufferPool::dispose_page(PageNum page_num)
{
  if (page_num == 0) {
    LOG_ERROR(&#34;Failed to dispose page %d, because it is the first page. filename=%s&#34;, page_num, file_name_.c_str());
    return RC::INTERNAL;
  }
  
  scoped_lock lock_guard(lock_);
  Frame           *used_frame = frame_manager_.get(id(), page_num);
  if (used_frame != nullptr) {
    ASSERT(&#34;the page try to dispose is in use. frame:%s&#34;, used_frame-&gt;to_string().c_str());
    frame_manager_.free(id(), page_num, used_frame);
  } else {
    LOG_DEBUG(&#34;page not found in memory while disposing it. pageNum=%d&#34;, page_num);
  }

  LSN lsn = 0;
  RC rc = log_handler_.deallocate_page(page_num, lsn);
  if (OB_FAIL(rc)) {
    LOG_ERROR(&#34;Failed to log deallocate page %d, rc=%s&#34;, page_num, strrc(rc));
    // ignore error handle
  }

  hdr_frame_-&gt;set_lsn(lsn);
  hdr_frame_-&gt;mark_dirty();
  file_header_-&gt;allocated_pages--;
  char tmp = 1 &lt;&lt; (page_num % 8);
  file_header_-&gt;bitmap[page_num / 8] &amp;= ~tmp;
  return RC::SUCCESS;
}
</code></pre><p>æ£€æŸ¥é¡µé¢å·ï¼Œç¡®ä¿æ–‡ä»¶å¤´é¡µé¢(<code>page_num</code>=0)ä¸ä¼šè¢«é‡Šæ”¾ã€‚<br>
æ£€æŸ¥é¡µé¢æ˜¯å¦åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœåœ¨å†…å­˜ä¸­åˆ™é‡Šæ”¾å®ƒã€‚<br>
è®°å½•æ—¥å¿—æ“ä½œï¼Œç¡®ä¿é‡Šæ”¾é¡µé¢çš„æ“ä½œå¯è¿½æº¯ã€‚<br>
æ›´æ–°æ–‡ä»¶å¤´çš„é¡µé¢åˆ†é…è®¡æ•°å’Œä½å›¾ï¼Œç¡®ä¿é¡µé¢é‡Šæ”¾çŠ¶æ€åŒæ­¥åˆ°æ–‡ä»¶:<br>
<code>hdr_frame_-&gt;set_lsn(lsn)</code>ï¼šå°†å½“å‰é¡µé¢å¤´æ–‡ä»¶çš„æ—¥å¿—åºåˆ—å·ï¼ˆ<code>LSN</code>ï¼‰æ›´æ–°ä¸ºæœ€æ–°çš„ <code>lsn</code>ï¼Œç¡®ä¿æ—¥å¿—é¡ºåºæ­£ç¡®ã€‚<br>
<code>hdr_frame_-&gt;mark_dirty()</code>ï¼šæ ‡è®°é¡µé¢ä¸ºè„é¡µï¼Œè¡¨ç¤ºé¡µé¢å¤´å·²ç»ä¿®æ”¹ï¼Œåœ¨é€‚å½“æ—¶æœºä¼šå°†å…¶åˆ·å›ç£ç›˜ã€‚<br>
<code>file_header_-&gt;allocated_pages--</code>ï¼šå‡å°‘æ–‡ä»¶å¤´ä¸­è®°å½•çš„å·²åˆ†é…é¡µé¢çš„è®¡æ•°ï¼Œè¡¨ç¤ºæœ‰ä¸€ä¸ªé¡µé¢è¢«é‡Šæ”¾ã€‚<br>
ä½å›¾æ›´æ–°ï¼š<code>bitmap</code> ç”¨äºè·Ÿè¸ªé¡µé¢çš„åˆ†é…çŠ¶æ€ã€‚é€šè¿‡ <code>file_header_-&gt;bitmap[page_num / 8] &amp;= ~tmp</code> è¿™è¡Œä»£ç ï¼Œæ¸…é™¤å¯¹åº”é¡µé¢çš„åˆ†é…æ ‡è®°ï¼ˆä½¿ç”¨æŒ‰ä½ä¸å’ŒæŒ‰ä½å–åæ“ä½œï¼‰ï¼Œå°†é¡µé¢æ ‡è®°ä¸ºæœªåˆ†é…ã€‚</p>
<h3 id="215-bpframemanager">2.1.5 <code>BPFrameManager</code></h3>
<pre tabindex="0"><code>class BPFrameManager
{
public:
  BPFrameManager(const char *tag);

  RC init(int pool_num);
  RC cleanup();

  /**
   * @brief è·å–æŒ‡å®šçš„é¡µé¢
   *
   * @param buffer_pool_id buffer Poolæ ‡è¯†
   * @param page_num  é¡µé¢å·
   * @return Frame* é¡µå¸§æŒ‡é’ˆ
   */
  Frame *get(int buffer_pool_id, PageNum page_num);

  /**
   * @brief åˆ—å‡ºæ‰€æœ‰æŒ‡å®šæ–‡ä»¶çš„é¡µé¢
   *
   * @param buffer_pool_id buffer Poolæ ‡è¯†
   * @return list&lt;Frame *&gt; é¡µå¸§åˆ—è¡¨
   */
  list&lt;Frame *&gt; find_list(int buffer_pool_id);

  /**
   * @brief åˆ†é…ä¸€ä¸ªæ–°çš„é¡µé¢
   *
   * @param buffer_pool_id buffer Poolæ ‡è¯†
   * @param page_num é¡µé¢ç¼–å·
   * @return Frame* é¡µå¸§æŒ‡é’ˆ
   */
  Frame *alloc(int buffer_pool_id, PageNum page_num);

  /**
   * å°½ç®¡frameä¸­å·²ç»åŒ…å«äº†buffer_pool_idå’Œpage_numï¼Œä½†æ˜¯ä¾ç„¶è¦æ±‚
   * ä¼ å…¥ï¼Œå› ä¸ºframeå¯èƒ½å¿˜è®°åˆå§‹åŒ–æˆ–è€…æ²¡æœ‰åˆå§‹åŒ–
   */
  RC free(int buffer_pool_id, PageNum page_num, Frame *frame);

  /**
   * å¦‚æœä¸èƒ½ä»ç©ºé—²é“¾è¡¨ä¸­åˆ†é…æ–°çš„é¡µé¢ï¼Œå°±ä½¿ç”¨è¿™ä¸ªæ¥å£ï¼Œ
   * å°è¯•ä»pin count=0çš„é¡µé¢ä¸­æ·˜æ±°ä¸€äº›
   * @param count æƒ³è¦purgeå¤šå°‘ä¸ªé¡µé¢
   * @param purger éœ€è¦åœ¨é‡Šæ”¾frameä¹‹å‰ï¼Œå¯¹é¡µé¢åšäº›ä»€ä¹ˆæ“ä½œã€‚å½“å‰æ˜¯åˆ·æ–°è„æ•°æ®åˆ°ç£ç›˜
   * @return è¿”å›æœ¬æ¬¡æ¸…ç†äº†å¤šå°‘ä¸ªé¡µé¢
   */
  int purge_frames(int count, function&lt;RC(Frame *frame)&gt; purger);

  size_t frame_num() const { return frames_.count(); }

  /**
   * æµ‹è¯•ä½¿ç”¨ã€‚è¿”å›å·²ç»ä»å†…å­˜ç”³è¯·çš„ä¸ªæ•°
   */
  size_t total_frame_num() const { return allocator_.get_size(); }

private:
  Frame *get_internal(const FrameId &amp;frame_id);
  RC     free_internal(const FrameId &amp;frame_id, Frame *frame);

private:
  class BPFrameIdHasher
  {
  public:
    size_t operator()(const FrameId &amp;frame_id) const { return frame_id.hash(); }
  };

  using FrameLruCache  = common::LruCache&lt;FrameId, Frame *, BPFrameIdHasher&gt;;
  using FrameAllocator = common::MemPoolSimple&lt;Frame&gt;;

  mutex          lock_;
  FrameLruCache  frames_;
  FrameAllocator allocator_;
};
</code></pre><h2 id="22-ç¼“å­˜é¡µæ¡†æ¶">2.2 ç¼“å­˜é¡µæ¡†æ¶</h2>
<p><code>Frame</code>:</p>
<pre tabindex="0"><code>class Frame
{
public:
  ~Frame()
  {
    // LOG_DEBUG(&#34;deallocate frame. this=%p, lbt=%s&#34;, this, common::lbt());
  }

  /**
   * @brief reinit å’Œ reset åœ¨ MemPoolSimple ä¸­ä½¿ç”¨
   * @details åœ¨ MemPoolSimple åˆ†é…å’Œé‡Šæ”¾ä¸€ä¸ªFrameå¯¹è±¡æ—¶ï¼Œä¸ä¼šè°ƒç”¨æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ï¼Œ
   * è€Œæ˜¯è°ƒç”¨reinitå’Œresetã€‚
   */
  void reinit() {}
  void reset() {}

  void clear_page() { memset(&amp;page_, 0, sizeof(page_)); }

  int  buffer_pool_id() const { return frame_id_.buffer_pool_id(); }
  void set_buffer_pool_id(int id) { frame_id_.set_buffer_pool_id(id); }

  /**
   * @brief åœ¨ç£ç›˜å’Œå†…å­˜ä¸­å†…å®¹å®Œå…¨ä¸€è‡´çš„æ•°æ®é¡µ
   * @details ç£ç›˜æ–‡ä»¶åˆ’åˆ†ä¸ºä¸€ä¸ªä¸ªé¡µé¢ï¼Œæ¯æ¬¡ä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªé¡µé¢ï¼Œå°±æ˜¯ Pageã€‚
   * frame æ˜¯ä¸ºäº†ç®¡ç†è¿™äº›é¡µé¢è€Œç»´æŠ¤çš„ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚
   */
  Page &amp;page() { return page_; }

  /**
   * @brief æ¯ä¸ªé¡µé¢éƒ½æœ‰ä¸€ä¸ªç¼–å·
   * @details å½“å‰é¡µé¢ç¼–å·è®°å½•åœ¨äº†é¡µé¢æ•°æ®ä¸­ï¼Œå…¶å®å¯ä»¥ä¸è®°å½•ï¼Œä»ç£ç›˜ä¸­åŠ è½½æ—¶è®°å½•åœ¨Frameä¿¡æ¯ä¸­å³å¯ã€‚
   */
  PageNum page_num() const { return frame_id_.page_num(); }
  void    set_page_num(PageNum page_num) { frame_id_.set_page_num(page_num); }
  FrameId frame_id() const { return frame_id_; }

  /**
   * @brief ä¸ºäº†å®ç°æŒä¹…åŒ–ï¼Œéœ€è¦å°†é¡µé¢çš„ä¿®æ”¹è®°å½•è®°å½•åˆ°æ—¥å¿—ä¸­ï¼Œè¿™é‡Œè®°å½•äº†æ—¥å¿—åºåˆ—å·
   * @details å¦‚æœå½“å‰é¡µé¢ä»ç£ç›˜ä¸­åŠ è½½å‡ºæ¥æ—¶ï¼Œå®ƒçš„æ—¥å¿—åºåˆ—å·æ¯”å½“å‰WAL(Write-Ahead-Logging)ä¸­çš„ä¸€äº›
   * åºåˆ—å·è¦å°ï¼Œé‚£å°±å¯ä»¥ä»æ—¥å¿—ä¸­è¯»å–è¿™äº›æ›´å¤§åºåˆ—å·çš„æ—¥å¿—ï¼Œåšé‡åšæ“ä½œï¼Œå°†é¡µé¢æ¢å¤åˆ°æœ€æ–°çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯redoã€‚
   */
  LSN  lsn() const { return page_.lsn; }
  void set_lsn(LSN lsn) { page_.lsn = lsn; }

  /**
   * @brief é¡µé¢æ ¡éªŒå’Œ
   * @details ç”¨äºæ ¡éªŒé¡µé¢å®Œæ•´æ€§ã€‚å¦‚æœé¡µé¢å†™å…¥ä¸€åŠæ—¶å‡ºç°å¼‚å¸¸ï¼Œå¯ä»¥é€šè¿‡æ ¡éªŒå’Œæ£€æµ‹å‡ºæ¥ã€‚
   */
  CheckSum check_sum() const { return page_.check_sum; }
  void     set_check_sum(CheckSum check_sum) { page_.check_sum = check_sum; }

  /**
   * @brief åˆ·æ–°å½“å‰å†…å­˜é¡µé¢çš„è®¿é—®æ—¶é—´
   * @details ç”±äºå†…å­˜æ˜¯æœ‰é™çš„ï¼Œæ¯”ç£ç›˜è¦å°å¾ˆå¤šã€‚é‚£å½“æˆ‘ä»¬è®¿é—®æŸäº›æ–‡ä»¶é¡µé¢æ—¶ï¼Œå¯èƒ½ç”±äºå†…å­˜ä¸è¶³
   * è€Œè¦æ·˜æ±°ä¸€äº›é¡µé¢ã€‚æˆ‘ä»¬é€‰æ‹©æ·˜æ±°å“ªäº›é¡µé¢å‘¢ï¼Ÿè¿™é‡Œä½¿ç”¨äº†LRUç®—æ³•ï¼Œå³æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„é¡µé¢è¢«æ·˜æ±°ã€‚
   * æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼Œé‡‡ç”¨çš„ä¾æ®å°±æ˜¯è®¿é—®æ—¶é—´ã€‚æ‰€ä»¥æ¯æ¬¡è®¿é—®æŸä¸ªé¡µé¢æ—¶ï¼Œæˆ‘ä»¬éƒ½è¦åˆ·æ–°ä¸€ä¸‹è®¿é—®æ—¶é—´ã€‚
   */
  void access();

  /**
   * @brief æ ‡è®°æŒ‡å®šé¡µé¢ä¸ºâ€œè„â€é¡µã€‚
   * @details å¦‚æœä¿®æ”¹äº†é¡µé¢çš„å†…å®¹ï¼Œåˆ™åº”è°ƒç”¨æ­¤å‡½æ•°ï¼Œ
   * ä»¥ä¾¿è¯¥é¡µé¢è¢«æ·˜æ±°å‡ºç¼“å†²åŒºæ—¶ç³»ç»Ÿå°†æ–°çš„é¡µé¢æ•°æ®å†™å…¥ç£ç›˜æ–‡ä»¶
   */
  void mark_dirty() { dirty_ = true; }

  /**
   * @brief é‡ç½®â€œè„â€æ ‡è®°
   * @details å¦‚æœé¡µé¢å·²ç»è¢«å†™å…¥ç£ç›˜æ–‡ä»¶ï¼Œåˆ™åº”è°ƒç”¨æ­¤å‡½æ•°ã€‚
   */
  void clear_dirty() { dirty_ = false; }
  bool dirty() const { return dirty_; }

  char *data() { return page_.data; }

  bool can_purge() { return pin_count_.load() == 0; }

  /**
   * @brief ç»™å½“å‰é¡µå¸§å¢åŠ å¼•ç”¨è®¡æ•°
   * piné€šå¸¸éƒ½ä¼šåŠ ç€frame manageré”æ¥è®¿é—®ã€‚
   * å½“æˆ‘ä»¬è®¿é—®æŸä¸ªé¡µé¢æ—¶ï¼Œæˆ‘ä»¬ä¸æœŸæœ›æ­¤é¡µé¢è¢«æ·˜æ±°ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå¢åŠ å¼•ç”¨è®¡æ•°ã€‚
   */
  void pin();

  /**
   * @brief é‡Šæ”¾ä¸€ä¸ªå½“å‰é¡µå¸§çš„å¼•ç”¨è®¡æ•°
   * ä¸pinå¯¹åº”ï¼Œä½†æ˜¯é€šå¸¸ä¸ä¼šåŠ ç€frame managerçš„é”æ¥è®¿é—®
   */
  int unpin();
  int pin_count() const { return pin_count_.load(); }

  void write_latch();
  void write_latch(intptr_t xid);

  void write_unlatch();
  void write_unlatch(intptr_t xid);

  void read_latch();
  void read_latch(intptr_t xid);
  bool try_read_latch();

  void read_unlatch();
  void read_unlatch(intptr_t xid);

  string to_string() const;

private:
  friend class BufferPool;

  bool          dirty_ = false;
  atomic&lt;int&gt;   pin_count_{0};
  unsigned long acc_time_ = 0;
  FrameId       frame_id_;
  Page          page_;

  /// åœ¨éå¹¶å‘ç¼–è¯‘æ—¶ï¼ŒåŠ é”è§£é”åŠ¨ä½œå°†ä»€ä¹ˆéƒ½ä¸åš
  common::RecursiveSharedMutex lock_;

  /// ä½¿ç”¨ä¸€äº›æ‰‹æ®µæ¥åšæµ‹è¯•ï¼Œæå‰æ£€æµ‹å‡ºå¤´ç–¼çš„æ­»é”é—®é¢˜
  /// å¦‚æœç¼–è¯‘æ—¶æ²¡æœ‰å¢åŠ è°ƒè¯•é€‰é¡¹ï¼Œè¿™äº›ä»£ç ä»€ä¹ˆéƒ½ä¸åš
  common::DebugMutex           debug_lock_;
  intptr_t                     write_locker_          = 0;
  int                          write_recursive_count_ = 0;
  unordered_map&lt;intptr_t, int&gt; read_lockers_;
};
</code></pre><p><code>Frame::pin()</code>ï¼š<br>
å¢åŠ é¡µé¢çš„ <code>pin_count_</code> è®¡æ•°ï¼Œé˜²æ­¢é¡µé¢è¢«æ·˜æ±°ã€‚</p>
<p><code>Frame::unpin()</code>:<br>
å‡å°‘é¡µé¢çš„ <code>pin_count_</code> è®¡æ•°ï¼Œå½“ <code>pin_count_</code> å½’é›¶æ—¶ï¼Œå…è®¸é¡µé¢è¢«æ·˜æ±°ã€‚</p>
<p><code>Frame::mark_dirty()</code>:<br>
æ ‡è®°é¡µé¢ä¸ºè„é¡µï¼Œè¡¨ç¤ºé¡µé¢å·²è¢«ä¿®æ”¹ï¼Œéœ€è¦åœ¨åˆé€‚çš„æ—¶æœºå°†æ•°æ®å†™å›ç£ç›˜ã€‚</p>
<p><code>Frame::write_latch()</code>:<br>
ä¸ºå½“å‰é¡µé¢åŠ å†™é”ï¼Œç¡®ä¿åœ¨å†™å…¥æ—¶ä¸è¢«å…¶ä»–çº¿ç¨‹è®¿é—®ã€‚</p>
<p><code>Frame::access()</code>:<br>
æ›´æ–°é¡µé¢çš„è®¿é—®æ—¶é—´ï¼Œç”¨äºæ›¿æ¢ç­–ç•¥ï¼Œæ ‡è¯†é¡µé¢æœ€è¿‘ä¸€æ¬¡è¢«è®¿é—®çš„æ—¶é—´ã€‚</p>
<h2 id="23-æ·˜æ±°ç­–ç•¥">2.3 æ·˜æ±°ç­–ç•¥</h2>
<pre tabindex="0"><code>int BPFrameManager::purge_frames(int count, function&lt;RC(Frame *frame)&gt; purger)
{
  lock_guard&lt;mutex&gt; lock_guard(lock_);

  vector&lt;Frame *&gt; frames_can_purge;
  if (count &lt;= 0) {
    count = 1;
  }
  frames_can_purge.reserve(count);

  auto purge_finder = [&amp;frames_can_purge, count](const FrameId &amp;frame_id, Frame *const frame) {
    if (frame-&gt;can_purge()) {
      frame-&gt;pin();
      frames_can_purge.push_back(frame);
      if (frames_can_purge.size() &gt;= static_cast&lt;size_t&gt;(count)) {
        return false;  // false to break the progress
      }
    }
    return true;  // true continue to look up
  };

  frames_.foreach_reverse(purge_finder);
  LOG_INFO(&#34;purge frames find %ld pages total&#34;, frames_can_purge.size());

  /// å½“å‰è¿˜åœ¨frameManagerçš„é”å†…ï¼Œè€Œ purger æ˜¯ä¸€ä¸ªéå¸¸è€—æ—¶çš„æ“ä½œ
  /// ä»–éœ€è¦æŠŠè„é¡µæ•°æ®åˆ·æ–°åˆ°ç£ç›˜ä¸Šå»ï¼Œæ‰€ä»¥è¿™é‡Œä¼šæå¤§åœ°é™ä½å¹¶å‘åº¦
  int freed_count = 0;
  for (Frame *frame : frames_can_purge) {
    RC rc = purger(frame);
    if (RC::SUCCESS == rc) {
      free_internal(frame-&gt;frame_id(), frame);
      freed_count++;
    } else {
      frame-&gt;unpin();
      LOG_WARN(&#34;failed to purge frame. frame_id=%s, rc=%s&#34;, 
               frame-&gt;frame_id().to_string().c_str(), strrc(rc));
    }
  }
  LOG_INFO(&#34;purge frame done. number=%d&#34;, freed_count);
  return freed_count;
}
</code></pre><p>æŸ¥æ‰¾å¯æ·˜æ±°çš„é¡µé¢:<br>
å®šä¹‰ä¸€ä¸ª <code>purge_finder</code> lambda å‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨äºéå†ç¼“å­˜ä¸­çš„æ‰€æœ‰é¡µé¢ï¼Œå¹¶å°†ç¬¦åˆæ¡ä»¶ï¼ˆå¯ä»¥æ·˜æ±°ï¼‰çš„é¡µé¢å­˜å‚¨åˆ° <code>frames_can_purge</code> å®¹å™¨ä¸­ã€‚<br>
<code>frame-&gt;can_purge()</code>ï¼šåˆ¤æ–­é¡µé¢æ˜¯å¦å¯ä»¥è¢«æ·˜æ±°ï¼Œé€šå¸¸æ˜¯é€šè¿‡ <code>pin_count == 0</code> æ¥åˆ¤æ–­é¡µé¢æ˜¯å¦æ­£åœ¨ä½¿ç”¨ï¼Œå¦‚æœé¡µé¢æœªè¢«å¼•ç”¨ï¼Œåˆ™å¯ä»¥æ·˜æ±°ã€‚<br>
<code>frame-&gt;pin()</code>ï¼šå¯¹è¯¥é¡µé¢æ‰§è¡Œ <code>pin</code> æ“ä½œï¼Œç¡®ä¿åœ¨å½“å‰çº¿ç¨‹ä½¿ç”¨è¯¥é¡µé¢æ—¶ï¼Œå®ƒä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ›¿æ¢æˆ–é‡Šæ”¾ã€‚<br>
å¦‚æœå·²ç»æ‰¾åˆ°äº†è¶³å¤Ÿæ•°é‡çš„é¡µé¢ï¼ˆå³<code> frames_can_purge.size() &gt;= count</code>ï¼‰ï¼Œåˆ™è¿”å› <code>false</code>ï¼Œä»¥ç»ˆæ­¢éå†ã€‚<br>
<code>frames_.foreach_reverse(purge_finder)</code>ï¼šéå†ç¼“å­˜æ± ä¸­çš„é¡µé¢ï¼ŒæŸ¥æ‰¾å¯ä»¥è¢«æ·˜æ±°çš„é¡µé¢ï¼Œå¹¶å­˜å‚¨åœ¨ <code>frames_can_purge</code> ä¸­ã€‚è¯¥éå†æ˜¯é€†åºè¿›è¡Œçš„ï¼ˆ<code>foreach_reverse</code>ï¼‰ï¼Œå¯èƒ½æ˜¯å› ä¸ºæœ€è¿‘ä½¿ç”¨çš„é¡µé¢æ’åœ¨é˜Ÿåˆ—çš„å‰é¢ï¼Œè€Œæœ€è¿‘æœªä½¿ç”¨çš„é¡µé¢æ’åœ¨åé¢ã€‚</p>
<p>æ‰§è¡Œæ·˜æ±°æ“ä½œ:<br>
åˆå§‹åŒ– <code>freed_count</code> å˜é‡ï¼Œç”¨äºç»Ÿè®¡æˆåŠŸæ·˜æ±°çš„é¡µé¢æ•°é‡ã€‚<br>
éå† <code>frames_can_purge</code> ä¸­çš„é¡µé¢ï¼Œå¹¶ä¸ºæ¯ä¸ªé¡µé¢è°ƒç”¨ä¼ å…¥çš„ <code>purger(frame)</code> å‡½æ•°æ‰§è¡Œæ·˜æ±°å‰çš„å¿…è¦æ“ä½œã€‚<br>
<code>purger(frame)</code>ï¼šè¿™æ˜¯ä¸€ä¸ªç”¨æˆ·æä¾›çš„å‡½æ•°ï¼Œé€šå¸¸ç”¨äºå°†è„é¡µï¼ˆä¿®æ”¹è¿‡ä½†å°šæœªåˆ·ç›˜çš„é¡µé¢ï¼‰å†™å›ç£ç›˜ã€‚è¿™ä¸ªæ“ä½œå¯èƒ½éå¸¸è€—æ—¶ï¼Œå› æ­¤æ˜¯å…³é”®æ­¥éª¤ã€‚<br>
å¦‚æœ <code>purger(frame)</code> æˆåŠŸï¼ˆè¿”å› <code>RC::SUCCESS</code>ï¼‰ï¼Œåˆ™è°ƒç”¨ <code>free_internal()</code> æ–¹æ³•é‡Šæ”¾è¯¥é¡µé¢ï¼Œå¹¶å¢åŠ å·²é‡Šæ”¾é¡µé¢çš„è®¡æ•° <code>freed_count</code>ã€‚<br>
å¦‚æœ <code>purger(frame)</code> å¤±è´¥ï¼Œè°ƒç”¨ <code>frame-&gt;unpin()</code> å–æ¶ˆä¹‹å‰å¯¹é¡µé¢çš„ <code>pin</code> æ“ä½œï¼Œå¹¶è®°å½•è­¦å‘Šæ—¥å¿—ã€‚</p>

    </div>
    <a href="/posts/miniob-bufferpool/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="w-100 w-30-l mb4 relative bg-white">
          <div class="w-100 mb4 nested-copy-line-height relative bg-white">
  <div class="mb3 pa4 gray overflow-hidden bg-white">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/miniob-debug-sql%E8%AF%AD%E5%8F%A5/" class="link black dim">
        
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <p>ç‚¹å‡»è¿”å›<a href="https://2549141519.github.io/#/toc">ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•</a></p>
<ul>
<li>ç›®å½•
{:toc}</li>
</ul>
<!-- raw HTML omitted -->
<h1 id="1-ä½¿ç”¨miniobçš„debug">1. ä½¿ç”¨miniobçš„DEBUG</h1>
<p>miniobå·²ç»å®ç°äº†<code>launch.json</code>å’Œ<code>tasks.json</code>ï¼Œå¯ä»¥ç›´æ¥è°ƒè¯•ã€‚<br>
åœ¨<code>miniob/src/observer/net/sql_task_handler.cpp</code>ä¸­ï¼Œç›´æ¥æ‰¾åˆ°<code>handle_sql</code>å‡½æ•°ï¼Œæ‰“æ–­ç‚¹ï¼Œè°ƒè¯•å³å¯ã€‚<br>
<img src="../blogImg/debug2.PNG" alt="å›¾ç‰‡2"><br>
<img src="../blogImg/debug3.PNG" alt="å›¾ç‰‡3"></p>
<pre tabindex="0"><code>RC SqlTaskHandler::handle_sql(SQLStageEvent *sql_event)
{
  RC rc = query_cache_stage_.handle_request(sql_event);
  if (OB_FAIL(rc)) {
    LOG_TRACE(&#34;failed to do query cache. rc=%s&#34;, strrc(rc));
    return rc;
  }

  rc = parse_stage_.handle_request(sql_event);
  if (OB_FAIL(rc)) {
    LOG_TRACE(&#34;failed to do parse. rc=%s&#34;, strrc(rc));
    return rc;
  }

  rc = resolve_stage_.handle_request(sql_event);
  if (OB_FAIL(rc)) {
    LOG_TRACE(&#34;failed to do resolve. rc=%s&#34;, strrc(rc));
    return rc;
  }

  rc = optimize_stage_.handle_request(sql_event);
  if (rc != RC::UNIMPLEMENTED &amp;&amp; rc != RC::SUCCESS) {
    LOG_TRACE(&#34;failed to do optimize. rc=%s&#34;, strrc(rc));
    return rc;
  }

  rc = execute_stage_.handle_request(sql_event);
  if (OB_FAIL(rc)) {
    LOG_TRACE(&#34;failed to do execute. rc=%s&#34;, strrc(rc));
    return rc;
  }

  return rc;
}
</code></pre><h1 id="2-è°ƒè¯•">2. è°ƒè¯•</h1>
<p>æ‰“æ–­ç‚¹ï¼š<br>
<img src="../blogImg/debug1.PNG" alt="å›¾1"><br>
å¼€å§‹è°ƒè¯•ï¼š<br>
é”®å…¥<code>CREATE TABLE TEST (ID int)</code>,åˆ›å»ºä¸€ä¸ªåä¸ºâ€œTESTâ€çš„è¡¨,è¡¨å«ä¸€ä¸ªåä¸ºâ€œIDâ€çš„æ•´å‹å­—æ®µã€‚ <br>
<img src="../blogImg/debug4.PNG" alt="å›¾4"><br>
è§£æé˜¶æ®µï¼š<br>
<img src="../blogImg/debug5.PNG" alt="å›¾5"><br>
è§£æå®Œæˆåï¼Œç”Ÿæˆè¯­æ³•æ ‘SQLNodeï¼š<br>
<img src="../blogImg/debug6.PNG" alt="å›¾6"><br>
<code>CREATE TABLE</code>æ“ä½œæ²¡æœ‰ä¼˜åŒ–è®¡åˆ’ï¼Œè¿”å›<code>UNIMPLEMENTED</code>ï¼Œç›´æ¥è¿›å…¥æ‰§è¡Œé˜¶æ®µã€‚<br>
<img src="../blogImg/debug7.PNG" alt="å›¾7"><br>
è¿›å…¥æ‰§è¡Œå™¨æ‰§è¡Œï¼Œè¾“å‡ºSUCCESSã€‚<br>
<img src="../blogImg/debug8.PNG" alt="å›¾8"><br>
ç¼–è¯‘ç»“æŸåæ‰§è¡Œ<code>SHOW TABLES</code>å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰è¡¨ï¼Œç¡®ä¿æˆåŠŸåˆ›å»ºè¡¨ï¼š<br>
<img src="../blogImg/debug9.PNG" alt="å›¾9"></p>

    </div>
    <a href="/posts/miniob-debug-sql%E8%AF%AD%E5%8F%A5/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="w-100 w-30-l mb4 relative bg-white">
          <div class="w-100 mb4 nested-copy-line-height relative bg-white">
  <div class="mb3 pa4 gray overflow-hidden bg-white">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/miniob-sql%E8%AF%AD%E5%8F%A5%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B/" class="link black dim">
        
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <p>ç‚¹å‡»è¿”å›<a href="https://2549141519.github.io/#/toc">ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•</a></p>
<ul>
<li>ç›®å½•
{:toc}</li>
</ul>
<!-- raw HTML omitted -->
<h1 id="1-sqlè¯­å¥æ‰§è¡Œæµç¨‹">1. SQLè¯­å¥æ‰§è¡Œæµç¨‹</h1>
<p>åœ¨MiniOBé¡¹ç›®ä¸­ï¼ŒSQLè¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<h2 id="11-sqlè§£æ">1.1 SQLè§£æ</h2>
<p>å½“SQLè¯­å¥è¢«è¾“å…¥æ—¶ï¼Œé¦–å…ˆç»è¿‡è¯æ³•å’Œè¯­æ³•åˆ†æå™¨ï¼ˆå¦‚ Flex å’Œ Bisonï¼‰è§£ææˆ<code>SQLNode</code>ã€‚<code>SQLNode</code>æ˜¯æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰çš„ç»„æˆéƒ¨åˆ†ï¼Œå®ƒè¡¨ç¤ºSQLè¯­å¥ä¸­çš„ä¸åŒç»“æ„å…ƒç´ ã€‚</p>
<h2 id="12-sqlnodeè½¬æ¢ä¸ºstmt">1.2 SQLNodeè½¬æ¢ä¸ºStmt</h2>
<p>åœ¨<code>Stmt</code>æ¨¡å—ä¸­ï¼Œ<code>SQLNode</code> ä¼šè¢«ç®€å•åœ°åˆ¤æ–­ï¼Œå¹¶æ ¹æ®ä¸åŒçš„ SQL è¯­å¥ç±»å‹ï¼ˆå¦‚<code> SELECT</code>ã€<code>INSERT</code>ã€<code>UPDATE</code> ç­‰ï¼‰ç”Ÿæˆç›¸åº”çš„<code>Stmt</code>å¯¹è±¡ã€‚<code>Stmt</code> æ˜¯é€»è¾‘è¯­ä¹‰çš„æ›´é«˜çº§åˆ«è¡¨ç¤ºï¼Œç”¨äºæ‰§è¡Œé€»è¾‘åˆ†æå’Œè¿›ä¸€æ­¥ä¼˜åŒ–ã€‚</p>
<h2 id="13-ç”Ÿæˆé€»è¾‘ç®—å­">1.3 ç”Ÿæˆé€»è¾‘ç®—å­</h2>
<p><code>Stmt</code>å¯¹è±¡ä¼šè¢«ä¼ é€’åˆ°é€»è¾‘åˆ†æé˜¶æ®µï¼Œç”Ÿæˆå¯¹åº”çš„é€»è¾‘ç®—å­ã€‚é€»è¾‘ç®—å­è¡¨ç¤ºæ“ä½œçš„é«˜å±‚æ¬¡è¯­ä¹‰ï¼ˆä¾‹å¦‚è¡¨æ‰«æã€è¿æ¥ã€ç­›é€‰ç­‰ï¼‰ï¼Œä½†æ­¤æ—¶å¹¶ä¸å…³å¿ƒå…·ä½“çš„æ‰§è¡Œæ–¹å¼ã€‚</p>
<h2 id="14-ç”Ÿæˆç‰©ç†ç®—å­">1.4 ç”Ÿæˆç‰©ç†ç®—å­</h2>
<p>åœ¨æŸ¥è¯¢ä¼˜åŒ–é˜¶æ®µï¼Œé€»è¾‘ç®—å­ä¼šè¢«ä¼˜åŒ–å™¨è½¬æ¢ä¸ºç‰©ç†ç®—å­ã€‚ç‰©ç†ç®—å­ä»£è¡¨æŸ¥è¯¢çš„å®é™…æ‰§è¡Œç­–ç•¥ï¼Œä¾‹å¦‚é¡ºåºæ‰«æã€ç´¢å¼•æ‰«æã€å“ˆå¸Œè¿æ¥ç­‰ã€‚ä¼˜åŒ–å™¨çš„ä½œç”¨æ˜¯é€‰æ‹©æœ€ä¼˜çš„æ‰§è¡Œæ–¹å¼ï¼Œä»¥æé«˜æŸ¥è¯¢æ•ˆç‡ã€‚ç‰©ç†ç®—å­ä¸å­˜å‚¨æ¨¡å—ä¹‹é—´æœ‰ç€ç›´æ¥çš„å…³è”ã€‚ç‰©ç†ç®—å­è´Ÿè´£æ‰§è¡Œå…·ä½“çš„æ“ä½œï¼Œè€Œè¿™äº›æ“ä½œå¾€å¾€æ¶‰åŠå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„å®é™…è¯»å–ã€å†™å…¥ã€æ›´æ–°å’Œåˆ é™¤ï¼Œè¿™äº›æ“ä½œéœ€è¦ä¸å­˜å‚¨æ¨¡å—äº¤äº’ã€‚</p>
<h2 id="15-æ‰§è¡Œ">1.5 æ‰§è¡Œ</h2>
<p>ç‰©ç†ç®—å­ä¼šç”±æ‰§è¡Œå™¨æ‰§è¡Œï¼Œæ‰§è¡Œå™¨æ ¹æ®ç‰©ç†ç®—å­ç”Ÿæˆçš„æ•°æ®æµï¼Œè®¿é—®å­˜å‚¨å±‚å¹¶è¿”å›ç»“æœã€‚</p>
<h1 id="2-æŸ¥è¯¢ä¼˜åŒ–">2. æŸ¥è¯¢ä¼˜åŒ–</h1>
<p>æŸ¥è¯¢ä¼˜åŒ– æ˜¯åœ¨é€»è¾‘ç®—å­ç”Ÿæˆåå’Œç‰©ç†ç®—å­ç”Ÿæˆå‰æ‰§è¡Œçš„ã€‚è¿™ä¸€æ­¥ä¼˜åŒ–å™¨æ ¹æ®é€»è¾‘ç®—å­ç”Ÿæˆå¤šä¸ªæ‰§è¡Œæ–¹æ¡ˆï¼ˆç‰©ç†ç®—å­ï¼‰ï¼Œå¹¶é€‰æ‹©æœ€ä¼˜çš„æ‰§è¡Œæ–¹å¼ã€‚<br>
ä¼˜åŒ–çš„ç›®æ ‡æ˜¯æé«˜æŸ¥è¯¢æ•ˆç‡ï¼Œå¯èƒ½åŒ…æ‹¬ï¼š<br>
é€‰æ‹©é€‚å½“çš„ç´¢å¼•ï¼šæ ¹æ®æ•°æ®åˆ†å¸ƒå’ŒæŸ¥è¯¢æ¡ä»¶é€‰æ‹©æœ€åˆé€‚çš„ç´¢å¼•ã€‚<br>
è¿æ¥é¡ºåºä¼˜åŒ–ï¼šå¯¹äºå¤šè¡¨è¿æ¥ï¼Œä¼˜åŒ–å™¨ä¼šæ ¹æ®è¡¨çš„å¤§å°ã€ç´¢å¼•ç­‰é€‰æ‹©åˆé€‚çš„è¿æ¥é¡ºåºã€‚<br>
å­æŸ¥è¯¢ä¼˜åŒ–ï¼šä¼˜åŒ–å™¨å¯èƒ½å°†å­æŸ¥è¯¢é‡å†™ä¸ºè¿æ¥æˆ–å…¶ä»–å½¢å¼ä»¥æé«˜æ•ˆç‡ã€‚<br>
ä¼˜åŒ–å®Œæˆåï¼Œä¼˜åŒ–å™¨ä¼šå°†é€»è¾‘ç®—å­è½¬æ¢ä¸ºç‰©ç†ç®—å­ï¼Œç‰©ç†ç®—å­è´Ÿè´£æ‰§è¡Œå…·ä½“çš„æ“ä½œï¼ˆå¦‚è¡¨æ‰«æã€ç´¢å¼•æŸ¥æ‰¾ç­‰ï¼‰ã€‚</p>
<h1 id="3-ä¸­é—´ä¼ é€’">3. ä¸­é—´ä¼ é€’</h1>
<p><code>SQLStageEvent</code>ç±»ç”¨äºåœ¨SQLè¯­å¥çš„ä¸åŒé˜¶æ®µä¼ é€’ä¿¡æ¯ã€‚åœ¨MiniOBé¡¹ç›®çš„æ‰§è¡Œæµç¨‹ä¸­,SQLè¯­å¥çš„å¤„ç†è¿‡ç¨‹å¯ä»¥é€šè¿‡<code>SQLStageEvent</code>ç±»å°†SQLç›¸å…³çš„æ•°æ®ç»“æ„ï¼ˆå¦‚ <code>ParsedSqlNode</code>ã€<code>Stmt</code>ã€<code>PhysicalOperator</code>ï¼‰åœ¨ä¸åŒé˜¶æ®µä¹‹é—´ä¼ é€’ã€‚</p>
<h2 id="31-ç¤ºä¾‹">3.1 ç¤ºä¾‹</h2>
<ol>
<li>è§£æé˜¶æ®µï¼š<code>ParsedSqlNode</code> è¢«åˆ›å»ºå¹¶è®¾ç½®ä¸º <code>sql_node_</code>ã€‚</li>
<li>è¯­ä¹‰åˆ†æé˜¶æ®µï¼šå°† <code>ParsedSqlNode</code> è½¬æ¢ä¸º <code>Stmt</code> å¯¹è±¡ï¼Œå¹¶è®¾ç½®åˆ° <code>stmt_</code> ä¸­ã€‚</li>
<li>æ‰§è¡Œè®¡åˆ’ç”Ÿæˆé˜¶æ®µï¼šåŸºäº <code>Stmt</code> ç”Ÿæˆ <code>PhysicalOperator</code>ï¼Œå¹¶è®¾ç½®åˆ° <code>operator_</code> ä¸­ã€‚</li>
<li>æ‰§è¡Œé˜¶æ®µï¼šæ‰§è¡Œå™¨é€šè¿‡ <code>PhysicalOperator</code> æ¥è®¿é—®å­˜å‚¨å±‚ï¼Œæ‰§è¡ŒSQLè¯­å¥ã€‚</li>
</ol>

    </div>
    <a href="/posts/miniob-sql%E8%AF%AD%E5%8F%A5%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="w-100 w-30-l mb4 relative bg-white">
          <div class="w-100 mb4 nested-copy-line-height relative bg-white">
  <div class="mb3 pa4 gray overflow-hidden bg-white">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/nginx-%E5%86%85%E5%AD%98%E6%B1%A0/" class="link black dim">
        
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <p>ç‚¹å‡»è¿”å›<a href="https://2549141519.github.io/#/toc">ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•</a></p>
<ul>
<li>ç›®å½•
{:toc}</li>
</ul>
<!-- raw HTML omitted -->
<h1 id="1-ä»‹ç»">1. ä»‹ç»</h1>
<p>Nginx å†…å­˜æ± çš„å®ç°æ˜¯å…¶é«˜æ€§èƒ½ã€é«˜å¹¶å‘å¤„ç†èƒ½åŠ›çš„é‡è¦ç»„æˆéƒ¨åˆ†ä¹‹ä¸€ã€‚Nginx çš„å†…å­˜æ± ä¸»è¦ç”¨äºé«˜æ•ˆç®¡ç†å†…å­˜ï¼Œé¿å…é¢‘ç¹çš„å†…å­˜åˆ†é…ä¸é‡Šæ”¾æ“ä½œï¼Œå‡å°‘å†…å­˜ç¢ç‰‡ï¼Œæå‡æ€§èƒ½ã€‚Nginx å†…å­˜æ± çš„å®ç°éµå¾ªâ€œé¢„åˆ†é…ä¸€å—å†…å­˜ï¼Œç„¶åè¿›è¡Œå°å—åˆ†é…â€çš„ç­–ç•¥ï¼Œç±»ä¼¼äºå¸¸è§çš„å†…å­˜æ± æ¨¡å‹ã€‚<br>
Nginxåœ¨ <a href="https://github.com/nginx/nginx/blob/master/src/core/ngx_palloc.h">ngx_palloc.h</a> å’Œ <a href="https://github.com/nginx/nginx/blob/master/src/core/ngx_palloc.c">ngx_palloc.c</a> ä¸­å®ç°äº†å†…å­˜æ± ã€‚</p>
<h1 id="2-å†…å­˜æ± çš„å®ç°åŸç†">2. å†…å­˜æ± çš„å®ç°åŸç†</h1>
<h2 id="21-nginx-å†…å­˜æ± çš„ç»“æ„">2.1 Nginx å†…å­˜æ± çš„ç»“æ„</h2>
<p><code>ngx_pool_s</code> ç»“æ„ä½“æ˜¯å†…å­˜æ± çš„æ ¸å¿ƒç»“æ„ï¼Œå®ƒç®¡ç†å†…å­˜å—çš„é“¾è¡¨ã€å†…å­˜æ± çš„å¤§å°ä¿¡æ¯ã€ä»¥åŠæ¸…ç†å‡½æ•°ç­‰ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>struct ngx_pool_s {
    ngx_pool_data_t       d;         // å†…å­˜å—çš„æ•°æ®
    size_t                max;       // å¯ä»è¯¥å†…å­˜æ± åˆ†é…çš„æœ€å¤§å†…å­˜å—å¤§å°
    ngx_pool_t           *current;   // å½“å‰æ´»è·ƒçš„å†…å­˜å—
    ngx_chain_t          *chain;     // ç¼“å­˜é“¾
    ngx_pool_large_t     *large;     // å¤§å—å†…å­˜é“¾è¡¨
    ngx_pool_cleanup_t   *cleanup;   // æ¸…ç†å‡½æ•°é“¾è¡¨
    ngx_log_t            *log;       // æ—¥å¿—å¯¹è±¡
};
</code></pre><p>å…¶ä¸­ï¼Œngx_pool_data_t å®šä¹‰äº†æ¯ä¸ªå†…å­˜å—çš„å…ƒæ•°æ®ï¼š</p>
<pre tabindex="0"><code>typedef struct {
    u_char      *last;    // å½“å‰å†…å­˜å—ä¸­å·²ä½¿ç”¨çš„æœ€åä½ç½®
    u_char      *end;     // å½“å‰å†…å­˜å—çš„æœ«å°¾ä½ç½®
    ngx_pool_t  *next;    // ä¸‹ä¸€ä¸ªå†…å­˜å—çš„æŒ‡é’ˆ
    ngx_uint_t   failed;  // åˆ†é…å¤±è´¥æ¬¡æ•°
} ngx_pool_data_t;
</code></pre><h2 id="22-å†…å­˜æ± çš„åˆ›å»ºå’Œé”€æ¯">2.2 å†…å­˜æ± çš„åˆ›å»ºå’Œé”€æ¯</h2>
<p><code>ngx_create_pool</code>å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªå†…å­˜æ± ï¼Œåˆ†é…ä¸€ä¸ªåˆå§‹å¤§å°ä¸º size çš„å†…å­˜å—ï¼Œå¹¶åˆå§‹åŒ–å†…å­˜æ± çš„å„ç§å‚æ•°ï¼š</p>
<pre tabindex="0"><code>ngx_pool_t *ngx_create_pool(size_t size, ngx_log_t *log) {
    ngx_pool_t *p;

    p = ngx_memalign(NGX_POOL_ALIGNMENT, size, log);  // å¯¹é½åˆ†é…å†…å­˜
    if (p == NULL) {
        return NULL;
    }

    p-&gt;d.last = (u_char *) p + sizeof(ngx_pool_t);  // åˆå§‹åŒ–lastæŒ‡é’ˆ
    p-&gt;d.end = (u_char *) p + size;  // æŒ‡å‘å†…å­˜å—çš„æœ«å°¾
    p-&gt;d.next = NULL;  
    p-&gt;d.failed = 0;

    size = size - sizeof(ngx_pool_t);
    p-&gt;max = (size &lt; NGX_MAX_ALLOC_FROM_POOL) ? size : NGX_MAX_ALLOC_FROM_POOL;  // ç¡®å®šåˆ†é…å—çš„æœ€å¤§å€¼

    p-&gt;current = p;
    p-&gt;chain = NULL;
    p-&gt;large = NULL;
    p-&gt;cleanup = NULL;
    p-&gt;log = log;

    return p;
}
</code></pre><p><code>ngx_destroy_pool</code>ç”¨äºé”€æ¯å†…å­˜æ± ï¼Œä¼šéå†å†…å­˜æ± ä¸­çš„æ‰€æœ‰å†…å­˜å—ã€æ¸…ç†å¤§å—å†…å­˜ã€å¹¶æ‰§è¡Œæ‰€æœ‰æ³¨å†Œçš„æ¸…ç†å‡½æ•°ï¼š</p>
<pre tabindex="0"><code>void ngx_destroy_pool(ngx_pool_t *pool) {
    ngx_pool_t *p, *n;
    ngx_pool_large_t *l;
    ngx_pool_cleanup_t *c;

    // è°ƒç”¨æ‰€æœ‰æ³¨å†Œçš„æ¸…ç†å‡½æ•°
    for (c = pool-&gt;cleanup; c; c = c-&gt;next) {
        if (c-&gt;handler) {
            c-&gt;handler(c-&gt;data);
        }
    }

    // é‡Šæ”¾å¤§å—å†…å­˜
    for (l = pool-&gt;large; l; l = l-&gt;next) {
        if (l-&gt;alloc) {
            ngx_free(l-&gt;alloc);
        }
    }

    // é‡Šæ”¾å†…å­˜æ± ä¸­çš„æ‰€æœ‰å†…å­˜å—
    for (p = pool, n = pool-&gt;d.next; /* void */; p = n, n = n-&gt;d.next) {
        ngx_free(p);
        if (n == NULL) {
            break;
        }
    }
}
</code></pre><h1 id="3-å†…å­˜æ± çš„åˆ†é…ç­–ç•¥">3. å†…å­˜æ± çš„åˆ†é…ç­–ç•¥</h1>
<p>Nginx å†…å­˜æ± æ ¹æ®åˆ†é…å†…å­˜çš„å¤§å°æ¥å†³å®šä»å“ªé‡Œåˆ†é…ï¼š<br>
å°å—å†…å­˜ï¼ˆå°äº <code>max</code>ï¼‰ï¼šä»å†…å­˜æ± çš„ç°æœ‰å—ä¸­åˆ†é…ã€‚<br>
å¤§å—å†…å­˜ï¼ˆå¤§äº <code>max</code>ï¼‰ï¼šç›´æ¥ä»ç³»ç»Ÿä¸­åˆ†é…å†…å­˜å¹¶æŒ‚è½½åˆ° <code>large</code> é“¾è¡¨ä¸­ã€‚</p>
<h2 id="31-å°å—å†…å­˜åˆ†é…">3.1 å°å—å†…å­˜åˆ†é…</h2>
<p>é€šè¿‡<code>ngx_palloc_small</code>å‡½æ•°å®Œæˆã€‚å½“è¦åˆ†é…çš„å†…å­˜å—å°äº<code>max</code>æ—¶ï¼Œå®ƒä¼šä»å½“å‰å†…å­˜å—ä¸­åˆ†é…ã€‚</p>
<pre tabindex="0"><code>static ngx_inline void *ngx_palloc_small(ngx_pool_t *pool, size_t size, ngx_uint_t align) {
    u_char *m;
    ngx_pool_t *p = pool-&gt;current;

    do {
        m = p-&gt;d.last;

        if (align) {
            m = ngx_align_ptr(m, NGX_ALIGNMENT);  // åœ°å€å¯¹é½
        }

        if ((size_t) (p-&gt;d.end - m) &gt;= size) {
            p-&gt;d.last = m + size;
            return m;
        }

        p = p-&gt;d.next;  // å°è¯•ä¸‹ä¸€ä¸ªå†…å­˜å—
    } while (p);

    return ngx_palloc_block(pool, size);  // è‹¥å½“å‰å†…å­˜å—ä¸è¶³ï¼Œåˆ™åˆ†é…æ–°å†…å­˜å—
}
</code></pre><p><code>d.last</code>ï¼šæ£€æŸ¥å½“å‰å†…å­˜å—æ˜¯å¦æœ‰è¶³å¤Ÿç©ºé—´å¯åˆ†é…ã€‚</p>
<h2 id="32-å¤§å—å†…å­˜åˆ†é…">3.2 å¤§å—å†…å­˜åˆ†é…</h2>
<p>å½“éœ€è¦åˆ†é…çš„å†…å­˜å—å¤§äº <code>max </code>æ—¶ï¼Œè°ƒç”¨ <code>ngx_palloc_large</code> å‡½æ•°ï¼Œå®ƒç›´æ¥è°ƒç”¨ç³»ç»Ÿçš„å†…å­˜åˆ†é…å‡½æ•°ï¼Œå¹¶å°†å¤§å—å†…å­˜æŒ‚è½½åˆ°<code> large</code> é“¾è¡¨ä¸­ç®¡ç†ã€‚</p>
<pre tabindex="0"><code>static void *ngx_palloc_large(ngx_pool_t *pool, size_t size) {
    void *p = ngx_alloc(size, pool-&gt;log);  // ç³»ç»Ÿå†…å­˜åˆ†é…
    if (p == NULL) {
        return NULL;
    }

    ngx_pool_large_t *large = ngx_palloc_small(pool, sizeof(ngx_pool_large_t), 1);
    if (large == NULL) {
        ngx_free(p);
        return NULL;
    }

    large-&gt;alloc = p;  // å°†å¤§å—å†…å­˜æŒ‚è½½åˆ° large é“¾è¡¨ä¸­
    large-&gt;next = pool-&gt;large;
    pool-&gt;large = large;

    return p;
}
</code></pre><h1 id="4-å†…å­˜æ± çš„æ¸…ç†æœºåˆ¶">4. å†…å­˜æ± çš„æ¸…ç†æœºåˆ¶</h1>
<p>Nginx å†…å­˜æ± æ”¯æŒæ³¨å†Œæ¸…ç†å‡½æ•°ï¼Œåœ¨é”€æ¯å†…å­˜æ± æ—¶è‡ªåŠ¨è°ƒç”¨è¿™äº›å‡½æ•°è¿›è¡Œèµ„æºæ¸…ç†ã€‚</p>
<p><code>ngx_pool_cleanup_add</code>å‡½æ•°ç”¨äºæ³¨å†Œæ¸…ç†å‡½æ•°ã€‚å®ƒä¼šåˆ›å»ºä¸€ä¸ª <code>ngx_pool_cleanup_t </code>ç»“æ„ï¼Œå¹¶å°†å…¶åŠ å…¥åˆ°å†…å­˜æ± çš„æ¸…ç†é“¾è¡¨ä¸­ï¼š</p>
<pre tabindex="0"><code>ngx_pool_cleanup_t *ngx_pool_cleanup_add(ngx_pool_t *p, size_t size) {
    ngx_pool_cleanup_t *c = ngx_palloc(p, sizeof(ngx_pool_cleanup_t));
    if (c == NULL) {
        return NULL;
    }

    if (size) {
        c-&gt;data = ngx_palloc(p, size);
        if (c-&gt;data == NULL) {
            return NULL;
        }
    } else {
        c-&gt;data = NULL;
    }

    c-&gt;handler = NULL;  // æ¸…ç†å‡½æ•°æŒ‡é’ˆ
    c-&gt;next = p-&gt;cleanup;
    p-&gt;cleanup = c;

    return c;
}
</code></pre>
    </div>
    <a href="/posts/nginx-%E5%86%85%E5%AD%98%E6%B1%A0/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="w-100 w-30-l mb4 relative bg-white">
          <div class="w-100 mb4 nested-copy-line-height relative bg-white">
  <div class="mb3 pa4 gray overflow-hidden bg-white">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/paxos-%E5%88%86%E5%B8%83%E5%BC%8F%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95/" class="link black dim">
        
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <p>ç‚¹å‡»è¿”å›<a href="https://2549141519.github.io/#/toc">ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•</a></p>
<ul>
<li>ç›®å½•
{:toc}</li>
</ul>
<!-- raw HTML omitted -->
<p>paper <a href="https://www.microsoft.com/en-us/research/uploads/prod/2016/12/paxos-simple-Copy.pdf">link</a></p>
<h1 id="1-paxosç®—æ³•ä»‹ç»">1. Paxosç®—æ³•ä»‹ç»</h1>
<p>Paxos æ˜¯ä¸€ç§ç”¨äº åˆ†å¸ƒå¼ç³»ç»Ÿ ä¸­è¾¾æˆä¸€è‡´æ€§çš„ç®—æ³•ï¼Œé€šå¸¸ç”¨äºè§£å†³åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ å…±è¯†é—®é¢˜ã€‚å®ƒä¿è¯äº†å³ä½¿åœ¨ç³»ç»Ÿä¸­çš„æŸäº›èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œå¤šä¸ªèŠ‚ç‚¹ä¹Ÿèƒ½å°±æŸä¸ªå€¼æˆ–çŠ¶æ€è¾¾æˆä¸€è‡´ã€‚Paxos ä¸»è¦ç”¨äºåœ¨æ²¡æœ‰ä¸­å¤®åè°ƒè€…çš„ç³»ç»Ÿä¸­ç¡®ä¿æ•°æ®çš„ ä¸€è‡´æ€§ å’Œ å¯é æ€§ã€‚</p>
<p>Paxosçš„å·¥ä½œæµç¨‹å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªä¸»è¦è§’è‰²å’Œä¸‰ä¸ªé˜¶æ®µã€‚</p>
<h2 id="11-ä¸‰ä¸ªä¸»è¦è§’è‰²">1.1 ä¸‰ä¸ªä¸»è¦è§’è‰²</h2>
<pre tabindex="0"><code>1. Proposerï¼šæè®®è€…ï¼Œè´Ÿè´£ç”Ÿæˆæè®®å€¼ï¼Œå¹¶å‘é€æè®®æ¶ˆæ¯ç»™Acceptorï¼Œå»ºè®®æŸä¸ªå€¼æˆä¸ºå…±è¯†å€¼ã€‚  
2. Acceptorï¼šæ¥å—è€…ï¼Œè´Ÿè´£æ¥æ”¶å’Œå­˜å‚¨æè®®ã€‚å¤šæ•° Acceptor æ¥å—æè®®åï¼Œè¯¥æè®®æ‰èƒ½ç”Ÿæ•ˆã€‚  
3. Learnerï¼šå­¦ä¹ è€…ï¼Œè´Ÿè´£æ¥æ”¶Acceptorçš„å“åº”ï¼Œå­¦ä¹ æœ€ç»ˆè¾¾æˆçš„å…±è¯†ç»“æœã€‚  
</code></pre><h2 id="12-ä¸‰ä¸ªé˜¶æ®µ">1.2 ä¸‰ä¸ªé˜¶æ®µ</h2>
<pre tabindex="0"><code>1. Prepare é˜¶æ®µï¼š
æè®®è€…å‘æ¥å—è€…å‘é€æè®®ï¼Œè¦æ±‚ Acceptor è¡¨ç¤ºæ˜¯å¦æ„¿æ„æ¥å—æ›´é«˜ç¼–å·çš„æè®®ã€‚
2. Promise é˜¶æ®µï¼š
Acceptor å‘ Proposer æ‰¿è¯ºä¸ä¼šæ¥å—ç¼–å·ä½äºå½“å‰æè®®çš„å…¶ä»–æè®®ã€‚
3. Accept é˜¶æ®µï¼š
ä¸€æ—¦æè®®è·å¾—å¤§å¤šæ•° Acceptor çš„åŒæ„ï¼ŒProposer å°±å¯ä»¥å®£å¸ƒè¯¥æè®®é€šè¿‡ï¼ŒLearner å°†ä¼šå­¦ä¹ åˆ°æœ€ç»ˆçš„å…±è¯†å€¼ã€‚
</code></pre><h2 id="13-paxosçš„å…³é”®ç‰¹æ€§">1.3 Paxosçš„å…³é”®ç‰¹æ€§</h2>
<p>å®¹é”™æ€§ï¼š<br>
å³ä½¿éƒ¨åˆ†èŠ‚ç‚¹æ•…éšœï¼ˆå¦‚ç½‘ç»œåˆ†åŒºæˆ–èŠ‚ç‚¹å´©æºƒï¼‰ï¼ŒPaxos ä»ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œåªè¦å¤§å¤šæ•°èŠ‚ç‚¹ï¼ˆä¸€èˆ¬ä¸ºè¶…è¿‡åŠæ•°çš„ Acceptorï¼‰æ­£å¸¸å·¥ä½œã€‚</p>
<p>ä¸€è‡´æ€§ï¼š<br>
æ‰€æœ‰èŠ‚ç‚¹æœ€ç»ˆéƒ½ä¼šè¾¾æˆä¸€è‡´çš„å…±è¯†å€¼ï¼Œä¿è¯ç³»ç»Ÿä¸ä¼šå‡ºç°ä¸åŒæ­¥çš„æƒ…å†µã€‚</p>
<p>å¯æ¢å¤æ€§ï¼š<br>
å³ä½¿ç³»ç»Ÿå‘ç”Ÿæ•…éšœï¼Œæ¢å¤å Paxos ä»èƒ½ç»§ç»­ä»ä¸Šæ¬¡ä¸­æ–­çš„åœ°æ–¹ç»§ç»­è¿è¡Œï¼Œä¸ä¼šä¸¢å¤±å·²ç»è¾¾æˆçš„å…±è¯†ã€‚</p>
<h1 id="2-ä¸€è‡´æ€§ç®—æ³•">2. ä¸€è‡´æ€§ç®—æ³•</h1>
<p>ä¸€è‡´æ€§ç®—æ³•æ˜¯Paxosçš„æ ¸å¿ƒã€‚ç›®çš„æ˜¯åœ¨å¤šä¸ªè¿›ç¨‹ä¸­è¾¾æˆä¸€è‡´é€‰æ‹©æŸä¸ªå€¼ï¼ˆå³ å…±è¯†ï¼‰ï¼Œå¹¶æå‡ºäº†å®ç°è¿™ç§å…±è¯†çš„ å®‰å…¨æ€§è¦æ±‚ã€‚</p>
<h2 id="21-å…±è¯†é—®é¢˜çš„åŸºæœ¬ç›®æ ‡">2.1 å…±è¯†é—®é¢˜çš„åŸºæœ¬ç›®æ ‡</h2>
<p>å…±è¯†ç®—æ³•çš„ç›®æ ‡æ˜¯ç¡®ä¿åœ¨ä¸€ç»„æè®®çš„å€¼ä¸­ï¼Œé€‰æ‹©ä¸€ä¸ªå¹¶è®©ç³»ç»Ÿå†…çš„æ‰€æœ‰è¿›ç¨‹çŸ¥é“è¿™ä¸ªè¢«é€‰æ‹©çš„å€¼ã€‚å…·ä½“è¦æ±‚åŒ…æ‹¬ï¼š</p>
<pre tabindex="0"><code>å¦‚æœæ²¡æœ‰æå‡ºä»»ä½•å€¼ï¼Œé‚£ä¹ˆä¸åº”é€‰æ‹©ä»»ä½•å€¼ã€‚
å¦‚æœå·²ç»é€‰æ‹©äº†ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆç³»ç»Ÿå†…çš„è¿›ç¨‹èƒ½å¤Ÿå­¦ä¹ åˆ°è¿™ä¸ªè¢«é€‰æ‹©çš„å€¼ã€‚
</code></pre><h2 id="22-å®‰å…¨æ€§è¦æ±‚">2.2 å®‰å…¨æ€§è¦æ±‚</h2>
<p>å…±è¯†ç®—æ³•å¿…é¡»éµå¾ªä»¥ä¸‹ å®‰å…¨æ€§è¦æ±‚ï¼š</p>
<pre tabindex="0"><code>åªèƒ½é€‰æ‹©å·²æè®®çš„å€¼ï¼š
ç®—æ³•ä¸èƒ½å‡­ç©ºé€‰å‡ºä¸€ä¸ªæ²¡æœ‰è¢«ä»»ä½•è¿›ç¨‹æè®®çš„å€¼ã€‚
åªèƒ½é€‰æ‹©å•ä¸ªå€¼ï¼š
å³ä½¿æœ‰å¤šä¸ªè¿›ç¨‹æå‡ºäº†ä¸åŒçš„å€¼ï¼Œæœ€ç»ˆç³»ç»Ÿå†…åªèƒ½æœ‰ä¸€ä¸ªå€¼è¢«é€‰æ‹©ã€‚
åªæœ‰åœ¨æŸä¸ªå€¼å®é™…è¢«é€‰ä¸­åï¼Œè¿›ç¨‹æ‰èƒ½å¾—çŸ¥è¿™ä¸ªå€¼ï¼š
è¿›ç¨‹ä¸èƒ½é”™è¯¯åœ°è®¤ä¸ºä¸€ä¸ªå€¼è¢«é€‰ä¸­äº†ï¼Œé™¤éè¿™ä¸ªå€¼ç¡®å®å·²ç»è¢«é€‰æ‹©ã€‚
</code></pre><h2 id="23-æ´»æ€§è¦æ±‚">2.3 æ´»æ€§è¦æ±‚</h2>
<p>è™½ç„¶é—®é¢˜ä¸­æ²¡æœ‰ç²¾ç¡®æè¿°æ´»æ€§è¦æ±‚ï¼Œä½†æå‡ºäº†å¦‚ä¸‹ç›®æ ‡ï¼š</p>
<pre tabindex="0"><code>æŸä¸ªæè®®çš„å€¼æœ€ç»ˆåº”è¢«é€‰æ‹©ï¼š
å¦‚æœæœ‰è¿›ç¨‹æå‡ºäº†å€¼ï¼Œç®—æ³•åº”è¯¥ä¿è¯æœ€ç»ˆä¼šé€‰æ‹©æŸä¸ªå€¼ï¼Œè€Œä¸æ˜¯æ— é™æœŸç­‰å¾…ã€‚
è¢«é€‰ä¸­çš„å€¼åº”è¯¥èƒ½å¤Ÿè¢«è¿›ç¨‹å­¦ä¹ åˆ°ï¼š
ä¸€æ—¦æŸä¸ªå€¼è¢«é€‰ä¸­ï¼Œç³»ç»Ÿä¸­çš„è¿›ç¨‹åº”èƒ½æœ€ç»ˆå¾—çŸ¥è¿™ä¸ªè¢«é€‰ä¸­çš„å€¼ã€‚
</code></pre><h2 id="24-é€šä¿¡æ¨¡å‹">2.4 é€šä¿¡æ¨¡å‹</h2>
<p>ç³»ç»Ÿä¸­çš„ä»£ç†ï¼ˆå³æè®®è€…ã€æ¥å—è€…ã€å­¦ä¹ è€…ï¼‰ä¹‹é—´é€šè¿‡ æ¶ˆæ¯ é€šä¿¡ï¼Œé—®é¢˜å‡è®¾ä½¿ç”¨çš„æ˜¯å…¸å‹çš„ å¼‚æ­¥ã€éæ‹œå åº­æ¨¡å‹ï¼Œå…¶ç‰¹æ€§åŒ…æ‹¬ï¼š</p>
<pre tabindex="0"><code>å¼‚æ­¥æ‰§è¡Œï¼š
ä»£ç†çš„æ“ä½œé€Ÿåº¦å¯ä»¥ä»»æ„ï¼Œå¯èƒ½ä¼šå¤±æ•ˆï¼ˆå´©æºƒï¼‰å¹¶é‡å¯ã€‚
å´©æºƒæ¢å¤ï¼š
æ‰€æœ‰ä»£ç†å¯èƒ½åœ¨å€¼è¢«é€‰ä¸­åå´©æºƒå¹¶é‡å¯ï¼Œå› æ­¤ï¼Œç³»ç»Ÿå¿…é¡»è®°ä½ä¸€äº›ä¿¡æ¯ï¼Œä»¥ä¾¿åœ¨é‡å¯åç»§ç»­è¿è¡Œã€‚å¦åˆ™ï¼Œåœ¨æ²¡æœ‰ä»»ä½•ä¿¡æ¯æ¢å¤çš„æƒ…å†µä¸‹ï¼Œç®—æ³•æ˜¯æ— æ³•ç»§ç»­å·¥ä½œçš„ã€‚
æ¶ˆæ¯çš„ä¸ç¡®å®šæ€§ï¼š
æ¶ˆæ¯å¯èƒ½å»¶è¿Ÿã€ä¸¢å¤±ã€é‡å¤å‘é€ï¼Œä½†æ¶ˆæ¯å†…å®¹ä¸ä¼šè¢«ç¯¡æ”¹ï¼ˆå³æ²¡æœ‰æ‹œå åº­é”™è¯¯ï¼‰ã€‚
</code></pre><h2 id="25-å·¥ä½œåŸç†">2.5 å·¥ä½œåŸç†</h2>
<p>Paxos ç®—æ³•è¢«è®¾è®¡ä¸ºåœ¨å¤šä¸ªèŠ‚ç‚¹å¯èƒ½å¤±æ•ˆæˆ–æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µä¸‹ï¼Œä»ç„¶èƒ½å¤Ÿåœ¨è¿™äº›èŠ‚ç‚¹ä¹‹é—´è¾¾æˆå…±è¯†ã€‚</p>
<h3 id="251-åˆå§‹æ–¹æ¡ˆå•ä¸ªæ¥å—è€…">2.5.1 åˆå§‹æ–¹æ¡ˆï¼šå•ä¸ªæ¥å—è€…</h3>
<p>æœ€ç®€å•çš„æ–¹æ¡ˆæ˜¯åªæœ‰ä¸€ä¸ª æ¥å—è€…ï¼ˆAcceptorï¼‰ï¼Œæ¯å½“ä¸€ä¸ª æè®®è€…ï¼ˆProposerï¼‰ æå‡ºå€¼æ—¶ï¼Œæ¥å—è€…ä¼šé€‰æ‹©ç¬¬ä¸€ä¸ªæ¥æ”¶åˆ°çš„æè®®å€¼ã€‚ç„¶è€Œï¼Œè¿™ä¸ªæ–¹æ¡ˆæœ‰æ˜æ˜¾çš„ç¼ºç‚¹ï¼šå¦‚æœæ¥å—è€…å¤±è´¥ï¼Œç³»ç»Ÿå°†æ— æ³•ç»§ç»­å‰è¿›ã€‚</p>
<h3 id="252-æ”¹è¿›æ–¹æ¡ˆå¤šä¸ªæ¥å—è€…">2.5.2 æ”¹è¿›æ–¹æ¡ˆï¼šå¤šä¸ªæ¥å—è€…</h3>
<p>ä¸ºäº†æé«˜å®¹é”™æ€§ï¼Œå¯ä»¥ä½¿ç”¨å¤šä¸ªæ¥å—è€…ã€‚æè®®è€…ä¼šå‘ä¸€ç»„æ¥å—è€…å‘é€æè®®ï¼Œæè®®å€¼ä¼šåœ¨è¶³å¤Ÿå¤šçš„æ¥å—è€…æ¥å—åè¢«è®¤ä¸ºæ˜¯â€œé€‰æ‹©çš„å€¼â€ã€‚â€œè¶³å¤Ÿå¤šâ€é€šå¸¸æ„å‘³ç€å¤šæ•°æ¥å—è€…ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªæ¥å—è€…åœ¨ä¸¤ä¸ªä¸åŒçš„å¤šæ•°é›†åˆä¸­ï¼ˆå³ä¿è¯äº¤é›†ï¼‰ï¼Œä»è€Œä¿è¯ä¸ä¼šæœ‰ä¸¤ä¸ªä¸åŒçš„å€¼è¢«åŒæ—¶é€‰ä¸­ã€‚</p>
<h3 id="253-é¿å…å†²çªå¼•å…¥æè®®ç¼–å·">2.5.3 é¿å…å†²çªï¼šå¼•å…¥æè®®ç¼–å·</h3>
<p>ä¸ºäº†é¿å…å¤šä¸ªæè®®åŒæ—¶è¢«ä¸åŒçš„æ¥å—è€…æ¥å—ï¼Œå¯¼è‡´æ²¡æœ‰å•ä¸€çš„å¤šæ•°å€¼è¢«é€‰ä¸­ï¼ŒPaxos å¼•å…¥äº† æè®®ç¼–å·ã€‚æè®®ä¸ä»…åŒ…å«ä¸€ä¸ªå€¼ï¼Œè¿˜åŒ…å«ä¸€ä¸ªå”¯ä¸€çš„ç¼–å·ã€‚ç¼–å·ç¡®ä¿æè®®çš„å…ˆåé¡ºåºï¼Œå¹¶è§„å®šè¾ƒé«˜ç¼–å·çš„æè®®å…·æœ‰ä¼˜å…ˆæƒã€‚</p>
<h3 id="254-å®‰å…¨æ€§ä¿è¯p2æ€§è´¨">2.5.4 å®‰å…¨æ€§ä¿è¯ï¼šP2æ€§è´¨</h3>
<p>ä¸ºäº†ç¡®ä¿å…±è¯†ç®—æ³•çš„å®‰å…¨æ€§ï¼Œå¿…é¡»ä¿è¯å¦‚æœä¸€ä¸ªå€¼ <code>v</code> å·²ç»è¢«é€‰ä¸­ï¼Œé‚£ä¹ˆæ‰€æœ‰ç¼–å·æ›´é«˜çš„æè®®ä¹Ÿå¿…é¡»é€‰æ‹©ç›¸åŒçš„å€¼ <code>v</code>ã€‚è¿™ä¸€ç‚¹æ˜¯é€šè¿‡â€œP2 æ€§è´¨â€æ¥ä¿è¯çš„ï¼ŒP2 ç¡®ä¿é€‰ä¸­å€¼åï¼Œåç»­çš„æè®®ä¸ä¼šè¿åå·²ç»è¾¾æˆçš„å…±è¯†ã€‚</p>
<h3 id="255-p2-æ€§è´¨çš„æ¨å¯¼å’Œæ‰©å±•">2.5.5 P2 æ€§è´¨çš„æ¨å¯¼å’Œæ‰©å±•</h3>
<p>ä¸ºäº†å®ç° <a href="#27-p2">P2</a>ï¼Œç³»ç»Ÿéœ€è¦æ»¡è¶³ä»¥ä¸‹çº¦æŸï¼š<code>å½“æè®®è€…å‘é€æ–°çš„æè®®æ—¶ï¼Œå®ƒå¿…é¡»å…ˆç¡®ä¿æ²¡æœ‰è¾ƒé«˜ç¼–å·çš„æè®®å·²ç»è¢«æ¥å—ã€‚</code>è¿™æ˜¯é€šè¿‡å‘é€ å‡†å¤‡è¯·æ±‚ï¼ˆprepare requestï¼‰ æ¥å®ç°çš„ï¼Œæè®®è€…è¦æ±‚æ¥å—è€…æ‰¿è¯ºä¸å†æ¥å—ä»»ä½•æ¯”å½“å‰æè®®ç¼–å·æ›´ä½çš„æè®®ï¼Œå¹¶æŠ¥å‘Šå…¶å·²æ¥å—çš„æœ€é«˜ç¼–å·æè®®ã€‚åŸºäºè¿™äº›ä¿¡æ¯ï¼Œæè®®è€…å¯ä»¥ç¡®ä¿æ–°æè®®ç¬¦åˆ P2 æ€§è´¨ã€‚</p>
<h3 id="256-ç®—æ³•ä¸¤ä¸ªé˜¶æ®µ">2.5.6 ç®—æ³•ä¸¤ä¸ªé˜¶æ®µ</h3>
<p>ç¬¬ä¸€é˜¶æ®µï¼š<br>
æè®®è€…é€‰æ‹©ä¸€ä¸ªæè®®ç¼–å·ï¼Œå¹¶å‘å¤šæ•°æ¥å—è€…å‘é€å‡†å¤‡è¯·æ±‚ï¼Œè¦æ±‚æ¥å—è€…æ‰¿è¯ºä¸å†æ¥å—ä»»ä½•æ¯”è¯¥ç¼–å·ä½çš„æè®®ï¼Œå¹¶è¿”å›å·²æ¥å—çš„æœ€é«˜ç¼–å·æè®®ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚<br>
ç¬¬äºŒé˜¶æ®µï¼š<br>
å¦‚æœæè®®è€…ä»å¤šæ•°æ¥å—è€…é‚£é‡Œå¾—åˆ°äº†å“åº”ï¼Œå®ƒä¼šé€‰æ‹©ä¸€ä¸ªå€¼ï¼Œå¹¶å‘æ¥å—è€…å‘é€ æ¥å—è¯·æ±‚ï¼ˆaccept requestï¼‰ï¼Œè¦æ±‚æ¥å—è€…æ¥å—è¿™ä¸ªç¼–å·çš„æè®®ã€‚å¦‚æœæè®®ç¬¦åˆæ¡ä»¶ï¼Œæ¥å—è€…ä¼šæ¥å—è¯¥æè®®ã€‚</p>
<h3 id="257-æè®®æ”¾å¼ƒä¸ä¼˜åŒ–">2.5.7 æè®®æ”¾å¼ƒä¸ä¼˜åŒ–</h3>
<p>æè®®è€…å¯ä»¥åœ¨ä»»æ„æ—¶é—´æ”¾å¼ƒæè®®ï¼Œå¹¶ä¸”ç®—æ³•å…è®¸æ¥å—è€…å¿½ç•¥å·²ç»è¿‡æ—¶çš„å‡†å¤‡è¯·æ±‚æˆ–æ¥å—è¯·æ±‚ã€‚å¦‚æœæ¥å—è€…å‘ç°è‡ªå·±å·²ç»å“åº”äº†æ›´é«˜ç¼–å·çš„æè®®ï¼Œåˆ™ä¼šå¿½ç•¥è¾ƒä½ç¼–å·çš„æè®®ã€‚æè®®è€…ä¹Ÿå¯ä»¥åœ¨å‘ç°æœ‰æ›´é«˜ç¼–å·çš„æè®®æ­£åœ¨è¿›è¡Œæ—¶æ”¾å¼ƒå½“å‰æè®®ï¼Œä»¥æé«˜ç®—æ³•æ•ˆç‡ã€‚</p>
<h3 id="258-æ•°æ®æŒä¹…æ€§å’Œå®¹é”™">2.5.8 æ•°æ®æŒä¹…æ€§å’Œå®¹é”™</h3>
<p>ä¸ºäº†åº”å¯¹èŠ‚ç‚¹å´©æºƒæˆ–é‡å¯ï¼ŒPaxos è¦æ±‚æ¯ä¸ªæ¥å—è€…è®°ä½å®ƒæ›¾ç»å“åº”è¿‡çš„æœ€é«˜ç¼–å·æè®®å’Œæ¥å—è¿‡çš„æœ€é«˜ç¼–å·æè®®ã€‚è¿™æ ·ï¼Œå³ä½¿æ¥å—è€…é‡æ–°å¯åŠ¨ï¼Œç®—æ³•çš„å®‰å…¨æ€§ä¾ç„¶èƒ½å¤Ÿå¾—åˆ°ä¿è¯ã€‚</p>
<h2 id="26-å­¦ä¹ è€…learner-å¦‚ä½•å¾—çŸ¥æŸä¸ªå€¼å·²ç»è¢«é€‰æ‹©">2.6 å­¦ä¹ è€…ï¼ˆLearnerï¼‰ å¦‚ä½•å¾—çŸ¥æŸä¸ªå€¼å·²ç»è¢«é€‰æ‹©</h2>
<p>æ ¸å¿ƒé—®é¢˜æ˜¯å­¦ä¹ è€…å¦‚ä½•ä» æ¥å—è€…ï¼ˆAcceptorï¼‰ é‚£é‡Œè·æ‚‰è¢«é€‰ä¸­çš„æè®®ï¼ˆå³è¢«é€‰ä¸­çš„å€¼ï¼‰ã€‚æœ‰å‡ ç§æ–¹æ³•å¯ä»¥å®ç°è¿™ä¸€ç‚¹ï¼Œåˆ†åˆ«åœ¨å¯é æ€§å’Œé€šä¿¡å¼€é”€ä¹‹é—´åšå‡ºäº†æƒè¡¡ã€‚</p>
<h3 id="261-ç®€å•ç®—æ³•æ¯ä¸ªæ¥å—è€…é€šçŸ¥æ‰€æœ‰å­¦ä¹ è€…">2.6.1 ç®€å•ç®—æ³•ï¼šæ¯ä¸ªæ¥å—è€…é€šçŸ¥æ‰€æœ‰å­¦ä¹ è€…</h3>
<p>æ¯å½“ä¸€ä¸ªæ¥å—è€…æ¥å—äº†ä¸€ä¸ªæè®®ï¼Œå®ƒå°±é€šçŸ¥æ‰€æœ‰çš„å­¦ä¹ è€…è¯¥æè®®çš„ä¿¡æ¯ã€‚è¿™ç§æ–¹å¼å¯ä»¥è®©å­¦ä¹ è€…å°½æ—©çŸ¥é“è¢«é€‰ä¸­çš„å€¼ï¼Œä½†å®ƒçš„ä»£ä»·æ˜¯é€šä¿¡å¼€é”€éå¸¸å¤§ã€‚æ¥å—è€…å¿…é¡»ç»™æ¯ä¸ªå­¦ä¹ è€…å‘é€æ¶ˆæ¯ï¼Œæ¶ˆæ¯çš„æ€»æ•°ä¸º æ¥å—è€…æ•°é‡ ä¸ å­¦ä¹ è€…æ•°é‡ çš„ä¹˜ç§¯ã€‚è¿™åœ¨è§„æ¨¡è¾ƒå¤§çš„ç³»ç»Ÿä¸­é€šä¿¡å¼€é”€ä¼šéå¸¸é«˜ã€‚</p>
<h3 id="262-ä¼˜åŒ–æ–¹æ³•å¼•å…¥ç‰¹å®šå­¦ä¹ è€…">2.6.2 ä¼˜åŒ–æ–¹æ³•ï¼šå¼•å…¥â€œç‰¹å®šå­¦ä¹ è€…â€</h3>
<p>ä¸ºäº†é™ä½é€šä¿¡å¼€é”€ï¼Œå¯ä»¥å¼•å…¥ä¸€ä¸ªâ€œç‰¹å®šå­¦ä¹ è€…ï¼ˆdistinguished learnerï¼‰â€ï¼Œæ‰€æœ‰æ¥å—è€…åœ¨æ¥å—æè®®ååªé€šçŸ¥è¿™ä¸ªç‰¹å®šçš„å­¦ä¹ è€…ã€‚ç„¶åï¼Œç‰¹å®šå­¦ä¹ è€…å°†è¢«é€‰ä¸­çš„å€¼é€šçŸ¥ç»™å…¶ä»–å­¦ä¹ è€…ã€‚è¿™ç§æ–¹æ³•å‡å°‘äº†é€šä¿¡é‡ï¼Œæ¶ˆæ¯æ€»æ•°åªç­‰äº æ¥å—è€…æ•°é‡ å’Œ å­¦ä¹ è€…æ•°é‡ çš„æ€»å’Œã€‚ç„¶è€Œï¼Œè¿™ç§æ–¹æ³•å¢åŠ äº†å¯é æ€§é£é™©â€”â€”å¦‚æœç‰¹å®šå­¦ä¹ è€…å‡ºç°æ•…éšœï¼Œç³»ç»Ÿå°±æ— æ³•ç»§ç»­å·¥ä½œã€‚</p>
<h3 id="263-æ”¹è¿›æ–¹æ³•ä½¿ç”¨å¤šä¸ªç‰¹å®šå­¦ä¹ è€…">2.6.3 æ”¹è¿›æ–¹æ³•ï¼šä½¿ç”¨å¤šä¸ªç‰¹å®šå­¦ä¹ è€…</h3>
<p>ä¸ºäº†æé«˜ç³»ç»Ÿçš„å¯é æ€§ï¼Œå¯ä»¥ä½¿ç”¨å¤šä¸ªç‰¹å®šå­¦ä¹ è€…ã€‚æ¯ä¸ªæ¥å—è€…å‘è¿™äº›ç‰¹å®šå­¦ä¹ è€…å‘é€ä¿¡æ¯ï¼Œç„¶åè¿™äº›ç‰¹å®šå­¦ä¹ è€…å°†å€¼å¹¿æ’­ç»™å…¶ä»–å­¦ä¹ è€…ã€‚è¿™ç§æ–¹æ³•åœ¨ä¿æŒé€šä¿¡å¼€é”€ç›¸å¯¹è¾ƒä½çš„åŒæ—¶æé«˜äº†ç³»ç»Ÿçš„å®¹é”™æ€§ï¼Œå› ä¸ºå³ä½¿ä¸€ä¸ªç‰¹å®šå­¦ä¹ è€…å¤±è´¥ï¼Œå…¶ä»–ç‰¹å®šå­¦ä¹ è€…ä»ç„¶å¯ä»¥é€šçŸ¥å­¦ä¹ è€…è¢«é€‰ä¸­çš„å€¼ã€‚ä¸è¿‡ï¼Œå¢åŠ ç‰¹å®šå­¦ä¹ è€…çš„æ•°é‡ä¹Ÿä¼šæé«˜é€šä¿¡å¤æ‚åº¦ã€‚</p>
<h3 id="264-æ¶ˆæ¯ä¸¢å¤±çš„å¤„ç†">2.6.4 æ¶ˆæ¯ä¸¢å¤±çš„å¤„ç†</h3>
<p>ç”±äº Paxos æ˜¯å¼‚æ­¥ç³»ç»Ÿï¼Œæ¶ˆæ¯å¯èƒ½ä¸¢å¤±ï¼Œå¯¼è‡´ä¸€ä¸ªå€¼å·²ç»è¢«é€‰ä¸­ä½†å­¦ä¹ è€…å´ä¸çŸ¥é“ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå­¦ä¹ è€…å¯ä»¥å‘æ¥å—è€…è¯¢é—®ä»–ä»¬æ¥å—çš„æè®®ã€‚ä½†å¦‚æœæ¥å—è€…å‡ºç°æ•…éšœï¼Œå­¦ä¹ è€…å¯èƒ½æ— æ³•å¾—çŸ¥å¤šæ•°æ¥å—è€…æ˜¯å¦æ¥å—äº†æŸä¸ªæè®®ã€‚</p>
<h3 id="265-æè®®è€…çš„ä½œç”¨">2.6.5 æè®®è€…çš„ä½œç”¨</h3>
<p>å¦‚æœå­¦ä¹ è€…éœ€è¦ç¡®åˆ‡åœ°çŸ¥é“æ˜¯å¦æœ‰å€¼è¢«é€‰ä¸­ï¼Œå®ƒå¯ä»¥è¦æ±‚æè®®è€…å‘èµ·ä¸€ä¸ªæ–°çš„æè®®ã€‚è¿™æ ·ï¼Œå³ä½¿å½“å‰æ²¡æœ‰å­¦ä¹ åˆ°é€‰å®šå€¼ï¼Œé€šè¿‡å‘èµ·æ–°çš„æè®®ï¼Œå­¦ä¹ è€…æœ€ç»ˆä¹Ÿèƒ½é€šè¿‡æ–°çš„æè®®å¾—çŸ¥ç³»ç»Ÿçš„å…±è¯†ã€‚</p>
<h2 id="27-p2">2.7 P2</h2>
<p>åœ¨ Paxos ç®—æ³•ä¸­ï¼ŒP2 æ€§è´¨ æ˜¯ä¿è¯ç®—æ³•å®‰å…¨æ€§çš„é‡è¦æ¡ä»¶ã€‚P2 æ€§è´¨çš„ç›®çš„æ˜¯ç¡®ä¿ä¸€æ—¦æŸä¸ªå€¼ <code>v</code> è¢«é€‰ä¸­åï¼Œæ‰€æœ‰å°†æ¥è¢«é€‰ä¸­çš„æè®®ï¼ˆæ— è®ºæè®®çš„ç¼–å·å¦‚ä½•ï¼‰éƒ½å¿…é¡»å…·æœ‰ç›¸åŒçš„å€¼ <code>v</code>ï¼Œä»è€Œé¿å…ç³»ç»Ÿé€‰å‡ºå¤šä¸ªä¸åŒçš„å€¼ã€‚</p>
<p>P2 æ€§è´¨ è§„å®šï¼šå¦‚æœä¸€ä¸ªç¼–å·ä¸º <code>m</code> çš„æè®®çš„å€¼ <code>v</code> è¢«é€‰ä¸­ï¼Œé‚£ä¹ˆæ‰€æœ‰ç¼–å·å¤§äº<code>m</code>çš„æè®®å¦‚æœè¢«é€‰ä¸­ï¼Œå®ƒä»¬çš„å€¼ä¹Ÿå¿…é¡»æ˜¯<code> v</code>ã€‚</p>
<p>è¿™ä¸€æ€§è´¨å¯ä»¥ä¿è¯ Paxos ç®—æ³•çš„å®‰å…¨æ€§ï¼Œå³ä½¿æœ‰å¤šä¸ªæè®®è€…å¹¶è¡Œå‘èµ·ä¸åŒçš„æè®®ï¼Œæœ€ç»ˆé€‰ä¸­çš„å€¼ä¹Ÿä¸ä¼šå‡ºç°å†²çªã€‚</p>
<h3 id="271-p2-æ€§è´¨çš„æ„ä¹‰">2.7.1 P2 æ€§è´¨çš„æ„ä¹‰</h3>
<p>é€šè¿‡ P2 æ€§è´¨çš„çº¦æŸï¼Œå¯ä»¥ç¡®ä¿ï¼š</p>
<pre tabindex="0"><code>ä¸€æ—¦æŸä¸ªå€¼è¢«å¤šæ•°æ¥å—è€…æ¥å—ï¼Œé‚£ä¹ˆæ‰€æœ‰åç»­çš„æè®®å¿…é¡»é€‰æ‹©åŒä¸€ä¸ªå€¼ã€‚
ä¸ä¼šæœ‰ä¸¤ä¸ªä¸åŒçš„å€¼è¢«ä¸åŒçš„æè®®è€…é€‰ä¸­ã€‚
</code></pre><h3 id="272-p2-æ€§è´¨çš„å®ç°">2.7.2 P2 æ€§è´¨çš„å®ç°</h3>
<pre tabindex="0"><code>åœ¨å‘å‡ºæè®®ä¹‹å‰ï¼Œæè®®è€…ï¼ˆProposerï¼‰ éœ€è¦å‘å¤šæ•°æ¥å—è€…ï¼ˆAcceptorï¼‰å‘é€ä¸€ä¸ª å‡†å¤‡è¯·æ±‚ï¼ˆprepare requestï¼‰ï¼Œè¯¢é—®ä»–ä»¬å·²ç»æ¥å—çš„æœ€é«˜ç¼–å·çš„æè®®ã€‚
å¦‚æœæœ‰æ¥å—è€…å·²ç»æ¥å—äº†æŸä¸ªç¼–å·è¾ƒå°çš„æè®®ï¼ˆä¾‹å¦‚ï¼Œç¼–å· m çš„æè®®ï¼‰ï¼Œé‚£ä¹ˆæè®®è€…åœ¨å‘å‡ºæ–°çš„æè®®æ—¶ï¼Œå¿…é¡»ä½¿ç”¨å·²ç»è¢«æ¥å—çš„ç¼–å· m å¯¹åº”çš„å€¼ï¼Œè€Œä¸èƒ½æå‡ºæ–°çš„å€¼ã€‚
å¦‚æœæ²¡æœ‰ä»»ä½•æ¥å—è€…æ¥å—è¿‡ç¼–å·å°äºå½“å‰æè®®ç¼–å·çš„æè®®ï¼Œé‚£ä¹ˆæè®®è€…å¯ä»¥è‡ªç”±é€‰æ‹©ä¸€ä¸ªæ–°çš„å€¼ã€‚
</code></pre><h2 id="28-paxos-ç®—æ³•-ä¸­å¦‚ä½•ç¡®ä¿-è¿›å±•æ€§liveness">2.8 Paxos ç®—æ³• ä¸­å¦‚ä½•ç¡®ä¿ è¿›å±•æ€§ï¼ˆlivenessï¼‰</h2>
<p>åœ¨ Paxos ç®—æ³•ä¸­ï¼Œå¦‚æœå­˜åœ¨å¤šä¸ªæè®®è€…ï¼ˆproposerï¼‰ï¼Œè¿™äº›æè®®è€…å¯èƒ½ä¼šåŒæ—¶å‘èµ·ä¸åŒç¼–å·çš„æè®®ã€‚è¿™æ ·å¯èƒ½å¯¼è‡´ä¸€ä¸ª æ´»é” åœºæ™¯ï¼šä¸¤ä¸ªæè®®è€…ä¸æ–­åœ°å¢åŠ æè®®ç¼–å·ï¼Œä½†æ²¡æœ‰ä»»ä½•ä¸€ä¸ªæè®®èƒ½è¢«æœ€ç»ˆé€‰ä¸­ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>æè®®è€… p å®Œæˆäº†ç¼–å·ä¸º n1 çš„ç¬¬ä¸€é˜¶æ®µï¼ˆPhase 1ï¼‰ã€‚</li>
<li>æè®®è€… q ç„¶åå®Œæˆäº†ç¼–å·ä¸º n2 &gt; n1 çš„ç¬¬ä¸€é˜¶æ®µï¼Œæ‰€æœ‰æ¥å—è€…ï¼ˆacceptorï¼‰ç°åœ¨éƒ½æ‰¿è¯ºä¸å†æ¥å—ä»»ä½•ç¼–å·å°äº n2 çš„æè®®ã€‚</li>
<li>å½“æè®®è€… p è¿›å…¥ç¬¬äºŒé˜¶æ®µå¹¶å‘é€ç¼–å·ä¸º n1 çš„æ¥å—è¯·æ±‚æ—¶ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½è¢«å¿½ç•¥ï¼Œå› ä¸ºæ¥å—è€…å·²ç»æ‰¿è¯ºæ¥å— n2 åŠæ›´å¤§çš„æè®®ã€‚</li>
<li>æè®®è€… p é‡æ–°å¼€å§‹ï¼Œå¹¶å®Œæˆäº†ç¼–å·ä¸º n3 &gt; n2 çš„æ–°ä¸€è½®æè®®ï¼Œå¯¼è‡´æè®®è€… q çš„ç¼–å·ä¸º n2 çš„ç¬¬äºŒé˜¶æ®µè¯·æ±‚è¢«å¿½ç•¥ã€‚</li>
</ol>
<h3 id="281-è§£å†³æ–¹æ¡ˆ">2.8.1 è§£å†³æ–¹æ¡ˆ</h3>
<p>ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒPaxos ç®—æ³•éœ€è¦é€‰å‡ºä¸€ä¸ª ç‰¹å®šæè®®è€…ï¼ˆdistinguished proposerï¼‰ï¼Œå³åœ¨ç‰¹å®šæ—¶åˆ»åªæœ‰ä¸€ä¸ªæè®®è€…èƒ½å¤Ÿå‘èµ·æè®®ã€‚<br>
å…³é”®ç‚¹ï¼š</p>
<pre tabindex="0"><code>å¦‚æœè¿™ä¸ªç‰¹å®šæè®®è€…å¯ä»¥ä¸å¤šæ•°æ¥å—è€…æˆåŠŸé€šä¿¡ï¼Œå¹¶ä¸”ä½¿ç”¨ä¸€ä¸ªå¤§äºä»»ä½•å·²ä½¿ç”¨æè®®ç¼–å·çš„æ–°ç¼–å·ï¼Œé‚£ä¹ˆå®ƒçš„æè®®å°†ä¼šæˆåŠŸè¢«æ¥å—ã€‚
å¦‚æœæè®®è€…å¾—çŸ¥æœ‰ç¼–å·æ›´é«˜çš„æè®®ï¼Œå®ƒä¼šæ”¾å¼ƒå½“å‰çš„æè®®ï¼Œé‡æ–°å‘èµ·ç¼–å·æ›´é«˜çš„æè®®ï¼Œç›´åˆ°æˆåŠŸã€‚
</code></pre><p>è¿›å±•æ€§ä¾èµ–äºç³»ç»Ÿä¸­ä»¥ä¸‹æ¡ä»¶çš„æ­£å¸¸å·¥ä½œï¼š</p>
<pre tabindex="0"><code>æè®®è€…ï¼šéœ€è¦æœ‰ä¸€ä¸ªè¢«é€‰ä¸­çš„æè®®è€…æ¥ä¸»å¯¼æè®®è¿‡ç¨‹ã€‚
æ¥å—è€…ï¼šæ¥å—è€…å¿…é¡»èƒ½å¤Ÿä¸ç‰¹å®šæè®®è€…æ­£å¸¸é€šä¿¡ã€‚
ç½‘ç»œé€šä¿¡ï¼šé€šä¿¡ç½‘ç»œä¸èƒ½å®Œå…¨å¤±æ•ˆï¼Œæ¶ˆæ¯å¿…é¡»èƒ½å¤Ÿåœ¨ä¸€å®šæ—¶é—´å†…ä¼ é€’ã€‚
</code></pre><p>ä¸ºäº†é€‰å‡ºä¸€ä¸ªâ€œç‰¹å®šæè®®è€…â€ï¼Œç³»ç»Ÿå¯èƒ½éœ€è¦ä½¿ç”¨éšæœºæ€§æˆ–åŸºäºçœŸå®æ—¶é—´çš„æœºåˆ¶ï¼Œæ¯”å¦‚ä½¿ç”¨ è¶…æ—¶ï¼ˆtimeoutï¼‰ æœºåˆ¶æ¥å†³å®šå“ªä¸ªæè®®è€…èƒ½å¤Ÿä¸»å¯¼æè®®è¿‡ç¨‹ã€‚</p>
<h2 id="29-paxos-ç®—æ³•-çš„å®ç°">2.9 Paxos ç®—æ³• çš„å®ç°</h2>
<h3 id="291-åŸºæœ¬ç½‘ç»œæ¨¡å‹">2.9.1 åŸºæœ¬ç½‘ç»œæ¨¡å‹</h3>
<p>Paxos ç®—æ³•å‡è®¾åœ¨ä¸€ä¸ª åˆ†å¸ƒå¼ç½‘ç»œ ä¸­æœ‰å¤šä¸ªè¿›ç¨‹ã€‚æ¯ä¸ªè¿›ç¨‹åœ¨ Paxos ä¸­å¯ä»¥æ‰®æ¼”å¤šä¸ªè§’è‰²ï¼ŒåŒ…æ‹¬ï¼šæè®®è€…ã€æ¥å—è€…ã€å­¦ä¹ è€…ã€‚<br>
åœ¨å®ç°ä¸­ï¼ŒPaxos é€šè¿‡ä¸€ä¸ªè¢«é€‰å‡ºçš„ é¢†å¯¼è€…ï¼ˆLeaderï¼‰ æ¥æ‰®æ¼”å…³é”®è§’è‰²ã€‚é¢†å¯¼è€…ä¸ä»…æ˜¯ ç‰¹å®šæè®®è€…ï¼ˆdistinguished proposerï¼‰ï¼Œè¿˜è´Ÿè´£æ‰®æ¼” ç‰¹å®šå­¦ä¹ è€…ï¼ˆdistinguished learnerï¼‰ çš„è§’è‰²ã€‚</p>
<h3 id="292-æ¶ˆæ¯é€šä¿¡æœºåˆ¶">2.9.2 æ¶ˆæ¯é€šä¿¡æœºåˆ¶</h3>
<p>Paxos ç®—æ³•çš„é€šä¿¡åŸºäºæ™®é€šçš„æ¶ˆæ¯ä¼ é€’ã€‚åœ¨å®é™…å®ç°ä¸­ï¼Œæè®®è€…ã€æ¥å—è€…ã€å­¦ä¹ è€…ä¹‹é—´é€šè¿‡å‘é€å’Œæ¥æ”¶æ¶ˆæ¯è¿›è¡Œäº¤äº’ï¼š<br>
æ¯æ¡æ¶ˆæ¯éƒ½ä¼šé™„å¸¦ç›¸åº”çš„ æè®®ç¼–å·ï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢ä¸åŒæè®®è€…çš„æ¶ˆæ¯è¢«æ··æ·†ï¼Œç¡®ä¿æè®®ç¼–å·çš„å”¯ä¸€æ€§å’Œé¡ºåºæ€§ã€‚</p>
<h3 id="293-ç¨³å®šå­˜å‚¨çš„ä½¿ç”¨">2.9.3 ç¨³å®šå­˜å‚¨çš„ä½¿ç”¨</h3>
<p>ç¨³å®šå­˜å‚¨ï¼ˆStable storageï¼‰ æ˜¯ Paxos ç®—æ³•çš„å…³é”®éƒ¨åˆ†ä¹‹ä¸€ï¼Œä¿è¯äº†åœ¨ç³»ç»Ÿå‘ç”Ÿæ•…éšœæˆ–èŠ‚ç‚¹é‡å¯çš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¾ç„¶å¯ä»¥æ¢å¤ä¹‹å‰çš„çŠ¶æ€ï¼š <br>
æ¯ä¸ªæ¥å—è€…åœ¨å‘é€å“åº”æ¶ˆæ¯ä¹‹å‰ï¼Œä¼šå°†å…¶æ‰“ç®—å‘é€çš„å“åº”ä¿¡æ¯è®°å½•åœ¨ç¨³å®šå­˜å‚¨ä¸­ã€‚è¿™æ ·å³ä½¿ç³»ç»Ÿå‘ç”Ÿæ•…éšœï¼Œé‡å¯åæ¥å—è€…å¯ä»¥æ¢å¤å¹¶ç»§ç»­å·¥ä½œï¼Œä¸ä¼šä¸¢å¤±å·²ç»æ¥å—çš„æè®®ä¿¡æ¯ã€‚</p>
<h3 id="294-æè®®ç¼–å·çš„å”¯ä¸€æ€§">2.9.4 æè®®ç¼–å·çš„å”¯ä¸€æ€§</h3>
<p>Paxos é€šè¿‡ å”¯ä¸€ç¼–å·çš„æè®® æ¥é¿å…å†²çªï¼Œå³æ¯ä¸ªæè®®å¿…é¡»æœ‰ä¸€ä¸ªå”¯ä¸€çš„ç¼–å·ï¼Œä¸èƒ½å‡ºç°ä¸¤ä¸ªæè®®è€…å‘å‡ºç›¸åŒç¼–å·çš„æè®®ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼š<br>
ä¸åŒçš„æè®®è€…é€‰æ‹©æè®®ç¼–å·æ—¶ï¼Œä½¿ç”¨ ä¸åŒçš„ç¼–å·é›†åˆï¼Œç¡®ä¿æ¯ä¸ªæè®®è€…çš„æè®®ç¼–å·ä¸é‡å ã€‚ä¾‹å¦‚ï¼Œæè®®è€… A å¯èƒ½ä»ç¼–å·é›†åˆ <code>{1, 4, 7, 10...}</code> é€‰æ‹©ï¼Œè€Œæè®®è€… B åˆ™ä»é›†åˆ<code>{2, 5, 8, 11...}</code>ä¸­é€‰æ‹©ã€‚<br>
æ¯ä¸ªæè®®è€…ä¼šåœ¨ç¨³å®šå­˜å‚¨ä¸­è®°å½•å…¶æ›¾ç»å°è¯•å‘å‡ºçš„ æœ€é«˜ç¼–å·æè®®ã€‚åœ¨å¼€å§‹æ–°çš„æè®®æ—¶ï¼Œæè®®è€…ä¼šé€‰æ‹©ä¸€ä¸ªæ¯”ä¹‹å‰ç¼–å·æ›´å¤§çš„ç¼–å·ï¼Œä»è€Œé¿å…é‡å¤ç¼–å·ã€‚</p>
<h3 id="295-é˜¶æ®µ-1-çš„å¯åŠ¨">2.9.5 é˜¶æ®µ 1 çš„å¯åŠ¨</h3>
<p>åœ¨ Paxos çš„ é˜¶æ®µ 1ä¸­ï¼Œæè®®è€…å‘å‡ºå‡†å¤‡è¯·æ±‚ï¼ˆprepare requestï¼‰ä»¥è·å–å¤šæ•°æ¥å—è€…çš„æ‰¿è¯ºã€‚æè®®è€…ä¼šä½¿ç”¨æ¯”ä¹‹å‰å°è¯•çš„æè®®ç¼–å·æ›´å¤§çš„ç¼–å·æ¥å¯åŠ¨è¿™ä¸ªé˜¶æ®µï¼Œç¡®ä¿æè®®çš„ç¼–å·æ˜¯å”¯ä¸€çš„å¹¶ä¸”ä¸ä¼šä¸è¿‡å»çš„æè®®å†²çªã€‚</p>
<h1 id="3-åˆ†å¸ƒå¼çŠ¶æ€æœºdistributed-state-machine">3. åˆ†å¸ƒå¼çŠ¶æ€æœºï¼ˆdistributed state machineï¼‰</h1>
<h2 id="31-åˆ†å¸ƒå¼çŠ¶æ€æœºçš„åŸºæœ¬æ¦‚å¿µ">3.1 åˆ†å¸ƒå¼çŠ¶æ€æœºçš„åŸºæœ¬æ¦‚å¿µ</h2>
<p>ä¸€ä¸ªç®€å•çš„åˆ†å¸ƒå¼ç³»ç»Ÿå¯ä»¥è¢«çœ‹ä½œæ˜¯å¤šä¸ªå®¢æˆ·ç«¯å‘ä¸€ä¸ªä¸­å¤®æœåŠ¡å™¨å‘å‡ºå‘½ä»¤ï¼Œè€Œè¿™ä¸ªæœåŠ¡å™¨æ‰§è¡Œè¿™äº›å‘½ä»¤å¹¶æ›´æ–°å…¶çŠ¶æ€ã€‚æœåŠ¡å™¨å¯ä»¥è¢«æè¿°ä¸ºä¸€ä¸ª ç¡®å®šæ€§çŠ¶æ€æœºï¼ˆdeterministic state machineï¼‰ï¼š</p>
<pre tabindex="0"><code>çŠ¶æ€æœºå…·æœ‰å½“å‰çš„çŠ¶æ€ï¼Œé€šè¿‡æ‰§è¡Œå‘½ä»¤ç”Ÿæˆæ–°çš„çŠ¶æ€å’Œè¾“å‡ºã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªé“¶è¡Œç³»ç»Ÿä¸­ï¼ŒçŠ¶æ€å¯ä»¥æ˜¯ç”¨æˆ·çš„è´¦æˆ·ä½™é¢ï¼Œå‘½ä»¤å¯ä»¥æ˜¯ææ¬¾æˆ–å­˜æ¬¾æ“ä½œã€‚
</code></pre><p>å¦‚æœä½¿ç”¨å•ä¸ªä¸­å¤®æœåŠ¡å™¨ï¼Œå®ƒçš„æ•…éšœå°†å¯¼è‡´æ•´ä¸ªç³»ç»Ÿå¤±æ•ˆã€‚å› æ­¤ï¼Œå®é™…å®ç°ä¸­ä½¿ç”¨å¤šä¸ªæœåŠ¡å™¨æ¥ç‹¬ç«‹åœ°å®ç°çŠ¶æ€æœºï¼Œå¹¶é€šè¿‡ Paxos ç®—æ³•ç¡®ä¿è¿™äº›æœåŠ¡å™¨éƒ½æ‰§è¡Œç›¸åŒçš„å‘½ä»¤åºåˆ—ã€‚</p>
<h2 id="32-çŠ¶æ€æœºä¸-paxos-ç®—æ³•">3.2 çŠ¶æ€æœºä¸ Paxos ç®—æ³•</h2>
<p>ä¸ºäº†ä¿è¯æ‰€æœ‰æœåŠ¡å™¨æ‰§è¡Œç›¸åŒçš„å‘½ä»¤åºåˆ—ï¼Œç³»ç»Ÿä¸ºæ¯ä¸ªçŠ¶æ€æœºå‘½ä»¤è¿è¡Œä¸€è½® Paxos ç®—æ³•çš„å®ä¾‹ã€‚ä¾‹å¦‚ï¼Œç¬¬ i ä¸ªçŠ¶æ€æœºå‘½ä»¤æ˜¯é€šè¿‡ç¬¬ i æ¬¡ Paxos å…±è¯†ç®—æ³•å®ä¾‹å†³å®šçš„ã€‚æ‰€æœ‰æœåŠ¡å™¨åœ¨ Paxos ç®—æ³•ä¸­æ‰®æ¼”æè®®è€…ã€æ¥å—è€…å’Œå­¦ä¹ è€…çš„è§’è‰²ï¼Œä¿è¯æ¯ä¸ªå‘½ä»¤éƒ½èƒ½è¢«æœ€ç»ˆç¡®å®šã€‚</p>
<h2 id="33-é¢†å¯¼è€…çš„é€‰ä¸¾å’Œå‘½ä»¤æ‰§è¡Œ">3.3 é¢†å¯¼è€…çš„é€‰ä¸¾å’Œå‘½ä»¤æ‰§è¡Œ</h2>
<p>åœ¨æ­£å¸¸æ“ä½œä¸­ï¼Œä¸€ä¸ªæœåŠ¡å™¨ä¼šè¢«é€‰ä¸º é¢†å¯¼è€…ï¼ˆleaderï¼‰ï¼Œå®ƒä½œä¸ºå”¯ä¸€çš„æè®®è€…æ¥å‘å¸ƒå®¢æˆ·ç«¯çš„å‘½ä»¤ã€‚é¢†å¯¼è€…å†³å®šæ¯ä¸ªå‘½ä»¤åœ¨å‘½ä»¤åºåˆ—ä¸­çš„ä½ç½®ï¼Œå¹¶å°è¯•é€šè¿‡ Paxos ç®—æ³•ç¡®ä¿å‘½ä»¤è¢«é€‰ä¸­ã€‚ä¾‹å¦‚ï¼Œå¦‚æœé¢†å¯¼è€…å†³å®šæŸä¸ªå‘½ä»¤æ˜¯ç¬¬ 135 ä¸ªå‘½ä»¤ï¼Œå®ƒä¼šå°è¯•è®©è¯¥å‘½ä»¤æˆä¸ºç¬¬ 135 æ¬¡ Paxos å®ä¾‹ä¸­çš„è¢«é€‰ä¸­å€¼ã€‚</p>
<p>é¢†å¯¼è€…é€šå¸¸èƒ½æˆåŠŸï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½å¤±è´¥ï¼Œä¾‹å¦‚å…¶ä»–æœåŠ¡å™¨ä¹Ÿè®¤ä¸ºè‡ªå·±æ˜¯é¢†å¯¼è€…å¹¶è¯•å›¾ä¸ºç›¸åŒä½ç½®å‘å¸ƒä¸åŒçš„å‘½ä»¤ã€‚ç„¶è€Œï¼ŒPaxos ç®—æ³•ä¿è¯åœ¨ç›¸åŒä½ç½®ä¸Šæœ€å¤šåªæœ‰ä¸€ä¸ªå‘½ä»¤èƒ½è¢«é€‰ä¸­ã€‚</p>
<h2 id="34-paxos-çš„æ•ˆç‡">3.4 Paxos çš„æ•ˆç‡</h2>
<p>æè®®çš„å€¼ç›´åˆ° ç¬¬äºŒé˜¶æ®µæ‰è¢«ç¡®å®šã€‚åœ¨æè®®è€…å®Œæˆç¬¬ä¸€é˜¶æ®µåï¼Œæè®®è€…å¯ä»¥é€‰æ‹©æ ¹æ®å·²æœ‰çš„å€¼è¿›è¡Œæè®®ï¼Œæˆ–è€…è‡ªç”±é€‰æ‹©ä¸€ä¸ªæ–°å€¼ã€‚é¢†å¯¼è€…é€šå¸¸ä¼šåœ¨æ‰§è¡Œäº†æŸä¸ªé˜¶æ®µ 1 åå¿«é€Ÿè¿›å…¥é˜¶æ®µ 2ï¼Œç¡®ä¿å‘½ä»¤èƒ½è¢«å¿«é€Ÿç¡®å®šã€‚</p>
<h2 id="35-ç³»ç»Ÿæ•…éšœå’Œé¢†å¯¼è€…åˆ‡æ¢">3.5 ç³»ç»Ÿæ•…éšœå’Œé¢†å¯¼è€…åˆ‡æ¢</h2>
<p>å½“é¢†å¯¼è€…æ•…éšœæ—¶ï¼Œæ–°é¢†å¯¼è€…ä¼šè¢«é€‰ä¸¾å‡ºæ¥ã€‚æ–°é¢†å¯¼è€…éœ€è¦ä»ä¹‹å‰çš„ Paxos å®ä¾‹ä¸­å­¦ä¹ å·²ç»ç¡®å®šçš„å‘½ä»¤ï¼Œå¹¶ä»å°šæœªé€‰ä¸­çš„å‘½ä»¤åºåˆ—ä¸­å¼€å§‹æè®®æ–°çš„å€¼ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ–°é¢†å¯¼è€…çŸ¥é“å‘½ä»¤ 1â€“134 å’Œ 138ã€139 å·²è¢«é€‰ä¸­ï¼Œå®ƒä¼šåœ¨ 135â€“137 å’Œ 140 ä¹‹åçš„å®ä¾‹ä¸­æ‰§è¡Œç¬¬ä¸€é˜¶æ®µï¼Œä»¥ç¡®ä¿è¿™äº›ä½ç½®çš„å‘½ä»¤è¢«å¡«è¡¥ã€‚</p>
<p>åœ¨å¤„ç†å‘½ä»¤ç¼ºå£æ—¶ï¼Œé¢†å¯¼è€…å¯ä»¥é€‰æ‹©ç”¨ â€œç©ºæ“ä½œï¼ˆnoopï¼‰â€ æ¥å¡«è¡¥ï¼Œè¿™ä¸ä¼šæ”¹å˜ç³»ç»ŸçŠ¶æ€ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿ç³»ç»Ÿçš„å‘½ä»¤åºåˆ—æ²¡æœ‰ç©ºéš™ï¼Œåç»­å‘½ä»¤å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚</p>
<h2 id="36-æè®®å’Œå“åº”">3.6 æè®®å’Œå“åº”</h2>
<p>é¢†å¯¼è€…å¯ä»¥åœ¨å®ƒçš„æŸä¸ªå‘½ä»¤è¿˜æœªè¢«ç¡®è®¤é€‰ä¸­æ—¶ç»§ç»­æè®®ä¸‹ä¸€ä¸ªå‘½ä»¤ã€‚å³ä½¿æœ‰äº›æ¶ˆæ¯ä¸¢å¤±ï¼ŒPaxos ç®—æ³•ä¹Ÿèƒ½é€šè¿‡æ¶ˆæ¯é‡ä¼ æ¥ç¡®ä¿å‘½ä»¤æœ€ç»ˆè¢«é€‰ä¸­ã€‚ç„¶è€Œï¼Œå¦‚æœé¢†å¯¼è€…æ•…éšœï¼Œå¯èƒ½ä¼šç•™ä¸‹ä¸€äº›å‘½ä»¤ç¼ºå£ï¼Œæ–°é¢†å¯¼è€…ä¸Šä»»æ—¶éœ€è¦å¡«è¡¥è¿™äº›ç¼ºå£ã€‚</p>
<h2 id="37-ç³»ç»Ÿçš„æ‰©å±•æ€§å’Œé‡é…ç½®">3.7 ç³»ç»Ÿçš„æ‰©å±•æ€§å’Œé‡é…ç½®</h2>
<p>å¦‚æœç³»ç»Ÿä¸­çš„æœåŠ¡å™¨é›†åˆéœ€è¦æ”¹å˜ï¼Œå¯ä»¥å°†æœåŠ¡å™¨ä¿¡æ¯ä½œä¸ºçŠ¶æ€çš„ä¸€éƒ¨åˆ†ï¼Œé€šè¿‡çŠ¶æ€æœºå‘½ä»¤æ¥æ›´æ–°ã€‚åœ¨æ‰§è¡Œç¬¬ i ä¸ªå‘½ä»¤åï¼Œæ–°çš„æœåŠ¡å™¨é›†åˆå¯ä»¥è¢«æŒ‡å®šä¸ºå¤„ç†ç¬¬ i+Î± ä¸ªå‘½ä»¤çš„æœåŠ¡å™¨é›†åˆï¼Œè¿™ä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿçµæ´»åœ°è¿›è¡Œé‡æ–°é…ç½®ã€‚</p>

    </div>
    <a href="/posts/paxos-%E5%88%86%E5%B8%83%E5%BC%8F%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="w-100 w-30-l mb4 relative bg-white">
          <div class="w-100 mb4 nested-copy-line-height relative bg-white">
  <div class="mb3 pa4 gray overflow-hidden bg-white">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/pre-push%E6%9C%AC%E5%9C%B0%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95/" class="link black dim">
        
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <p>ç‚¹å‡»è¿”å›<a href="https://2549141519.github.io/#/toc">ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•</a></p>
<ul>
<li>ç›®å½•
{:toc}</li>
</ul>
<!-- raw HTML omitted -->
<h1 id="1-é›†æˆæµ‹è¯•">1. é›†æˆæµ‹è¯•</h1>
<p>é›†æˆæµ‹è¯•ï¼ˆIntegration Testingï¼‰æ˜¯ä¸€ç§è½¯ä»¶æµ‹è¯•æ–¹æ³•ï¼Œæ—¨åœ¨éªŒè¯ä¸åŒæ¨¡å—æˆ–ç»„ä»¶ä¹‹é—´çš„äº¤äº’æ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œã€‚é›†æˆæµ‹è¯•å…³æ³¨å¤šä¸ªæ¨¡å—æˆ–ç»„ä»¶çš„ç»„åˆå’Œå®ƒä»¬ä¹‹é—´çš„æ¥å£ã€‚</p>
<h1 id="2-æœ¬åœ°é›†æˆæµ‹è¯•">2. æœ¬åœ°é›†æˆæµ‹è¯•</h1>
<p>ä¿®æ”¹githubé¡¹ç›®å¹¶æäº¤ï¼ˆgit pushï¼‰æ—¶ï¼Œä¼šè§¦å‘pre-pushé’©å­ï¼Œåœ¨pre-pushé’©å­ä¸­ï¼Œä¼šæ‰§è¡Œé›†æˆæµ‹è¯•ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦é€šè¿‡ã€‚
æœ¬æ–‡ç¼–å†™äº†ç®€å•çš„é›†æˆæµ‹è¯•ï¼Œåœ¨é¡¹ç›®æäº¤æ—¶ï¼Œé›†æˆæµ‹è¯•ä¼šåˆ¤æ–­æ˜¯å¦ç¼–è¯‘æˆåŠŸï¼ˆc++ï¼‰ï¼Œè‹¥ä¸æˆåŠŸåˆ™æç¤ºç¼–è¯‘å¤±è´¥ï¼Œå¹¶é˜»æ­¢æäº¤ã€‚
æœªä¿®æ”¹pre-pushé’©å­æ—¶ï¼Œé»˜è®¤å°†ä¸ä¼šæ‰§è¡Œé›†æˆæµ‹è¯•ï¼š<br>
<img src="../blogImg/IntegrationTesting2.PNG" alt="Alt text"></p>
<h1 id="3-pre-pushé›†æˆæµ‹è¯•çš„å®ç°">3. pre-pushé›†æˆæµ‹è¯•çš„å®ç°</h1>
<h2 id="31-ç¼–å†™cæ–‡ä»¶ç”¨äºæµ‹è¯•é›†æˆæµ‹è¯•æ˜¯å¦æˆåŠŸ">3.1 ç¼–å†™c++æ–‡ä»¶ï¼Œç”¨äºæµ‹è¯•é›†æˆæµ‹è¯•æ˜¯å¦æˆåŠŸ</h2>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>#include <!-- raw HTML omitted --><br>
int main() {<br>
int n = 0;<br>
std::cout &laquo; n &laquo; std::endl;<br>
return 0;<br>
}</p></blockquote>
<h2 id="32-ç¼–å†™pre-pushé’©å­è„šæœ¬ç”¨äºæ‰§è¡Œç¼–è¯‘æµ‹è¯•">3.2 ç¼–å†™pre-pushé’©å­è„šæœ¬ï¼Œç”¨äºæ‰§è¡Œç¼–è¯‘æµ‹è¯•</h2>
<p><img src="../blogImg/IntegrationTesting4.PNG" alt="Alt text"></p>
<p>åœ¨é¡¹ç›®æ ¹ç›®å½•çš„.git/hooksä¸­æ–°å»ºpre-pushæ–‡ä»¶:</p>
<pre tabindex="0"><code>remote=&#34;$1&#34;
url=&#34;$2&#34;
# Step 1: ç¼–è¯‘ C++ ä»£ç 
echo &#34;Compiling C++ code...&#34;
g++ -o main main.cpp
if [ $? -ne 0 ]; then
    echo &#34;Compilation failed. Aborting push.&#34;
    exit 1
fi
echo &#34;Compilation succeeded. Proceeding to check commits...&#34;
# Step 2: æ£€æŸ¥æäº¤ä¿¡æ¯ä¸­æ˜¯å¦åŒ…å« &#34;WIP&#34;
# è®¡ç®—ç©ºå†…å®¹çš„å“ˆå¸Œå€¼ï¼ˆç”¨äºæ£€æŸ¥æ˜¯å¦æ˜¯åˆ é™¤æ“ä½œï¼‰
zero=$(git hash-object --stdin &lt;/dev/null | tr &#39;[0-9a-f]&#39; &#39;0&#39;)
# è¯»å– git push æä¾›çš„æœ¬åœ°å’Œè¿œç¨‹å¼•ç”¨
while read local_ref local_oid remote_ref remote_oid
do
        if test &#34;$local_oid&#34; = &#34;$zero&#34;
        then
                # Handle delete
                :
        else
                if test &#34;$remote_oid&#34; = &#34;$zero&#34;
                then
                        # New branch, examine all commits
                        range=&#34;$local_oid&#34;
                else
                        # Update to existing branch, examine new commits
                        range=&#34;$remote_oid..$local_oid&#34;
                fi
                # Check for WIP commit
                commit=$(git rev-list -n 1 --grep &#39;^WIP&#39; &#34;$range&#34;)
                if test -n &#34;$commit&#34;
                then
                        echo &gt;&amp;2 &#34;Found WIP commit in $local_ref, not pushing&#34;
                        exit 1
                fi
        fi
done
exit 0
</code></pre><p>ç¼–å†™å®Œæˆåæ‰§è¡Œå‘½ä»¤<code>chmod +x pre-push</code>ï¼Œä½¿æ–‡ä»¶å…·æœ‰å¯æ‰§è¡Œæƒé™ã€‚</p>
<h2 id="33-æµ‹è¯•">3.3 æµ‹è¯•</h2>
<p>æµ‹è¯•æ—¶ï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤<code>git push origin main</code>ï¼Œè‹¥ç¼–è¯‘æˆåŠŸï¼Œåˆ™æç¤ºæ¨é€æˆåŠŸï¼Œè‹¥ç¼–è¯‘å¤±è´¥ï¼Œåˆ™æç¤ºç¼–è¯‘å¤±è´¥ï¼Œå¹¶é˜»æ­¢æäº¤ã€‚<br>
æˆåŠŸæ—¶ï¼š<br>
<img src="../blogImg/IntegrationTesting3.PNG" alt=""><br>
æ­¤æ—¶ä¿®æ”¹main.cppæ–‡ä»¶ï¼Œå°†<code>int n = 0;</code>æ³¨é‡Šæ‰ï¼Œå¹¶å†æ¬¡æ‰§è¡Œ<code>git push origin main</code>ï¼Œæ­¤æ—¶ä¼šæç¤ºç¼–è¯‘å¤±è´¥ï¼Œå¹¶é˜»æ­¢æäº¤ï¼š <br>
<img src="../blogImg/IntegrationTesting1.PNG" alt=""></p>

    </div>
    <a href="/posts/pre-push%E6%9C%AC%E5%9C%B0%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
        <div class="w-100 w-30-l mb4 relative bg-white">
          <div class="w-100 mb4 nested-copy-line-height relative bg-white">
  <div class="mb3 pa4 gray overflow-hidden bg-white">
    <span class="f6 db">Posts</span>
    <h1 class="f3 near-black">
      <a href="/posts/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" class="link black dim">
        
      </a>
    </h1>
    <div class="nested-links f5 lh-copy nested-copy-line-height">
      <p>ç‚¹å‡»è¿”å›<a href="https://2549141519.github.io/#/toc">ğŸ”—æˆ‘çš„åšå®¢æ–‡ç« ç›®å½•</a></p>
<ul>
<li>ç›®å½•
{:toc}</li>
</ul>
<!-- raw HTML omitted -->
<h1 id="1-è™šæ‹Ÿå†…å­˜">1. è™šæ‹Ÿå†…å­˜</h1>
<p>ç¡¬ä»¶æ”¯æŒï¼š<br>
ç°ä»£å¤„ç†å™¨é€šè¿‡å†…å­˜ç®¡ç†å•å…ƒï¼ˆMMUï¼‰æ”¯æŒè™šæ‹Ÿå†…å­˜ã€‚è™šæ‹Ÿå†…å­˜å°†ç‰©ç†å†…å­˜å’Œå­˜å‚¨è®¾å¤‡ï¼ˆå¦‚ç¡¬ç›˜ï¼‰ç»“åˆèµ·æ¥ï¼Œä½¿æ“ä½œç³»ç»Ÿå’Œç¨‹åºå¯ä»¥ä½¿ç”¨æ¯”ç‰©ç†å†…å­˜æ›´å¤šçš„ç©ºé—´ã€‚å¤„ç†å™¨ä¸­çš„MMUè´Ÿè´£å°†è¿›ç¨‹è®¿é—®çš„è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€ã€‚</p>
<p>æ“ä½œç³»ç»Ÿæœºåˆ¶ï¼š<br>
æ“ä½œç³»ç»Ÿé€šè¿‡é¡µè¡¨ï¼ˆPage Tableï¼‰æ¥ç»´æŠ¤è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€çš„æ˜ å°„å…³ç³»ã€‚å½“è¿›ç¨‹è¯·æ±‚çš„è™šæ‹Ÿå†…å­˜é¡µä¸åœ¨ç‰©ç†å†…å­˜ä¸­æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šäº§ç”Ÿâ€œç¼ºé¡µä¸­æ–­â€ï¼ˆPage Faultï¼‰ï¼Œç„¶åä»ç¡¬ç›˜ä¸­åŠ è½½ç›¸åº”çš„é¡µé¢ã€‚</p>
<h1 id="2-å†…å­˜ç®¡ç†å•å…ƒmmu">2. å†…å­˜ç®¡ç†å•å…ƒï¼ˆMMUï¼‰</h1>
<p>MMUæ˜¯è®¡ç®—æœºå¤„ç†å™¨ä¸­çš„ä¸€ä¸ªç¡¬ä»¶æ¨¡å—ï¼Œå®ƒè´Ÿè´£è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢ã€‚åœ¨è®¿é—®å†…å­˜æ—¶ï¼ŒCPUé¦–å…ˆç”Ÿæˆè™šæ‹Ÿåœ°å€ï¼ŒMMUå°†å…¶è½¬æ¢ä¸ºç‰©ç†åœ°å€ï¼Œä»è€Œè®¿é—®å®é™…çš„ç‰©ç†å†…å­˜ã€‚</p>
<p>TLBï¼ˆTranslation Lookaside Bufferï¼‰ï¼š<br>
MMUä¸­è¿˜æœ‰ä¸€ç§ç¼“å­˜å«TLBï¼Œç”¨æ¥å­˜å‚¨è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„ï¼Œé¿å…æ¯æ¬¡è®¿é—®å†…å­˜éƒ½è¿›è¡Œå¤æ‚çš„é¡µè¡¨æŸ¥æ‰¾ã€‚</p>
<h1 id="3-å†…å­˜å…±äº«">3. å†…å­˜å…±äº«</h1>
<p>å¤šä¸ªè¿›ç¨‹å¯ä»¥é€šè¿‡æ“ä½œç³»ç»Ÿæä¾›çš„å…±äº«å†…å­˜æœºåˆ¶å…±äº«ç‰©ç†å†…å­˜çš„åŒä¸€éƒ¨åˆ†ã€‚å…±äº«å†…å­˜æ˜¯ä¸€ç§é«˜æ•ˆçš„è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ï¼Œé¿å…äº†æ•°æ®å¤åˆ¶ã€‚</p>
<p>æ“ä½œç³»ç»Ÿæ”¯æŒï¼š<br>
å…±äº«å†…å­˜é€šå¸¸ç”±æ“ä½œç³»ç»Ÿæä¾›çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆå¦‚<code>shmget</code>å’Œ<code>shmat</code>ï¼‰å®ç°ã€‚æ“ä½œç³»ç»Ÿå…è®¸å¤šä¸ªè¿›ç¨‹é€šè¿‡æ˜ å°„åŒä¸€æ®µç‰©ç†å†…å­˜æ¥å…±äº«æ•°æ®ã€‚</p>
<h1 id="4-å †å’Œæ ˆçš„å†…å­˜ç®¡ç†">4. å †å’Œæ ˆçš„å†…å­˜ç®¡ç†</h1>
<p>æ ˆï¼ˆStackï¼‰ï¼š<br>
æ ˆæ˜¯ä¸€ç§è¿ç»­çš„å†…å­˜åŒºåŸŸï¼Œå¸¸ç”¨äºå­˜å‚¨å‡½æ•°çš„å±€éƒ¨å˜é‡å’Œè°ƒç”¨ä¿¡æ¯ã€‚æ ˆçš„å†…å­˜åˆ†é…æ˜¯è‡ªåŠ¨çš„ï¼Œå½“å‡½æ•°è°ƒç”¨ç»“æŸæ—¶ï¼Œæ ˆå†…å­˜ä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚æ ˆç©ºé—´ç›¸å¯¹è¾ƒå°ï¼Œé€Ÿåº¦å¿«ï¼Œä½†å­˜å‚¨é‡æœ‰é™ã€‚</p>
<p>å †ï¼ˆHeapï¼‰ï¼š<br>
å †ç”¨äºåŠ¨æ€åˆ†é…å†…å­˜ï¼Œç¨‹åºéœ€è¦æ˜¾å¼åˆ†é…å’Œé‡Šæ”¾å †å†…å­˜ï¼ˆå¦‚Cè¯­è¨€ä¸­çš„<code>malloc</code>å’Œ<code>free</code>ï¼‰ã€‚å †çš„å†…å­˜å¯ä»¥ä¸è¿ç»­ï¼Œä¸”å¤§å°æ¯”æ ˆå¤§å¾—å¤šã€‚</p>
<h1 id="5-ç¼“å­˜ç®¡ç†">5. ç¼“å­˜ç®¡ç†</h1>
<p>ç¡¬ä»¶ç¼“å­˜ï¼š<br>
å¤„ç†å™¨å†…éƒ¨é€šå¸¸æœ‰å¤šçº§ç¼“å­˜ï¼ˆL1ã€L2ã€L3ï¼‰ï¼Œè¿™äº›ç¼“å­˜ç”¨äºå­˜å‚¨æœ€è¿‘è®¿é—®çš„å†…å­˜æ•°æ®ï¼Œå‡å°‘è®¿é—®ä¸»å†…å­˜çš„å»¶è¿Ÿã€‚</p>
<p>è½¯ä»¶ç¼“å­˜ï¼š<br>
æ•°æ®åº“åœ¨åº”ç”¨å±‚é¢ä¹Ÿä¼šå®ç°ç¼“å­˜ï¼Œä¾‹å¦‚ç¼“å†²æ± ï¼ˆBuffer Poolï¼‰ï¼Œç”¨äºç¼“å­˜ç£ç›˜ä¸­çš„æ•°æ®é¡µï¼Œå‡å°‘ç£ç›˜I/Oæ“ä½œã€‚</p>
<h1 id="6-åƒåœ¾å›æ”¶garbage-collection">6. åƒåœ¾å›æ”¶ï¼ˆGarbage Collectionï¼‰</h1>
<p>æ‰‹åŠ¨å†…å­˜ç®¡ç†ï¼š<br>
åœ¨C/C++ä¸­ï¼Œå¼€å‘è€…éœ€è¦æ‰‹åŠ¨ç®¡ç†å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾ï¼Œæœªèƒ½æ­£ç¡®é‡Šæ”¾å†…å­˜ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p>
<p>è‡ªåŠ¨åƒåœ¾å›æ”¶ï¼š<br>
å¦‚Javaç­‰è¯­è¨€ä¸­æœ‰è‡ªåŠ¨åƒåœ¾å›æ”¶ï¼ˆGCï¼‰æœºåˆ¶ï¼ŒGCé€šè¿‡è¿½è¸ªå“ªäº›å†…å­˜å—ä¸å†è¢«å¼•ç”¨æ¥è‡ªåŠ¨å›æ”¶å†…å­˜ã€‚</p>
<h1 id="7-å†…å­˜å¯¹é½">7. å†…å­˜å¯¹é½</h1>
<p>CPUè®¿é—®å†…å­˜æ—¶ï¼Œé€šå¸¸è¦æ±‚æ•°æ®æŒ‰ç‰¹å®šå­—èŠ‚å¯¹é½ã€‚ä¾‹å¦‚ï¼Œ32ä½ç³»ç»Ÿä¸­ï¼Œ4å­—èŠ‚çš„æ•´æ•°åº”æŒ‰4å­—èŠ‚å¯¹é½ï¼Œ64ä½ç³»ç»Ÿä¸­ï¼Œ8å­—èŠ‚çš„æ•°æ®åº”æŒ‰8å­—èŠ‚å¯¹é½ã€‚</p>
<p>å¯¹é½å†…å­˜è®¿é—®å¯ä»¥æé«˜è®¿é—®é€Ÿåº¦ï¼Œå› ä¸ºæœªå¯¹é½çš„è®¿é—®å¯èƒ½éœ€è¦å¤šæ¬¡å†…å­˜è®¿é—®ã€‚</p>
<h1 id="8-å†…å­˜æ˜ å°„io">8. å†…å­˜æ˜ å°„I/O</h1>
<p>å†…å­˜æ˜ å°„I/Oï¼ˆMemory-mapped I/Oï¼‰å…è®¸å°†å¤–éƒ¨è®¾å¤‡ï¼ˆå¦‚ç£ç›˜ï¼‰ç›´æ¥æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­ï¼Œä»è€Œå¯ä»¥é€šè¿‡å†…å­˜è¯»å†™æ“ä½œè®¿é—®è®¾å¤‡ã€‚</p>
<p>æ“ä½œç³»ç»Ÿæä¾›ç³»ç»Ÿè°ƒç”¨ï¼ˆå¦‚<code>mmap</code>ï¼‰ï¼Œå…è®¸å°†æ–‡ä»¶æˆ–è®¾å¤‡æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œè¿™æ ·æ–‡ä»¶ä¸­çš„æ•°æ®å°±å¯ä»¥åƒå†…å­˜ä¸€æ ·è®¿é—®ã€‚</p>
<h1 id="9-å†…å­˜ç¢ç‰‡åŒ–">9. å†…å­˜ç¢ç‰‡åŒ–</h1>
<p>å†…å­˜ç¢ç‰‡ï¼š<br>
éšç€å†…å­˜çš„é¢‘ç¹åˆ†é…å’Œé‡Šæ”¾ï¼Œå¯èƒ½ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚å¤–éƒ¨ç¢ç‰‡æ˜¯æœªè¢«ä½¿ç”¨çš„å°å—å†…å­˜ï¼Œè€Œå†…éƒ¨ç¢ç‰‡åˆ™æ˜¯å·²åˆ†é…ä½†æœªå®Œå…¨ä½¿ç”¨çš„å†…å­˜ã€‚</p>
<p>å†…å­˜ç®¡ç†æŠ€æœ¯ï¼š<br>
é€šè¿‡å†…å­˜æ± ã€ç´§å‡‘åˆ†é…ç­‰æŠ€æœ¯ï¼Œå¯ä»¥å‡å°‘å†…å­˜ç¢ç‰‡ï¼Œæé«˜å†…å­˜ä½¿ç”¨æ•ˆç‡ã€‚</p>
<h1 id="10-æ•°æ®åº“ä¸­ç‰¹å®šçš„å†…å­˜ç®¡ç†æŠ€æœ¯">10. æ•°æ®åº“ä¸­ç‰¹å®šçš„å†…å­˜ç®¡ç†æŠ€æœ¯</h1>
<p>MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ï¼š<br>
MVCCé€šè¿‡å­˜å‚¨æ•°æ®çš„å¤šä¸ªç‰ˆæœ¬æ¥æ”¯æŒå¹¶å‘äº‹åŠ¡ã€‚æ•°æ®åº“éœ€è¦ç®¡ç†ä¸åŒç‰ˆæœ¬çš„å†…å­˜æ•°æ®ï¼Œç¡®ä¿æ—§ç‰ˆæœ¬èƒ½åŠæ—¶æ¸…ç†ï¼Œé¿å…å†…å­˜æµªè´¹ã€‚</p>
<p>æ—¥å¿—ç®¡ç†ï¼š<br>
æ•°æ®åº“ä½¿ç”¨Redo Logå’ŒUndo Logæ¥ç®¡ç†äº‹åŠ¡çš„å›æ»šå’Œæ¢å¤ï¼Œè¿™äº›æ—¥å¿—éœ€è¦æœ‰æ•ˆçš„å†…å­˜ç®¡ç†æ¥ç¡®ä¿é«˜æ•ˆæ€§ã€‚</p>
<p>å†…å­˜è¡¨ï¼š<br>
æœ‰äº›æ•°æ®åº“ï¼ˆå¦‚In-Memoryæ•°æ®åº“ï¼‰ä¼šå°†æ•°æ®å®Œå…¨å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå› æ­¤å†…å­˜ç®¡ç†ç­–ç•¥åœ¨è¿™ç±»æ•°æ®åº“ä¸­å°¤ä¸ºé‡è¦ã€‚</p>

    </div>
    <a href="/posts/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
  </div>
</div>

        </div>
      
    </section>
    <ul class="pagination pagination-default">
      <li class="page-item">
        <a href="/posts/" aria-label="First" class="page-link" role="button"><span aria-hidden="true">&laquo;&laquo;</span></a>
      </li>
      <li class="page-item">
        <a href="/posts/" aria-label="Previous" class="page-link" role="button"><span aria-hidden="true">&laquo;</span></a>
      </li>
      <li class="page-item">
        <a href="/posts/" aria-label="Page 1" class="page-link" role="button">1</a>
      </li>
      <li class="page-item active">
        <a aria-current="page" aria-label="Page 2" class="page-link" role="button">2</a>
      </li>
      <li class="page-item">
        <a href="/posts/page/3/" aria-label="Page 3" class="page-link" role="button">3</a>
      </li>
      <li class="page-item">
        <a href="/posts/page/3/" aria-label="Next" class="page-link" role="button"><span aria-hidden="true">&raquo;</span></a>
      </li>
      <li class="page-item">
        <a href="/posts/page/3/" aria-label="Last" class="page-link" role="button"><span aria-hidden="true">&raquo;&raquo;</span></a>
      </li>
    </ul></article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="http://localhost:1313/" >
    &copy;  Wei Haoyu 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
